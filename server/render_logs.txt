INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746080567_fcr28z8y4
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763746080555_gjuchgoob
INFO:     10.20.170.104:56346 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:üìÅ File: 08.06.2025 Allied Innovative Payment 2.pdf, Size: 227321 bytes, Hash: 98272fc00893adae..., User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.new_extract:üîç Checking for duplicates BEFORE proceeding with upload...
INFO:app.api.new_extract:‚úÖ No duplicate found - proceeding with upload for file: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.new_extract:üöÄ Starting extraction: 08.06.2025 Allied Innovative Payment 2.pdf (ID: upload_1763746080555_gjuchgoob)
INFO:app.services.gcs_utils:‚úÖ File uploaded to GCS: statements/e62dda3a-d8de-4a57-b985-80fb5df9dd4b/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.new_extract:‚úÖ Uploaded to GCS: statements/e62dda3a-d8de-4a57-b985-80fb5df9dd4b/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:üîê Generating signed URL for: statements/e62dda3a-d8de-4a57-b985-80fb5df9dd4b/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:üìù Generating signed URL with:
INFO:app.services.gcs_utils:   - Content-Type: application/pdf
INFO:app.services.gcs_utils:   - Content-Disposition: inline
INFO:app.services.gcs_utils:   - Expiration: 1 hour(s)
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/e62dda3a-d8de-4a57-b985-80fb5df9dd4b/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:   URL expires at: 2025-11-21 18:28:03.228809
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1763746080555_gjuchgoob
INFO:app.db.crud.environment:‚úÖ Found existing default environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 for user f6cf1764-5bfc-4352-abd9-81b72b7cf191 in company d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.api.new_extract:‚úÖ Using user's default environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 for upload consistency
INFO:app.api.new_extract:üìù Upload metadata prepared (NOT saved to DB): e62dda3a-d8de-4a57-b985-80fb5df9dd4b
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: e62dda3a-d8de-4a57-b985-80fb5df9dd4b)
INFO:app.services.conversational_summary_service:‚úÖ ConversationalSummaryService initialized with GPT-4o
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚úÖ Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:‚≠ê PRIMARY: GPT-5 Vision - AVAILABLE ‚úì
INFO:app.services.enhanced_extraction_service:   Features: Structured outputs, 60-80% token savings, 99.9% reliability
INFO:app.services.enhanced_extraction_service:üìã FALLBACK services: Lazy-loaded on demand (Claude, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:‚è±Ô∏è  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:üöÄ Enhanced 3-phase pipeline: ENABLED
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚úÖ Using GPT-5 Vision as primary extraction service
INFO:app.services.enhanced_extraction_service:‚úÖ GPT5_VISION service validated successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚≠ê‚≠ê‚≠ê ROUTING TO GPT-5 VISION EXTRACTION ‚≠ê‚≠ê‚≠ê
INFO:app.services.enhanced_extraction_service:   Extraction Method: smart
INFO:app.services.enhanced_extraction_service:   Features: Structured outputs, token optimization, intelligent page selection
INFO:app.services.enhanced_extraction_service:   File: pdfs/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.enhanced_extraction_service:   NOTE: Function name '_extract_with_claude_progress' is legacy - it USES GPT-5
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763746080555_gjuchgoob
INFO:app.services.enhanced_extraction_service:‚ÑπÔ∏è Carrier from database 'Pinecrestconsulting' has no specific prompt. Continuing detection.
INFO:app.services.enhanced_extraction_service:No carrier match detected inside provided text snippet.
INFO:app.services.enhanced_extraction_service:No carrier match detected inside provided text snippet.
INFO:app.services.enhanced_extraction_service:‚úì Using carrier context for GPT prompts: Pinecrestconsulting (options: none)
INFO:app.services.enhanced_extraction_service:üì° Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.enhanced_extraction_service:üì° Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.enhanced_extraction_service:‚≠ê Starting GPT-5 Vision extraction for pdfs/08.06.2025 Allied Innovative Payment 2.pdf (enhanced=True)
INFO:app.services.enhanced_extraction_service:   Using structured outputs for 99.9% reliability
INFO:app.services.enhanced_extraction_service:   Token optimization: 60-80% savings via intelligent page selection
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:üöÄ CALLING GPT-5 VISION SERVICE FOR EXTRACTION
INFO:app.services.enhanced_extraction_service:   File: pdfs/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.enhanced_extraction_service:   Carrier: Pinecrestconsulting
INFO:app.services.enhanced_extraction_service:   Enhanced Mode: True
INFO:app.services.enhanced_extraction_service:   Max Pages: 100 (intelligent page selection)
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.gpt.enhanced_service:üöÄ Starting enhanced extraction for Pinecrestconsulting | upload_1763746083
INFO:app.services.gpt.vision_extractor:üìÑ Processing PDF with direct upload method: pdfs/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.gpt.vision_extractor:üìè Document has 7 pages (> 6 single-call limit). Using chunked extraction.
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.gpt.vision_extractor:üì§ Uploading PDF: /tmp/tmpcpd_wua2.pdf
INFO:     10.219.18.220:32798 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/files "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:‚úÖ PDF uploaded: file-8ksmjjtXcwEnQjL9aLY42f
INFO:app.services.gpt.dynamic_prompts:üîç GPT: Looking up carrier prompt: 'Pinecrestconsulting' ‚Üí normalized: 'pinecrestconsulting'
INFO:app.services.gpt.dynamic_prompts:‚ùå No carrier-specific prompt found for 'Pinecrestconsulting', using standard prompt only
INFO:app.services.gpt.dynamic_prompts:   Available carriers: ['UnitedHealthcare', 'United Healthcare', 'UHC', 'United Health Group', 'UnitedHealth', 'Redirect Health']
INFO:app.services.gpt.vision_extractor:üìã Extracting from PDF using Responses API (file_id: file-8ksmjjtXcwEnQjL9aLY42f)
INFO:     10.219.18.220:32804 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:51476 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:51484 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:51480 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:43350 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:43366 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:43512 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:43524 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:39780 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:39804 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:39790 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:43994 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:44006 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:38648 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:38660 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:46828 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:46840 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:46842 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:56064 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:56078 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:49724 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:üìä Response length: 15586 characters
INFO:app.services.gpt.vision_extractor:‚úÖ Extraction complete: 3 tables, 13030 tokens, $0.0018
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.gpt.vision_extractor:üì§ Uploading PDF: /tmp/tmpk46_kgaz.pdf
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/files "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:‚úÖ PDF uploaded: file-N393wsMbP3qFEJnx6Vxozs
INFO:app.services.gpt.dynamic_prompts:üîç GPT: Looking up carrier prompt: 'Pinecrestconsulting' ‚Üí normalized: 'pinecrestconsulting'
INFO:app.services.gpt.dynamic_prompts:‚ùå No carrier-specific prompt found for 'Pinecrestconsulting', using standard prompt only
INFO:app.services.gpt.dynamic_prompts:   Available carriers: ['UnitedHealthcare', 'United Healthcare', 'UHC', 'United Health Group', 'UnitedHealth', 'Redirect Health']
INFO:app.services.gpt.vision_extractor:üìã Extracting from PDF using Responses API (file_id: file-N393wsMbP3qFEJnx6Vxozs)
INFO:     10.219.18.220:49728 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:60538 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:60548 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:60558 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:39830 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:39846 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:42616 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:42628 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:37420 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:37446 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:37434 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:38504 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:38520 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:42058 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:42060 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:58624 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:üìä Response length: 11747 characters
INFO:app.services.gpt.vision_extractor:‚úÖ Extraction complete: 3 tables, 10677 tokens, $0.0016
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.gpt.vision_extractor:üì§ Uploading PDF: /tmp/tmpwgjdcsh2.pdf
INFO:     10.219.18.220:58640 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:58650 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/files "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:‚úÖ PDF uploaded: file-SA2Ero1pCZSZVjpAf9J8Eq
INFO:app.services.gpt.dynamic_prompts:üîç GPT: Looking up carrier prompt: 'Pinecrestconsulting' ‚Üí normalized: 'pinecrestconsulting'
INFO:app.services.gpt.dynamic_prompts:‚ùå No carrier-specific prompt found for 'Pinecrestconsulting', using standard prompt only
INFO:app.services.gpt.dynamic_prompts:   Available carriers: ['UnitedHealthcare', 'United Healthcare', 'UHC', 'United Health Group', 'UnitedHealth', 'Redirect Health']
INFO:app.services.gpt.vision_extractor:üìã Extracting from PDF using Responses API (file_id: file-SA2Ero1pCZSZVjpAf9J8Eq)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:33082 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:33092 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:40722 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:40736 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:47382 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:47390 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:47398 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:50828 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:50830 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:52648 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:52656 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:49204 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:49218 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:49220 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:üìä Response length: 8987 characters
INFO:app.services.gpt.vision_extractor:‚úÖ Extraction complete: 1 tables, 7686 tokens, $0.0010
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.gpt.vision_extractor:‚úÖ Document processing complete: 7 tables, $0.0000
INFO:app.services.gpt.monitoring:‚úÖ Extraction success | upload_id=upload_1763746083 | pages=1 | tokens=31393 | cost=$0.0043 | time=226.36s
INFO:app.services.gpt.enhanced_service:‚úÖ Extraction complete: 7 tables, $0.0043, 226.36s
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚úÖ GPT-5 VISION SERVICE COMPLETED SUCCESSFULLY
INFO:app.services.enhanced_extraction_service:   Success: True
INFO:app.services.enhanced_extraction_service:   Tables Extracted: 7
INFO:app.services.enhanced_extraction_service:   Tokens Used: 31393
INFO:app.services.enhanced_extraction_service:   Cost: $0.0043
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚ö° Transforming GPT-5 Vision results to compatible format
INFO:app.services.enhanced_extraction_service:üìä GPT-5 extraction results:
INFO:app.services.enhanced_extraction_service:   - Tables: 7
INFO:app.services.enhanced_extraction_service:   - Groups/Companies: 26
INFO:app.services.enhanced_extraction_service:   - Writing Agents: 3
INFO:app.services.enhanced_extraction_service:   - Carrier: ALLIED
INFO:app.services.enhanced_extraction_service:   - Broker: INNOVATIVE BPS LLC
INFO:app.services.enhanced_extraction_service:   - Statement Date: 2025-08-06
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.enhanced_extraction_service:‚úÖ GPT-5 metadata extracted: carrier=ALLIED, date=2025-08-06, broker=INNOVATIVE BPS LLC
INFO:app.services.enhanced_extraction_service:   Cost: $0.0043, Tokens: 31393
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
üìé Enhanced multi-strategy stitching: Processing 7 tables
üìé Canonical header identified: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 1 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 2 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 3 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 4 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 5 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 6 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 7 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Found 1 unique header patterns
üìé Header pattern 'group no.' appears in 7 tables
üìé Creating group with 7 tables (identical headers)
üìé Grouped 7 tables into 1 groups
üìé Merging group 1 with 7 tables
INFO:app.services.extraction_utils:‚úÖ Merged table created: 74 rows (enhancements preserved from individual tables)
üìé Merged table 1: 10 headers, 74 rows
üìé Merged headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üìé Enhanced stitching completed: 1 final tables
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.enhanced_extraction_service:GPT-5: Verified normalized headers
INFO:app.services.enhanced_extraction_service:üìä Table 1 summary rows ‚Üí model:13 heuristic:13 final:13
INFO:app.services.enhanced_extraction_service:   ‚Ü≥ Example reasoning row 3: score=1.7 reasons=['Row annotated as GroupSummary', 'Contains summary keyword', 'Matches expected rollup label', "Matches 'Total for Group' pattern", "Contains 'Total for ...' phrase", 'Matches running total of previous detail rows']
INFO:app.services.enhanced_extraction_service:‚≠ê GPT-5: Processed 7 tables into 1 tables
INFO:app.services.enhanced_extraction_service:   Cost: $0.0043
INFO:app.services.enhanced_extraction_service:   Tokens: 31393
INFO:app.services.enhanced_extraction_service:‚úÖ Using GPT-5's structured output summary row detection
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1763746080555_gjuchgoob
INFO:app.services.conversational_summary_service:üó£Ô∏è Generating conversational summary...
INFO:app.services.conversational_summary_service:üîç _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'groups_and_companies', 'writing_agents', 'business_intelligence', 'summary', 'total_tokens_used', 'estimated_cost_usd', 'processing_time_seconds', 'quality_summary', 'metadata', 'extraction_quality', 'structured_data', 'extraction_pipeline']
INFO:app.services.conversational_summary_service:‚úÖ Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:üéØ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: []
INFO:app.services.conversational_summary_service:   - Relationships: []
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['number_of_groups', 'number_of_agents', 'total_commission', 'top_contributors']
INFO:app.services.conversational_summary_service:‚úÖ Using root-level groups_and_companies: 26 items
INFO:app.services.conversational_summary_service:‚úÖ Using root-level writing_agents: 3 items
INFO:app.services.conversational_summary_service:‚úÖ SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:üöÄ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:‚úÖ SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:üöÄ Calling GPT-4o API for summary generation...
INFO:app.services.conversational_summary_service:   Model: gpt-4o
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 120708 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 429 Too Many Requests"
INFO:openai._base_client:Retrying request to /chat/completions in 0.380965 seconds
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 429 Too Many Requests"
INFO:openai._base_client:Retrying request to /chat/completions in 0.912383 seconds
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:40552 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.conversational_summary_service:‚ùå Summary generation failed: Error code: 429 - {'error': {'message': 'Request too large for gpt-4o in organization org-DXuWxsjx0mXX2seALxBQOck1 on tokens per min (TPM): Limit 30000, Requested 30560. The input or output tokens must be reduced in order to run successfully. Visit https://platform.openai.com/account/rate-limits to learn more.', 'type': 'tokens', 'param': None, 'code': 'rate_limit_exceeded'}}
ERROR:app.services.conversational_summary_service:   Error type: RateLimitError
ERROR:app.services.conversational_summary_service:   Full traceback:
Traceback (most recent call last):
  File "/app/app/services/conversational_summary_service.py", line 227, in generate_conversational_summary
    response = await self.client.chat.completions.create(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/resources/chat/completions/completions.py", line 2585, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1794, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/openai/_base_client.py", line 1594, in request
    raise self._make_status_error_from_response(err.response) from None
openai.RateLimitError: Error code: 429 - {'error': {'message': 'Request too large for gpt-4o in organization org-DXuWxsjx0mXX2seALxBQOck1 on tokens per min (TPM): Limit 30000, Requested 30560. The input or output tokens must be reduced in order to run successfully. Visit https://platform.openai.com/account/rate-limits to learn more.', 'type': 'tokens', 'param': None, 'code': 'rate_limit_exceeded'}}
ERROR:app.services.conversational_summary_service:   Extraction data keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'groups_and_companies', 'writing_agents', 'business_intelligence', 'summary', 'total_tokens_used', 'estimated_cost_usd', 'processing_time_seconds', 'quality_summary', 'metadata', 'extraction_quality', 'structured_data', 'extraction_pipeline']
WARNING:app.services.conversational_summary_service:üîÑ Generating fallback summary...
INFO:app.services.conversational_summary_service:   Using standard data: carrier=ALLIED, broker=Unknown, date=2025-08-06
WARNING:app.services.conversational_summary_service:   Fallback summary: Commission statement from ALLIED. for period ending 2025-08-06. prepared for INNOVATIVE BPS LLC. Total commission: $2,100.58. 74 commission entries across 1 table(s).
WARNING:app.services.conversational_summary_service:‚ö†Ô∏è Using fallback summary: Commission statement from ALLIED. for period ending 2025-08-06. prepared for INNOVATIVE BPS LLC. Total commission: $2,100.58. 74 commission entries across 1 table(s).
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Started stage validation for upload upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Completed processing for upload upload_1763746080555_gjuchgoob in 231.66 seconds
INFO:app.api.new_extract:‚úÖ Extraction completed successfully
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1763746080555_gjuchgoob
INFO:app.api.new_extract:üîç Summary row refinement adjusted table 0: [3, 8, 14, 15, 19, 53, 55, 57, 59, 61, 62, 64, 73] ‚Üí [3, 8, 14, 15, 19, 53, 59, 60, 61, 62, 64, 73]
INFO:app.api.new_extract:‚úÖ Extraction completed (data NOT saved to DB, will be saved on approval)
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: e62dda3a-d8de-4a57-b985-80fb5df9dd4b)
INFO:app.api.new_extract:üéØ Format Learning: Using carrier ALLIED with ID 5c9324ac-1794-4563-8e0e-8cd5c5317181
WARNING:app.api.new_extract:üö® CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as ALLIED (5c9324ac-1794-4563-8e0e-8cd5c5317181)
INFO:app.api.new_extract:üîÑ Reassigning file to correct carrier: ALLIED
INFO:app.services.gcs_utils:‚úÖ File copied in GCS: statements/e62dda3a-d8de-4a57-b985-80fb5df9dd4b/08.06.2025 Allied Innovative Payment 2.pdf -> statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ File deleted from GCS: statements/e62dda3a-d8de-4a57-b985-80fb5df9dd4b/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:üîê Generating signed URL for: statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:üìù Generating signed URL with:
üéØ FormatLearningService: Finding matching format for company 5c9324ac-1794-4563-8e0e-8cd5c5317181
INFO:app.services.gcs_utils:   - Content-Type: application/pdf
INFO:app.services.gcs_utils:   - Content-Disposition: inline
INFO:app.services.gcs_utils:   - Expiration: 1 hour(s)
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:   URL expires at: 2025-11-21 18:31:56.312600
INFO:app.api.new_extract:‚úÖ File moved to correct carrier folder in GCS: statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.new_extract:‚úÖ Updated upload metadata: carrier_id=5c9324ac-1794-4563-8e0e-8cd5c5317181, company_id stays as user's company=d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.api.new_extract:üìä Single table detected, using it for field mapping
INFO:app.api.new_extract:üéØ Using table 0 for field mapping with 10 headers
üéØ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ FormatLearningService: Table structure: {'row_count': 74, 'column_count': 10, 'has_financial_data': True}
üéØ FormatLearningService: Headers type: <class 'list'>
üéØ FormatLearningService: Headers length: 10
üéØ CRUD: Finding best matching format for company 5c9324ac-1794-4563-8e0e-8cd5c5317181
üéØ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD: Input table structure: {'row_count': 74, 'column_count': 10, 'has_financial_data': True}
üéØ CRUD: Found 1 saved formats for company
üéØ CRUD: Comparing with saved format:
üéØ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD:   Header similarity: 0.7200000000000001
üéØ CRUD:   Structure similarity: 1.0
üéØ CRUD:   Total score: 0.776
üéØ CRUD:   -> New best match with score 0.776
üéØ FormatLearningService: Best match score: 0.776
üéØ FormatLearningService: Found matching format with signature: 434609905947a9e8728df0b79ba381ce
üéØ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üéØ FormatLearningService: Learned table editor settings: {'carrier_name': 'ALLIED', 'corrected_carrier_name': 'ALLIED', 'statement_date': '2025-01-08', 'corrected_statement_date': '2025-01-08', 'statement_total_amount': 9336.9, 'total_amount_field_name': 'Invoice Total'}
INFO:app.api.new_extract:üéØ Format Learning: Found matching format with score 0.776
INFO:app.api.new_extract:üéØ Format Learning: Applying corrected carrier name from learned format: ALLIED
INFO:app.api.new_extract:üéØ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:‚úÖ Total extracted from document_metadata: $2100.58
WARNING:app.api.new_extract:‚ö†Ô∏è Replacing total_amount 2100.58 (method=document_metadata) with summary_row_scan=3604.95
INFO:app.api.new_extract:üéØ Format Learning: Total validation result: {'matches': False, 'extracted_amount': 3604.95, 'learned_amount': 9336.9, 'difference': 5731.95, 'difference_percent': 61.39, 'status': 'mismatch', 'tolerance_percent': 5.0}
INFO:app.api.new_extract:üìä Added total to document_metadata: $3604.95 (method: summary_row_scan)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:üîç AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.85 confidence
INFO:app.api.new_extract:‚úÖ AI Plan Detection: 1 plan types with 0.85 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763746080555_gjuchgoob
INFO:app.api.new_extract:üß† AI Field Mapping: Starting field mapping during extraction
INFO:app.api.new_extract:üìã Normalizing headers for AI mapping:
INFO:app.api.ai_intelligent_mapping:üöÄ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ü§ñ AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:üîç AI Mapping: carrier_id provided: True (value: 5c9324ac-1794-4563-8e0e-8cd5c5317181)
INFO:     10.219.18.220:40568 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.ai_field_mapping_service:üéØ Carrier ID is valid, attempting to retrieve learned mapping for carrier 5c9324ac-1794-4563-8e0e-8cd5c5317181
INFO:app.services.ai_field_mapping_service:üîç Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:üîç Looking up learned format for carrier 5c9324ac-1794-4563-8e0e-8cd5c5317181 with 10 headers
INFO:app.services.ai_field_mapping_service:‚ùå No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:üîç Found 1 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:üîç Format signature 434609905947a9e8728df0b79ba381ce: similarity = 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ New best match with similarity 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ Found similar format with 0.72 similarity score
INFO:app.services.ai_field_mapping_service:üéØ Found learned mapping for carrier with 0.72 confidence
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:‚úÖ AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:‚úÖ AI Mapping: Generated 10 mappings with 0.89 confidence
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:     10.219.18.220:46248 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:‚úÖ Enhanced AI Analysis Complete: Overall confidence 0.89
INFO:app.api.new_extract:‚úÖ AI Field Mapping: 10 mappings with sample data, confidence 0.89
INFO:app.api.new_extract:‚úÖ Conversational summary supplied by extraction pipeline
INFO:app.api.new_extract:   Summary preview: Commission statement from ALLIED. for period ending 2025-08-06. prepared for INNOVATIVE BPS LLC. Total commission: $2,100.58. 74 commission entries across 1 table(s).
INFO:app.api.new_extract:   Structured data keys: []
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: e62dda3a-d8de-4a57-b985-80fb5df9dd4b)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {}...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763746080555_gjuchgoob
ERROR:app.services.websocket_service:Timeout sending message to upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746080567_fcr28z8y4
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746080567_fcr28z8y4
ERROR:app.services.websocket_service:Timeout sending message to upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746080567_fcr28z8y4
INFO:     connection closed
ERROR:asyncio:Task exception was never retrieved
future: <Task finished name='Task-1351' coro=<WebSocket.close() done, defined at /usr/local/lib/python3.11/site-packages/starlette/websockets.py:180> exception=RuntimeError('Cannot call "send" once a close message has been sent.')>
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/starlette/websockets.py", line 181, in close
    await self.send({"type": "websocket.close", "code": code, "reason": reason or ""})
  File "/usr/local/lib/python3.11/site-packages/starlette/websockets.py", line 98, in send
    raise RuntimeError('Cannot call "send" once a close message has been sent.')
RuntimeError: Cannot call "send" once a close message has been sent.
ERROR:app.services.websocket_service:Error broadcasting to session session_1763746080567_fcr28z8y4: 
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/protocol.py", line 1301, in close_connection
    await self.transfer_data_task
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/protocol.py", line 963, in transfer_data
    message = await self.read_message()
              ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/protocol.py", line 1033, in read_message
    frame = await self.read_data_frame(max_size=self.max_size)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/protocol.py", line 1108, in read_data_frame
    frame = await self.read_frame(max_size)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/protocol.py", line 1165, in read_frame
    frame = await Frame.read(
            ^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/framing.py", line 68, in read
    data = await reader(2)
           ^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/asyncio/streams.py", line 750, in readexactly
    await self._wait_for_data('readexactly')
  File "/usr/local/lib/python3.11/asyncio/streams.py", line 543, in _wait_for_data
    await self._waiter
asyncio.exceptions.CancelledError
The above exception was the direct cause of the following exception:
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 332, in asgi_send
    await self.send(data)  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/protocol.py", line 635, in send
    await self.ensure_open()
  File "/usr/local/lib/python3.11/site-packages/websockets/legacy/protocol.py", line 948, in ensure_open
    raise self.connection_closed_exc()
websockets.exceptions.ConnectionClosedError: sent 1011 (internal error) keepalive ping timeout; no close frame received
The above exception was the direct cause of the following exception:
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/starlette/websockets.py", line 86, in send
    await self._send(message)
  File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 39, in sender
    await send(message)
  File "/usr/local/lib/python3.11/site-packages/uvicorn/protocols/websockets/websockets_impl.py", line 345, in asgi_send
    raise ClientDisconnected from exc
uvicorn.protocols.utils.ClientDisconnected
During handling of the above exception, another exception occurred:
Traceback (most recent call last):
  File "/app/app/services/websocket_service.py", line 272, in broadcast_to_upload
    await asyncio.wait_for(
  File "/usr/local/lib/python3.11/asyncio/tasks.py", line 489, in wait_for
    return fut.result()
           ^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/starlette/websockets.py", line 166, in send_text
    await self.send({"type": "websocket.send", "text": data})
  File "/usr/local/lib/python3.11/site-packages/starlette/websockets.py", line 89, in send
    raise WebSocketDisconnect(code=1006)
starlette.websockets.WebSocketDisconnect
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_STARTED
WARNING:app.services.websocket_service:No active connections found for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763746080555_gjuchgoob
INFO:app.api.new_extract:üìä Calculating invoice total from 1 tables
INFO:app.api.new_extract:üìä Table 0: Found invoice column at index 4: 'Invoice Total'
INFO:app.api.new_extract:‚úÖ Table 0: Calculated from rows: $66,325.44
INFO:app.api.new_extract:‚úÖ TOTAL invoice amount from all tables: $66,325.44
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: STEP_PROGRESS
WARNING:app.services.websocket_service:No active connections found for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763746080555_gjuchgoob: EXTRACTION_COMPLETE
WARNING:app.services.websocket_service:No active connections found for upload_id upload_1763746080555_gjuchgoob
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763746080555_gjuchgoob
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1763746080555_gjuchgoob
WARNING:app.api.websocket:WebSocket disconnected during message handling: WebSocket is not connected. Need to call "accept" first.
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763746080555_gjuchgoob
INFO:     10.20.174.248:40256 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     10.219.18.220:50190 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:50202 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:50200 - "GET /health HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763746080555_gjuchgoob. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746371900_415uve3zk
INFO:     10.20.16.82:59196 - "WebSocket /api/ws/progress/upload_1763746080555_gjuchgoob?session_id=session_1763746371900_415uve3zk" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746371900_415uve3zk, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746371900_415uve3zk
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:37094 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:37104 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:37504 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:37518 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:44182 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:44192 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:44204 - "GET /health HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746371900_415uve3zk
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746371900_415uve3zk
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763746080555_gjuchgoob
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763746080555_gjuchgoob. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746401538_ygyrrxef3
INFO:     10.20.33.62:36860 - "WebSocket /api/ws/progress/upload_1763746080555_gjuchgoob?session_id=session_1763746401538_ygyrrxef3" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746401538_ygyrrxef3, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746401538_ygyrrxef3
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763746080555_gjuchgoob
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746401538_ygyrrxef3
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746401538_ygyrrxef3
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763746080555_gjuchgoob
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763746080555_gjuchgoob. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746402539_5kwk62jpw
INFO:     10.20.148.164:38526 - "WebSocket /api/ws/progress/upload_1763746080555_gjuchgoob?session_id=session_1763746402539_5kwk62jpw" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746402539_5kwk62jpw, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746402539_5kwk62jpw
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:57912 - "GET /health HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746402539_5kwk62jpw
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746402539_5kwk62jpw
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763746080555_gjuchgoob
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763746080555_gjuchgoob. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746406539_8a34pghpr
INFO:     10.20.166.78:58878 - "WebSocket /api/ws/progress/upload_1763746080555_gjuchgoob?session_id=session_1763746406539_8a34pghpr" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763746080555_gjuchgoob, session_id=session_1763746406539_8a34pghpr, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763746080555_gjuchgoob, session_id: session_1763746406539_8a34pghpr
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763746080555_gjuchgoob
INFO:     10.219.18.220:57926 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:58512 - "GET /health HTTP/1.1" 200 OK
INFO:     connection closed