INFO:     10.20.245.226:34518 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
     [OPTIONS]200commission-tracker-1.onrender.com/api/extract-tables-smart/clientIP="86.50.75.139" requestID="3b35d6f0-7e6e-414c" responseTimeMS=16 responseBytes=876 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:app.api.new_extract:ğŸ“ File: 2025.05.pdf, Size: 72109 bytes, Hash: 506a12fe8c1069e0..., User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.new_extract:ğŸ” Checking for duplicates BEFORE proceeding with upload...
INFO:app.api.new_extract:âœ… No duplicate found - proceeding with upload for file: 2025.05.pdf
INFO:app.api.new_extract:ğŸš€ Starting extraction: 2025.05.pdf (ID: upload_1763980540949_caydha1ce)
INFO:app.services.gcs_utils:âœ… File uploaded to GCS: statements/fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d/2025.05.pdf
INFO:app.api.new_extract:âœ… Uploaded to GCS: statements/fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ” Generating signed URL for: statements/fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ“ Generating signed URL with:
INFO:app.services.gcs_utils:   - Content-Type: application/pdf
INFO:app.services.gcs_utils:   - Content-Disposition: inline
INFO:app.services.gcs_utils:   - Expiration: 1 hour(s)
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d/2025.05.pdf
INFO:app.services.gcs_utils:   URL expires at: 2025-11-24 11:35:43.734989
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1763980540949_caydha1ce
INFO:app.db.crud.environment:âœ… Found existing default environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 for user f6cf1764-5bfc-4352-abd9-81b72b7cf191 in company d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.api.new_extract:âœ… Using user's default environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 for upload consistency
INFO:app.api.new_extract:ğŸ“ Upload metadata prepared (NOT saved to DB): fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d)
INFO:app.services.conversational_summary_service:âœ… ConversationalSummaryService initialized with GPT-4o
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:âœ… Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:â­ PRIMARY: GPT-5 Vision - AVAILABLE âœ“
INFO:app.services.enhanced_extraction_service:   Features: Structured outputs, 60-80% token savings, 99.9% reliability
INFO:app.services.enhanced_extraction_service:ğŸ“‹ FALLBACK services: Lazy-loaded on demand (Claude, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:â±ï¸  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:ğŸš€ Enhanced 3-phase pipeline: ENABLED
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:âœ… Using GPT-5 Vision as primary extraction service
INFO:app.services.enhanced_extraction_service:âœ… GPT5_VISION service validated successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:â­â­â­ ROUTING TO GPT-5 VISION EXTRACTION â­â­â­
INFO:app.services.enhanced_extraction_service:   Extraction Method: smart
INFO:app.services.enhanced_extraction_service:   Features: Structured outputs, token optimization, intelligent page selection
INFO:app.services.enhanced_extraction_service:   File: pdfs/2025.05.pdf
INFO:app.services.enhanced_extraction_service:   NOTE: Function name '_extract_with_claude_progress' is legacy - it USES GPT-5
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763980540949_caydha1ce
INFO:app.services.enhanced_extraction_service:â„¹ï¸ Carrier from database 'Pinecrestconsulting' has no specific prompt. Continuing detection.
INFO:app.services.enhanced_extraction_service:No carrier match detected inside provided text snippet.
INFO:app.services.enhanced_extraction_service:ğŸ” Detected carrier 'Redirect Health' from contextual text match.
INFO:app.services.enhanced_extraction_service:âœ“ Carrier detected from PDF text: Redirect Health
INFO:app.services.enhanced_extraction_service:âœ“ Using carrier context for GPT prompts: Redirect Health (options: {'merge_similar_tables': True, 'summary_keywords': ['total', 'grand total', 'subtotal', 'sum', 'broker total', 'group invoices total', 'commission summary'], 'summary_row_templates': ['Group Invoices for Broker Commissions', 'Group ID / Group Name rollups', "Lines that start with 'Total' or end with 'Totals'"], 'expected_rollups': ['Group Total', 'Group Invoices Total', 'Commission Amount Total', 'Allowance Type Total', 'Grand Total'], 'numeric_tolerance_bps': 65, 'row_role_examples': [{'label': 'GroupSummary', 'signature': "Identifier columns blank or show 'Group Total' but dollar columns populated with the sum of above rows."}, {'label': 'AllowanceSummary', 'signature': 'Rows where only the Allowance Type and numeric columns are populated and the numeric values equal the prior block.'}, {'label': 'CarrierSummary', 'signature': 'Rows near the end of a table that restate Invoice Amount, Commissionable Amount, and Commission Amount.'}], 'domain_notes': 'Redirect Health statements bundle 1-2 page tables where writing agent subtotals appear above grand totals. Summary rows frequently blank out the Group ID column but repeat invoice, commissionable, and commission totals.'})
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763980540949_caydha1ce
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.enhanced_extraction_service:â­ Starting GPT-5 Vision extraction for pdfs/2025.05.pdf (enhanced=True)
INFO:app.services.enhanced_extraction_service:   Using structured outputs for 99.9% reliability
INFO:app.services.enhanced_extraction_service:   Token optimization: 60-80% savings via intelligent page selection
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸš€ CALLING GPT-5 VISION SERVICE FOR EXTRACTION
INFO:app.services.enhanced_extraction_service:   File: pdfs/2025.05.pdf
INFO:app.services.enhanced_extraction_service:   Carrier: Redirect Health
INFO:app.services.enhanced_extraction_service:   Enhanced Mode: True
INFO:app.services.enhanced_extraction_service:   Max Pages: 100 (intelligent page selection)
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.gpt.enhanced_service:ğŸš€ Starting enhanced extraction for Redirect Health | upload_1763980544
INFO:app.services.gpt.vision_extractor:ğŸ“„ Processing PDF with direct upload method: pdfs/2025.05.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.gpt.vision_extractor:ğŸ“¤ Uploading PDF: pdfs/2025.05.pdf
INFO:     10.219.18.220:46386 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/files "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:âœ… PDF uploaded: file-VBvYYfndDeD1Qs5PY4LSFM
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.gpt.dynamic_prompts:ğŸ” GPT: Looking up carrier prompt: 'Redirect Health' â†’ normalized: 'redirecthealth'
INFO:app.services.gpt.dynamic_prompts:âœ… MATCH FOUND! Using carrier-specific prompt for: Redirect Health
INFO:app.services.gpt.vision_extractor:ğŸ“‹ Applied carrier-specific instructions for Redirect Health
INFO:app.services.gpt.vision_extractor:ğŸ“‹ Extracting from PDF using Responses API (file_id: file-VBvYYfndDeD1Qs5PY4LSFM)
INFO:     10.219.18.220:46394 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:46396 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:46544 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:46556 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:38362 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:38378 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:38698 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:38706 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:38700 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:52912 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:52922 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:43828 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:43834 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:     10.219.18.220:50694 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.gpt.vision_extractor:ğŸ“Š Response length: 11462 characters
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.gpt.vision_extractor:âœ… Extraction complete: 3 tables, 8952 tokens, $0.0013
INFO:app.services.gpt.vision_extractor:âœ… Document processing complete: 3 tables, $0.0013
INFO:app.services.gpt.monitoring:âœ… Extraction success | upload_id=upload_1763980544 | pages=1 | tokens=8952 | cost=$0.0013 | time=60.82s
INFO:app.services.gpt.enhanced_service:âœ… Extraction complete: 3 tables, $0.0013, 60.82s
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:âœ… GPT-5 VISION SERVICE COMPLETED SUCCESSFULLY
INFO:app.services.enhanced_extraction_service:   Success: True
INFO:app.services.enhanced_extraction_service:   Tables Extracted: 3
INFO:app.services.enhanced_extraction_service:   Tokens Used: 8952
INFO:app.services.enhanced_extraction_service:   Cost: $0.0013
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:âš¡ Transforming GPT-5 Vision results to compatible format
INFO:app.services.enhanced_extraction_service:ğŸ“Š GPT-5 extraction results:
INFO:app.services.enhanced_extraction_service:   - Tables: 3
INFO:app.services.enhanced_extraction_service:   - Groups/Companies: 12
INFO:app.services.enhanced_extraction_service:   - Writing Agents: 0
INFO:app.services.enhanced_extraction_service:   - Carrier: Redirect Health
INFO:app.services.enhanced_extraction_service:   - Broker: Innovative BPS LLC
INFO:app.services.enhanced_extraction_service:   - Statement Date: 2025-05-31
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.enhanced_extraction_service:âœ… GPT-5 metadata extracted: carrier=Redirect Health, date=2025-05-31, broker=Innovative BPS LLC
INFO:app.services.enhanced_extraction_service:   Cost: $0.0013, Tokens: 8952
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
ğŸ“ Enhanced multi-strategy stitching: Processing 3 tables
ğŸ“ Canonical header identified: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount'] (6 columns)
ğŸ“ Table 1 headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount'] (6 columns)
ğŸ“ Table 2 headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Allowance Type', 'Commission Amount'] (6 columns)
ğŸ“ Table 3 headers: ['Total Invoice Amount', 'Commissionable Amount', 'Commission Amount'] (3 columns)
ğŸ“ Found 3 unique header patterns
ğŸ“ Fuzzy merge enabled. Attempting to combine similar header groups (threshold=0.8).
ğŸ“ Similarity breakdown for tables:
   Header: 0.905
   Column count: 1.000
   Row format: 1.000
   Data pattern: 0.833
   Structure: 0.667
   Final score: 0.913
ğŸ“ Fuzzy merge: combining group 1 with 2 (similarity=0.913)
   ğŸ” Smart column splitting detected - using enhanced similarity
   Smart splitting similarity: phrase=0.894, word=0.400, combined=0.746
ğŸ“ Similarity breakdown for tables:
   Header: 0.746
   Column count: 0.500
   Row format: 0.500
   Data pattern: 0.333
   Structure: 0.667
   Final score: 0.565
ğŸ“ Grouped 3 tables into 2 groups
ğŸ“ Merging group 1 with 2 tables
INFO:app.services.extraction_utils:âœ… Merged table created: 14 rows (enhancements preserved from individual tables)
ğŸ“ Merged table 1: 6 headers, 14 rows
ğŸ“ Merged headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
ğŸ“ Merging group 2 with 1 tables
ğŸ“ Merged table 2: 3 headers, 1 rows
ğŸ“ Merged headers: ['Total Invoice Amount', 'Commissionable Amount', 'Commission Amount']
ğŸ“ Enhanced stitching completed: 2 final tables
INFO:app.services.extraction_utils:âœ… Merged table created: 1 rows (enhancements preserved from individual tables)
INFO:app.services.extraction_utils:Header normalization: 6 headers normalized
INFO:app.services.enhanced_extraction_service:GPT-5: Verified normalized headers
INFO:app.services.extraction_utils:Header normalization: 3 headers normalized
INFO:app.services.enhanced_extraction_service:GPT-5: Verified normalized headers
INFO:app.services.enhanced_extraction_service:ğŸ“Š Table 1 summary rows â†’ model:2 heuristic:2 final:2
INFO:app.services.enhanced_extraction_service:   â†³ Example reasoning row 11: score=1.1 reasons=['Row annotated as GroupSummary', 'Identifier columns blank', 'Matches running total of previous detail rows']
INFO:app.services.enhanced_extraction_service:ğŸ“Š Table 2 summary rows â†’ model:1 heuristic:1 final:1
INFO:app.services.enhanced_extraction_service:   â†³ Example reasoning row 0: score=0.55 reasons=['Row annotated as CarrierSummary', 'Row is mostly numeric']
INFO:app.services.enhanced_extraction_service:â­ GPT-5: Processed 3 tables into 2 tables
INFO:app.services.enhanced_extraction_service:   Cost: $0.0013
INFO:app.services.enhanced_extraction_service:   Tokens: 8952
INFO:app.services.enhanced_extraction_service:âœ… Using GPT-5's structured output summary row detection
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1763980540949_caydha1ce
INFO:app.services.conversational_summary_service:ğŸ—£ï¸ Generating conversational summary...
INFO:app.services.conversational_summary_service:ğŸ” _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'groups_and_companies', 'writing_agents', 'business_intelligence', 'summary', 'total_tokens_used', 'estimated_cost_usd', 'processing_time_seconds', 'quality_summary', 'metadata', 'extraction_quality', 'structured_data', 'extraction_pipeline']
INFO:app.services.conversational_summary_service:âœ… Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:ğŸ¯ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: []
INFO:app.services.conversational_summary_service:   - Relationships: []
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['number_of_groups', 'number_of_agents', 'total_commission', 'top_contributors']
INFO:app.services.conversational_summary_service:âœ… Using root-level groups_and_companies: 12 items
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:ğŸš€ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:ğŸš€ Calling GPT-4o API for summary generation...
INFO:app.services.conversational_summary_service:   Model: gpt-4o
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 38633 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.conversational_summary_service:ğŸ“Š Token usage - Input: 9,698, Output: 305
INFO:app.services.conversational_summary_service:âœ… GPT-4o API call successful
INFO:app.services.conversational_summary_service:âœ… Detected structured JSON response from GPT-4o
INFO:app.services.conversational_summary_service:ğŸ“Š GPT-4o provided 11 fields: ['carrier_name', 'broker_company', 'statement_date', 'broker_id', 'payment_type', 'total_amount', 'company_count', 'top_contributors', 'commission_structure', 'census_count', 'billing_periods']
INFO:app.services.conversational_summary_service:âœ… Extracted structured summary data (4 fields): ['statement_date', 'total_amount', 'company_count', 'broker_id_confidence']
INFO:app.services.conversational_summary_service:âœ… Fallback added 1 missing fields: ['broker_id_confidence']
INFO:app.services.conversational_summary_service:ğŸ“„ Generated summary length: 615 characters
INFO:app.services.conversational_summary_service:ğŸ“Š Final structured data keys: ['statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'carrier_name', 'broker_company', 'broker_id', 'payment_type', 'top_contributors', 'commission_structure', 'census_count', 'billing_periods']
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Started stage validation for upload upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Completed processing for upload upload_1763980540949_caydha1ce in 64.54 seconds
INFO:app.api.new_extract:âœ… Extraction completed successfully
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1763980540949_caydha1ce
INFO:app.api.new_extract:ğŸ” Summary row refinement adjusted table 1: [0] â†’ []
INFO:app.api.new_extract:âœ… Extraction completed (data NOT saved to DB, will be saved on approval)
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d)
INFO:app.api.new_extract:ğŸ¯ Format Learning: Using carrier Redirect Health with ID 8340174b-f6ed-42eb-976d-4868bb06c844
WARNING:app.api.new_extract:ğŸš¨ CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as Redirect Health (8340174b-f6ed-42eb-976d-4868bb06c844)
INFO:app.api.new_extract:ğŸ”„ Reassigning file to correct carrier: Redirect Health
INFO:app.services.gcs_utils:âœ… File copied in GCS: statements/fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d/2025.05.pdf -> statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:âœ… File deleted from GCS: statements/fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ” Generating signed URL for: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ“ Generating signed URL with:
INFO:app.services.gcs_utils:   - Content-Type: application/pdf
INFO:app.services.gcs_utils:   - Content-Disposition: inline
INFO:app.services.gcs_utils:   - Expiration: 1 hour(s)
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:   URL expires at: 2025-11-24 11:36:49.906028
INFO:app.api.new_extract:âœ… File moved to correct carrier folder in GCS: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.api.new_extract:âœ… Updated upload metadata: carrier_id=8340174b-f6ed-42eb-976d-4868bb06c844, company_id stays as user's company=d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.api.new_extract:ğŸ” Multiple tables detected (2), analyzing for field mapping suitability
INFO:app.api.new_extract:   Table 0: type=, rows=14, score=79
INFO:app.api.new_extract:   Table 1: type=, rows=1, score=61
INFO:app.api.new_extract:ğŸ¯ INTELLIGENT SELECTION: Using table 0 for field mapping
INFO:app.api.new_extract:   Reasoning: Selected table 0 (table_type=, rows=14, commission_headers=3, score=79)
INFO:app.api.new_extract:ğŸ¯ Using table 0 for field mapping with 6 headers
ğŸ¯ FormatLearningService: Finding matching format for company 8340174b-f6ed-42eb-976d-4868bb06c844
ğŸ¯ FormatLearningService: Headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
ğŸ¯ FormatLearningService: Table structure: {'row_count': 14, 'column_count': 6, 'has_financial_data': True}
ğŸ¯ FormatLearningService: Headers type: <class 'list'>
ğŸ¯ FormatLearningService: Headers length: 6
ğŸ¯ CRUD: Finding best matching format for company 8340174b-f6ed-42eb-976d-4868bb06c844
ğŸ¯ CRUD: Input headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
ğŸ¯ CRUD: Input table structure: {'row_count': 14, 'column_count': 6, 'has_financial_data': True}
INFO:app.services.orphan_cleanup_service:ğŸ§¹ Starting orphan cleanup job...
INFO:     10.219.18.220:50702 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.220:50700 - "GET /health HTTP/1.1" 200 OK
ğŸ¯ CRUD: Found 1 saved formats for company
ğŸ¯ CRUD: Comparing with saved format:
ğŸ¯ CRUD:   Saved headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
ğŸ¯ CRUD:   Header similarity: 0.8
ğŸ¯ CRUD:   Structure similarity: 1.0
ğŸ¯ CRUD:   Total score: 0.8400000000000001
ğŸ¯ CRUD:   -> New best match with score 0.8400000000000001
ğŸ¯ FormatLearningService: Best match score: 0.8400000000000001
ğŸ¯ FormatLearningService: Found matching format with signature: f0d2424f7efd76c2fcfb224d0246d1f1
ğŸ¯ FormatLearningService: Learned field mapping: {'Group ID': 'Policy Number', 'Comm. Rate': 'Commission Rate', 'Group Name': 'Client Name', 'Invoice Amount': 'Premium Total', 'Commission Amount': 'Commission Earned', 'Commissionable Amount': 'Invoice Total'}
ğŸ¯ FormatLearningService: Learned table editor settings: {'headers': ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount'], 'summary_rows': [], 'corrected_carrier_name': '', 'corrected_statement_date': '2025-05-31', 'user_corrections': {'carrier_name': '', 'statement_date': '2025-05-31'}}
INFO:app.api.new_extract:ğŸ¯ Format Learning: Found matching format with score 0.8400000000000001
INFO:app.api.new_extract:ğŸ¯ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:âœ… Total extracted from document_metadata: $4861.56
WARNING:app.api.new_extract:âš ï¸ Replacing total_amount 4861.56 (method=document_metadata) with summary_row_scan=75202.00
INFO:app.api.new_extract:ğŸ¯ Format Learning: Total validation result: {'matches': False, 'difference': None, 'difference_percent': None, 'status': 'no_comparison', 'reason': 'Missing total amount for comparison'}
INFO:app.api.new_extract:ğŸ“Š Added total to document_metadata: $75202.00 (method: summary_row_scan)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763980540949_caydha1ce
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:ğŸ” AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:âœ… AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763980540949_caydha1ce
INFO:app.api.new_extract:ğŸ§  AI Field Mapping: Starting field mapping during extraction
INFO:app.api.new_extract:ğŸ“‹ Normalizing headers for AI mapping:
INFO:app.api.ai_intelligent_mapping:ğŸš€ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ğŸ¤– AI Mapping: Analyzing 6 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:ğŸ” AI Mapping: carrier_id provided: True (value: 8340174b-f6ed-42eb-976d-4868bb06c844)
INFO:     10.219.18.220:47966 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.ai_field_mapping_service:ğŸ¯ Carrier ID is valid, attempting to retrieve learned mapping for carrier 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.services.ai_field_mapping_service:ğŸ” Generated format signature for lookup: f0d2424f7efd76c2fcfb224d0246d1f1
INFO:app.services.ai_field_mapping_service:ğŸ” Looking up learned format for carrier 8340174b-f6ed-42eb-976d-4868bb06c844 with 6 headers
INFO:app.services.orphan_cleanup_service:âœ… Orphan cleanup completed: no orphans found
INFO:app.services.ai_field_mapping_service:âœ… Found EXACT match for learned format with signature f0d2424f7efd76c2fcfb224d0246d1f1
INFO:app.services.ai_field_mapping_service:âœ… Learned field mapping has 6 mappings
INFO:app.services.ai_field_mapping_service:ğŸ¯ Found learned mapping for carrier with 1.00 confidence
INFO:app.services.ai_field_mapping_service:ğŸ¯ Using learned mappings directly with match score 1.0
INFO:app.services.ai_field_mapping_service:âœ… Learned field_mapping contains 6 mappings
INFO:app.services.ai_field_mapping_service:âœ… Applied 6 learned mappings directly - returning early
INFO:app.services.ai_field_mapping_service:âœ… Response includes learned_format_used=True flag
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:âœ… Enhanced AI Analysis Complete: Overall confidence 0.93
INFO:app.api.new_extract:âœ… AI Field Mapping: 6 mappings with sample data, confidence 0.95
INFO:app.api.new_extract:âœ… Conversational summary supplied by extraction pipeline
INFO:app.api.new_extract:   Summary preview: This is a commission statement from Redirect Health for Innovative BPS LLC, dated May 31, 2025. The document reports a total of $4,861.56 in commissions across 14 groups, with Alcala Logistics leading
INFO:app.api.new_extract:   Structured data keys: ['statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'carrier_name', 'broker_company', 'broker_id', 'payment_type', 'top_contributors', 'commission_structure', 'census_count', 'billing_periods']
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d)
INFO:app.api.new_extract:ğŸ“¤ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:ğŸ“Š Sending structured data: {"statement_date": "2025-05-31", "total_amount": "4861.56", "company_count": 14, "broker_id_confidence": 0.7, "carrier_name": "Redirect Health", "broker_company": "Innovative BPS LLC", "broker_id": nu...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763980540949_caydha1ce
INFO:app.api.new_extract:ğŸ“Š Calculating invoice total from 2 tables
INFO:app.api.new_extract:ğŸ“Š Table 0: Found invoice column at index 2: 'Invoice Amount'
INFO:app.api.new_extract:âœ… Table 0: Calculated from rows: $164,292.00
INFO:app.api.new_extract:ğŸ“Š Table 1: Found invoice column at index 0: 'Total Invoice Amount'
INFO:app.api.new_extract:âœ… Table 1: Calculated from rows: $70,498.00
INFO:app.api.new_extract:âœ… TOTAL invoice amount from all tables: $234,790.00
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980540949_caydha1ce: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980540949_caydha1ce
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763980540949_caydha1ce
INFO:app.api.new_extract:âœ… Extraction complete! Sent results via WebSocket for upload_id: upload_1763980540949_caydha1ce
INFO:     10.219.18.220:47974 - "GET /health HTTP/1.1" 200 OK
INFO:     10.20.245.226:34518 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
     [POST]200commission-tracker-1.onrender.com/api/extract-tables-smart/clientIP="86.50.75.139" requestID="3ccb90a0-2ace-4bb8" responseTimeMS=79207 responseBytes=6669 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
     [OPTIONS]200commission-tracker-1.onrender.com/api/auto-approve/process-liteclientIP="86.50.75.139" requestID="c546fa03-7415-40e9" responseTimeMS=2 responseBytes=920 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:     10.20.245.226:34518 - "OPTIONS /api/auto-approve/process-lite HTTP/1.1" 200 OK
INFO:app.api.auto_approval:Auto-approval started for upload fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.services.websocket_service:Broadcasting message to upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.services.websocket_service:Broadcasting message to upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.services.websocket_service:Broadcasting message to upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.api.auto_approval:ğŸ” Auto-approval: Filtered 2 tables to 2 commission tables for saving
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Raw field_mapping from learned format: {'Group ID': 'Policy Number', 'Comm. Rate': 'Commission Rate', 'Group Name': 'Client Name', 'Invoice Amount': 'Premium Total', 'Commission Amount': 'Commission Earned', 'Commissionable Amount': 'Invoice Total'}
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Using 6 field mappings from learned format
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Field config list: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saving edited tables for upload_id: fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Tables count: 2
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Selected statement date: {'date': '2025-05-31'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Company ID (deprecated): 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Carrier ID: None
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Field config received: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Converted 2 tables to database format
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Updating upload with tables, statement date, and carrier
ğŸ¯ CRUD: update_upload_tables called for upload_id: fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
ğŸ¯ CRUD: Tables data length: 2
ğŸ¯ CRUD: Selected statement date: {'date': '2025-05-31'}
ğŸ¯ CRUD: Carrier ID: None
ğŸ¯ CRUD: Upload not found for ID: fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:ğŸ¯ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully saved 2 edited tables
INFO:app.services.websocket_service:Broadcasting message to upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763980540949_caydha1ce, session_id=session_1763980540959_kchp43sfm
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763980540949_caydha1ce, session_id=session_1763980540959_kchp43sfm
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763980540949_caydha1ce
INFO:app.api.auto_approval:Updated format learning usage count for signature: f0d2424f7efd76c2fcfb224d0246d1f1
INFO:app.services.websocket_service:Broadcasting message to upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.db.crud.statement_upload:âœ… Saving statement review for upload fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d with valid status: Approved
INFO:app.db.crud.statement_upload:ğŸ’¾ Upload not found for ID: fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d - This is unexpected for remap flow
WARNING:app.db.crud.statement_upload:âš ï¸ Statement fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d should already exist in database for remap operation
INFO:app.db.crud.statement_upload:âœ… All required fields present, proceeding with record creation
INFO:app.db.crud.statement_upload:âœ… Using user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191 (from current_user_id)
INFO:app.db.crud.statement_upload:âœ… Retrieved user's company_id d883a865-a54f-41d6-968e-f94c3cb3f589 from users table for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.db.crud.environment:âœ… Found existing default environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 for user f6cf1764-5bfc-4352-abd9-81b72b7cf191 in company d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.db.crud.statement_upload:âœ… ALWAYS using user's default environment_id 9f4a7a57-5715-4b1e-98a9-b9901726a485 for consistency
INFO:app.db.crud.statement_upload:âœ… Created new DB record for upload fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.db.crud.statement_upload:=== REMAP DEBUG ===
INFO:app.db.crud.statement_upload:ğŸ’¾ Saving statement review: upload_id=fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d, status=Approved
INFO:app.db.crud.statement_upload:ğŸ“‹ Field config being saved: 6 fields
INFO:app.db.crud.statement_upload:ğŸ“Š Final data tables: 2
INFO:app.db.crud.statement_upload:ğŸ“… Selected statement date: {'date': '2025-05-31'}
INFO:app.db.crud.statement_upload:===================
ğŸ’¾ Saving statement review: upload_id=fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d, status=Approved
ğŸ“‹ Field config being saved: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ“Š Final data rows: 2
ğŸ“… Selected statement date being saved: {'date': '2025-05-31'}
ğŸ” DEBUG Saving table 0 'Table 1': summaryRows=[11, 13], type=<class 'list'>
ğŸ” DEBUG Saving table 1 'Table 2': summaryRows=[], type=<class 'list'>
ğŸ“ Extracted field_mapping with 6 mappings: {'Group ID': 'Policy Number', 'Comm. Rate': 'Commission Rate', 'Group Name': 'Client Name', 'Invoice Amount': 'Premium Total', 'Commission Amount': 'Commission Earned', 'Commissionable Amount': 'Invoice Total'}
ğŸ’° Calculating extracted_total for manual approval...
ğŸ’° field_mapping keys: ['Group ID', 'Comm. Rate', 'Group Name', 'Invoice Amount', 'Commission Amount', 'Commissionable Amount']
ğŸ’° Number of tables in final_data: 2
ğŸ’° Found commission field (EXACT MATCH): Commission Amount -> Commission Earned
ğŸ’° Final commission_source_field: Commission Amount
  ğŸ“Š Table 0: 6 headers, 14 rows
  ğŸ“‹ Headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
  ğŸ“‹ First row sample: ['G-RDA012300075', 'CG23 Logistics', '$5,824.00', '$5,264.00', '2.00%', '$105.28']
  ğŸ’° Table 0: Commission column 'Commission Amount' at index 5
    Row 0: [LIST] raw_value = '$105.28' (type: <class 'str'>)
    Row 0: Added $105.28 (running total: $105.28)
    Row 1: [LIST] raw_value = '$753.84' (type: <class 'str'>)
    Row 1: Added $753.84 (running total: $859.12)
    Row 2: [LIST] raw_value = '$361.68' (type: <class 'str'>)
    Row 2: Added $361.68 (running total: $1220.80)
    Row 3: [LIST] raw_value = '$60.90' (type: <class 'str'>)
    Row 3: Added $60.90 (running total: $1281.70)
    Row 4: [LIST] raw_value = '$379.32' (type: <class 'str'>)
    Row 4: Added $379.32 (running total: $1661.02)
    Row 5: [LIST] raw_value = '$246.18' (type: <class 'str'>)
    Row 5: Added $246.18 (running total: $1907.20)
    Row 6: [LIST] raw_value = '$315.84' (type: <class 'str'>)
    Row 6: Added $315.84 (running total: $2223.04)
    Row 7: [LIST] raw_value = '$361.68' (type: <class 'str'>)
    Row 7: Added $361.68 (running total: $2584.72)
    Row 8: [LIST] raw_value = '$692.88' (type: <class 'str'>)
    Row 8: Added $692.88 (running total: $3277.60)
    Row 9: [LIST] raw_value = '$438.60' (type: <class 'str'>)
    Row 9: Added $438.60 (running total: $3716.20)
    Row 10: [LIST] raw_value = '$585.36' (type: <class 'str'>)
    Row 10: Added $585.36 (running total: $4301.56)
    Row 11: SKIPPED (summary row)
    Row 12: [LIST] raw_value = '$560.00' (type: <class 'str'>)
    Row 12: Added $560.00 (running total: $4861.56)
    Row 13: SKIPPED (summary row)
  âœ… Table 0 total: $4861.56
  ğŸ“Š Table 1: 3 headers, 1 rows
  ğŸ“‹ Headers: ['Total Invoice Amount', 'Commissionable Amount', 'Commission Amount']
  ğŸ“‹ First row sample: ['$70,498.00', '$70,498.00', '$4,861.56']
  ğŸ’° Table 1: Commission column 'Commission Amount' at index 2
    Row 0: [LIST] raw_value = '$4,861.56' (type: <class 'str'>)
    Row 0: Added $4861.56 (running total: $9723.12)
  âœ… Table 1 total: $4861.56
ğŸ’° AI-extracted total from document: $75202.00
ğŸ’° Total comparison:
   - AI extracted from document: $75202.00
   - Calculated from table rows: $9723.12
   - Difference: $65478.88 (87.07%)
   - Match: False
âš ï¸ TOTAL MISMATCH DETECTED! Changing status from 'Approved' to 'needs_review'
ğŸ’° Final extracted_total: $9723.12
âœ… Set extracted_total=75202.0 (AI-extracted), calculated_total=9723.12, total_amount_match=False
INFO:app.services.user_profile_service:Recorded contribution: approval for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.review:âœ… User contribution recorded for needs_review statement fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.api.auto_approval:ğŸ“Š Priority 1: Using total from document_metadata: $75,202.00
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Found PRIMARY commission field: 'Commission Amount' (mapped to 'Commission Earned')
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Calculating total from 2 table(s)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table 0: Found 6 headers
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Commission field 'Commission Amount' found at index 5
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table has 14 rows, 2 summary rows to skip
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 12 data rows from table 0
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table 1: Found 3 headers
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Commission field 'Commission Amount' found at index 2
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table has 1 rows, 0 summary rows to skip
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 1 data rows from table 1
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Found invoice field (exact match): 'Commissionable Amount' (mapped to 'Invoice Total')
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Calculating invoice total from 2 table(s)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Invoice field 'Commissionable Amount' found at index 3
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 12 invoice rows from table 0
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Invoice field 'Commissionable Amount' found at index 1
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 1 invoice rows from table 1
INFO:app.api.auto_approval:ğŸ“Š Total validation:
INFO:app.api.auto_approval:  - Extracted from file: $75202.00
INFO:app.api.auto_approval:  - Calculated from table: $9723.12
INFO:app.api.auto_approval:  - Invoice total calculated: $151524.00
INFO:app.api.auto_approval:  - Difference: $65,478.88 (87.07%)
INFO:app.api.auto_approval:  - Match: False
WARNING:app.api.auto_approval:âš ï¸ Auto-approval: Totals don't match, setting status to 'needs_review' for manual review
INFO:     10.219.18.220:44926 - "GET /health HTTP/1.1" 200 OK
INFO:app.api.auto_approval:âœ… Updated DB record with auto-approval metadata
INFO:app.api.auto_approval:âš ï¸ Auto-approval: Status is 'needs_review', skipping commission data processing
     [GET]commission-tracker-1.onrender.com/api/ws/progress/upload_1763980540949_caydha1ce?session_id=session_1763980540959_kchp43sfmclientIP="86.50.75.139" requestID="" responseTimeMS=81579 responseBytes=0 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:app.services.user_profile_service:Recorded contribution: auto_approval for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.auto_approval:âœ… User contribution recorded for auto-approved statement fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.services.websocket_service:Broadcasting message to upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:app.api.auto_approval:Auto-approval completed for upload fabc89d8-b4ce-4d52-8ebb-9dfb0fa39c9d
INFO:     10.20.245.226:34518 - "POST /api/auto-approve/process-lite HTTP/1.1" 200 OK
     [POST]200commission-tracker-1.onrender.com/api/auto-approve/process-liteclientIP="86.50.75.139" requestID="f1e8c37a-6ef3-4aea" responseTimeMS=2176 responseBytes=1099 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:     10.20.245.226:34518 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     10.21.101.173:37174 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
     [GET]200commission-tracker-1.onrender.com/api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485clientIP="86.50.75.139" requestID="75955324-06e3-45e7" responseTimeMS=689 responseBytes=1140 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:     10.20.245.226:34518 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
     [GET]200commission-tracker-1.onrender.com/api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485clientIP="86.50.75.139" requestID="fa41da67-f7c4-41e2" responseTimeMS=737 responseBytes=1062 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:     10.219.18.220:44934 - "GET /health HTTP/1.1" 200 OK
     [GET]200commission-tracker-1.onrender.com/api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485clientIP="86.50.75.139" requestID="eac2aa9e-81e2-44bf" responseTimeMS=704 responseBytes=1062 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
