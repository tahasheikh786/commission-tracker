
INFO:app.api.new_extract:üìä Single table detected, using it for field mapping
INFO:app.api.new_extract:üéØ Using table 0 for field mapping with 10 headers
üéØ FormatLearningService: Finding matching format for company 5c9324ac-1794-4563-8e0e-8cd5c5317181
üéØ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ FormatLearningService: Table structure: {'row_count': 57, 'column_count': 10, 'has_financial_data': True}
üéØ FormatLearningService: Headers type: <class 'list'>
üéØ FormatLearningService: Headers length: 10
üéØ CRUD: Finding best matching format for company 5c9324ac-1794-4563-8e0e-8cd5c5317181
üéØ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD: Input table structure: {'row_count': 57, 'column_count': 10, 'has_financial_data': True}
üéØ CRUD: Found 1 saved formats for company
üéØ CRUD: Comparing with saved format:
üéØ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD:   Header similarity: 0.7200000000000001
üéØ CRUD:   Structure similarity: 1.0
üéØ CRUD:   Total score: 0.776
üéØ CRUD:   -> New best match with score 0.776
üéØ FormatLearningService: Best match score: 0.776
üéØ FormatLearningService: Found matching format with signature: 434609905947a9e8728df0b79ba381ce
üéØ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üéØ FormatLearningService: Learned table editor settings: {'carrier_name': 'ALLIED', 'corrected_carrier_name': 'ALLIED', 'statement_date': '2025-01-08', 'corrected_statement_date': '2025-01-08', 'statement_total_amount': 9336.9, 'total_amount_field_name': 'Invoice Total'}
INFO:app.api.new_extract:üéØ Format Learning: Found matching format with score 0.776
INFO:app.api.new_extract:üéØ Format Learning: Applying corrected carrier name from learned format: ALLIED
INFO:app.api.new_extract:üéØ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:‚úÖ Total extracted from document_metadata: $386.61
WARNING:app.api.new_extract:‚ö†Ô∏è Replacing total_amount 386.61 (method=document_metadata) with summary_row_scan=3604.95
INFO:app.api.new_extract:üéØ Format Learning: Total validation result: {'matches': False, 'extracted_amount': 3604.95, 'learned_amount': 9336.9, 'difference': 5731.95, 'difference_percent': 61.39, 'status': 'mismatch', 'tolerance_percent': 5.0}
INFO:app.api.new_extract:üìä Added total to document_metadata: $3604.95 (method: summary_row_scan)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763738587282_nqe0mpn5u: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:üîç AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:‚úÖ AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763738587282_nqe0mpn5u: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.api.new_extract:üß† AI Field Mapping: Starting field mapping during extraction
INFO:app.api.new_extract:üìã Normalizing headers for AI mapping:
INFO:app.api.ai_intelligent_mapping:üöÄ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ü§ñ AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:üîç AI Mapping: carrier_id provided: True (value: 5c9324ac-1794-4563-8e0e-8cd5c5317181)
INFO:     10.219.18.238:50110 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.ai_field_mapping_service:üéØ Carrier ID is valid, attempting to retrieve learned mapping for carrier 5c9324ac-1794-4563-8e0e-8cd5c5317181
INFO:app.services.ai_field_mapping_service:üîç Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:üîç Looking up learned format for carrier 5c9324ac-1794-4563-8e0e-8cd5c5317181 with 10 headers
INFO:app.services.ai_field_mapping_service:‚ùå No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:üîç Found 1 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:üîç Format signature 434609905947a9e8728df0b79ba381ce: similarity = 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ New best match with similarity 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ Found similar format with 0.72 similarity score
INFO:app.services.ai_field_mapping_service:üéØ Found learned mapping for carrier with 0.72 confidence
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:‚úÖ AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:‚úÖ AI Mapping: Generated 10 mappings with 0.89 confidence
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:     10.219.18.238:53646 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:53648 - "GET /health HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.85 confidence
INFO:app.api.ai_intelligent_mapping:‚úÖ Enhanced AI Analysis Complete: Overall confidence 0.87
INFO:app.api.new_extract:‚úÖ AI Field Mapping: 10 mappings with sample data, confidence 0.89
INFO:app.api.new_extract:‚úÖ Conversational summary supplied by extraction pipeline
INFO:app.api.new_extract:   Summary preview: This is a commission payment summary from Allied for INNOVATIVE BPS LLC, dated August 6, 2025. The document outlines $107,995.80 in total commissions across 57 groups, with PRIDE DELIVERY SERVIC leadi
INFO:app.api.new_extract:   Structured data keys: ['statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'census_count', 'billing_periods', 'carrier_name', 'broker_company', 'broker_id', 'payment_type', 'top_contributors', 'commission_structure']
INFO:app.api.new_extract:üîß Transformed summary_rows to summaryRows for table: [2, 5, 11, 12, 13, 14, 22, 24, 43, 51, 55, 56]
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: e4f76ff4-6270-41f9-b80c-8798e523653d)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {"statement_date": "2025-08-06", "total_amount": "107995.80", "company_count": 57, "broker_id_confidence": 0.7, "census_count": null, "billing_periods": "July-August 2025", "carrier_name": "ALLIED", "...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763738587282_nqe0mpn5u: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763738587282_nqe0mpn5u: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.api.new_extract:üìä Calculating invoice total from 1 tables
INFO:app.api.new_extract:üìä Table 0: Found invoice column at index 4: 'Invoice Total'
INFO:app.api.new_extract:‚úÖ Table 0: Extracted from summary row: $443.10
INFO:app.api.new_extract:‚úÖ TOTAL invoice amount from all tables: $443.10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763738587282_nqe0mpn5u: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763738587282_nqe0mpn5u: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763738587282_nqe0mpn5u
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1763738587282_nqe0mpn5u
INFO:     10.219.18.238:53654 - "GET /health HTTP/1.1" 200 OK
INFO:     10.20.174.248:41710 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     10.20.174.248:41710 - "OPTIONS /api/auto-approve/process HTTP/1.1" 200 OK
     [POST]200commission-tracker-1.onrender.com/api/extract-tables-smart/clientIP="86.50.75.139" requestID="c70b3f42-a4dc-493c" responseTimeMS=272547 responseBytes=9764 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
     [OPTIONS]200commission-tracker-1.onrender.com/api/auto-approve/processclientIP="86.50.75.139" requestID="fe5ba1bc-cca5-417a" responseTimeMS=4 responseBytes=920 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:     10.219.18.238:53666 - "GET /health HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763738587282_nqe0mpn5u, session_id=session_1763738587287_ukl3de7cg
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763738587282_nqe0mpn5u, session_id=session_1763738587287_ukl3de7cg
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763738587282_nqe0mpn5u
     [POST]502commission-tracker-1.onrender.com/api/auto-approve/processclientIP="86.50.75.139" requestID="f77e6802-41e8-4b2f" responseTimeMS=19 responseBytes=223158 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:app.api.pdf_proxy:üîÑ Proxying PDF from: https://storage.googleapis.com/pdf_extraction_files_saver/statements/5c9324ac-1794-4563-8e0e-8cd5c53...
     [GET]502commission-tracker-1.onrender.com/api/pending/progress/e4f76ff4-6270-41f9-b80c-8798e523653d/table_editorclientIP="86.50.75.139" requestID="84c6a3dc-cf5c-4d3f" responseTimeMS=16 responseBytes=223158 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:httpx:HTTP Request: GET https://storage.googleapis.com/pdf_extraction_files_saver/statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/08.06.2025%20Allied%20Innovative%20Payment%202.pdf?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=docsai-table-extractor%40pdf-tables-extractor-465009.iam.gserviceaccount.com%2F20251121%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20251121T152700Z&X-Goog-Expires=3599&X-Goog-SignedHeaders=host&response-content-disposition=inline&response-content-type=application%2Fpdf&X-Goog-Signature=91c41e530767032b0c7eb2b279666cb2d0afbef386fe2d03946221ec87944787c1397cc36dc87f62f132d7b246f957f0e99a073609c614ee6b7bfaabb32cf95833ed1a7c0cc5e2b74edf5fbb9873a374c3ec84153d62b3b8fc08b5ff341ecf194c7dea50cf67273efb7828042530e542443f9bc15368a6bb9af7bb2a77c04fa346a26e723e008a54351920efae1837c47d8a3f88ac9f7934d1f806991890859437fb83e558e8e3a5a9e44a5b99bf49fe02e7608152da53f8be6f2812b070f2b8190891321cebe33966002ce0ac7d15e0eb49698565f349af8bd417dedbe7d5487312aaca1746a0ea5fc53b0b6847194d0bbd11bb73d0cfbdab57d461d356614b "HTTP/1.1 200 OK"
INFO:     10.20.148.164:59946 - "GET /api/pdf-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fpdf_extraction_files_saver%2Fstatements%2F5c9324ac-1794-4563-8e0e-8cd5c5317181%2F08.06.2025%2520Allied%2520Innovative%2520Payment%25202.pdf%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Ddocsai-table-extractor%2540pdf-tables-extractor-465009.iam.gserviceaccount.com%252F20251121%252Fauto%252Fstorage%252Fgoog4_request%26X-Goog-Date%3D20251121T152700Z%26X-Goog-Expires%3D3599%26X-Goog-SignedHeaders%3Dhost%26response-content-disposition%3Dinline%26response-content-type%3Dapplication%252Fpdf%26X-Goog-Signature%3D91c41e530767032b0c7eb2b279666cb2d0afbef386fe2d03946221ec87944787c1397cc36dc87f62f132d7b246f957f0e99a073609c614ee6b7bfaabb32cf95833ed1a7c0cc5e2b74edf5fbb9873a374c3ec84153d62b3b8fc08b5ff341ecf194c7dea50cf67273efb7828042530e542443f9bc15368a6bb9af7bb2a77c04fa346a26e723e008a54351920efae1837c47d8a3f88ac9f7934d1f806991890859437fb83e558e8e3a5a9e44a5b99bf49fe02e7608152da53f8be6f2812b070f2b8190891321cebe33966002ce0ac7d15e0eb49698565f349af8bd417dedbe7d5487312aaca1746a0ea5fc53b0b6847194d0bbd11bb73d0cfbdab57d461d356614b HTTP/1.1" 200 OK
     [GET]commission-tracker-1.onrender.com/api/ws/progress/upload_1763738587282_nqe0mpn5u?session_id=session_1763738587287_ukl3de7cgclientIP="86.50.75.139" requestID="" responseTimeMS=274839 responseBytes=0 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
     [GET]200commission-tracker-1.onrender.com/api/pdf-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fpdf_extraction_files_saver%2Fstatements%2F5c9324ac-1794-4563-8e0e-8cd5c5317181%2F08.06.2025%2520Allied%2520Innovative%2520Payment%25202.pdf%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Ddocsai-table-extractor%2540pdf-tables-extractor-465009.iam.gserviceaccount.com%252F20251121%252Fauto%252Fstorage%252Fgoog4_request%26X-Goog-Date%3D20251121T152700Z%26X-Goog-Expires%3D3599%26X-Goog-SignedHeaders%3Dhost%26response-content-disposition%3Dinline%26response-content-type%3Dapplication%252Fpdf%26X-Goog-Signature%3D91c41e530767032b0c7eb2b279666cb2d0afbef386fe2d03946221ec87944787c1397cc36dc87f62f132d7b246f957f0e99a073609c614ee6b7bfaabb32cf95833ed1a7c0cc5e2b74edf5fbb9873a374c3ec84153d62b3b8fc08b5ff341ecf194c7dea50cf67273efb7828042530e542443f9bc15368a6bb9af7bb2a77c04fa346a26e723e008a54351920efae1837c47d8a3f88ac9f7934d1f806991890859437fb83e558e8e3a5a9e44a5b99bf49fe02e7608152da53f8be6f2812b070f2b8190891321cebe33966002ce0ac7d15e0eb49698565f349af8bd417dedbe7d5487312aaca1746a0ea5fc53b0b6847194d0bbd11bb73d0cfbdab57d461d356614bclientIP="86.50.75.139" requestID="80ce430d-03a5-4101" responseTimeMS=173 responseBytes=228347 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:     10.219.18.238:40596 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:40598 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:38388 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:38390 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:38406 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:57670 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:57674 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:42040 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:42046 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:58264 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:58262 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:58284 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:46048 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:46052 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:46052 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:41670 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:41682 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:51256 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:51254 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:51280 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:40180 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:40192 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:52236 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:52240 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:43770 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:43772 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:43780 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:57620 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:57632 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:56872 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:56888 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:53448 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:53450 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:53478 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:59436 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:59442 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:49922 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:49924 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:54634 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:54642 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:54644 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:57780 - "GET /health HTTP/1.1" 200 OK
INFO:app.main:Cleaned up 500 expired/inactive sessions
INFO:     10.219.18.238:57792 - "GET /health HTTP/1.1" 200 OK
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:     10.219.18.238:47626 - "GET /health HTTP/1.1" 200 OK
INFO:     10.219.18.238:47634 - "GET /health HTTP/1.1" 200 OK
