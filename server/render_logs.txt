NFO:app.services.enhanced_extraction_service:üì° Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.enhanced_extraction_service:‚úÖ Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:üì° Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/01.13.25 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.claude.service:Standard file (37 pages, 0.31MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763051002294_jwtsotx3w
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763051002294_jwtsotx3w: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763051002294_jwtsotx3w
INFO:app.services.claude.dynamic_prompts:No carrier name provided, using standard prompt only
INFO:app.services.claude.service:üìã No carrier-specific prompt for 'None', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 125,488 (37 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded: 122,877 current + 125,488 new = 248,365 tokens (limit: 25,500). Waiting 61.61s for token bucket reset.
     [GET]500commission-tracker-1.onrender.com/api/ws/progress/upload_1763051096023_vy8kr6nkq?session_id=session_1763051096027_xr8849rjuclientIP="107.219.95.113" requestID="" responseTimeMS=30000 responseBytes=145 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
     [GET]commission-tracker-1.onrender.com/api/ws/progress/upload_1763051002294_jwtsotx3w?session_id=session_1763051002304_frtnm76q3clientIP="86.50.74.174" requestID="" responseTimeMS=127378 responseBytes=0 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
     [GET]500commission-tracker-1.onrender.com/api/ws/progress/upload_1763051002294_jwtsotx3w?session_id=session_1763051131335_gcicy67asclientIP="86.50.74.174" requestID="" responseTimeMS=1 responseBytes=145 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
     [GET]500commission-tracker-1.onrender.com/api/ws/progress/upload_1763051002294_jwtsotx3w?session_id=session_1763051134092_j8y9oz0exclientIP="86.50.74.174" requestID="" responseTimeMS=2 responseBytes=145 userAgent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36"
INFO:app.services.claude.utils:‚úÖ Token bucket forcefully reset. Proceeding with 125,488 tokens.
INFO:app.services.claude.utils:üìä Rate limit status: 2/50 RPM, 125,488/25,500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 61.62s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:     Shutting down
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
INFO:     connection closed
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
INFO:app.api.websocket:Received unknown message type: heartbeat
ERROR:app.services.websocket_service:Error sending personal message: 
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763051002294_jwtsotx3w, session_id=session_1763051002304_frtnm76q3
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763051096023_vy8kr6nkq. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763051096023_vy8kr6nkq, session_id: session_1763051096027_xr8849rju
INFO:     10.20.229.134:35996 - "WebSocket /api/ws/progress/upload_1763051096023_vy8kr6nkq?session_id=session_1763051096027_xr8849rju" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763051096023_vy8kr6nkq, session_id=session_1763051096027_xr8849rju, timeout=1800s
INFO:     connection closed
ERROR:app.services.websocket_service:Error sending personal message: 
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763051096023_vy8kr6nkq, session_id=session_1763051096027_xr8849rju
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763051096023_vy8kr6nkq, session_id: session_1763051096027_xr8849rju
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763051096023_vy8kr6nkq
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
INFO:     10.219.19.14:45012 - "GET /health HTTP/1.1" 200 OK
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.
ERROR:app.api.websocket:Error handling WebSocket message: WebSocket is not connected. Need to call "accept" first.