INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
WARNING:app.services.gpt.vision_extractor:‚ö†Ô∏è Response incomplete/truncated at 6000 tokens. Retrying with 10000 tokens (attempt 1/2).
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:üìä Response length: 17657 characters
INFO:app.services.gpt.vision_extractor:‚úÖ Extraction complete: 3 tables, 15454 tokens, $0.0023
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.gpt.vision_extractor:üì§ Uploading PDF: /var/folders/2g/bqpglbdx7xd0zlkzpbb60nqc0000gn/T/tmp8u1o22vn.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/files "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:‚úÖ PDF uploaded: file-QAt4u8EGW8qTzzXjnHnqB3
INFO:app.services.gpt.dynamic_prompts:üîç GPT: Looking up carrier prompt: 'Pinecrestconsulting' ‚Üí normalized: 'pinecrestconsulting'
INFO:app.services.gpt.dynamic_prompts:‚ùå No carrier-specific prompt found for 'Pinecrestconsulting', using standard prompt only
INFO:app.services.gpt.dynamic_prompts:   Available carriers: ['UnitedHealthcare', 'United Healthcare', 'UHC', 'United Health Group', 'UnitedHealth', 'Redirect Health', 'breckpoint', 'Breckpoint']
INFO:app.services.gpt.vision_extractor:üéØ Added total location guidance for carrier: Pinecrestconsulting
INFO:app.services.gpt.vision_extractor:üìã Extracting from PDF using Responses API (file_id: file-QAt4u8EGW8qTzzXjnHnqB3)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
WARNING:app.services.gpt.vision_extractor:‚ö†Ô∏è Response incomplete/truncated at 6000 tokens. Retrying with 10000 tokens (attempt 1/2).
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:üìä Response length: 12341 characters
INFO:app.services.gpt.vision_extractor:‚úÖ Extraction complete: 1 tables, 13345 tokens, $0.0021
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.gpt.vision_extractor:üì§ Uploading PDF: /var/folders/2g/bqpglbdx7xd0zlkzpbb60nqc0000gn/T/tmppabtz7_e.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/files "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:‚úÖ PDF uploaded: file-47A8FsWJQo4ub4naJpRtoa
INFO:app.services.gpt.dynamic_prompts:üîç GPT: Looking up carrier prompt: 'Pinecrestconsulting' ‚Üí normalized: 'pinecrestconsulting'
INFO:app.services.gpt.dynamic_prompts:‚ùå No carrier-specific prompt found for 'Pinecrestconsulting', using standard prompt only
INFO:app.services.gpt.dynamic_prompts:   Available carriers: ['UnitedHealthcare', 'United Healthcare', 'UHC', 'United Health Group', 'UnitedHealth', 'Redirect Health', 'breckpoint', 'Breckpoint']
INFO:app.services.gpt.vision_extractor:üéØ Added total location guidance for carrier: Pinecrestconsulting
INFO:app.services.gpt.vision_extractor:üìã Extracting from PDF using Responses API (file_id: file-47A8FsWJQo4ub4naJpRtoa)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/responses "HTTP/1.1 200 OK"
INFO:app.services.gpt.vision_extractor:üìä Response length: 5960 characters
INFO:app.services.gpt.vision_extractor:‚úÖ Extraction complete: 1 tables, 9169 tokens, $0.0015
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.gpt.vision_extractor:‚úÖ Document processing complete: 5 tables, $0.0000
INFO:app.services.gpt.monitoring:‚úÖ Extraction success | upload_id=upload_1764016978 | pages=1 | tokens=37968 | cost=$0.0060 | time=401.89s
INFO:app.services.gpt.enhanced_service:‚úÖ Extraction complete: 5 tables, $0.0060, 401.89s
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚úÖ GPT-5 VISION SERVICE COMPLETED SUCCESSFULLY
INFO:app.services.enhanced_extraction_service:   Success: True
INFO:app.services.enhanced_extraction_service:   Tables Extracted: 5
INFO:app.services.enhanced_extraction_service:   Tokens Used: 37968
INFO:app.services.enhanced_extraction_service:   Cost: $0.0060
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚ö° Transforming GPT-5 Vision results to compatible format
INFO:app.services.enhanced_extraction_service:üìä GPT-5 extraction results:
INFO:app.services.enhanced_extraction_service:   - Tables: 5
INFO:app.services.enhanced_extraction_service:   - Groups/Companies: 13
INFO:app.services.enhanced_extraction_service:   - Writing Agents: 3
INFO:app.services.enhanced_extraction_service:   - Carrier: ALLIED
INFO:app.services.enhanced_extraction_service:   - Broker: INNOVATIVE BPS LLC
INFO:app.services.enhanced_extraction_service:   - Statement Date: 2025-08-06
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.enhanced_extraction_service:üìã GPT-5 carrier/broker extraction ‚Üí carrier='ALLIED' (0.95) | broker='INNOVATIVE BPS LLC' (0.95)
INFO:app.services.enhanced_extraction_service:‚úÖ GPT-5 metadata extracted: carrier=ALLIED, date=2025-08-06, broker=INNOVATIVE BPS LLC
INFO:app.services.enhanced_extraction_service:   Cost: $0.0060, Tokens: 37968
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
üìé Enhanced multi-strategy stitching: Processing 5 tables
üìé Processing 5 detail tables for potential merging
üìé Canonical header identified: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Detail table 1 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Detail table 2 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Detail table 3 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Detail table 4 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Detail table 5 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Found 1 unique header patterns
üìé Header pattern 'group no.' appears in 5 tables
üìé Creating group with 5 tables (identical headers)
üìé Grouped 5 detail tables into 1 groups
üìé Merging group 1 with 5 tables
INFO:app.services.extraction_utils:‚úÖ Merged table created: 71 rows (enhancements preserved from individual tables)
üìé Merged detail table 1: 10 headers, 71 rows
üìé Merged headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üìé Enhanced stitching completed: 1 detail table(s) + 0 grand total table(s) = 1 final tables
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.enhanced_extraction_service:GPT-5: Verified normalized headers
INFO:app.services.enhanced_extraction_service:üìä Table 1 summary rows ‚Üí model:14 heuristic:14 final:14
INFO:app.services.enhanced_extraction_service:   ‚Ü≥ Example reasoning row 3: score=1.7 reasons=['Row annotated as GroupSummary', 'Contains summary keyword', 'Matches expected rollup label', "Matches 'Total for Group' pattern", "Contains 'Total for ...' phrase", 'Matches running total of previous detail rows']
INFO:app.services.enhanced_extraction_service:‚≠ê GPT-5: Processed 5 tables into 1 tables
INFO:app.services.enhanced_extraction_service:   Cost: $0.0060
INFO:app.services.enhanced_extraction_service:   Tokens: 37968
INFO:app.services.enhanced_extraction_service:‚úÖ Using GPT-5's structured output summary row detection
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1764016970866_qecv8do0h
INFO:app.services.conversational_summary_service:üó£Ô∏è Generating conversational summary...
INFO:app.services.conversational_summary_service:üîç _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:‚úÖ Attaching condensed enhanced context to prompt
INFO:app.services.conversational_summary_service:‚úÖ SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:üöÄ Calling GPT-4o API for summary generation...
INFO:app.services.conversational_summary_service:   Model: gpt-4o
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 2797 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.conversational_summary_service:üìä Token usage - Input: 1,058, Output: 278
INFO:app.services.conversational_summary_service:‚úÖ GPT-4o API call successful
INFO:app.services.conversational_summary_service:‚úÖ Detected structured JSON response from GPT-4o
INFO:app.services.conversational_summary_service:üìä GPT-4o provided 11 fields: ['carrier_name', 'broker_company', 'statement_date', 'broker_id', 'payment_type', 'total_amount', 'company_count', 'top_contributors', 'commission_structure', 'census_count', 'billing_periods']
INFO:app.services.conversational_summary_service:üìä Extracted structured fields: broker_company='INNOVATIVE BPS LLC', carrier='ALLIED', company_count=13 (from 13 groups_and_companies)
INFO:app.services.conversational_summary_service:‚úÖ Extracted structured summary data (8 fields): ['carrier_name', 'broker_company', 'statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'census_count', 'billing_periods']
INFO:app.services.conversational_summary_service:‚úÖ Fallback added 1 missing fields: ['broker_id_confidence']
INFO:app.services.conversational_summary_service:üìÑ Generated summary length: 497 characters
INFO:app.services.conversational_summary_service:üìä Final structured data keys: ['carrier_name', 'broker_company', 'statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'census_count', 'billing_periods', 'broker_id', 'payment_type', 'top_contributors', 'commission_structure']
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Started stage validation for upload upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Completed processing for upload upload_1764016970866_qecv8do0h in 407.96 seconds
INFO:app.api.new_extract:‚úÖ Extraction completed successfully
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1764016970866_qecv8do0h
INFO:app.api.new_extract:üîç Summary row refinement adjusted table 0: [3, 8, 14, 15, 19, 52, 54, 56, 58, 60, 61, 63, 65, 70] ‚Üí [1, 2, 3, 6, 7, 8, 14, 15, 17, 18, 19, 52, 58, 59, 60, 61, 63, 65, 70]
INFO:app.api.new_extract:‚úÖ Extraction completed (data NOT saved to DB, will be saved on approval)
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: 5aecca3b-d567-4cb9-989c-877448a3b0bc)
INFO:app.api.new_extract:üéØ Format Learning: Using carrier ALLIED with ID 5c9324ac-1794-4563-8e0e-8cd5c5317181
WARNING:app.api.new_extract:üö® CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as ALLIED (5c9324ac-1794-4563-8e0e-8cd5c5317181)
INFO:app.api.new_extract:üîÑ Reassigning file to correct carrier: ALLIED
INFO:app.services.gcs_utils:‚úÖ File copied in GCS: statements/5aecca3b-d567-4cb9-989c-877448a3b0bc/8.6.2025.pdf -> statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/8.6.2025.pdf
INFO:app.services.gcs_utils:‚úÖ File deleted from GCS: statements/5aecca3b-d567-4cb9-989c-877448a3b0bc/8.6.2025.pdf
INFO:app.services.gcs_utils:üîê Generating signed URL for: statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/8.6.2025.pdf
INFO:app.services.gcs_utils:üìù Generating signed URL with:
INFO:app.services.gcs_utils:   - Content-Type: application/pdf
INFO:app.services.gcs_utils:   - Content-Disposition: inline
INFO:app.services.gcs_utils:   - Expiration: 1 hour(s)
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/8.6.2025.pdf
INFO:app.services.gcs_utils:   URL expires at: 2025-11-24 21:49:48.248924
INFO:app.api.new_extract:‚úÖ File moved to correct carrier folder in GCS: statements/5c9324ac-1794-4563-8e0e-8cd5c5317181/8.6.2025.pdf
INFO:app.api.new_extract:‚úÖ Updated upload metadata: carrier_id=5c9324ac-1794-4563-8e0e-8cd5c5317181, company_id stays as user's company=d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.api.new_extract:üìä Single table detected, using it for field mapping
INFO:app.api.new_extract:üéØ Using table 0 for field mapping with 10 headers
üéØ FormatLearningService: Finding matching format for company 5c9324ac-1794-4563-8e0e-8cd5c5317181
üéØ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ FormatLearningService: Table structure: {'row_count': 71, 'column_count': 10, 'has_financial_data': True}
üéØ FormatLearningService: Headers type: <class 'list'>
üéØ FormatLearningService: Headers length: 10
üéØ CRUD: Finding best matching format for company 5c9324ac-1794-4563-8e0e-8cd5c5317181
üéØ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD: Input table structure: {'row_count': 71, 'column_count': 10, 'has_financial_data': True}
üéØ CRUD: Found 2 saved formats for company
üéØ CRUD: Comparing with saved format:
üéØ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD:   Header similarity: 0.8
üéØ CRUD:   Structure similarity: 1.0
üéØ CRUD:   Total score: 0.8400000000000001
üéØ CRUD:   -> New best match with score 0.8400000000000001
üéØ CRUD: Comparing with saved format:
üéØ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD:   Header similarity: 0.7200000000000001
üéØ CRUD:   Structure similarity: 1.0
üéØ CRUD:   Total score: 0.776
üéØ FormatLearningService: Best match score: 0.8400000000000001
üéØ FormatLearningService: Found matching format with signature: 6f736ac611e1789c131a993b10321314
üéØ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üéØ FormatLearningService: Learned table editor settings: {'headers': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'summary_rows': [1, 2, 3, 6, 7, 8, 14, 16, 17, 18, 52, 58, 61, 63, 67, 68, 69, 71, 72, 73, 77, 78, 79, 80], 'corrected_carrier_name': '', 'corrected_statement_date': '2025-08-06', 'user_corrections': {'carrier_name': '', 'statement_date': '2025-08-06'}}
INFO:app.api.new_extract:üéØ Format Learning: Found matching format with score 0.8400000000000001
INFO:app.api.new_extract:üéØ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:‚úÖ Total extracted from document_metadata: $386.61
WARNING:app.api.new_extract:üõ°Ô∏è PROTECTED: Document metadata total ($386.61) is LOCKED. Skipping table column scanning to prevent incorrect replacements.
WARNING:app.api.new_extract:üõ°Ô∏è ABSOLUTE PROTECTION: existing method is 'document_metadata' ($386.61). Candidate 'calculated_sum' ($3,846.45) is REJECTED regardless of priority. Document metadata is the HIGHEST priority source and can NEVER be replaced!
INFO:app.api.new_extract:üéØ Format Learning: Total validation result: {'matches': False, 'difference': None, 'difference_percent': None, 'status': 'no_comparison', 'reason': 'Missing total amount for comparison'}
INFO:app.api.new_extract:üìä Added total to document_metadata: $386.61 (method: document_metadata)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:üîç AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:‚úÖ AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1764016970866_qecv8do0h
INFO:app.api.new_extract:üß† AI Field Mapping: Starting field mapping during extraction
INFO:app.api.new_extract:üìã Normalizing headers for AI mapping:
INFO:app.api.ai_intelligent_mapping:üöÄ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ü§ñ AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:üîç AI Mapping: carrier_id provided: True (value: 5c9324ac-1794-4563-8e0e-8cd5c5317181)
INFO:app.services.ai_field_mapping_service:üéØ Carrier ID is valid, attempting to retrieve learned mapping for carrier 5c9324ac-1794-4563-8e0e-8cd5c5317181
INFO:app.services.ai_field_mapping_service:üîç Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:üîç Looking up learned format for carrier 5c9324ac-1794-4563-8e0e-8cd5c5317181 with 10 headers
INFO:app.services.ai_field_mapping_service:‚úÖ Found EXACT match for learned format with signature 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:‚úÖ Learned field mapping has 10 mappings
INFO:app.services.ai_field_mapping_service:üéØ Found learned mapping for carrier with 1.00 confidence
INFO:app.services.ai_field_mapping_service:üéØ Using learned mappings directly with match score 1.0
INFO:app.services.ai_field_mapping_service:‚úÖ Learned field_mapping contains 10 mappings
INFO:app.services.ai_field_mapping_service:‚úÖ Applied 9 learned mappings directly - returning early
INFO:app.services.ai_field_mapping_service:‚úÖ Response includes learned_format_used=True flag
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:‚úÖ Enhanced AI Analysis Complete: Overall confidence 0.93
INFO:app.api.new_extract:‚úÖ AI Field Mapping: 9 mappings with sample data, confidence 0.95
INFO:app.api.new_extract:‚úÖ Conversational summary supplied by extraction pipeline
INFO:app.api.new_extract:   Summary preview: This is an ABSF Commission Payment Summary from Allied for INNOVATIVE BPS LLC, dated August 6, 2025. The document outlines a total of $386.61 in commissions, encompassing 13 client groups. The top con
INFO:app.api.new_extract:   Structured data keys: ['carrier_name', 'broker_company', 'statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'census_count', 'billing_periods', 'broker_id', 'payment_type', 'top_contributors', 'commission_structure']
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 5aecca3b-d567-4cb9-989c-877448a3b0bc)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {"carrier_name": "ALLIED", "broker_company": "INNOVATIVE BPS LLC", "statement_date": "2025-08-06", "total_amount": "386.61", "company_count": 13, "broker_id_confidence": 0.7, "census_count": "null", "...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1764016970866_qecv8do0h
INFO:app.api.new_extract:üìä Calculating invoice total from 1 tables
INFO:app.api.new_extract:üìä Table 0: Found invoice column at index 4: 'Invoice Total'
INFO:app.api.new_extract:‚úÖ Table 0: Calculated from rows: $66,325.44
INFO:app.api.new_extract:‚úÖ TOTAL invoice amount from all tables: $66,325.44
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1764016970866_qecv8do0h: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1764016970866_qecv8do0h
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1764016970866_qecv8do0h
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1764016970866_qecv8do0h
INFO:     127.0.0.1:59247 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1764016970866_qecv8do0h, session_id=session_1764016970876_pd1bje7ux
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1764016970866_qecv8do0h, session_id=session_1764016970876_pd1bje7ux
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1764016970866_qecv8do0h
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:app.api.auto_approval:Auto-approval started for upload 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.services.websocket_service:Broadcasting message to upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.services.websocket_service:Broadcasting message to upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.services.websocket_service:Broadcasting message to upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.api.auto_approval:üîç Auto-approval: Filtered 1 tables to 1 commission tables for saving
INFO:app.api.auto_approval:ü§ñ Auto-approval: Raw field_mapping from learned format: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
INFO:app.api.auto_approval:ü§ñ Auto-approval: Using 10 field mappings from learned format
INFO:app.api.auto_approval:ü§ñ Auto-approval: Field config list: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Saving edited tables for upload_id: 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.api.table_editor:üéØ Table Editor API: Tables count: 1
INFO:app.api.table_editor:üéØ Table Editor API: Selected statement date: {'date': '2025-08-06'}
INFO:app.api.table_editor:üéØ Table Editor API: Company ID (deprecated): 5c9324ac-1794-4563-8e0e-8cd5c5317181
INFO:app.api.table_editor:üéØ Table Editor API: Carrier ID: None
INFO:app.api.table_editor:üéØ Table Editor API: Field config received: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:üéØ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:üéØ Table Editor API: Updating upload with tables, statement date, and carrier
üéØ CRUD: update_upload_tables called for upload_id: 5aecca3b-d567-4cb9-989c-877448a3b0bc
üéØ CRUD: Tables data length: 1
üéØ CRUD: Selected statement date: {'date': '2025-08-06'}
üéØ CRUD: Carrier ID: None
üéØ CRUD: Upload not found for ID: 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.api.table_editor:üéØ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:üéØ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:üéØ Table Editor API: Successfully saved 1 edited tables
INFO:app.services.websocket_service:Broadcasting message to upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.api.auto_approval:Updated format learning usage count for signature: 6f736ac611e1789c131a993b10321314
INFO:app.services.websocket_service:Broadcasting message to upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.db.crud.statement_upload:‚úÖ Saving statement review for upload 5aecca3b-d567-4cb9-989c-877448a3b0bc with valid status: Approved
INFO:app.db.crud.statement_upload:üíæ Upload not found for ID: 5aecca3b-d567-4cb9-989c-877448a3b0bc - This is unexpected for remap flow
WARNING:app.db.crud.statement_upload:‚ö†Ô∏è Statement 5aecca3b-d567-4cb9-989c-877448a3b0bc should already exist in database for remap operation
INFO:app.db.crud.statement_upload:‚úÖ All required fields present, proceeding with record creation
INFO:app.db.crud.statement_upload:‚úÖ Using user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191 (from current_user_id)
INFO:app.db.crud.statement_upload:‚úÖ Retrieved user's company_id d883a865-a54f-41d6-968e-f94c3cb3f589 from users table for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.db.crud.environment:‚úÖ Found existing default environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 for user f6cf1764-5bfc-4352-abd9-81b72b7cf191 in company d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.db.crud.statement_upload:‚úÖ ALWAYS using user's default environment_id 9f4a7a57-5715-4b1e-98a9-b9901726a485 for consistency
INFO:app.db.crud.statement_upload:‚úÖ Created new DB record for upload 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.db.crud.statement_upload:=== REMAP DEBUG ===
INFO:app.db.crud.statement_upload:üíæ Saving statement review: upload_id=5aecca3b-d567-4cb9-989c-877448a3b0bc, status=Approved
INFO:app.db.crud.statement_upload:üìã Field config being saved: 10 fields
INFO:app.db.crud.statement_upload:üìä Final data tables: 1
INFO:app.db.crud.statement_upload:üìÖ Selected statement date: {'date': '2025-08-06'}
INFO:app.db.crud.statement_upload:===================
üíæ Saving statement review: upload_id=5aecca3b-d567-4cb9-989c-877448a3b0bc, status=Approved
üìã Field config being saved: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
üìä Final data rows: 1
üìÖ Selected statement date being saved: {'date': '2025-08-06'}
üîç DEBUG Saving table 0 'Table 1': summaryRows=[1, 2, 3, 6, 7, 8, 14, 15, 17, 18, 19, 52, 58, 59, 60, 61, 63, 65, 70], type=<class 'list'>
üìù Extracted field_mapping with 10 mappings: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üí∞ Calculating extracted_total for manual approval...
üí∞ field_mapping keys: ['Agent %', 'Group No.', 'Census Ct.', 'Group Name', 'Adj. Period', 'Paid Amount', 'Invoice Total', 'Billing Period', 'Stoploss Total', 'Calculation Method']
üí∞ Number of tables in final_data: 1
üí∞ Found commission field (EXACT MATCH): Paid Amount -> Commission Earned
üí∞ Final commission_source_field: Paid Amount
  üí∞ Processing 1 detail table(s) (excluded 0 grand total tables)
  üìä Table 0: 10 headers, 71 rows
  üìã Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  üìã First row sample: ['L213059', 'BOLT LOGISTIC', '8/1/2025', '7/1/2025', '($627.27)', '($266.05)', '22.5%', 'Premium Equivalent', '-1', '($141.14)']
  üí∞ Table 0: Commission column 'Paid Amount' at index 9
    Row 0: [LIST] raw_value = '($141.14)' (type: <class 'str'>)
    Row 0: Added $-141.14 (running total: $-141.14)
    Row 1: SKIPPED (summary row)
    Row 2: SKIPPED (summary row)
    Row 3: SKIPPED (summary row)
    Row 4: [LIST] raw_value = '($552.73)' (type: <class 'str'>)
    Row 4: Added $-552.73 (running total: $-693.87)
    Row 5: [LIST] raw_value = '$38.12' (type: <class 'str'>)
    Row 5: Added $38.12 (running total: $-655.75)
    Row 6: SKIPPED (summary row)
    Row 7: SKIPPED (summary row)
    Row 8: SKIPPED (summary row)
    Row 9: [LIST] raw_value = '$159.51' (type: <class 'str'>)
    Row 9: Added $159.51 (running total: $-496.24)
    Row 10: [LIST] raw_value = '$122.04' (type: <class 'str'>)
    Row 10: Added $122.04 (running total: $-374.20)
    Row 11: [LIST] raw_value = '$244.08' (type: <class 'str'>)
    Row 11: Added $244.08 (running total: $-130.12)
    Row 12: [LIST] raw_value = '$925.23' (type: <class 'str'>)
    Row 12: Added $925.23 (running total: $795.11)
    Row 13: [LIST] raw_value = '($61.02)' (type: <class 'str'>)
    Row 13: Added $-61.02 (running total: $734.09)
    Row 14: SKIPPED (summary row)
    Row 15: SKIPPED (summary row)
    Row 16: [LIST] raw_value = '$68.68' (type: <class 'str'>)
    Row 16: Added $68.68 (running total: $802.77)
    Row 17: SKIPPED (summary row)
    Row 18: SKIPPED (summary row)
    Row 19: SKIPPED (summary row)
    Row 20: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 20: Added $58.62 (running total: $861.39)
    Row 21: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 21: Added $-61.14 (running total: $800.25)
    Row 22: [LIST] raw_value = '$132.52' (type: <class 'str'>)
    Row 22: Added $132.52 (running total: $932.77)
    Row 23: [LIST] raw_value = '$163.29' (type: <class 'str'>)
    Row 23: Added $163.29 (running total: $1096.06)
    Row 24: [LIST] raw_value = '$221.70' (type: <class 'str'>)
    Row 24: Added $221.70 (running total: $1317.76)
    Row 25: [LIST] raw_value = '$724.20' (type: <class 'str'>)
    Row 25: Added $724.20 (running total: $2041.96)
    Row 26: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 26: Added $58.62 (running total: $2100.58)
    Row 27: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 27: Added $-61.14 (running total: $2039.44)
    Row 28: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 28: Added $58.62 (running total: $2098.06)
    Row 29: [LIST] raw_value = '($15.28)' (type: <class 'str'>)
    Row 29: Added $-15.28 (running total: $2082.78)
    Row 30: [LIST] raw_value = '($147.19)' (type: <class 'str'>)
    Row 30: Added $-147.19 (running total: $1935.59)
    Row 31: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 31: Added $-61.14 (running total: $1874.45)
    Row 32: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 32: Added $58.62 (running total: $1933.07)
    Row 33: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 33: Added $-61.14 (running total: $1871.93)
    Row 34: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 34: Added $-61.14 (running total: $1810.79)
    Row 35: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 35: Added $-61.14 (running total: $1749.65)
    Row 36: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 36: Added $58.62 (running total: $1808.27)
    Row 37: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 37: Added $-61.14 (running total: $1747.13)
    Row 38: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 38: Added $58.62 (running total: $1805.75)
    Row 39: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 39: Added $58.62 (running total: $1864.37)
    Row 40: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 40: Added $58.62 (running total: $1922.99)
    Row 41: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 41: Added $58.62 (running total: $1981.61)
    Row 42: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 42: Added $-61.14 (running total: $1920.47)
    Row 43: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 43: Added $58.62 (running total: $1979.09)
    Row 44: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 44: Added $58.62 (running total: $2037.71)
    Row 45: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 45: Added $58.62 (running total: $2096.33)
    Row 46: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 46: Added $58.62 (running total: $2154.95)
    Row 47: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 47: Added $-61.14 (running total: $2093.81)
    Row 48: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 48: Added $-61.14 (running total: $2032.67)
    Row 49: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 49: Added $-61.14 (running total: $1971.53)
    Row 50: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 50: Added $-61.14 (running total: $1910.39)
    Row 51: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 51: Added $-61.14 (running total: $1849.25)
    Row 52: SKIPPED (summary row)
    Row 53: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 53: Added $-61.08 (running total: $1788.17)
    Row 54: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 54: Added $-61.08 (running total: $1727.09)
    Row 55: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 55: Added $-61.08 (running total: $1666.01)
    Row 56: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 56: Added $-61.08 (running total: $1604.93)
    Row 57: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 57: Added $-61.08 (running total: $1543.85)
    Row 58: SKIPPED (summary row)
    Row 59: SKIPPED (summary row)
    Row 60: SKIPPED (summary row)
    Row 61: SKIPPED (summary row)
    Row 62: [LIST] raw_value = '($31.29)' (type: <class 'str'>)
    Row 62: Added $-31.29 (running total: $1512.56)
    Row 63: SKIPPED (summary row)
    Row 64: [LIST] raw_value = '($81.68)' (type: <class 'str'>)
    Row 64: Added $-81.68 (running total: $1430.88)
    Row 65: SKIPPED (summary row)
    Row 66: [LIST] raw_value = '$97.20' (type: <class 'str'>)
    Row 66: Added $97.20 (running total: $1528.08)
    Row 67: [LIST] raw_value = '$1,194.57' (type: <class 'str'>)
    Row 67: Added $1194.57 (running total: $2722.65)
    Row 68: [LIST] raw_value = '($132.73)' (type: <class 'str'>)
    Row 68: Added $-132.73 (running total: $2589.92)
    Row 69: [LIST] raw_value = '$1,256.53' (type: <class 'str'>)
    Row 69: Added $1256.53 (running total: $3846.45)
    Row 70: SKIPPED (summary row)
  ‚úÖ Table 0 total: $3846.45
üí∞ AI-extracted total from document: $386.61
üí∞ Total comparison:
   - AI extracted from document: $386.61
   - Calculated from table rows: $3846.45
   - Difference: $3459.84 (894.92%)
   - Match: False
‚ö†Ô∏è TOTAL MISMATCH DETECTED! Changing status from 'Approved' to 'needs_review'
üí∞ Final extracted_total: $3846.45
‚úÖ Set extracted_total=386.61 (AI-extracted), calculated_total=3846.45, total_amount_match=False
INFO:app.services.user_profile_service:Recorded contribution: approval for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.review:‚úÖ User contribution recorded for needs_review statement 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.api.auto_approval:üìä Priority 1: Using total from document_metadata: $386.61
INFO:app.api.auto_approval:üí∞ Auto-approval: Found PRIMARY commission field: 'Paid Amount' (mapped to 'Commission Earned')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Processing 1 detail table(s) (excluded 0 grand total tables)
INFO:app.api.auto_approval:üí∞ Auto-approval: Table 0: Found 10 headers
INFO:app.api.auto_approval:üí∞ Auto-approval: Commission field 'Paid Amount' found at index 9
INFO:app.api.auto_approval:üí∞ Auto-approval: Table has 71 rows, 19 summary rows to skip
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 52 data rows from table 0
INFO:app.api.auto_approval:üí∞ Auto-approval: Found invoice field (exact match): 'Invoice Total' (mapped to 'Invoice Total')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating invoice total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Processing 1 detail table(s) for invoice total (excluded 0 grand total tables)
INFO:app.api.auto_approval:üí∞ Auto-approval: Invoice field 'Invoice Total' found at index 4
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 52 invoice rows from table 0
INFO:app.api.auto_approval:üìä Total validation:
INFO:app.api.auto_approval:  - Extracted from file: $386.61
INFO:app.api.auto_approval:  - Calculated from table: $3846.45
INFO:app.api.auto_approval:  - Invoice total calculated: $60574.61
INFO:app.api.auto_approval:  - Tolerance: 5% or $5.00, whichever is larger = $19.33
INFO:app.api.auto_approval:  - Difference: $3,459.84 (894.92%)
INFO:app.api.auto_approval:  - Match: False
INFO:app.api.auto_approval:üìù Auto-approval COMPLETED with review flag: Learned format applied successfully, but totals don't match. User can review and remap if needed.
INFO:app.api.auto_approval:‚úÖ Updated DB record with auto-approval metadata
INFO:app.api.auto_approval:üìù Auto-approval: Status is 'needs_review' - commission data will be processed after user reviews and manually approves the statement
INFO:app.services.user_profile_service:Recorded contribution: auto_approval for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.auto_approval:‚úÖ User contribution recorded for auto-approved statement 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.services.websocket_service:Broadcasting message to upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:app.api.auto_approval:Auto-approval completed for upload 5aecca3b-d567-4cb9-989c-877448a3b0bc
INFO:     127.0.0.1:59359 - "POST /api/auto-approve/process-lite HTTP/1.1" 200 OK
INFO:     127.0.0.1:59369 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:59359 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:59371 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:59359 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:59373 - "GET /api/earned-commission/carrier/user-specific/5c9324ac-1794-4563-8e0e-8cd5c5317181/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:59369 - "GET /api/companies/user-specific/5c9324ac-1794-4563-8e0e-8cd5c5317181/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:59359 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:59359 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
