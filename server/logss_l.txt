INFO:app.services.ai_field_mapping_service:ğŸ” AI Mapping: carrier_id provided: True (value: 8340174b-f6ed-42eb-976d-4868bb06c844)
INFO:app.services.ai_field_mapping_service:ğŸ¯ Carrier ID is valid, attempting to retrieve learned mapping for carrier 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.services.ai_field_mapping_service:ğŸ” Generated format signature for lookup: f0d2424f7efd76c2fcfb224d0246d1f1
INFO:app.services.ai_field_mapping_service:ğŸ” Looking up learned format for carrier 8340174b-f6ed-42eb-976d-4868bb06c844 with 6 headers
INFO:app.services.ai_field_mapping_service:âœ… Found EXACT match for learned format with signature f0d2424f7efd76c2fcfb224d0246d1f1
INFO:app.services.ai_field_mapping_service:âœ… Learned field mapping has 6 mappings
INFO:app.services.ai_field_mapping_service:ğŸ¯ Found learned mapping for carrier with 1.00 confidence
INFO:app.services.ai_field_mapping_service:ğŸ¯ Using learned mappings directly with match score 1.0
INFO:app.services.ai_field_mapping_service:âœ… Learned field_mapping contains 6 mappings
INFO:app.services.ai_field_mapping_service:âœ… Applied 6 learned mappings directly - returning early
INFO:app.services.ai_field_mapping_service:âœ… Response includes learned_format_used=True flag
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:âœ… Enhanced AI Analysis Complete: Overall confidence 0.93
INFO:app.api.new_extract:âœ… AI Field Mapping: 6 mappings with sample data, confidence 0.95
INFO:app.api.new_extract:âœ… Conversational summary supplied by extraction pipeline
INFO:app.api.new_extract:   Summary preview: This is a commission statement from Redirect Health for an unidentified broker, dated May 31, 2025. The document indicates a total payment of $4,861.56, covering 12 different groups. The most signific
INFO:app.api.new_extract:   Structured data keys: ['statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'carrier_name', 'broker_company', 'broker_id', 'payment_type', 'top_contributors', 'commission_structure', 'census_count', 'billing_periods']
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 9d102016-8e5f-48c1-b2e0-47924af5facf)
INFO:app.api.new_extract:ğŸ“¤ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:ğŸ“Š Sending structured data: {"statement_date": "2025-05-31", "total_amount": "4861.56", "company_count": 12, "broker_id_confidence": 0.7, "carrier_name": "Redirect Health", "broker_company": "Unknown", "broker_id": "null", "paym...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980159946_r2amit71i: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980159946_r2amit71i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980159946_r2amit71i: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980159946_r2amit71i
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763980159946_r2amit71i
INFO:app.api.new_extract:ğŸ“Š Calculating invoice total from 2 tables
INFO:app.api.new_extract:ğŸ“Š Table 0: Found invoice column at index 2: 'Invoice Amount'
INFO:app.api.new_extract:âœ… Table 0: Calculated from rows: $82,146.00
INFO:app.api.new_extract:ğŸ“Š Table 1: Found invoice column at index 0: 'Total Invoice Amount'
INFO:app.api.new_extract:âœ… Table 1: Calculated from rows: $70,498.00
INFO:app.api.new_extract:âœ… TOTAL invoice amount from all tables: $152,644.00
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980159946_r2amit71i: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980159946_r2amit71i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763980159946_r2amit71i: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763980159946_r2amit71i
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763980159946_r2amit71i
INFO:app.api.new_extract:âœ… Extraction complete! Sent results via WebSocket for upload_id: upload_1763980159946_r2amit71i
INFO:     127.0.0.1:58236 - "OPTIONS /api/auto-approve/process-lite HTTP/1.1" 200 OK
INFO:     127.0.0.1:57842 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763980159946_r2amit71i, session_id=session_1763980159969_ovr4htnty
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763980159946_r2amit71i, session_id=session_1763980159969_ovr4htnty
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763980159946_r2amit71i
INFO:app.api.auto_approval:Auto-approval started for upload 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.services.websocket_service:Broadcasting message to upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.services.websocket_service:Broadcasting message to upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.services.websocket_service:Broadcasting message to upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.auto_approval:ğŸ” Auto-approval: Skipping table 1 - all 1 rows are summary rows during save
INFO:app.api.auto_approval:ğŸ” Auto-approval: Filtered 2 tables to 1 commission tables for saving
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Raw field_mapping from learned format: {'Group ID': 'Policy Number', 'Comm. Rate': 'Commission Rate', 'Group Name': 'Client Name', 'Invoice Amount': 'Premium Total', 'Commission Amount': 'Commission Earned', 'Commissionable Amount': 'Invoice Total'}
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Using 6 field mappings from learned format
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Field config list: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saving edited tables for upload_id: 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Tables count: 1
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Selected statement date: {'date': '2025-05-31'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Company ID (deprecated): 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Carrier ID: None
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Field config received: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Updating upload with tables, statement date, and carrier
ğŸ¯ CRUD: update_upload_tables called for upload_id: 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ CRUD: Tables data length: 1
ğŸ¯ CRUD: Selected statement date: {'date': '2025-05-31'}
ğŸ¯ CRUD: Carrier ID: None
ğŸ¯ CRUD: Upload not found for ID: 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:ğŸ¯ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully saved 1 edited tables
INFO:app.services.websocket_service:Broadcasting message to upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.auto_approval:Updated format learning usage count for signature: f0d2424f7efd76c2fcfb224d0246d1f1
INFO:app.services.websocket_service:Broadcasting message to upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.db.crud.statement_upload:âœ… Saving statement review for upload 9d102016-8e5f-48c1-b2e0-47924af5facf with valid status: Approved
INFO:app.db.crud.statement_upload:ğŸ’¾ Upload not found for ID: 9d102016-8e5f-48c1-b2e0-47924af5facf - This is unexpected for remap flow
WARNING:app.db.crud.statement_upload:âš ï¸ Statement 9d102016-8e5f-48c1-b2e0-47924af5facf should already exist in database for remap operation
INFO:app.db.crud.statement_upload:âœ… All required fields present, proceeding with record creation
INFO:app.db.crud.statement_upload:âœ… Using user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191 (from current_user_id)
INFO:app.db.crud.statement_upload:âœ… Retrieved user's company_id d883a865-a54f-41d6-968e-f94c3cb3f589 from users table for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.db.crud.environment:âœ… Found existing default environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 for user f6cf1764-5bfc-4352-abd9-81b72b7cf191 in company d883a865-a54f-41d6-968e-f94c3cb3f589
INFO:app.db.crud.statement_upload:âœ… ALWAYS using user's default environment_id 9f4a7a57-5715-4b1e-98a9-b9901726a485 for consistency
INFO:app.db.crud.statement_upload:âœ… Created new DB record for upload 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.db.crud.statement_upload:=== REMAP DEBUG ===
INFO:app.db.crud.statement_upload:ğŸ’¾ Saving statement review: upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf, status=Approved
INFO:app.db.crud.statement_upload:ğŸ“‹ Field config being saved: 6 fields
INFO:app.db.crud.statement_upload:ğŸ“Š Final data tables: 1
INFO:app.db.crud.statement_upload:ğŸ“… Selected statement date: {'date': '2025-05-31'}
INFO:app.db.crud.statement_upload:===================
ğŸ’¾ Saving statement review: upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf, status=Approved
ğŸ“‹ Field config being saved: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ“Š Final data rows: 1
ğŸ“… Selected statement date being saved: {'date': '2025-05-31'}
ğŸ” DEBUG Saving table 0 'Table 1': summaryRows=[11], type=<class 'list'>
ğŸ“ Extracted field_mapping with 6 mappings: {'Group ID': 'Policy Number', 'Comm. Rate': 'Commission Rate', 'Group Name': 'Client Name', 'Invoice Amount': 'Premium Total', 'Commission Amount': 'Commission Earned', 'Commissionable Amount': 'Invoice Total'}
ğŸ’° Calculating extracted_total for manual approval...
ğŸ’° field_mapping keys: ['Group ID', 'Comm. Rate', 'Group Name', 'Invoice Amount', 'Commission Amount', 'Commissionable Amount']
ğŸ’° Number of tables in final_data: 1
ğŸ’° Found commission field (EXACT MATCH): Commission Amount -> Commission Earned
ğŸ’° Final commission_source_field: Commission Amount
  ğŸ’° Processing 1 detail table(s) (excluded 0 grand total tables)
  ğŸ“Š Table 0: 6 headers, 14 rows
  ğŸ“‹ Headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
  ğŸ“‹ First row sample: ['G-RDA012300075', 'CG23 Logistics', '$5,824.00', '$5,264.00', '2.00%', '$105.28']
  ğŸ’° Table 0: Commission column 'Commission Amount' at index 5
    Row 0: [LIST] raw_value = '$105.28' (type: <class 'str'>)
    Row 0: Added $105.28 (running total: $105.28)
    Row 1: [LIST] raw_value = '$753.84' (type: <class 'str'>)
    Row 1: Added $753.84 (running total: $859.12)
    Row 2: [LIST] raw_value = '$361.68' (type: <class 'str'>)
    Row 2: Added $361.68 (running total: $1220.80)
    Row 3: [LIST] raw_value = '$60.90' (type: <class 'str'>)
    Row 3: Added $60.90 (running total: $1281.70)
    Row 4: [LIST] raw_value = '$379.32' (type: <class 'str'>)
    Row 4: Added $379.32 (running total: $1661.02)
    Row 5: [LIST] raw_value = '$246.18' (type: <class 'str'>)
    Row 5: Added $246.18 (running total: $1907.20)
    Row 6: [LIST] raw_value = '$315.84' (type: <class 'str'>)
    Row 6: Added $315.84 (running total: $2223.04)
    Row 7: [LIST] raw_value = '$361.68' (type: <class 'str'>)
    Row 7: Added $361.68 (running total: $2584.72)
    Row 8: [LIST] raw_value = '$692.88' (type: <class 'str'>)
    Row 8: Added $692.88 (running total: $3277.60)
    Row 9: [LIST] raw_value = '$438.60' (type: <class 'str'>)
    Row 9: Added $438.60 (running total: $3716.20)
    Row 10: [LIST] raw_value = '$585.36' (type: <class 'str'>)
    Row 10: Added $585.36 (running total: $4301.56)
    Row 11: SKIPPED (summary row)
    Row 12: [LIST] raw_value = '$560.00' (type: <class 'str'>)
    Row 12: Added $560.00 (running total: $4861.56)
    Row 13: [LIST] raw_value = '$560.00' (type: <class 'str'>)
    Row 13: Added $560.00 (running total: $5421.56)
  âœ… Table 0 total: $5421.56
ğŸ’° AI-extracted total from document: $4861.56
ğŸ’° Total comparison:
   - AI extracted from document: $4861.56
   - Calculated from table rows: $5421.56
   - Difference: $560.00 (11.52%)
   - Match: False
âš ï¸ TOTAL MISMATCH DETECTED! Changing status from 'Approved' to 'needs_review'
ğŸ’° Final extracted_total: $5421.56
âœ… Set extracted_total=4861.56 (AI-extracted), calculated_total=5421.56, total_amount_match=False
INFO:app.services.user_profile_service:Recorded contribution: approval for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.review:âœ… User contribution recorded for needs_review statement 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.auto_approval:ğŸ“Š Priority 1: Using total from document_metadata: $4,861.56
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Found PRIMARY commission field: 'Commission Amount' (mapped to 'Commission Earned')
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Calculating total from 1 table(s)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processing 1 detail table(s) (excluded 0 grand total tables)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table 0: Found 6 headers
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Commission field 'Commission Amount' found at index 5
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table has 14 rows, 1 summary rows to skip
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 13 data rows from table 0
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Found invoice field (exact match): 'Commissionable Amount' (mapped to 'Invoice Total')
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Calculating invoice total from 1 table(s)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processing 1 detail table(s) for invoice total (excluded 0 grand total tables)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Invoice field 'Commissionable Amount' found at index 3
WARNING:app.api.auto_approval:ğŸ’° Auto-approval: Row 13: Failed to parse invoice value 'None': could not convert string to float: 'None'
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 12 invoice rows from table 0
INFO:app.api.auto_approval:ğŸ“Š Total validation:
INFO:app.api.auto_approval:  - Extracted from file: $4861.56
INFO:app.api.auto_approval:  - Calculated from table: $5421.56
INFO:app.api.auto_approval:  - Invoice total calculated: $81026.00
INFO:app.api.auto_approval:  - Tolerance: 5% or $5.00, whichever is larger = $243.08
INFO:app.api.auto_approval:  - Difference: $560.00 (11.52%)
INFO:app.api.auto_approval:  - Match: False
INFO:app.api.auto_approval:ğŸ“ Auto-approval COMPLETED with review flag: Learned format applied successfully, but totals don't match. User can review and remap if needed.
INFO:app.api.auto_approval:âœ… Updated DB record with auto-approval metadata
INFO:app.api.auto_approval:ğŸ“ Auto-approval: Status is 'needs_review' - commission data will be processed after user reviews and manually approves the statement
INFO:app.services.user_profile_service:Recorded contribution: auto_approval for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.auto_approval:âœ… User contribution recorded for auto-approved statement 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.services.websocket_service:Broadcasting message to upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.auto_approval:Auto-approval completed for upload 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:     127.0.0.1:58238 - "POST /api/auto-approve/process-lite HTTP/1.1" 200 OK
INFO:     127.0.0.1:58238 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:58307 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:58238 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:58307 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:58238 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:58238 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:58725 - "GET /api/companies/user-specific/8340174b-f6ed-42eb-976d-4868bb06c844/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:58726 - "GET /api/earned-commission/carrier/user-specific/8340174b-f6ed-42eb-976d-4868bb06c844/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:58778 - "GET /api/pdf-preview?gcs_key=statements%2F8340174b-f6ed-42eb-976d-4868bb06c844%2F2025.05.pdf HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:58778 - "GET /api/pdf-preview?gcs_key=statements%2F8340174b-f6ed-42eb-976d-4868bb06c844%2F2025.05.pdf HTTP/1.1" 307 Temporary Redirect
INFO:app.api.statements:ğŸ” PDF preview requested for: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.api.statements:ğŸ” Checking if file exists in GCS: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.api.statements:âœ… File exists, generating signed URL: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ” Generating signed URL for: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ“ Generating signed URL with:
INFO:app.services.gcs_utils:   - Content-Type: application/pdf
INFO:app.services.gcs_utils:   - Content-Disposition: inline
INFO:app.services.gcs_utils:   - Expiration: 1 hour(s)
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:   URL expires at: 2025-11-24 11:32:58.937681
INFO:app.api.statements:âœ… Signed URL generated successfully for: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:     127.0.0.1:58778 - "GET /api/pdf-preview/?gcs_key=statements%2F8340174b-f6ed-42eb-976d-4868bb06c844%2F2025.05.pdf HTTP/1.1" 200 OK
INFO:app.api.statements:ğŸ” PDF preview requested for: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.api.statements:ğŸ” Checking if file exists in GCS: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.api.statements:âœ… File exists, generating signed URL: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ” Generating signed URL for: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:ğŸ“ Generating signed URL with:
INFO:app.services.gcs_utils:   - Content-Type: application/pdf
INFO:app.services.gcs_utils:   - Content-Disposition: inline
INFO:app.services.gcs_utils:   - Expiration: 1 hour(s)
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:app.services.gcs_utils:   URL expires at: 2025-11-24 11:32:59.202577
INFO:app.api.statements:âœ… Signed URL generated successfully for: statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf
INFO:     127.0.0.1:58778 - "GET /api/pdf-preview/?gcs_key=statements%2F8340174b-f6ed-42eb-976d-4868bb06c844%2F2025.05.pdf HTTP/1.1" 200 OK
INFO:app.api.pdf_proxy:ğŸ”„ Proxying PDF from: https://storage.googleapis.com/pdf_extraction_files_saver/statements/8340174b-f6ed-42eb-976d-4868bb0...
INFO:     127.0.0.1:58780 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:httpx:HTTP Request: GET https://storage.googleapis.com/pdf_extraction_files_saver/statements/8340174b-f6ed-42eb-976d-4868bb06c844/2025.05.pdf?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=docsai-table-extractor%40pdf-tables-extractor-465009.iam.gserviceaccount.com%2F20251124%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20251124T103259Z&X-Goog-Expires=3599&X-Goog-SignedHeaders=host&response-content-disposition=inline&response-content-type=application%2Fpdf&X-Goog-Signature=3874dca96e7cabed0438804054ecd43844082d6d094559deefaa93975d6e672558f0ebbc6ca2757ee46592ac872fcd5b1739fc9f90024e8586d05ef77f7b3e1eb0d59282abc3c0ee45a4dd66a64ddb36498a34bdb9f0a38712d9e9b6211e57b0615acfb93e6a1eb12649f7d043dbd14c8533b6d4233c3eab05deac89baf508f437ec6a5b34dc98c10aff9a0f489b7b44297d6f49202c0492807666199f81c20a832455eba7d24bbb17426b3d3b87c239d2214d290bcac7e497f6b8a8ef1be8081b3a4713ea4d28f64fb416cb554ec5b3fb80835adef6195a4cdde7df3d64946e806532169b29c128ef2021232a345f0b9ee658826aeec02cf42b402390053b6f "HTTP/1.1 200 OK"
INFO:     127.0.0.1:58786 - "GET /api/pdf-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fpdf_extraction_files_saver%2Fstatements%2F8340174b-f6ed-42eb-976d-4868bb06c844%2F2025.05.pdf%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Ddocsai-table-extractor%2540pdf-tables-extractor-465009.iam.gserviceaccount.com%252F20251124%252Fauto%252Fstorage%252Fgoog4_request%26X-Goog-Date%3D20251124T103259Z%26X-Goog-Expires%3D3599%26X-Goog-SignedHeaders%3Dhost%26response-content-disposition%3Dinline%26response-content-type%3Dapplication%252Fpdf%26X-Goog-Signature%3D3874dca96e7cabed0438804054ecd43844082d6d094559deefaa93975d6e672558f0ebbc6ca2757ee46592ac872fcd5b1739fc9f90024e8586d05ef77f7b3e1eb0d59282abc3c0ee45a4dd66a64ddb36498a34bdb9f0a38712d9e9b6211e57b0615acfb93e6a1eb12649f7d043dbd14c8533b6d4233c3eab05deac89baf508f437ec6a5b34dc98c10aff9a0f489b7b44297d6f49202c0492807666199f81c20a832455eba7d24bbb17426b3d3b87c239d2214d290bcac7e497f6b8a8ef1be8081b3a4713ea4d28f64fb416cb554ec5b3fb80835adef6195a4cdde7df3d64946e806532169b29c128ef2021232a345f0b9ee658826aeec02cf42b402390053b6f HTTP/1.1" 200 OK
INFO:     127.0.0.1:58780 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:app.services.orphan_cleanup_service:ğŸ§¹ Starting orphan cleanup job...
INFO:app.api.statements:ğŸ“‹ Fetching statements for carrier 8340174b-f6ed-42eb-976d-4868bb06c844 with status filter: ['Approved', 'needs_review']
INFO:app.services.orphan_cleanup_service:âœ… Orphan cleanup completed: no orphans found
INFO:app.api.statements:âœ… Found 5 statements with valid statuses
INFO:     127.0.0.1:58854 - "GET /api/companies/8340174b-f6ed-42eb-976d-4868bb06c844/statements/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:58880 - "OPTIONS /api/table-editor/save-tables HTTP/1.1" 200 OK
INFO:     127.0.0.1:58854 - "POST /api/table-editor/save-tables HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:58880 - "OPTIONS /api/table-editor/save-tables/ HTTP/1.1" 200 OK
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saving edited tables for upload_id: 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Tables count: 1
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Selected statement date: {'date': '2025-05-31'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Company ID (deprecated): 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Carrier ID: None
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Field config received: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Updating upload with tables, statement date, and carrier
ğŸ¯ CRUD: update_upload_tables called for upload_id: 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ CRUD: Tables data length: 1
ğŸ¯ CRUD: Selected statement date: {'date': '2025-05-31'}
ğŸ¯ CRUD: Carrier ID: None
ğŸ¯ CRUD: Found upload, updating with tables, statement date, and carrier
ğŸ¯ CRUD: Saved selected statement date to database: {'date': '2025-05-31'}
ğŸ¯ CRUD: Statement date type: <class 'dict'>
ğŸ¯ CRUD: Statement date keys: ['date']
ğŸ¯ CRUD: Also saved statement date and carrier to progress_data
ğŸ¯ CRUD: Successfully updated upload 9d102016-8e5f-48c1-b2e0-47924af5facf with tables, statement date, and carrier
ğŸ¯ CRUD: Final selected_statement_date in database: {'date': '2025-05-31'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:ğŸ¯ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully saved 1 edited tables
INFO:     127.0.0.1:58854 - "POST /api/table-editor/save-tables/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:58902 - "OPTIONS /api/table-editor/learn-format-patterns HTTP/1.1" 200 OK
INFO:app.api.table_editor:ğŸ¯ Format Learning: Using carrier_id from request: 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.table_editor:ğŸ¯ Format Learning: Extracted 6 field mappings from field_config
INFO:app.api.table_editor:ğŸ¯ Format Learning: Field mappings: {'Group ID': 'Policy Number', 'Comm. Rate': 'Commission Rate', 'Group Name': 'Client Name', 'Invoice Amount': 'Premium Total', 'Commission Amount': 'Commission Earned', 'Commissionable Amount': 'Invoice Total'}
WARNING:app.db.crud.carrier_format_learning:âš ï¸ Saving format learning for company 8340174b-f6ed-42eb-976d-4868bb06c844 without status validation. This should only happen in special cases (e.g., manual format creation).
INFO:app.api.table_editor:Successfully learned format patterns with signature: f0d2424f7efd76c2fcfb224d0246d1f1 for carrier 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:     127.0.0.1:58854 - "POST /api/table-editor/learn-format-patterns HTTP/1.1" 200 OK
INFO:     127.0.0.1:58902 - "OPTIONS /api/companies/8340174b-f6ed-42eb-976d-4868bb06c844/mapping?upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf HTTP/1.1" 200 OK
INFO:     127.0.0.1:58854 - "POST /api/companies/8340174b-f6ed-42eb-976d-4868bb06c844/mapping?upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:58902 - "OPTIONS /api/companies/8340174b-f6ed-42eb-976d-4868bb06c844/mapping/?upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf HTTP/1.1" 200 OK
INFO:app.api.mapping:ğŸ¯ Mapping API: Received mapping request for carrier/company 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.mapping:ğŸ¯ Mapping API: Upload ID: 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:app.api.mapping:ğŸ¯ Mapping API: Config received - mapping keys: ['Group ID', 'Comm. Rate', 'Group Name', 'Invoice Amount', 'Commission Amount', 'Commissionable Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Selected statement date: {'date': '2025-05-31'}
INFO:app.api.mapping:ğŸ¯ Mapping API: Table data rows: 0
INFO:app.api.mapping:ğŸ¯ Mapping API: Headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Retrieved carrier_id from upload: 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.mapping:ğŸ¯ Mapping API: Final carrier_id to use: 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.mapping:ğŸ¯ Mapping API: Saved 6 field mappings for carrier 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:app.api.mapping:ğŸ¯ Mapping API: Saved configuration for carrier 8340174b-f6ed-42eb-976d-4868bb06c844
WARNING:app.api.mapping:ğŸ¯ Mapping API: No statement date or table data provided for commission processing
WARNING:app.api.mapping:ğŸ¯ Mapping API: table_data is None or empty
INFO:app.api.mapping:ğŸ¯ Mapping API: Mapping update completed successfully for carrier 8340174b-f6ed-42eb-976d-4868bb06c844
INFO:     127.0.0.1:58854 - "POST /api/companies/8340174b-f6ed-42eb-976d-4868bb06c844/mapping/?upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf HTTP/1.1" 200 OK
INFO:     127.0.0.1:58976 - "OPTIONS /api/review/approve HTTP/1.1" 200 OK
INFO:     127.0.0.1:58854 - "POST /api/review/approve HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:58976 - "OPTIONS /api/review/approve/ HTTP/1.1" 200 OK
INFO:app.db.crud.statement_upload:âœ… Saving statement review for upload 9d102016-8e5f-48c1-b2e0-47924af5facf with valid status: Approved
INFO:app.db.crud.statement_upload:âœ… Updating existing statement 9d102016-8e5f-48c1-b2e0-47924af5facf (REMAP operation)
INFO:app.db.crud.statement_upload:ğŸ“‹ Current status: needs_review â†’ New status: Approved
INFO:app.db.crud.statement_upload:=== REMAP DEBUG ===
INFO:app.db.crud.statement_upload:ğŸ’¾ Saving statement review: upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf, status=Approved
INFO:app.db.crud.statement_upload:ğŸ“‹ Field config being saved: 6 fields
INFO:app.db.crud.statement_upload:ğŸ“Š Final data tables: 1
INFO:app.db.crud.statement_upload:ğŸ“… Selected statement date: {'date': '2025-05-31', 'carrier_name': ''}
INFO:app.db.crud.statement_upload:===================
ğŸ’¾ Saving statement review: upload_id=9d102016-8e5f-48c1-b2e0-47924af5facf, status=Approved
ğŸ“‹ Field config being saved: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ“Š Final data rows: 1
ğŸ“… Selected statement date being saved: {'date': '2025-05-31', 'carrier_name': ''}
ğŸ” DEBUG Saving table 0 'Table 1': summaryRows=[11, 13], type=<class 'list'>
ğŸ“ Extracted field_mapping with 6 mappings: {'Group ID': 'Policy Number', 'Comm. Rate': 'Commission Rate', 'Group Name': 'Client Name', 'Invoice Amount': 'Premium Total', 'Commission Amount': 'Commission Earned', 'Commissionable Amount': 'Invoice Total'}
ğŸ’° Calculating extracted_total for manual approval...
ğŸ’° field_mapping keys: ['Group ID', 'Comm. Rate', 'Group Name', 'Invoice Amount', 'Commission Amount', 'Commissionable Amount']
ğŸ’° Number of tables in final_data: 1
ğŸ’° Found commission field (EXACT MATCH): Commission Amount -> Commission Earned
ğŸ’° Final commission_source_field: Commission Amount
  ğŸ’° Processing 1 detail table(s) (excluded 0 grand total tables)
  ğŸ“Š Table 0: 6 headers, 14 rows
  ğŸ“‹ Headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
  ğŸ“‹ First row sample: {'Group ID': 'G-RDA012300075', 'Group Name': 'CG23 Logistics', 'Invoice Amount': '$5,824.00', 'Commissionable Amount': '$5,264.00', 'Comm. Rate': '2.00%', 'Commission Amount': '$105.28'}
  ğŸ’° Table 0: Commission column 'Commission Amount' at index 5
    Row 0: [DICT] raw_value = '$105.28' (type: <class 'str'>)
    Row 0: Added $105.28 (running total: $105.28)
    Row 1: [DICT] raw_value = '$753.84' (type: <class 'str'>)
    Row 1: Added $753.84 (running total: $859.12)
    Row 2: [DICT] raw_value = '$361.68' (type: <class 'str'>)
    Row 2: Added $361.68 (running total: $1220.80)
    Row 3: [DICT] raw_value = '$60.90' (type: <class 'str'>)
    Row 3: Added $60.90 (running total: $1281.70)
    Row 4: [DICT] raw_value = '$379.32' (type: <class 'str'>)
    Row 4: Added $379.32 (running total: $1661.02)
    Row 5: [DICT] raw_value = '$246.18' (type: <class 'str'>)
    Row 5: Added $246.18 (running total: $1907.20)
    Row 6: [DICT] raw_value = '$315.84' (type: <class 'str'>)
    Row 6: Added $315.84 (running total: $2223.04)
    Row 7: [DICT] raw_value = '$361.68' (type: <class 'str'>)
    Row 7: Added $361.68 (running total: $2584.72)
    Row 8: [DICT] raw_value = '$692.88' (type: <class 'str'>)
    Row 8: Added $692.88 (running total: $3277.60)
    Row 9: [DICT] raw_value = '$438.60' (type: <class 'str'>)
    Row 9: Added $438.60 (running total: $3716.20)
    Row 10: [DICT] raw_value = '$585.36' (type: <class 'str'>)
    Row 10: Added $585.36 (running total: $4301.56)
    Row 11: SKIPPED (summary row)
    Row 12: [DICT] raw_value = '$560.00' (type: <class 'str'>)
    Row 12: Added $560.00 (running total: $4861.56)
    Row 13: SKIPPED (summary row)
  âœ… Table 0 total: $4861.56
ğŸ’° AI-extracted total from document: $4861.56
ğŸ’° Total comparison:
   - AI extracted from document: $4861.56
   - Calculated from table rows: $4861.56
   - Difference: $0.00 (0.00%)
   - Match: True
ğŸ’° Final extracted_total: $4861.56
ğŸ’° Calculating extracted_invoice_total for manual approval...
ğŸ’° Found invoice field: Invoice Amount -> Premium Total
  ğŸ’° Calculating invoice total from 1 detail table(s) (excluding grand total tables)
  ğŸ“Š Table 0: 6 headers, 14 rows
  ğŸ“‹ Headers: ['Group ID', 'Group Name', 'Invoice Amount', 'Commissionable Amount', 'Comm. Rate', 'Commission Amount']
  ğŸ“‹ First row sample: {'Group ID': 'G-RDA012300075', 'Group Name': 'CG23 Logistics', 'Invoice Amount': '$5,824.00', 'Commissionable Amount': '$5,264.00', 'Comm. Rate': '2.00%', 'Commission Amount': '$105.28'}
  ğŸ’° Table 0: Invoice column 'Invoice Amount' at index 2
    Row 0: [DICT] invoice_value = '$5,824.00'
    Row 0: Added $5824.00 to invoice (running total: $5824.00)
    Row 1: [DICT] invoice_value = '$12,564.00'
    Row 1: Added $12564.00 to invoice (running total: $18388.00)
    Row 2: [DICT] invoice_value = '$6,028.00'
    Row 2: Added $6028.00 to invoice (running total: $24416.00)
    Row 3: [DICT] invoice_value = '$1,015.00'
    Row 3: Added $1015.00 to invoice (running total: $25431.00)
    Row 4: [DICT] invoice_value = '$6,322.00'
    Row 4: Added $6322.00 to invoice (running total: $31753.00)
    Row 5: [DICT] invoice_value = '$4,103.00'
    Row 5: Added $4103.00 to invoice (running total: $35856.00)
    Row 6: [DICT] invoice_value = '$5,824.00'
    Row 6: Added $5824.00 to invoice (running total: $41680.00)
    Row 7: [DICT] invoice_value = '$6,028.00'
    Row 7: Added $6028.00 to invoice (running total: $47708.00)
    Row 8: [DICT] invoice_value = '$11,548.00'
    Row 8: Added $11548.00 to invoice (running total: $59256.00)
    Row 9: [DICT] invoice_value = '$7,310.00'
    Row 9: Added $7310.00 to invoice (running total: $66566.00)
    Row 10: [DICT] invoice_value = '$9,756.00'
    Row 10: Added $9756.00 to invoice (running total: $76322.00)
    Row 12: [DICT] invoice_value = '$5,824.00'
    Row 12: Added $5824.00 to invoice (running total: $82146.00)
  âœ… Table 0 invoice total: $82146.00
ğŸ’° Final extracted_invoice_total: $82146.00
âœ… Set extracted_total=4861.56 (AI-extracted), calculated_total=4861.56, total_amount_match=True
âœ… Set extracted_invoice_total=82146.0
âœ… Statement approved, processing commission data with BULK OPTIMIZATION...
ğŸš€ BULK PROCESSING: Starting optimized commission processing for upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ” Extracting field mappings from: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
âœ… Found client name field: Group Name -> Client Name
âœ… Found invoice field from SOURCE pattern: Invoice Amount -> Premium Total
âœ… Found commission field (exact match): Commission Amount -> Commission Earned
ğŸ” Extracted field mappings: {'client_name_field': 'Group Name', 'commission_earned_field': 'Commission Amount', 'invoice_total_field': 'Invoice Amount'}
   âœ… Client Name: Using 'Group Name'
   âœ… Commission Earned: Using 'Commission Amount'
   âœ… Invoice Total: Using 'Invoice Amount'
âœ… OPTIMIZED: Pre-extracted field mappings: client=Group Name, commission=Commission Amount, invoice=Invoice Amount
ğŸ‘¤ Processing for user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191
ğŸŒ Processing for environment_id: 9f4a7a57-5715-4b1e-98a9-b9901726a485
ğŸ“… Statement date: 2025-05-31 00:00:00 (month: 5, year: 2025)
ğŸ“Š Table 0: Mapped fields - client[1]=Group Name, commission[5]=Commission Amount, invoice[2]=Invoice Amount
ğŸ” DEBUG Table 0: summaryRows raw value: [11, 13], type: <class 'list'>
ğŸ” Table 0: Excluding 2 summary rows from commission calculations: [11, 13]
â­ï¸ Skipping summary row 11 in table 0
â­ï¸ Skipping summary row 13 in table 0
ğŸ“Š Extracted 12 commission records for bulk processing
ğŸ” Found 1 clients with multiple statement rows:
   1. CG23 Logistics: 3 rows, total commission: $981.12
ğŸ“Š Commission Analysis: {'total_records': 12, 'unique_clients': 10, 'clients_with_multiple_rows': 1}
ğŸ” Bulk fetch: Looking up 10 unique commission records (with user + month/year isolation)
âœ… Bulk fetch: Found 0 existing records for specified users
ğŸ“Š Aggregating 12 individual records by unique constraint...
âœ… Aggregated into 10 unique commission records (with user isolation)
   ğŸ“‹ CG23 Logistics (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $981.12 commission, $17472.00 invoice
   ğŸ“‹ Alcala Logistics (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $753.84 commission, $12564.00 invoice
   ğŸ“‹ Anam Logistics (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $361.68 commission, $6028.00 invoice
ğŸ“Š Bulk operations prepared: 0 updates, 10 inserts
â• Executing bulk insert for 10 records
âœ… BULK PROCESSING: Successfully processed 12 records
ğŸ“ˆ Performance: Reduced from 600-800 DB operations to 2-3 operations
INFO:app.services.user_profile_service:Recorded contribution: approval for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.review:âœ… User contribution recorded for approved statement 9d102016-8e5f-48c1-b2e0-47924af5facf
INFO:     127.0.0.1:58854 - "POST /api/review/approve/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:58854 - "GET /api/companies/user-specific/8340174b-f6ed-42eb-976d-4868bb06c844/statements HTTP/1.1" 200 OK
ğŸ¯ Remove Upload: Found commission record for CG23 Logistics that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for Alcala Logistics that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for Anam Logistics that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for Atlas Logistics Services that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for BAMAC Enterprise LLC that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for Cannon Logistics, LLC that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for JDW Logistics that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for Legacy Delivery and Logistics that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for Pria Logistics that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found commission record for Salute Logistics, LLC that contains upload 9d102016-8e5f-48c1-b2e0-47924af5facf
ğŸ¯ Remove Upload: Found 10 commission records to update
ğŸ¯ Remove Upload: Processing commission record for CG23 Logistics
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from CG23 Logistics, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record 78472e64-52fd-435a-9100-685d86b46506 as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for Alcala Logistics
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from Alcala Logistics, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record c43ae74f-2292-4e06-a523-d4929ebbe8eb as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for Anam Logistics
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from Anam Logistics, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record b5f8c660-0e79-4f51-802a-1f0979bfc5c9 as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for Atlas Logistics Services
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from Atlas Logistics Services, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record 53acbfb4-7abe-4336-8d19-24a307a4e3bd as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for BAMAC Enterprise LLC
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from BAMAC Enterprise LLC, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record 13626330-e3fa-49a1-882a-348d93315541 as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for Cannon Logistics, LLC
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from Cannon Logistics, LLC, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record c2e912c2-a21b-4a50-892f-3ff97c35b52d as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for JDW Logistics
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from JDW Logistics, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record c54501d8-9279-4eb2-82f1-8f311f3ea834 as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for Legacy Delivery and Logistics
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from Legacy Delivery and Logistics, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record e3ce53ed-b843-4e07-ad3a-661cb8859427 as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for Pria Logistics
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from Pria Logistics, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record ba05301a-79a1-4c2f-9453-05fbffabdd0e as no uploads remain
ğŸ¯ Remove Upload: Processing commission record for Salute Logistics, LLC
ğŸ¯ Extract Commission: Processing field_config: [{'field': 'Group ID', 'mapping': 'Policy Number'}, {'field': 'Comm. Rate', 'mapping': 'Commission Rate'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Invoice Amount', 'mapping': 'Premium Total'}, {'field': 'Commission Amount', 'mapping': 'Commission Earned'}, {'field': 'Commissionable Amount', 'mapping': 'Invoice Total'}]
ğŸ¯ Extract Commission: Checking field: Group ID -> 
ğŸ¯ Extract Commission: Checking field: Comm. Rate -> 
ğŸ¯ Extract Commission: Checking field: Group Name -> 
ğŸ¯ Extract Commission: Checking field: Invoice Amount -> 
ğŸ¯ Extract Commission: Checking field: Commission Amount -> 
ğŸ¯ Extract Commission: Checking field: Commissionable Amount -> 
ğŸ¯ Extract Commission: Found alternative client name field: 
ğŸ¯ Extract Commission: Found alternative commission field: 
ğŸ¯ Extract Commission: Missing required field: client_name_field=
ğŸ¯ Remove Upload: Deleted upload is from month 5
ğŸ¯ Remove Upload: Removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from Salute Logistics, LLC, remaining uploads: []
ğŸ¯ Remove Upload: Deleted commission record 069bfb69-5d10-452f-b9f3-42cb3950bca1 as no uploads remain
Successfully removed upload 9d102016-8e5f-48c1-b2e0-47924af5facf from 10 commission records
INFO:     127.0.0.1:59137 - "DELETE /api/companies/8340174b-f6ed-42eb-976d-4868bb06c844/statements/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:59137 - "GET /api/earned-commission/carrier/user-specific/8340174b-f6ed-42eb-976d-4868bb06c844/stats HTTP/1.1" 200 OK
INFO:app.services.orphan_cleanup_service:ğŸ§¹ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:âœ… Orphan cleanup completed: no orphans found
