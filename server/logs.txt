(venv) (base) kayttaja@Kayttajas-MacBook-Pro server % uvicorn app.main:app --reload
INFO:     Will watch for changes in these directories: ['/Users/kayttaja/Desktop/commision-tracker/server']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [62043] using StatReload
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [62045]
INFO:     Waiting for application startup.
INFO:app.main:‚úÖ Orphan cleanup scheduler started (runs every 3 minutes)
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.orphan_cleanup_service:üöÄ Starting orphan cleanup scheduler (runs every 3 minutes)
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:     127.0.0.1:56648 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:app.main:Cleaned up 465 expired/inactive sessions
üîç Auth Status - All cookies: ['access_token', 'refresh_token', 'session_token', '__next_hmr_refresh_hash__']
üîç Auth Status - Access token present: True
üîç Auth Status - Request host: localhost:8000
üîç Auth Status - Request origin: http://localhost:3000
üîç Auth Status - Cookie access_token: eyJhbGciOiJIUzI1NiIs...
üîç Auth Status - Cookie refresh_token: eyJhbGciOiJIUzI1NiIs...
üîç Auth Status - Cookie session_token: 83bf8977-bb98-40ce-a...
üîç Auth Status - Cookie __next_hmr_refresh_hash__: 195beea9f78d48ea3509197114e12357633457081244afec
INFO:     127.0.0.1:56699 - "GET /api/auth/otp/status HTTP/1.1" 200 OK
üîç Debug - All cookies received: ['access_token', 'refresh_token', 'session_token', '__next_hmr_refresh_hash__']
üîç Debug - Access token present: True
INFO:     127.0.0.1:56730 - "OPTIONS /environments HTTP/1.1" 200 OK
INFO:     127.0.0.1:56699 - "GET /api/auth/permissions HTTP/1.1" 200 OK
INFO:     127.0.0.1:56732 - "GET /environments HTTP/1.1" 200 OK
INFO:     127.0.0.1:56740 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56742 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:56744 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56732 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56738 - "GET /api/dashboard/stats?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:56699 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56744 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56742 - "GET /api/dashboard/stats?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56732 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56740 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56738 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56699 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56744 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:56742 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56732 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56740 - "GET /api/dashboard/stats?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:56738 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:56742 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:56742 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763132202335_qum79tu5i. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763132202335_qum79tu5i, session_id: session_1763132202364_x84v0bhom
INFO:     127.0.0.1:56828 - "WebSocket /api/ws/progress/upload_1763132202335_qum79tu5i?session_id=session_1763132202364_x84v0bhom" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763132202335_qum79tu5i, session_id=session_1763132202364_x84v0bhom, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763132202335_qum79tu5i, session_id: session_1763132202364_x84v0bhom
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763132202335_qum79tu5i
INFO:     127.0.0.1:56830 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:üìÅ File: 01.13.2025.2 Allied Innovative Payment.pdf, Size: 77177 bytes, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.new_extract:üöÄ Starting extraction: 01.13.2025.2 Allied Innovative Payment.pdf (ID: upload_1763132202335_qum79tu5i)
INFO:app.services.gcs_utils:‚úÖ File uploaded to GCS: statements/7616f0d0-74ae-435b-81ca-aa7ef64da221/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:‚úÖ Uploaded to GCS: statements/7616f0d0-74ae-435b-81ca-aa7ef64da221/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/7616f0d0-74ae-435b-81ca-aa7ef64da221/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1763132202335_qum79tu5i
INFO:app.api.new_extract:üìù Upload metadata prepared (NOT saved to DB): 7616f0d0-74ae-435b-81ca-aa7ef64da221
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: 7616f0d0-74ae-435b-81ca-aa7ef64da221)
INFO:app.services.claude.service:üîÑ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:üîë API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:‚úÖ Claude API client initialized successfully
INFO:app.services.claude.service:üìã Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic Extraction Service initialized
INFO:app.services.claude.utils:üîß Token Bucket initialized:
INFO:app.services.claude.utils:   RPM Limit: 45 (from 50)
INFO:app.services.claude.utils:   TPM Limit: 36,000 (from 40,000)
INFO:app.services.claude.utils:   Buffer: 90%
INFO:app.services.claude.utils:   Max chunk: 12 pages = 33,000 tokens + 3K prompt
INFO:app.services.claude.service:‚úÖ Claude Document AI Service initialized
INFO:app.services.claude.service:üìã Primary model: claude-sonnet-4-5-20250929
INFO:app.services.claude.service:üìã Fallback model: claude-opus-4-1-20250805
INFO:app.services.claude.service:üìè Limits: 32MB, 100 pages
INFO:app.services.claude.service:üõ°Ô∏è  Rate limiting: ENABLED (40 RPM, 32,000 TPM) - OPTIMAL for performance
INFO:app.services.claude.service:üíæ Prompt caching: SUPPORTED
INFO:app.services.claude.service:üìä Chunk size: Dynamic (calculated per file, adapts 2-8 pages)
INFO:app.services.enhanced_extraction_service:‚úÖ Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:üÜï PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:üìã FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:‚è±Ô∏è  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:üöÄ Enhanced 3-phase pipeline: ENABLED
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:‚úÖ CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763132202335_qum79tu5i
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.claude.service:üîç Extracting metadata with Claude from: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.claude.service:üìä Estimated tokens for request: 4,077 (1 pages)
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-5-20250929 (attempt 1/5, cache=False)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 50.000000 seconds
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 44.000000 seconds
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=2,763, output=248
INFO:app.services.claude.service:üìä Token tracking: Estimated=4,077, Actual=2,763, Diff=-1,314
INFO:app.services.claude.service:üîß Token bucket adjusted: 4,077 ‚Üí 2,763
INFO:app.services.enhanced_extraction_service:‚úì Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.enhanced_extraction_service:üì° Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.enhanced_extraction_service:‚úÖ Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:üì° Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/01.13.2025.2 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.claude.service:üìÑ Standard file (1 pages) - Using STANDARD processing
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763132202335_qum79tu5i
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763132202335_qum79tu5i: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763132202335_qum79tu5i
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìã No carrier-specific prompt for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 16,840 (1 pages)
INFO:app.services.claude.utils:‚úÖ Token bucket reset (60s window)
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-5-20250929 (attempt 1/5, cache=False)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 39.000000 seconds
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 54.000000 seconds
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.claude.service:‚ùå Claude API error (attempt 1/5): Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 8,000 output tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV7ys7rcaFauWVGTiENeg'}
ERROR:app.services.claude.service:   Rate limit error: True, Retriable: True
WARNING:app.services.claude.service:‚ö†Ô∏è  Rate limit hit! Retry-After: 60.00s
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-5-20250929 (attempt 2/5, cache=False)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 57.000000 seconds
INFO:app.api.websocket:Received unknown message type: heartbeat
