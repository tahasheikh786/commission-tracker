(venv) (base) kayttaja@Kayttajas-MacBook-Pro server % uvicorn app.main:app --reload
INFO:     Will watch for changes in these directories: ['/Users/kayttaja/Desktop/commision-tracker/server']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [47537] using StatReload
âœ… Using Render PostgreSQL database
âœ… Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
ğŸŒ CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [47541]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 450 expired/inactive sessions
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1762805414776_hjcda34sa. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1762805414776_hjcda34sa, session_id: session_1762805414814_5mbzbe4kc
INFO:     127.0.0.1:50026 - "WebSocket /api/ws/progress/upload_1762805414776_hjcda34sa?session_id=session_1762805414814_5mbzbe4kc" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1762805414776_hjcda34sa, session_id=session_1762805414814_5mbzbe4kc, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1762805414776_hjcda34sa, session_id: session_1762805414814_5mbzbe4kc
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1762805414776_hjcda34sa
INFO:     127.0.0.1:50032 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:ğŸ“ File: 01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ”‘ Hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49
INFO:app.api.new_extract:ğŸ“ Size: 77177 bytes
INFO:app.api.new_extract:ğŸ‘¤ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ” Checking for user duplicates - Hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ“š Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/c5da3ed6-475c-4b46-8266-7b83ab2eed8d/01.07.2025 UHC Commission Statement.pdf: hash=725348b8b20e1e6c..., status=Approved
INFO:app.services.duplicate_detection_service:  - statements/607ba6c6-2ecf-4966-b7ad-0aad2d2f4a21/8.6.2025.pdf: hash=328b73e57c101b42..., status=approved
INFO:app.services.duplicate_detection_service:âŒ No duplicate found for hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49
INFO:app.api.new_extract:ğŸš€ Starting extract-tables-smart for file: 01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“ File path: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“Š File size: 77177 bytes
INFO:app.api.new_extract:ğŸ†” Upload ID: upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:ğŸ’¾ Saving uploaded file...
INFO:app.api.new_extract:âœ… File saved successfully
INFO:app.api.new_extract:ğŸ“¤ Uploading file to GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File uploaded to GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Successfully uploaded and verified file in GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:Using specified environment ce970b80-0cbc-4861-b6bd-449e1590a99c (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8)
INFO:app.api.new_extract:ğŸ”§ Getting enhanced extraction service...
INFO:app.services.claude.service:ğŸ”„ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:ğŸ”‘ API Key found: sk-ant-api03-Du...
INFO:app.services.claude.service:âœ… Claude API client initialized successfully
INFO:app.services.claude.service:ğŸ“‹ Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:âœ… Semantic Extraction Service initialized
INFO:app.services.claude.service:âœ… Claude Document AI Service initialized
INFO:app.services.claude.service:ğŸ“‹ Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“‹ Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“ Limits: 32MB, 100 pages
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.enhanced_extraction_service:âœ… Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:ğŸ†• PRIMARY: Claude Document AI + GPT-4 AI operations
INFO:app.services.enhanced_extraction_service:ğŸ“‹ FALLBACK services: Lazy-loaded on demand
INFO:app.services.enhanced_extraction_service:â±ï¸  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:ğŸš€ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:âœ… Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:ğŸš€ Starting extraction task...
INFO:app.api.new_extract:ğŸ“Š Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:âœ… Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:âœ… CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ” Starting GPT metadata extraction...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage gpt_metadata_extraction for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting extraction step...
INFO:app.services.enhanced_extraction_service:ğŸ“„ Calling _extract_metadata_with_gpt for file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ” Starting _extract_metadata_with_gpt for file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:Extracting metadata with GPT from first page of pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:ğŸ“„ Opening PDF file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:ğŸ“„ PDF has 1 pages, loading first page
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting first page to image...
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting to PIL Image...
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting to base64...
INFO:app.services.enhanced_extraction_service:âœ… Converted first page to image (359344 chars)
INFO:app.services.enhanced_extraction_service:ğŸ” Checking GPT service availability...
INFO:app.services.enhanced_extraction_service:âœ… GPT-4 service is available
INFO:app.services.enhanced_extraction_service:Calling GPT-4 Vision API for metadata extraction

(venv) (base) kayttaja@Kayttajas-MacBook-Pro server % uvicorn app.main:app --reload
INFO:     Will watch for changes in these directories: ['/Users/kayttaja/Desktop/commision-tracker/server']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [47537] using StatReload
âœ… Using Render PostgreSQL database
âœ… Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
ğŸŒ CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [47541]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 450 expired/inactive sessions
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1762805414776_hjcda34sa. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1762805414776_hjcda34sa, session_id: session_1762805414814_5mbzbe4kc
INFO:     127.0.0.1:50026 - "WebSocket /api/ws/progress/upload_1762805414776_hjcda34sa?session_id=session_1762805414814_5mbzbe4kc" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1762805414776_hjcda34sa, session_id=session_1762805414814_5mbzbe4kc, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1762805414776_hjcda34sa, session_id: session_1762805414814_5mbzbe4kc
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1762805414776_hjcda34sa
INFO:     127.0.0.1:50032 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:ğŸ“ File: 01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ”‘ Hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49
INFO:app.api.new_extract:ğŸ“ Size: 77177 bytes
INFO:app.api.new_extract:ğŸ‘¤ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ” Checking for user duplicates - Hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ“š Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/c5da3ed6-475c-4b46-8266-7b83ab2eed8d/01.07.2025 UHC Commission Statement.pdf: hash=725348b8b20e1e6c..., status=Approved
INFO:app.services.duplicate_detection_service:  - statements/607ba6c6-2ecf-4966-b7ad-0aad2d2f4a21/8.6.2025.pdf: hash=328b73e57c101b42..., status=approved
INFO:app.services.duplicate_detection_service:âŒ No duplicate found for hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49
INFO:app.api.new_extract:ğŸš€ Starting extract-tables-smart for file: 01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“ File path: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“Š File size: 77177 bytes
INFO:app.api.new_extract:ğŸ†” Upload ID: upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:ğŸ’¾ Saving uploaded file...
INFO:app.api.new_extract:âœ… File saved successfully
INFO:app.api.new_extract:ğŸ“¤ Uploading file to GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File uploaded to GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Successfully uploaded and verified file in GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:Using specified environment ce970b80-0cbc-4861-b6bd-449e1590a99c (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8)
INFO:app.api.new_extract:ğŸ”§ Getting enhanced extraction service...
INFO:app.services.claude.service:ğŸ”„ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:ğŸ”‘ API Key found: sk-ant-api03-Du...
INFO:app.services.claude.service:âœ… Claude API client initialized successfully
INFO:app.services.claude.service:ğŸ“‹ Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:âœ… Semantic Extraction Service initialized
INFO:app.services.claude.service:âœ… Claude Document AI Service initialized
INFO:app.services.claude.service:ğŸ“‹ Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“‹ Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“ Limits: 32MB, 100 pages
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.enhanced_extraction_service:âœ… Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:ğŸ†• PRIMARY: Claude Document AI + GPT-4 AI operations
INFO:app.services.enhanced_extraction_service:ğŸ“‹ FALLBACK services: Lazy-loaded on demand
INFO:app.services.enhanced_extraction_service:â±ï¸  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:ğŸš€ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:âœ… Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:ğŸš€ Starting extraction task...
INFO:app.api.new_extract:ğŸ“Š Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:âœ… Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:âœ… CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ” Starting GPT metadata extraction...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage gpt_metadata_extraction for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting extraction step...
INFO:app.services.enhanced_extraction_service:ğŸ“„ Calling _extract_metadata_with_gpt for file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ” Starting _extract_metadata_with_gpt for file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:Extracting metadata with GPT from first page of pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:ğŸ“„ Opening PDF file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:ğŸ“„ PDF has 1 pages, loading first page
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting first page to image...
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting to PIL Image...
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting to base64...
INFO:app.services.enhanced_extraction_service:âœ… Converted first page to image (359344 chars)
INFO:app.services.enhanced_extraction_service:ğŸ” Checking GPT service availability...
INFO:app.services.enhanced_extraction_service:âœ… GPT-4 service is available
INFO:app.services.enhanced_extraction_service:Calling GPT-4 Vision API for metadata extraction
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.enhanced_extraction_service:GPT-4 response: {
  "carrier_name": "ALLIED",
  "carrier_confidence": 0.95,
  "statement_date": "1/8/2025",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.85,
  "evidence": "Carrier name found in the logo at the top left. Statement date labeled as 'Report Date' near the top right. Broker company found under the address section near the top left.",
  "summary": "The document is an ABSF Commission Payment Summary from ALLIED. It is addressed to INNOVATIVE BPS LLC, located at 18111 Preston Rd, Ste 610, Dallas, TX 75252. The report date is 1/8/2025. The document details commission payments for SOAR LOGISTICS LL, with a total amount of $1,027.20. The payment type is EFT. The document includes billing periods, invoice totals, stoploss totals, agent percentages, calculation methods, census counts, and paid amounts."
}
INFO:app.services.extraction_utils:Date normalized: '1/8/2025' -> '2025-01-08'
INFO:app.services.enhanced_extraction_service:âœ… GPT metadata extraction successful: {'success': True, 'carrier_name': 'ALLIED', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.9, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.85, 'summary': 'The document is an ABSF Commission Payment Summary from ALLIED. It is addressed to INNOVATIVE BPS LLC, located at 18111 Preston Rd, Ste 610, Dallas, TX 75252. The report date is 1/8/2025. The document details commission payments for SOAR LOGISTICS LL, with a total amount of $1,027.20. The payment type is EFT. The document includes billing periods, invoice totals, stoploss totals, agent percentages, calculation methods, census counts, and paid amounts.', 'evidence': "Carrier name found in the logo at the top left. Statement date labeled as 'Report Date' near the top right. Broker company found under the address section near the top left.", 'extraction_method': 'gpt4o_vision_first_page'}
INFO:app.services.enhanced_extraction_service:âœ… GPT metadata marked as successful in result
INFO:app.services.enhanced_extraction_service:ğŸ“¤ Sending step progress with metadata...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:âœ… Step progress sent successfully
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/01.13.2025.2 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:Standard file (1 pages, 0.07MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'ALLIED', using standard prompt only
INFO:app.services.claude.service:ğŸ“‹ No carrier-specific prompt for 'ALLIED', using standard prompt only
INFO:app.services.claude.service:Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/3)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:âœ… Claude API call successful. Tokens: {'input_tokens': 4368, 'output_tokens': 723}
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage validation for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage validation for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:ğŸš€ Running enhanced 3-phase extraction pipeline...
INFO:app.services.claude.service:   Phase 1: Document Intelligence âœ“ (completed)
INFO:app.services.claude.service:   Phase 2: Semantic Extraction â†’ Starting...
INFO:app.services.claude.service:   Phase 3: Intelligent Summarization â†’ Pending...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage semantic_analysis for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:ğŸ“Š Phase 2: Semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ” Starting semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 0 writing agents: []
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 4 groups/companies
INFO:app.services.claude.semantic_extractor:âœ… Semantic extraction completed successfully
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage semantic_analysis for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:âœï¸ Phase 3: Intelligent summarization...
INFO:app.services.claude.service:ğŸ“Š Semantic result keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.claude.service:   - Entities: âœ…
INFO:app.services.claude.service:   - Relationships: âœ…
INFO:app.services.claude.service:   - Business Intelligence: âœ…
INFO:app.services.claude.service:ğŸ“ Summary service available: True
INFO:app.services.claude.service:ğŸš€ Calling generate_conversational_summary with use_enhanced=True...
INFO:app.services.conversational_summary_service:ğŸ—£ï¸ Generating conversational summary...
INFO:app.services.conversational_summary_service:ğŸ” _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.conversational_summary_service:âœ… Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:ğŸ¯ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: ['carrier', 'broker', 'writing_agents', 'groups_and_companies', 'document_metadata']
INFO:app.services.conversational_summary_service:   - Relationships: ['carrier_to_broker', 'broker_to_agents', 'agents_to_groups', 'groups_to_payments']
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['total_commission_amount', 'number_of_groups', 'commission_structures', 'top_contributors', 'special_payments', 'payment_period', 'patterns_detected']
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:ğŸš€ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:ğŸš€ Calling Claude API for summary generation...
INFO:app.services.conversational_summary_service:   Model: claude-sonnet-4-20250514
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 8827 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.conversational_summary_service:âœ… Claude API call successful
INFO:app.services.conversational_summary_service:   Response content blocks: 1
INFO:app.services.conversational_summary_service:ğŸ“„ Generated summary length: 618 characters
INFO:app.services.conversational_summary_service:ğŸ“„ Generated summary: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attributed to SOAR LOGISTICS LL, with two larger payments of $419.93 each and two smaller payments of $93.67 each, suggesting a pattern of duplicate or split billing entries for the same client group. The statement notably lacks identified writing agents and uses both Premium Equivalent and percentage-based commission structures, though the specific writing agent managing SOAR LOGISTICS LL is not specified in the document.
INFO:app.services.conversational_summary_service:âœ… Summary generated in 6.76s: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025...
INFO:app.services.claude.service:âœ… Summary generation completed. Success: True
INFO:app.services.claude.service:ğŸ“„ Generated summary (first 200 chars): This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attribut...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:âœ… Enhanced 3-phase pipeline completed successfully
INFO:app.services.claude.service:ğŸ“¦ Enhanced result keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'quality_summary', 'metadata', 'extraction_quality', 'entities', 'relationships', 'business_intelligence', 'summary', 'extraction_pipeline', 'semantic_extraction_success']
INFO:app.services.claude.service:   - Summary length: 618 characters
INFO:app.services.claude.service:   - Summary preview: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 acro...
INFO:app.services.claude.service:âœ… Claude extraction completed in 20.08s
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
ğŸ“ Enhanced multi-strategy stitching: Processing 1 tables
ğŸ“ Canonical header identified: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Table 1 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Found 1 unique header patterns
ğŸ“ Grouped 1 tables into 1 groups
ğŸ“ Merging group 1 with 1 tables
INFO:app.services.extraction_utils:âœ… Merged table created: 4 rows (enhancements preserved from individual tables)
ğŸ“ Merged table 1: 10 headers, 4 rows
ğŸ“ Merged headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ“ Enhanced stitching completed: 1 final tables
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.enhanced_extraction_service:Claude: Verified normalized headers
INFO:app.services.enhanced_extraction_service:Claude: Processed 1 tables into 1 tables
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ¯ STAGE 3: CONVERSATIONAL SUMMARY GENERATION
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   - Enhanced mode enabled: True
INFO:app.services.enhanced_extraction_service:   - Result has 'summary': True
INFO:app.services.enhanced_extraction_service:   - Summary service available: True
INFO:app.services.enhanced_extraction_service:âœ… Using enhanced summary from Claude pipeline
INFO:app.services.enhanced_extraction_service:   Summary length: 618 characters
INFO:app.services.enhanced_extraction_service:   Summary preview: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attribut...
INFO:app.services.enhanced_extraction_service:ğŸ“¤ Sending Claude-generated summary to frontend via WebSocket NOW
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:âœ… Claude-generated summary sent to frontend successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ“ FINAL SUMMARY SELECTION: ENHANCED CONVERSATIONAL
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   Summary length: 618 characters
INFO:app.services.enhanced_extraction_service:   Full summary:
This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attributed to SOAR LOGISTICS LL, with two larger payments of $419.93 each and two smaller payments of $93.67 each, suggesting a pattern of duplicate or split billing entries for the same client group. The statement notably lacks identified writing agents and uses both Premium Equivalent and percentage-based commission structures, though the specific writing agent managing SOAR LOGISTICS LL is not specified in the document.
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage validation for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed processing for upload upload_1762805414776_hjcda34sa in 47.90 seconds
INFO:app.api.new_extract:âœ… Extraction completed successfully: {'success': True, 'tables': [{'headers': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'rows': [['L244338', 'SOAR LOGISTICS LL', '12/1/2024', '12/1/2024', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '4', '$93.67'], ['L244338', 'SOAR LOGISTICS LL', '12/1/2024', '12/1/2024', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '19', '$419.93'], ['L244338', 'SOAR LOGISTICS LL', '1/1/2025', '1/1/2025', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '4', '$93.67'], ['L244338', 'SOAR LOGISTICS LL', '1/1/2025', '1/1/2025', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '19', '$419.93']], 'table_type': 'commission_table', 'page_number': 1, 'confidence_score': 0.98, 'summary_rows': [4, 5], 'metadata': {'total_tables_merged': 1, 'total_rows': 4, 'canonical_header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'merged_from_tables': [0]}, 'header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']}], 'extraction_method': 'claude', 'file_type': 'pdf', 'document_metadata': {'carrier_name': 'Allied Benefit Systems', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.92, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.98, 'total_pages': 1, 'file_size_mb': 0.07360172271728516, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 1027.2, 'total_amount_label': 'Total for Vendor'}, 'extracted_carrier': 'Allied Benefit Systems', 'extracted_date': '2025-01-08', 'quality_summary': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 1.0, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'metadata': {'table_count': 1, 'quality_grade': 'A', 'confidence_score': 0.98, 'token_usage': {'input_tokens': 4368, 'output_tokens': 723}}, 'extraction_quality': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 1.0, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'entities': {'carrier': {'name': 'Allied Benefit Systems', 'confidence': 0.95, 'evidence': 'Document metadata'}, 'broker': {'company_name': 'INNOVATIVE BPS LLC', 'confidence': 0.98, 'evidence': 'Document metadata'}, 'writing_agents': [], 'groups_and_companies': [{'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$93.67'}, {'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$419.93'}, {'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$93.67'}, {'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$419.93'}], 'document_metadata': {'carrier_name': 'Allied Benefit Systems', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.92, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.98, 'total_pages': 1, 'file_size_mb': 0.07360172271728516, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 1027.2, 'total_amount_label': 'Total for Vendor'}}, 'relationships': {'carrier_to_broker': {'carrier': 'Allied Benefit Systems', 'broker': 'INNOVATIVE BPS LLC', 'relationship': 'issues_commission_to'}, 'broker_to_agents': [], 'agents_to_groups': [{'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}], 'groups_to_payments': [{'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}]}, 'business_intelligence': {'total_commission_amount': 'Not specified', 'number_of_groups': 4, 'commission_structures': ['Premium Equivalent', 'Percentage-based'], 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$93.67'}], 'special_payments': [], 'payment_period': '', 'patterns_detected': ['Standard commission structure']}, 'summary': 'This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attributed to SOAR LOGISTICS LL, with two larger payments of $419.93 each and two smaller payments of $93.67 each, suggesting a pattern of duplicate or split billing entries for the same client group. The statement notably lacks identified writing agents and uses both Premium Equivalent and percentage-based commission structures, though the specific writing agent managing SOAR LOGISTICS LL is not specified in the document.', 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:ğŸ’¾ Updating upload record with results...
INFO:app.api.new_extract:âœ… Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8)
INFO:app.api.new_extract:ğŸ¯ Format Learning: Using carrier Allied Benefit Systems with ID 22a632c3-1d14-415a-9411-7e451c18dfde
WARNING:app.api.new_extract:ğŸš¨ CARRIER MISMATCH DETECTED: File uploaded to aa4a116d-b561-4eae-a3cc-7b0bda919685 but extracted as Allied Benefit Systems (22a632c3-1d14-415a-9411-7e451c18dfde)
INFO:app.api.new_extract:ğŸ”„ Reassigning file to correct carrier: Allied Benefit Systems
INFO:app.services.gcs_utils:âœ… File copied in GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf -> statements/22a632c3-1d14-415a-9411-7e451c18dfde/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File deleted from GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/22a632c3-1d14-415a-9411-7e451c18dfde/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… File moved to correct carrier folder in GCS: statements/22a632c3-1d14-415a-9411-7e451c18dfde/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Updated statement upload: carrier_id=22a632c3-1d14-415a-9411-7e451c18dfde, company_id=22a632c3-1d14-415a-9411-7e451c18dfde
INFO:app.api.new_extract:ğŸ“Š Single table detected, using it for field mapping
INFO:app.api.new_extract:ğŸ¯ Using table 0 for field mapping with 10 headers
ğŸ¯ FormatLearningService: Finding matching format for company 22a632c3-1d14-415a-9411-7e451c18dfde
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ FormatLearningService: Headers type: <class 'list'>
ğŸ¯ FormatLearningService: Headers length: 10
ğŸ¯ CRUD: Finding best matching format for company 22a632c3-1d14-415a-9411-7e451c18dfde
ğŸ¯ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD: Input table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ CRUD: Found 2 saved formats for company
ğŸ¯ CRUD: Comparing with saved format:
ğŸ¯ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD:   Header similarity: 0.8
ğŸ¯ CRUD:   Structure similarity: 1.0
ğŸ¯ CRUD:   Total score: 0.8400000000000001
ğŸ¯ CRUD:   -> New best match with score 0.8400000000000001
ğŸ¯ CRUD: Comparing with saved format:
ğŸ¯ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD:   Header similarity: 0.8
ğŸ¯ CRUD:   Structure similarity: 0.0
ğŸ¯ CRUD:   Total score: 0.6400000000000001
ğŸ¯ FormatLearningService: Best match score: 0.8400000000000001
ğŸ¯ FormatLearningService: Found matching format with signature: 434609905947a9e8728df0b79ba381ce
ğŸ¯ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
ğŸ¯ FormatLearningService: Learned table editor settings: {'carrier_name': 'Allied Benefit Systems', 'corrected_carrier_name': 'Allied Benefit Systems', 'statement_date': '2025-01-08', 'corrected_statement_date': '2025-01-08', 'statement_total_amount': 9336.9, 'total_amount_field_name': 'Invoice Total'}
INFO:app.api.new_extract:ğŸ¯ Format Learning: Found matching format with score 0.8400000000000001
INFO:app.api.new_extract:ğŸ¯ Format Learning: Applying corrected carrier name from learned format: Allied Benefit Systems
INFO:app.api.new_extract:ğŸ¯ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:âœ… Total extracted from document_metadata: $1027.20
INFO:app.api.new_extract:ğŸ¯ Format Learning: Total validation result: {'matches': False, 'extracted_amount': 1027.2, 'learned_amount': 9336.9, 'difference': 8309.699999999999, 'difference_percent': 89.0, 'status': 'mismatch', 'tolerance_percent': 5.0}
INFO:app.api.new_extract:ğŸ“Š Added total to document_metadata: $1027.20 (method: document_metadata)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:ğŸ” AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types

(venv) (base) kayttaja@Kayttajas-MacBook-Pro server % uvicorn app.main:app --reload
INFO:     Will watch for changes in these directories: ['/Users/kayttaja/Desktop/commision-tracker/server']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [47537] using StatReload
âœ… Using Render PostgreSQL database
âœ… Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
ğŸŒ CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [47541]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 450 expired/inactive sessions
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1762805414776_hjcda34sa. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1762805414776_hjcda34sa, session_id: session_1762805414814_5mbzbe4kc
INFO:     127.0.0.1:50026 - "WebSocket /api/ws/progress/upload_1762805414776_hjcda34sa?session_id=session_1762805414814_5mbzbe4kc" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1762805414776_hjcda34sa, session_id=session_1762805414814_5mbzbe4kc, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1762805414776_hjcda34sa, session_id: session_1762805414814_5mbzbe4kc
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1762805414776_hjcda34sa
INFO:     127.0.0.1:50032 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:ğŸ“ File: 01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ”‘ Hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49
INFO:app.api.new_extract:ğŸ“ Size: 77177 bytes
INFO:app.api.new_extract:ğŸ‘¤ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ” Checking for user duplicates - Hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ“š Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/c5da3ed6-475c-4b46-8266-7b83ab2eed8d/01.07.2025 UHC Commission Statement.pdf: hash=725348b8b20e1e6c..., status=Approved
INFO:app.services.duplicate_detection_service:  - statements/607ba6c6-2ecf-4966-b7ad-0aad2d2f4a21/8.6.2025.pdf: hash=328b73e57c101b42..., status=approved
INFO:app.services.duplicate_detection_service:âŒ No duplicate found for hash: 3e2ff2652f27d5274b8cb4628997b5717e19d25115be91a37c7aac6c5f287f49
INFO:app.api.new_extract:ğŸš€ Starting extract-tables-smart for file: 01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“ File path: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“Š File size: 77177 bytes
INFO:app.api.new_extract:ğŸ†” Upload ID: upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:ğŸ’¾ Saving uploaded file...
INFO:app.api.new_extract:âœ… File saved successfully
INFO:app.api.new_extract:ğŸ“¤ Uploading file to GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File uploaded to GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Successfully uploaded and verified file in GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:Using specified environment ce970b80-0cbc-4861-b6bd-449e1590a99c (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8)
INFO:app.api.new_extract:ğŸ”§ Getting enhanced extraction service...
INFO:app.services.claude.service:ğŸ”„ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:ğŸ”‘ API Key found: sk-ant-api03-Du...
INFO:app.services.claude.service:âœ… Claude API client initialized successfully
INFO:app.services.claude.service:ğŸ“‹ Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:âœ… Semantic Extraction Service initialized
INFO:app.services.claude.service:âœ… Claude Document AI Service initialized
INFO:app.services.claude.service:ğŸ“‹ Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“‹ Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“ Limits: 32MB, 100 pages
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.enhanced_extraction_service:âœ… Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:ğŸ†• PRIMARY: Claude Document AI + GPT-4 AI operations
INFO:app.services.enhanced_extraction_service:ğŸ“‹ FALLBACK services: Lazy-loaded on demand
INFO:app.services.enhanced_extraction_service:â±ï¸  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:ğŸš€ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:âœ… Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:ğŸš€ Starting extraction task...
INFO:app.api.new_extract:ğŸ“Š Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:âœ… Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:âœ… CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ” Starting GPT metadata extraction...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage gpt_metadata_extraction for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting extraction step...
INFO:app.services.enhanced_extraction_service:ğŸ“„ Calling _extract_metadata_with_gpt for file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:ğŸ” Starting _extract_metadata_with_gpt for file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:Extracting metadata with GPT from first page of pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:ğŸ“„ Opening PDF file: pdfs/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.enhanced_extraction_service:ğŸ“„ PDF has 1 pages, loading first page
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting first page to image...
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting to PIL Image...
INFO:app.services.enhanced_extraction_service:ğŸ–¼ï¸ Converting to base64...
INFO:app.services.enhanced_extraction_service:âœ… Converted first page to image (359344 chars)
INFO:app.services.enhanced_extraction_service:ğŸ” Checking GPT service availability...
INFO:app.services.enhanced_extraction_service:âœ… GPT-4 service is available
INFO:app.services.enhanced_extraction_service:Calling GPT-4 Vision API for metadata extraction
INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.enhanced_extraction_service:GPT-4 response: {
  "carrier_name": "ALLIED",
  "carrier_confidence": 0.95,
  "statement_date": "1/8/2025",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.85,
  "evidence": "Carrier name found in the logo at the top left. Statement date labeled as 'Report Date' near the top right. Broker company found under the address section near the top left.",
  "summary": "The document is an ABSF Commission Payment Summary from ALLIED. It is addressed to INNOVATIVE BPS LLC, located at 18111 Preston Rd, Ste 610, Dallas, TX 75252. The report date is 1/8/2025. The document details commission payments for SOAR LOGISTICS LL, with a total amount of $1,027.20. The payment type is EFT. The document includes billing periods, invoice totals, stoploss totals, agent percentages, calculation methods, census counts, and paid amounts."
}
INFO:app.services.extraction_utils:Date normalized: '1/8/2025' -> '2025-01-08'
INFO:app.services.enhanced_extraction_service:âœ… GPT metadata extraction successful: {'success': True, 'carrier_name': 'ALLIED', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.9, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.85, 'summary': 'The document is an ABSF Commission Payment Summary from ALLIED. It is addressed to INNOVATIVE BPS LLC, located at 18111 Preston Rd, Ste 610, Dallas, TX 75252. The report date is 1/8/2025. The document details commission payments for SOAR LOGISTICS LL, with a total amount of $1,027.20. The payment type is EFT. The document includes billing periods, invoice totals, stoploss totals, agent percentages, calculation methods, census counts, and paid amounts.', 'evidence': "Carrier name found in the logo at the top left. Statement date labeled as 'Report Date' near the top right. Broker company found under the address section near the top left.", 'extraction_method': 'gpt4o_vision_first_page'}
INFO:app.services.enhanced_extraction_service:âœ… GPT metadata marked as successful in result
INFO:app.services.enhanced_extraction_service:ğŸ“¤ Sending step progress with metadata...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:âœ… Step progress sent successfully
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/01.13.2025.2 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:Standard file (1 pages, 0.07MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'ALLIED', using standard prompt only
INFO:app.services.claude.service:ğŸ“‹ No carrier-specific prompt for 'ALLIED', using standard prompt only
INFO:app.services.claude.service:Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/3)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:âœ… Claude API call successful. Tokens: {'input_tokens': 4368, 'output_tokens': 723}
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage validation for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage validation for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:ğŸš€ Running enhanced 3-phase extraction pipeline...
INFO:app.services.claude.service:   Phase 1: Document Intelligence âœ“ (completed)
INFO:app.services.claude.service:   Phase 2: Semantic Extraction â†’ Starting...
INFO:app.services.claude.service:   Phase 3: Intelligent Summarization â†’ Pending...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage semantic_analysis for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:ğŸ“Š Phase 2: Semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ” Starting semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 0 writing agents: []
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 4 groups/companies
INFO:app.services.claude.semantic_extractor:âœ… Semantic extraction completed successfully
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage semantic_analysis for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:âœï¸ Phase 3: Intelligent summarization...
INFO:app.services.claude.service:ğŸ“Š Semantic result keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.claude.service:   - Entities: âœ…
INFO:app.services.claude.service:   - Relationships: âœ…
INFO:app.services.claude.service:   - Business Intelligence: âœ…
INFO:app.services.claude.service:ğŸ“ Summary service available: True
INFO:app.services.claude.service:ğŸš€ Calling generate_conversational_summary with use_enhanced=True...
INFO:app.services.conversational_summary_service:ğŸ—£ï¸ Generating conversational summary...
INFO:app.services.conversational_summary_service:ğŸ” _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.conversational_summary_service:âœ… Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:ğŸ¯ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: ['carrier', 'broker', 'writing_agents', 'groups_and_companies', 'document_metadata']
INFO:app.services.conversational_summary_service:   - Relationships: ['carrier_to_broker', 'broker_to_agents', 'agents_to_groups', 'groups_to_payments']
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['total_commission_amount', 'number_of_groups', 'commission_structures', 'top_contributors', 'special_payments', 'payment_period', 'patterns_detected']
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:ğŸš€ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:ğŸš€ Calling Claude API for summary generation...
INFO:app.services.conversational_summary_service:   Model: claude-sonnet-4-20250514
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 8827 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.conversational_summary_service:âœ… Claude API call successful
INFO:app.services.conversational_summary_service:   Response content blocks: 1
INFO:app.services.conversational_summary_service:ğŸ“„ Generated summary length: 618 characters
INFO:app.services.conversational_summary_service:ğŸ“„ Generated summary: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attributed to SOAR LOGISTICS LL, with two larger payments of $419.93 each and two smaller payments of $93.67 each, suggesting a pattern of duplicate or split billing entries for the same client group. The statement notably lacks identified writing agents and uses both Premium Equivalent and percentage-based commission structures, though the specific writing agent managing SOAR LOGISTICS LL is not specified in the document.
INFO:app.services.conversational_summary_service:âœ… Summary generated in 6.76s: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025...
INFO:app.services.claude.service:âœ… Summary generation completed. Success: True
INFO:app.services.claude.service:ğŸ“„ Generated summary (first 200 chars): This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attribut...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1762805414776_hjcda34sa
INFO:app.services.claude.service:âœ… Enhanced 3-phase pipeline completed successfully
INFO:app.services.claude.service:ğŸ“¦ Enhanced result keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'quality_summary', 'metadata', 'extraction_quality', 'entities', 'relationships', 'business_intelligence', 'summary', 'extraction_pipeline', 'semantic_extraction_success']
INFO:app.services.claude.service:   - Summary length: 618 characters
INFO:app.services.claude.service:   - Summary preview: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 acro...
INFO:app.services.claude.service:âœ… Claude extraction completed in 20.08s
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
ğŸ“ Enhanced multi-strategy stitching: Processing 1 tables
ğŸ“ Canonical header identified: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Table 1 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Found 1 unique header patterns
ğŸ“ Grouped 1 tables into 1 groups
ğŸ“ Merging group 1 with 1 tables
INFO:app.services.extraction_utils:âœ… Merged table created: 4 rows (enhancements preserved from individual tables)
ğŸ“ Merged table 1: 10 headers, 4 rows
ğŸ“ Merged headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ“ Enhanced stitching completed: 1 final tables
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.enhanced_extraction_service:Claude: Verified normalized headers
INFO:app.services.enhanced_extraction_service:Claude: Processed 1 tables into 1 tables
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ¯ STAGE 3: CONVERSATIONAL SUMMARY GENERATION
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   - Enhanced mode enabled: True
INFO:app.services.enhanced_extraction_service:   - Result has 'summary': True
INFO:app.services.enhanced_extraction_service:   - Summary service available: True
INFO:app.services.enhanced_extraction_service:âœ… Using enhanced summary from Claude pipeline
INFO:app.services.enhanced_extraction_service:   Summary length: 618 characters
INFO:app.services.enhanced_extraction_service:   Summary preview: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attribut...
INFO:app.services.enhanced_extraction_service:ğŸ“¤ Sending Claude-generated summary to frontend via WebSocket NOW
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.enhanced_extraction_service:âœ… Claude-generated summary sent to frontend successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ“ FINAL SUMMARY SELECTION: ENHANCED CONVERSATIONAL
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   Summary length: 618 characters
INFO:app.services.enhanced_extraction_service:   Full summary:
This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attributed to SOAR LOGISTICS LL, with two larger payments of $419.93 each and two smaller payments of $93.67 each, suggesting a pattern of duplicate or split billing entries for the same client group. The statement notably lacks identified writing agents and uses both Premium Equivalent and percentage-based commission structures, though the specific writing agent managing SOAR LOGISTICS LL is not specified in the document.
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Started stage validation for upload upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Completed processing for upload upload_1762805414776_hjcda34sa in 47.90 seconds
INFO:app.api.new_extract:âœ… Extraction completed successfully: {'success': True, 'tables': [{'headers': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'rows': [['L244338', 'SOAR LOGISTICS LL', '12/1/2024', '12/1/2024', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '4', '$93.67'], ['L244338', 'SOAR LOGISTICS LL', '12/1/2024', '12/1/2024', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '19', '$419.93'], ['L244338', 'SOAR LOGISTICS LL', '1/1/2025', '1/1/2025', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '4', '$93.67'], ['L244338', 'SOAR LOGISTICS LL', '1/1/2025', '1/1/2025', '$9,336.90', '$3,514.94', '6%', 'Premium Equivalent', '19', '$419.93']], 'table_type': 'commission_table', 'page_number': 1, 'confidence_score': 0.98, 'summary_rows': [4, 5], 'metadata': {'total_tables_merged': 1, 'total_rows': 4, 'canonical_header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'merged_from_tables': [0]}, 'header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']}], 'extraction_method': 'claude', 'file_type': 'pdf', 'document_metadata': {'carrier_name': 'Allied Benefit Systems', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.92, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.98, 'total_pages': 1, 'file_size_mb': 0.07360172271728516, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 1027.2, 'total_amount_label': 'Total for Vendor'}, 'extracted_carrier': 'Allied Benefit Systems', 'extracted_date': '2025-01-08', 'quality_summary': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 1.0, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'metadata': {'table_count': 1, 'quality_grade': 'A', 'confidence_score': 0.98, 'token_usage': {'input_tokens': 4368, 'output_tokens': 723}}, 'extraction_quality': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 1.0, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'entities': {'carrier': {'name': 'Allied Benefit Systems', 'confidence': 0.95, 'evidence': 'Document metadata'}, 'broker': {'company_name': 'INNOVATIVE BPS LLC', 'confidence': 0.98, 'evidence': 'Document metadata'}, 'writing_agents': [], 'groups_and_companies': [{'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$93.67'}, {'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$419.93'}, {'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$93.67'}, {'group_name': 'SOAR LOGISTICS LL', 'group_number': None, 'paid_amount': '$419.93'}], 'document_metadata': {'carrier_name': 'Allied Benefit Systems', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.92, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.98, 'total_pages': 1, 'file_size_mb': 0.07360172271728516, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 1027.2, 'total_amount_label': 'Total for Vendor'}}, 'relationships': {'carrier_to_broker': {'carrier': 'Allied Benefit Systems', 'broker': 'INNOVATIVE BPS LLC', 'relationship': 'issues_commission_to'}, 'broker_to_agents': [], 'agents_to_groups': [{'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'SOAR LOGISTICS LL', 'relationship': 'manages'}], 'groups_to_payments': [{'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}]}, 'business_intelligence': {'total_commission_amount': 'Not specified', 'number_of_groups': 4, 'commission_structures': ['Premium Equivalent', 'Percentage-based'], 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$93.67'}], 'special_payments': [], 'payment_period': '', 'patterns_detected': ['Standard commission structure']}, 'summary': 'This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attributed to SOAR LOGISTICS LL, with two larger payments of $419.93 each and two smaller payments of $93.67 each, suggesting a pattern of duplicate or split billing entries for the same client group. The statement notably lacks identified writing agents and uses both Premium Equivalent and percentage-based commission structures, though the specific writing agent managing SOAR LOGISTICS LL is not specified in the document.', 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:ğŸ’¾ Updating upload record with results...
INFO:app.api.new_extract:âœ… Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8)
INFO:app.api.new_extract:ğŸ¯ Format Learning: Using carrier Allied Benefit Systems with ID 22a632c3-1d14-415a-9411-7e451c18dfde
WARNING:app.api.new_extract:ğŸš¨ CARRIER MISMATCH DETECTED: File uploaded to aa4a116d-b561-4eae-a3cc-7b0bda919685 but extracted as Allied Benefit Systems (22a632c3-1d14-415a-9411-7e451c18dfde)
INFO:app.api.new_extract:ğŸ”„ Reassigning file to correct carrier: Allied Benefit Systems
INFO:app.services.gcs_utils:âœ… File copied in GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf -> statements/22a632c3-1d14-415a-9411-7e451c18dfde/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File deleted from GCS: statements/3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/22a632c3-1d14-415a-9411-7e451c18dfde/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… File moved to correct carrier folder in GCS: statements/22a632c3-1d14-415a-9411-7e451c18dfde/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Updated statement upload: carrier_id=22a632c3-1d14-415a-9411-7e451c18dfde, company_id=22a632c3-1d14-415a-9411-7e451c18dfde
INFO:app.api.new_extract:ğŸ“Š Single table detected, using it for field mapping
INFO:app.api.new_extract:ğŸ¯ Using table 0 for field mapping with 10 headers
ğŸ¯ FormatLearningService: Finding matching format for company 22a632c3-1d14-415a-9411-7e451c18dfde
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ FormatLearningService: Headers type: <class 'list'>
ğŸ¯ FormatLearningService: Headers length: 10
ğŸ¯ CRUD: Finding best matching format for company 22a632c3-1d14-415a-9411-7e451c18dfde
ğŸ¯ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD: Input table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ CRUD: Found 2 saved formats for company
ğŸ¯ CRUD: Comparing with saved format:
ğŸ¯ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD:   Header similarity: 0.8
ğŸ¯ CRUD:   Structure similarity: 1.0
ğŸ¯ CRUD:   Total score: 0.8400000000000001
ğŸ¯ CRUD:   -> New best match with score 0.8400000000000001
ğŸ¯ CRUD: Comparing with saved format:
ğŸ¯ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD:   Header similarity: 0.8
ğŸ¯ CRUD:   Structure similarity: 0.0
ğŸ¯ CRUD:   Total score: 0.6400000000000001
ğŸ¯ FormatLearningService: Best match score: 0.8400000000000001
ğŸ¯ FormatLearningService: Found matching format with signature: 434609905947a9e8728df0b79ba381ce
ğŸ¯ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
ğŸ¯ FormatLearningService: Learned table editor settings: {'carrier_name': 'Allied Benefit Systems', 'corrected_carrier_name': 'Allied Benefit Systems', 'statement_date': '2025-01-08', 'corrected_statement_date': '2025-01-08', 'statement_total_amount': 9336.9, 'total_amount_field_name': 'Invoice Total'}
INFO:app.api.new_extract:ğŸ¯ Format Learning: Found matching format with score 0.8400000000000001
INFO:app.api.new_extract:ğŸ¯ Format Learning: Applying corrected carrier name from learned format: Allied Benefit Systems
INFO:app.api.new_extract:ğŸ¯ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:âœ… Total extracted from document_metadata: $1027.20
INFO:app.api.new_extract:ğŸ¯ Format Learning: Total validation result: {'matches': False, 'extracted_amount': 1027.2, 'learned_amount': 9336.9, 'difference': 8309.699999999999, 'difference_percent': 89.0, 'status': 'mismatch', 'tolerance_percent': 5.0}
INFO:app.api.new_extract:ğŸ“Š Added total to document_metadata: $1027.20 (method: document_metadata)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:ğŸ” AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:âœ… AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:ğŸ§  AI Field Mapping: Starting field mapping during extraction
INFO:app.api.ai_intelligent_mapping:ğŸš€ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ğŸ¤– AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:ğŸ” AI Mapping: carrier_id provided: True (value: 22a632c3-1d14-415a-9411-7e451c18dfde)
INFO:app.services.ai_field_mapping_service:ğŸ¯ Carrier ID is valid, attempting to retrieve learned mapping for carrier 22a632c3-1d14-415a-9411-7e451c18dfde
INFO:app.services.ai_field_mapping_service:ğŸ” Generated format signature for lookup: 434609905947a9e8728df0b79ba381ce
INFO:app.services.ai_field_mapping_service:ğŸ” Looking up learned format for carrier 22a632c3-1d14-415a-9411-7e451c18dfde with 10 headers
INFO:app.services.ai_field_mapping_service:âœ… Found EXACT match for learned format with signature 434609905947a9e8728df0b79ba381ce
INFO:app.services.ai_field_mapping_service:âœ… Learned field mapping has 10 mappings
INFO:app.services.ai_field_mapping_service:ğŸ¯ Found learned mapping for carrier with 1.00 confidence
INFO:app.services.ai_field_mapping_service:ğŸ¯ Using learned mappings directly with match score 1.0
INFO:app.services.ai_field_mapping_service:âœ… Learned field_mapping contains 10 mappings
INFO:app.services.ai_field_mapping_service:âœ… Applied 10 learned mappings directly - returning early
INFO:app.services.ai_field_mapping_service:âœ… Response includes learned_format_used=True flag
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:âœ… Enhanced AI Analysis Complete: Overall confidence 0.93
INFO:app.api.new_extract:âœ… AI Field Mapping: 10 mappings with 0.95 confidence
INFO:app.api.new_extract:âœ… Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is  an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total vendor payment of $1,027.20 across 4 commission entries. All payments are attributed to SOAR LOGISTICS LL, with two larger payments of $419.93 each and two smaller payments of $93.67 each, suggesting a pattern of duplicate or split billing entries for the same client group. The statement notably lacks identified writing agents and uses both Premium Equivalent and percentage-based commission structures, though the specific writing agent managing SOAR LOGISTICS LL is not specified in the document.
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8)
INFO:app.api.new_extract:ğŸ“¤ Sending pre-generated enhanced summary via WebSocket...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762805414776_hjcda34sa: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762805414776_hjcda34sa
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1762805414776_hjcda34sa
INFO:app.api.new_extract:âœ… Extraction complete! Sent results via WebSocket for upload_id: upload_1762805414776_hjcda34sa
INFO:     127.0.0.1:50380 - "OPTIONS /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:50034 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1762805414776_hjcda34sa, session_id=session_1762805414814_5mbzbe4kc
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1762805414776_hjcda34sa, session_id=session_1762805414814_5mbzbe4kc
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1762805414776_hjcda34sa
INFO:app.api.auto_approval:Auto-approval started for upload 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8
INFO:app.services.websocket_service:Broadcasting message to upload_id 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 3ae5ef1d-090a-4c70-a63c-04a1e8a3b9c8


