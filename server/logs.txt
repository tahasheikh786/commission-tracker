 'LUDICROUS SPEED LOGI', 'amount': '1389.84'}, {'name': 'SITIJI IN', 'amount': '1130.33'}], 'commission_structure': 'Percentage-based'}, 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1762984467706_6t83gdc10
INFO:app.api.new_extract:üíæ Updating upload record with results...
INFO:app.api.new_extract:‚úÖ Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: 2e496f0f-585c-4195-9de1-5b4aa4755b3d)
INFO:app.api.new_extract:üéØ Format Learning: Using carrier ALLIED with ID 4488bb05-bd57-458c-915c-4de65619610d
WARNING:app.api.new_extract:üö® CARRIER MISMATCH DETECTED: File uploaded to 44489a43-9b71-4b79-a216-a14c90bef851 but extracted as ALLIED (4488bb05-bd57-458c-915c-4de65619610d)
INFO:app.api.new_extract:üîÑ Reassigning file to correct carrier: ALLIED
INFO:app.services.gcs_utils:‚úÖ File copied in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf -> statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ File deleted from GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.new_extract:‚úÖ File moved to correct carrier folder in GCS: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.new_extract:‚úÖ Updated statement upload: carrier_id=4488bb05-bd57-458c-915c-4de65619610d, company_id=4488bb05-bd57-458c-915c-4de65619610d
INFO:app.api.new_extract:üìä Single table detected, using it for field mapping
INFO:app.api.new_extract:üéØ Using table 0 for field mapping with 10 headers
üéØ FormatLearningService: Finding matching format for company 4488bb05-bd57-458c-915c-4de65619610d
üéØ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ FormatLearningService: Table structure: {'row_count': 33, 'column_count': 10, 'has_financial_data': True}
üéØ FormatLearningService: Headers type: <class 'list'>
üéØ FormatLearningService: Headers length: 10
üéØ CRUD: Finding best matching format for company 4488bb05-bd57-458c-915c-4de65619610d
üéØ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD: Input table structure: {'row_count': 33, 'column_count': 10, 'has_financial_data': True}
üéØ CRUD: Found 1 saved formats for company
üéØ CRUD: Comparing with saved format:
üéØ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD:   Header similarity: 0.7200000000000001
üéØ CRUD:   Structure similarity: 1.0
üéØ CRUD:   Total score: 0.776
üéØ CRUD:   -> New best match with score 0.776
üéØ FormatLearningService: Best match score: 0.776
üéØ FormatLearningService: Found matching format with signature: 434609905947a9e8728df0b79ba381ce
üéØ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üéØ FormatLearningService: Learned table editor settings: {'carrier_name': 'ALLIED', 'corrected_carrier_name': 'ALLIED', 'statement_date': '2025-01-08', 'corrected_statement_date': '2025-01-08', 'statement_total_amount': 9336.9, 'total_amount_field_name': 'Invoice Total'}
INFO:app.api.new_extract:üéØ Format Learning: Found matching format with score 0.776
INFO:app.api.new_extract:üéØ Format Learning: Applying corrected carrier name from learned format: ALLIED
INFO:app.api.new_extract:üéØ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:‚úÖ Total extracted from document_metadata: $3604.95
INFO:app.api.new_extract:üéØ Format Learning: Total validation result: {'matches': False, 'extracted_amount': 3604.95, 'learned_amount': 9336.9, 'difference': 5731.95, 'difference_percent': 61.39, 'status': 'mismatch', 'tolerance_percent': 5.0}
INFO:app.api.new_extract:üìä Added total to document_metadata: $3604.95 (method: document_metadata)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:üîç AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:‚úÖ AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1762984467706_6t83gdc10
INFO:app.api.new_extract:üß† AI Field Mapping: Starting field mapping during extraction
INFO:app.api.ai_intelligent_mapping:üöÄ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ü§ñ AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:üîç AI Mapping: carrier_id provided: True (value: 4488bb05-bd57-458c-915c-4de65619610d)
INFO:app.services.ai_field_mapping_service:üéØ Carrier ID is valid, attempting to retrieve learned mapping for carrier 4488bb05-bd57-458c-915c-4de65619610d
INFO:app.services.ai_field_mapping_service:üîç Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:üîç Looking up learned format for carrier 4488bb05-bd57-458c-915c-4de65619610d with 10 headers
INFO:app.services.ai_field_mapping_service:‚ùå No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:üîç Found 1 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:üîç Format signature 434609905947a9e8728df0b79ba381ce: similarity = 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ New best match with similarity 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ Found similar format with 0.72 similarity score
INFO:app.services.ai_field_mapping_service:üéØ Found learned mapping for carrier with 0.72 confidence
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:‚úÖ AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:‚úÖ AI Mapping: Generated 10 mappings with 0.92 confidence
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:‚úÖ Enhanced AI Analysis Complete: Overall confidence 0.91
INFO:app.api.new_extract:‚úÖ AI Field Mapping: 10 mappings with 0.92 confidence
INFO:app.api.new_extract:‚úÖ Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is This is an Allied commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 in net commissions across a substantial portfolio of 10 unique companies with multiple line items. PRIDE DELIVERY SERVIC dominates the portfolio with $2,318.37 in net commissions (64% of total) from three separate transactions, followed by LUDICROUS SPEED LOGI contributing $1,389.84 net from five transactions, and SITIJI IN generating $1,130.33 net despite having both positive and negative adjustments across ten line items. The statement reveals significant commission volatility with numerous negative adjustments, particularly affecting BTK RUSH IN (five consecutive deductions of $61.08 each totaling -$305.40), FUZION EXPRESS LL (net loss of -$514.61), and several other transportation and logistics companies, suggesting either premium adjustments, policy cancellations, or billing corrections across this logistics-focused client base.
INFO:app.api.new_extract:   Structured data: {'carrier_name': 'ALLIED', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-08-06', 'total_amount': '3604.95', 'company_count': '10', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'PRIDE DELIVERY SERVIC', 'amount': '2318.37'}, {'name': 'LUDICROUS SPEED LOGI', 'amount': '1389.84'}, {'name': 'SITIJI IN', 'amount': '1130.33'}], 'commission_structure': 'Percentage-based'}
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 2e496f0f-585c-4195-9de1-5b4aa4755b3d)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {"carrier_name": "ALLIED", "broker_company": "INNOVATIVE BPS LLC", "statement_date": "2025-08-06", "total_amount": "3604.95", "company_count": "10", "broker_id_confidence": 0.7, "top_contributors": [{...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1762984467706_6t83gdc10
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1762984467706_6t83gdc10
INFO:     127.0.0.1:57978 - "OPTIONS /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:57386 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1762984467706_6t83gdc10, session_id=session_1762984467730_5n4y9fnao
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1762984467706_6t83gdc10, session_id=session_1762984467730_5n4y9fnao
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1762984467706_6t83gdc10
INFO:app.api.auto_approval:Auto-approval started for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:üîç Auto-approval: Filtered 1 tables to 1 commission tables for saving
INFO:app.api.auto_approval:ü§ñ Auto-approval: Raw field_mapping from learned format: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
INFO:app.api.auto_approval:ü§ñ Auto-approval: Using 10 field mappings from learned format
INFO:app.api.auto_approval:ü§ñ Auto-approval: Field config list: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Saving edited tables for upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.table_editor:üéØ Table Editor API: Tables count: 1
INFO:app.api.table_editor:üéØ Table Editor API: Selected statement date: {'date': '2025-08-06'}
INFO:app.api.table_editor:üéØ Table Editor API: Company ID: 4488bb05-bd57-458c-915c-4de65619610d
INFO:app.api.table_editor:üéØ Table Editor API: Field config received: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:üéØ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:üéØ Table Editor API: Updating upload with tables, statement date, and carrier
üéØ CRUD: update_upload_tables called for upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üéØ CRUD: Tables data length: 1
üéØ CRUD: Selected statement date: {'date': '2025-08-06'}
üéØ CRUD: Carrier ID: None
üéØ CRUD: Found upload, updating with tables, statement date, and carrier
üéØ CRUD: Saved selected statement date to database: {'date': '2025-08-06'}
üéØ CRUD: Statement date type: <class 'dict'>
üéØ CRUD: Statement date keys: ['date']
üéØ CRUD: Also saved statement date and carrier to progress_data
üéØ CRUD: Successfully updated upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d with tables, statement date, and carrier
üéØ CRUD: Final selected_statement_date in database: {'date': '2025-08-06'}
INFO:app.api.table_editor:üéØ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:üéØ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:üéØ Table Editor API: Successfully saved 1 edited tables
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:Updated format learning usage count for signature: 434609905947a9e8728df0b79ba381ce
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üíæ Saving statement review: upload_id=2e496f0f-585c-4195-9de1-5b4aa4755b3d, status=Approved
üìã Field config being saved: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
üìä Final data rows: 1
üìÖ Selected statement date being saved: {'date': '2025-08-06'}
üîç DEBUG Saving table 0 'Table 1': summaryRows=[], type=<class 'list'>
üìù Extracted field_mapping with 10 mappings: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üí∞ Calculating extracted_total for manual approval...
üí∞ field_mapping keys: ['Agent %', 'Group No.', 'Census Ct.', 'Group Name', 'Adj. Period', 'Paid Amount', 'Invoice Total', 'Billing Period', 'Stoploss Total', 'Calculation Method']
üí∞ Number of tables in final_data: 1
üí∞ Found commission field (EXACT MATCH): Paid Amount -> Commission Earned
üí∞ Final commission_source_field: Paid Amount
  üìä Table 0: 10 headers, 33 rows
  üìã Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  üìã First row sample: ['L213059', 'BOLT LOGISTIC', '8/1/2025', '7/1/2025', '($627.27)', '($266.05)', '22.5%', 'Premium Equivalent', '-1', '($141.14)']
  üí∞ Table 0: Commission column 'Paid Amount' at index 9
    Row 0: [LIST] raw_value = '($141.14)' (type: <class 'str'>)
    Row 0: Added $-141.14 (running total: $-141.14)
    Row 1: [LIST] raw_value = '($552.73)' (type: <class 'str'>)
    Row 1: Added $-552.73 (running total: $-693.87)
    Row 2: [LIST] raw_value = '$38.12' (type: <class 'str'>)
    Row 2: Added $38.12 (running total: $-655.75)
    Row 3: [LIST] raw_value = '$159.51' (type: <class 'str'>)
    Row 3: Added $159.51 (running total: $-496.24)
    Row 4: [LIST] raw_value = '$122.04' (type: <class 'str'>)
    Row 4: Added $122.04 (running total: $-374.20)
    Row 5: [LIST] raw_value = '$244.08' (type: <class 'str'>)
    Row 5: Added $244.08 (running total: $-130.12)
    Row 6: [LIST] raw_value = '$925.23' (type: <class 'str'>)
    Row 6: Added $925.23 (running total: $795.11)
    Row 7: [LIST] raw_value = '($61.02)' (type: <class 'str'>)
    Row 7: Added $-61.02 (running total: $734.09)
    Row 8: [LIST] raw_value = '$68.68' (type: <class 'str'>)
    Row 8: Added $68.68 (running total: $802.77)
    Row 9: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 9: Added $58.62 (running total: $861.39)
    Row 10: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 10: Added $-61.14 (running total: $800.25)
    Row 11: [LIST] raw_value = '$132.52' (type: <class 'str'>)
    Row 11: Added $132.52 (running total: $932.77)
    Row 12: [LIST] raw_value = '$163.29' (type: <class 'str'>)
    Row 12: Added $163.29 (running total: $1096.06)
    Row 13: [LIST] raw_value = '$221.70' (type: <class 'str'>)
    Row 13: Added $221.70 (running total: $1317.76)
    Row 14: [LIST] raw_value = '$724.20' (type: <class 'str'>)
    Row 14: Added $724.20 (running total: $2041.96)
    Row 15: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 15: Added $58.62 (running total: $2100.58)
    Row 16: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 16: Added $-61.14 (running total: $2039.44)
    Row 17: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 17: Added $58.62 (running total: $2098.06)
    Row 18: [LIST] raw_value = '($15.28)' (type: <class 'str'>)
    Row 18: Added $-15.28 (running total: $2082.78)
    Row 19: [LIST] raw_value = '($147.19)' (type: <class 'str'>)
    Row 19: Added $-147.19 (running total: $1935.59)
    Row 20: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 20: Added $-61.08 (running total: $1874.51)
    Row 21: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 21: Added $-61.08 (running total: $1813.43)
    Row 22: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 22: Added $-61.08 (running total: $1752.35)
    Row 23: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 23: Added $-61.08 (running total: $1691.27)
    Row 24: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 24: Added $-61.08 (running total: $1630.19)
    Row 25: [LIST] raw_value = '($87.66)' (type: <class 'str'>)
    Row 25: Added $-87.66 (running total: $1542.53)
    Row 26: [LIST] raw_value = '($87.66)' (type: <class 'str'>)
    Row 26: Added $-87.66 (running total: $1454.87)
    Row 27: [LIST] raw_value = '($31.29)' (type: <class 'str'>)
    Row 27: Added $-31.29 (running total: $1423.58)
    Row 28: [LIST] raw_value = '($81.68)' (type: <class 'str'>)
    Row 28: Added $-81.68 (running total: $1341.90)
    Row 29: [LIST] raw_value = '$97.20' (type: <class 'str'>)
    Row 29: Added $97.20 (running total: $1439.10)
    Row 30: [LIST] raw_value = '$1,194.57' (type: <class 'str'>)
    Row 30: Added $1194.57 (running total: $2633.67)
    Row 31: [LIST] raw_value = '($132.73)' (type: <class 'str'>)
    Row 31: Added $-132.73 (running total: $2500.94)
    Row 32: [LIST] raw_value = '$1,256.53' (type: <class 'str'>)
    Row 32: Added $1256.53 (running total: $3757.47)
  ‚úÖ Table 0 total: $3757.47
üí∞ Final extracted_total: $3757.47
üí∞ Calculating extracted_invoice_total for manual approval...
üí∞ Found invoice field (exact match): Invoice Total -> Invoice Total
  üìä Table 0: 10 headers, 33 rows
  üìã Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  üìã First row sample: ['L213059', 'BOLT LOGISTIC', '8/1/2025', '7/1/2025', '($627.27)', '($266.05)', '22.5%', 'Premium Equivalent', '-1', '($141.14)']
  üí∞ Table 0: Invoice column 'Invoice Total' at index 4
    Row 0: [LIST] invoice_value = '($627.27)'
    Row 0: Added $-627.27 to invoice (running total: $-627.27)
    Row 1: [LIST] invoice_value = '$4,806.13'
    Row 1: Added $4806.13 to invoice (running total: $4178.86)
    Row 2: [LIST] invoice_value = '($331.46)'
    Row 2: Added $-331.46 to invoice (running total: $3847.40)
    Row 3: [LIST] invoice_value = '$547.17'
    Row 3: Added $547.17 to invoice (running total: $4394.57)
    Row 4: [LIST] invoice_value = '$7,173.86'
    Row 4: Added $7173.86 to invoice (running total: $11568.43)
    Row 5: [LIST] invoice_value = '$7,173.86'
    Row 5: Added $7173.86 to invoice (running total: $18742.29)
    Row 6: [LIST] invoice_value = '$7,173.86'
    Row 6: Added $7173.86 to invoice (running total: $25916.15)
    Row 7: [LIST] invoice_value = '$547.17'
    Row 7: Added $547.17 to invoice (running total: $26463.32)
    Row 8: [LIST] invoice_value = '$443.10'
    Row 8: Added $443.10 to invoice (running total: $26906.42)
    Row 9: [LIST] invoice_value = '($14.36)'
    Row 9: Added $-14.36 to invoice (running total: $26892.06)
    Row 10: [LIST] invoice_value = '$407.91'
    Row 10: Added $407.91 to invoice (running total: $27299.97)
    Row 11: [LIST] invoice_value = '$407.91'
    Row 11: Added $407.91 to invoice (running total: $27707.88)
    Row 12: [LIST] invoice_value = '$6,338.06'
    Row 12: Added $6338.06 to invoice (running total: $34045.94)
    Row 13: [LIST] invoice_value = '$6,338.06'
    Row 13: Added $6338.06 to invoice (running total: $40384.00)
    Row 14: [LIST] invoice_value = '$6,338.06'
    Row 14: Added $6338.06 to invoice (running total: $46722.06)
    Row 15: [LIST] invoice_value = '($14.36)'
    Row 15: Added $-14.36 to invoice (running total: $46707.70)
    Row 16: [LIST] invoice_value = '($14.36)'
    Row 16: Added $-14.36 to invoice (running total: $46693.34)
    Row 17: [LIST] invoice_value = '($14.36)'
    Row 17: Added $-14.36 to invoice (running total: $46678.98)
    Row 18: [LIST] invoice_value = '($928.34)'
    Row 18: Added $-928.34 to invoice (running total: $45750.64)
    Row 19: [LIST] invoice_value = '($928.34)'
    Row 19: Added $-928.34 to invoice (running total: $44822.30)
    Row 20: [LIST] invoice_value = '($297.96)'
    Row 20: Added $-297.96 to invoice (running total: $44524.34)
    Row 21: [LIST] invoice_value = '($297.96)'
    Row 21: Added $-297.96 to invoice (running total: $44226.38)
    Row 22: [LIST] invoice_value = '($297.96)'
    Row 22: Added $-297.96 to invoice (running total: $43928.42)
    Row 23: [LIST] invoice_value = '($297.96)'
    Row 23: Added $-297.96 to invoice (running total: $43630.46)
    Row 24: [LIST] invoice_value = '($297.96)'
    Row 24: Added $-297.96 to invoice (running total: $43332.50)
    Row 25: [LIST] invoice_value = '($974.10)'
    Row 25: Added $-974.10 to invoice (running total: $42358.40)
    Row 26: [LIST] invoice_value = '($974.10)'
    Row 26: Added $-974.10 to invoice (running total: $41384.30)
    Row 27: [LIST] invoice_value = '($298.00)'
    Row 27: Added $-298.00 to invoice (running total: $41086.30)
    Row 28: [LIST] invoice_value = '($297.03)'
    Row 28: Added $-297.03 to invoice (running total: $40789.27)
    Row 29: [LIST] invoice_value = '$474.13'
    Row 29: Added $474.13 to invoice (running total: $41263.40)
    Row 30: [LIST] invoice_value = '$9,078.08'
    Row 30: Added $9078.08 to invoice (running total: $50341.48)
    Row 31: [LIST] invoice_value = '($491.59)'
    Row 31: Added $-491.59 to invoice (running total: $49849.89)
    Row 32: [LIST] invoice_value = '$9,078.08'
    Row 32: Added $9078.08 to invoice (running total: $58927.97)
  ‚úÖ Table 0 invoice total: $58927.97
üí∞ Final extracted_invoice_total: $58927.97
‚úÖ Set extracted_total=3757.47, total_amount_match=True
‚úÖ Set extracted_invoice_total=58927.97
‚úÖ Statement approved, processing commission data with BULK OPTIMIZATION...
üöÄ BULK PROCESSING: Starting optimized commission processing for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üîç Extracting field mappings from: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
‚úÖ Found client name field: Group Name -> Client Name
‚úÖ Found commission field (exact match): Paid Amount -> Commission Earned
‚úÖ Found invoice total field (exact): Invoice Total -> Invoice Total
üîç Extracted field mappings: {'client_name_field': 'Group Name', 'commission_earned_field': 'Paid Amount', 'invoice_total_field': 'Invoice Total'}
   ‚úÖ Client Name: Using 'Group Name'
   ‚úÖ Commission Earned: Using 'Paid Amount'
   ‚úÖ Invoice Total: Using 'Invoice Total'
‚úÖ OPTIMIZED: Pre-extracted field mappings: client=Group Name, commission=Paid Amount, invoice=Invoice Total
üë§ Processing for user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191
üåç Processing for environment_id: ce970b80-0cbc-4861-b6bd-449e1590a99c
üìÖ Statement date: 2025-08-06 00:00:00 (month: 8, year: 2025)
üìä Table 0: Mapped fields - client[1]=Group Name, commission[9]=Paid Amount, invoice[4]=Invoice Total
üîç DEBUG Table 0: summaryRows raw value: [], type: <class 'list'>
‚ö†Ô∏è  Table 0: NO summary rows to exclude - all rows will be processed
üìä Extracted 33 commission records for bulk processing
üîç Found 6 clients with multiple statement rows:
   1. FUZION EXPRESS LL: 2 rows, total commission: $-514.61
   2. LUDICROUS SPEED LOGI: 5 rows, total commission: $1389.84
   3. SITIJI IN: 11 rows, total commission: $1132.82
   4. BTK RUSH IN: 5 rows, total commission: $-305.40
   5. THE TOTAL PACKAGE LO: 2 rows, total commission: $-175.32
üìä Commission Analysis: {'total_records': 33, 'unique_clients': 11, 'clients_with_multiple_rows': 6}
üîç Bulk fetch: Looking up 11 unique commission records (with user isolation)
‚úÖ Bulk fetch: Found 0 existing records for specified users
üìä Aggregating 33 individual records by unique constraint...
‚úÖ Aggregated into 11 unique commission records (with user isolation)
   üìã BOLT LOGISTIC (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $-141.14 commission, $-627.27 invoice
   üìã FUZION EXPRESS LL (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $-514.61 commission, $4474.67 invoice
   üìã LUDICROUS SPEED LOGI (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $1389.84 commission, $22615.92 invoice
üìä Bulk operations prepared: 0 updates, 11 inserts
‚ûï Executing bulk insert for 11 records
‚úÖ BULK PROCESSING: Successfully processed 33 records
üìà Performance: Reduced from 600-800 DB operations to 2-3 operations
INFO:app.api.auto_approval:üìù Auto-approval: Normalizing filename for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
ERROR:app.services.gcs_utils:Source file not found in GCS for rename: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.auto_approval:‚ö†Ô∏è Auto-approval: Failed to rename file in GCS
INFO:app.api.auto_approval:  ‚è≠Ô∏è Auto-approval: Skipping rate field: 'Agent %' -> 'Commission Rate'
INFO:app.api.auto_approval:üí∞ Auto-approval: Found commission field: 'Paid Amount' (mapped to 'Commission Earned')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Table 0: Found 10 headers
INFO:app.api.auto_approval:üí∞ Auto-approval: Commission field 'Paid Amount' found at index 9
INFO:app.api.auto_approval:üí∞ Auto-approval: Table has 33 rows, 0 summary rows to skip
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 33 data rows from table 0
INFO:app.api.auto_approval:üí∞ Auto-approval: Found invoice field (exact match): 'Invoice Total' (mapped to 'Invoice Total')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating invoice total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Invoice field 'Invoice Total' found at index 4
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 33 invoice rows from table 0
INFO:app.api.auto_approval:Total validation:
INFO:app.api.auto_approval:  - Extracted from file: $3604.95
INFO:app.api.auto_approval:  - Calculated from table: $3757.47
INFO:app.api.auto_approval:  - Invoice total calculated: $58927.97
INFO:app.api.auto_approval:  - Match: True (difference: 4.23%)
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:Auto-approval completed for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:     127.0.0.1:57980 - "POST /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58072 - "GET /api/companies/user-specific/4488bb05-bd57-458c-915c-4de65619610d/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58074 - "GET /api/earned-commission/carrier/user-specific/4488bb05-bd57-458c-915c-4de65619610d/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [70606]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [79390]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [79390]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
WARNING:  StatReload detected changes in 'app/api/auto_approval.py'. Reloading...
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [80788]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [81165]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [81165]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [83443]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [83443]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [84333]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1762985476844_vv5imenjx. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:     127.0.0.1:61736 - "WebSocket /api/ws/progress/upload_1762985476844_vv5imenjx?session_id=session_1762985476872_w25lakt7x" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1762985476844_vv5imenjx, session_id=session_1762985476872_w25lakt7x, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1762985476844_vv5imenjx
INFO:     127.0.0.1:61738 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:üìÅ File: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üîë Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üìè Size: 373495 bytes
INFO:app.api.new_extract:üë§ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üîç Checking for user duplicates - Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üìö Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf: hash=98272fc00893adae..., status=approved
INFO:app.services.duplicate_detection_service:  - statements/defb777c-dfcb-4c37-8ec2-bd62ac58a1a2/01.13.2025.2 Allied Innovative Payment.pdf: hash=3e2ff2652f27d527..., status=Approved
INFO:app.services.duplicate_detection_service:‚ùå No duplicate found for hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üöÄ Starting extract-tables-smart for file: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìÅ File path: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìä File size: 373495 bytes
INFO:app.api.new_extract:üÜî Upload ID: upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:üíæ Saving uploaded file...
INFO:app.api.new_extract:‚úÖ File saved successfully
INFO:app.api.new_extract:üì§ Uploading file to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ File uploaded to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:‚úÖ Successfully uploaded and verified file in GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:Using specified environment ce970b80-0cbc-4861-b6bd-449e1590a99c (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: b845111f-7c3a-4f80-b930-9b14560779fd)
INFO:app.api.new_extract:üîß Getting enhanced extraction service...
INFO:app.services.claude.service:üîÑ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:üîë API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:‚úÖ Claude API client initialized successfully
INFO:app.services.claude.service:üìã Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic Extraction Service initialized
INFO:app.services.claude.service:‚úÖ Claude Document AI Service initialized
INFO:app.services.claude.service:üìã Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìã Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìè Limits: 32MB, 100 pages
INFO:app.services.claude.service:üõ°Ô∏è  Rate limiting: ENABLED (50 RPM, 25,500 TPM)
INFO:app.services.claude.service:üíæ Prompt caching: SUPPORTED
INFO:app.services.enhanced_extraction_service:‚úÖ Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:üÜï PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:üìã FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:‚è±Ô∏è  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:üöÄ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:‚úÖ Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:üöÄ Starting extraction task...
INFO:app.api.new_extract:üìä Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:‚úÖ CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:üîç Extracting metadata with Claude from: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.claude.service:üìä Estimated tokens for request: 178,977 (54 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (178977/25500). Waiting 59.83s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 1/50 RPM, 178977/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 59.83s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat


INFO:app.api.ai_intelligent_mapping:üöÄ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ü§ñ AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:üîç AI Mapping: carrier_id provided: True (value: 4488bb05-bd57-458c-915c-4de65619610d)
INFO:app.services.ai_field_mapping_service:üéØ Carrier ID is valid, attempting to retrieve learned mapping for carrier 4488bb05-bd57-458c-915c-4de65619610d
INFO:app.services.ai_field_mapping_service:üîç Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:üîç Looking up learned format for carrier 4488bb05-bd57-458c-915c-4de65619610d with 10 headers
INFO:app.services.ai_field_mapping_service:‚ùå No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:üîç Found 1 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:üîç Format signature 434609905947a9e8728df0b79ba381ce: similarity = 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ New best match with similarity 0.72
INFO:app.services.ai_field_mapping_service:‚úÖ Found similar format with 0.72 similarity score
INFO:app.services.ai_field_mapping_service:üéØ Found learned mapping for carrier with 0.72 confidence
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:‚úÖ AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:‚úÖ AI Mapping: Generated 10 mappings with 0.92 confidence
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:‚úÖ Enhanced AI Analysis Complete: Overall confidence 0.91
INFO:app.api.new_extract:‚úÖ AI Field Mapping: 10 mappings with 0.92 confidence
INFO:app.api.new_extract:‚úÖ Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is This is an Allied commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 in net commissions across a substantial portfolio of 10 unique companies with multiple line items. PRIDE DELIVERY SERVIC dominates the portfolio with $2,318.37 in net commissions (64% of total) from three separate transactions, followed by LUDICROUS SPEED LOGI contributing $1,389.84 net from five transactions, and SITIJI IN generating $1,130.33 net despite having both positive and negative adjustments across ten line items. The statement reveals significant commission volatility with numerous negative adjustments, particularly affecting BTK RUSH IN (five consecutive deductions of $61.08 each totaling -$305.40), FUZION EXPRESS LL (net loss of -$514.61), and several other transportation and logistics companies, suggesting either premium adjustments, policy cancellations, or billing corrections across this logistics-focused client base.
INFO:app.api.new_extract:   Structured data: {'carrier_name': 'ALLIED', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-08-06', 'total_amount': '3604.95', 'company_count': '10', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'PRIDE DELIVERY SERVIC', 'amount': '2318.37'}, {'name': 'LUDICROUS SPEED LOGI', 'amount': '1389.84'}, {'name': 'SITIJI IN', 'amount': '1130.33'}], 'commission_structure': 'Percentage-based'}
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 2e496f0f-585c-4195-9de1-5b4aa4755b3d)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {"carrier_name": "ALLIED", "broker_company": "INNOVATIVE BPS LLC", "statement_date": "2025-08-06", "total_amount": "3604.95", "company_count": "10", "broker_id_confidence": 0.7, "top_contributors": [{...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1762984467706_6t83gdc10
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1762984467706_6t83gdc10
INFO:     127.0.0.1:57978 - "OPTIONS /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:57386 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1762984467706_6t83gdc10, session_id=session_1762984467730_5n4y9fnao
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1762984467706_6t83gdc10, session_id=session_1762984467730_5n4y9fnao
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1762984467706_6t83gdc10
INFO:app.api.auto_approval:Auto-approval started for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:üîç Auto-approval: Filtered 1 tables to 1 commission tables for saving
INFO:app.api.auto_approval:ü§ñ Auto-approval: Raw field_mapping from learned format: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
INFO:app.api.auto_approval:ü§ñ Auto-approval: Using 10 field mappings from learned format
INFO:app.api.auto_approval:ü§ñ Auto-approval: Field config list: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Saving edited tables for upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.table_editor:üéØ Table Editor API: Tables count: 1
INFO:app.api.table_editor:üéØ Table Editor API: Selected statement date: {'date': '2025-08-06'}
INFO:app.api.table_editor:üéØ Table Editor API: Company ID: 4488bb05-bd57-458c-915c-4de65619610d
INFO:app.api.table_editor:üéØ Table Editor API: Field config received: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:üéØ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:üéØ Table Editor API: Updating upload with tables, statement date, and carrier
üéØ CRUD: update_upload_tables called for upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üéØ CRUD: Tables data length: 1
üéØ CRUD: Selected statement date: {'date': '2025-08-06'}
üéØ CRUD: Carrier ID: None
üéØ CRUD: Found upload, updating with tables, statement date, and carrier
üéØ CRUD: Saved selected statement date to database: {'date': '2025-08-06'}
üéØ CRUD: Statement date type: <class 'dict'>
üéØ CRUD: Statement date keys: ['date']
üéØ CRUD: Also saved statement date and carrier to progress_data
üéØ CRUD: Successfully updated upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d with tables, statement date, and carrier
üéØ CRUD: Final selected_statement_date in database: {'date': '2025-08-06'}
INFO:app.api.table_editor:üéØ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:üéØ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:üéØ Table Editor API: Successfully saved 1 edited tables
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:Updated format learning usage count for signature: 434609905947a9e8728df0b79ba381ce
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üíæ Saving statement review: upload_id=2e496f0f-585c-4195-9de1-5b4aa4755b3d, status=Approved
üìã Field config being saved: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
üìä Final data rows: 1
üìÖ Selected statement date being saved: {'date': '2025-08-06'}
üîç DEBUG Saving table 0 'Table 1': summaryRows=[], type=<class 'list'>
üìù Extracted field_mapping with 10 mappings: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üí∞ Calculating extracted_total for manual approval...
üí∞ field_mapping keys: ['Agent %', 'Group No.', 'Census Ct.', 'Group Name', 'Adj. Period', 'Paid Amount', 'Invoice Total', 'Billing Period', 'Stoploss Total', 'Calculation Method']
üí∞ Number of tables in final_data: 1
üí∞ Found commission field (EXACT MATCH): Paid Amount -> Commission Earned
üí∞ Final commission_source_field: Paid Amount
  üìä Table 0: 10 headers, 33 rows
  üìã Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  üìã First row sample: ['L213059', 'BOLT LOGISTIC', '8/1/2025', '7/1/2025', '($627.27)', '($266.05)', '22.5%', 'Premium Equivalent', '-1', '($141.14)']
  üí∞ Table 0: Commission column 'Paid Amount' at index 9
    Row 0: [LIST] raw_value = '($141.14)' (type: <class 'str'>)
    Row 0: Added $-141.14 (running total: $-141.14)
    Row 1: [LIST] raw_value = '($552.73)' (type: <class 'str'>)
    Row 1: Added $-552.73 (running total: $-693.87)
    Row 2: [LIST] raw_value = '$38.12' (type: <class 'str'>)
    Row 2: Added $38.12 (running total: $-655.75)
    Row 3: [LIST] raw_value = '$159.51' (type: <class 'str'>)
    Row 3: Added $159.51 (running total: $-496.24)
    Row 4: [LIST] raw_value = '$122.04' (type: <class 'str'>)
    Row 4: Added $122.04 (running total: $-374.20)
    Row 5: [LIST] raw_value = '$244.08' (type: <class 'str'>)
    Row 5: Added $244.08 (running total: $-130.12)
    Row 6: [LIST] raw_value = '$925.23' (type: <class 'str'>)
    Row 6: Added $925.23 (running total: $795.11)
    Row 7: [LIST] raw_value = '($61.02)' (type: <class 'str'>)
    Row 7: Added $-61.02 (running total: $734.09)
    Row 8: [LIST] raw_value = '$68.68' (type: <class 'str'>)
    Row 8: Added $68.68 (running total: $802.77)
    Row 9: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 9: Added $58.62 (running total: $861.39)
    Row 10: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 10: Added $-61.14 (running total: $800.25)
    Row 11: [LIST] raw_value = '$132.52' (type: <class 'str'>)
    Row 11: Added $132.52 (running total: $932.77)
    Row 12: [LIST] raw_value = '$163.29' (type: <class 'str'>)
    Row 12: Added $163.29 (running total: $1096.06)
    Row 13: [LIST] raw_value = '$221.70' (type: <class 'str'>)
    Row 13: Added $221.70 (running total: $1317.76)
    Row 14: [LIST] raw_value = '$724.20' (type: <class 'str'>)
    Row 14: Added $724.20 (running total: $2041.96)
    Row 15: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 15: Added $58.62 (running total: $2100.58)
    Row 16: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 16: Added $-61.14 (running total: $2039.44)
    Row 17: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 17: Added $58.62 (running total: $2098.06)
    Row 18: [LIST] raw_value = '($15.28)' (type: <class 'str'>)
    Row 18: Added $-15.28 (running total: $2082.78)
    Row 19: [LIST] raw_value = '($147.19)' (type: <class 'str'>)
    Row 19: Added $-147.19 (running total: $1935.59)
    Row 20: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 20: Added $-61.08 (running total: $1874.51)
    Row 21: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 21: Added $-61.08 (running total: $1813.43)
    Row 22: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 22: Added $-61.08 (running total: $1752.35)
    Row 23: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 23: Added $-61.08 (running total: $1691.27)
    Row 24: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 24: Added $-61.08 (running total: $1630.19)
    Row 25: [LIST] raw_value = '($87.66)' (type: <class 'str'>)
    Row 25: Added $-87.66 (running total: $1542.53)
    Row 26: [LIST] raw_value = '($87.66)' (type: <class 'str'>)
    Row 26: Added $-87.66 (running total: $1454.87)
    Row 27: [LIST] raw_value = '($31.29)' (type: <class 'str'>)
    Row 27: Added $-31.29 (running total: $1423.58)
    Row 28: [LIST] raw_value = '($81.68)' (type: <class 'str'>)
    Row 28: Added $-81.68 (running total: $1341.90)
    Row 29: [LIST] raw_value = '$97.20' (type: <class 'str'>)
    Row 29: Added $97.20 (running total: $1439.10)
    Row 30: [LIST] raw_value = '$1,194.57' (type: <class 'str'>)
    Row 30: Added $1194.57 (running total: $2633.67)
    Row 31: [LIST] raw_value = '($132.73)' (type: <class 'str'>)
    Row 31: Added $-132.73 (running total: $2500.94)
    Row 32: [LIST] raw_value = '$1,256.53' (type: <class 'str'>)
    Row 32: Added $1256.53 (running total: $3757.47)
  ‚úÖ Table 0 total: $3757.47
üí∞ Final extracted_total: $3757.47
üí∞ Calculating extracted_invoice_total for manual approval...
üí∞ Found invoice field (exact match): Invoice Total -> Invoice Total
  üìä Table 0: 10 headers, 33 rows
  üìã Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  üìã First row sample: ['L213059', 'BOLT LOGISTIC', '8/1/2025', '7/1/2025', '($627.27)', '($266.05)', '22.5%', 'Premium Equivalent', '-1', '($141.14)']
  üí∞ Table 0: Invoice column 'Invoice Total' at index 4
    Row 0: [LIST] invoice_value = '($627.27)'
    Row 0: Added $-627.27 to invoice (running total: $-627.27)
    Row 1: [LIST] invoice_value = '$4,806.13'
    Row 1: Added $4806.13 to invoice (running total: $4178.86)
    Row 2: [LIST] invoice_value = '($331.46)'
    Row 2: Added $-331.46 to invoice (running total: $3847.40)
    Row 3: [LIST] invoice_value = '$547.17'
    Row 3: Added $547.17 to invoice (running total: $4394.57)
    Row 4: [LIST] invoice_value = '$7,173.86'
    Row 4: Added $7173.86 to invoice (running total: $11568.43)
    Row 5: [LIST] invoice_value = '$7,173.86'
    Row 5: Added $7173.86 to invoice (running total: $18742.29)
    Row 6: [LIST] invoice_value = '$7,173.86'
    Row 6: Added $7173.86 to invoice (running total: $25916.15)
    Row 7: [LIST] invoice_value = '$547.17'
    Row 7: Added $547.17 to invoice (running total: $26463.32)
    Row 8: [LIST] invoice_value = '$443.10'
    Row 8: Added $443.10 to invoice (running total: $26906.42)
    Row 9: [LIST] invoice_value = '($14.36)'
    Row 9: Added $-14.36 to invoice (running total: $26892.06)
    Row 10: [LIST] invoice_value = '$407.91'
    Row 10: Added $407.91 to invoice (running total: $27299.97)
    Row 11: [LIST] invoice_value = '$407.91'
    Row 11: Added $407.91 to invoice (running total: $27707.88)
    Row 12: [LIST] invoice_value = '$6,338.06'
    Row 12: Added $6338.06 to invoice (running total: $34045.94)
    Row 13: [LIST] invoice_value = '$6,338.06'
    Row 13: Added $6338.06 to invoice (running total: $40384.00)
    Row 14: [LIST] invoice_value = '$6,338.06'
    Row 14: Added $6338.06 to invoice (running total: $46722.06)
    Row 15: [LIST] invoice_value = '($14.36)'
    Row 15: Added $-14.36 to invoice (running total: $46707.70)
    Row 16: [LIST] invoice_value = '($14.36)'
    Row 16: Added $-14.36 to invoice (running total: $46693.34)
    Row 17: [LIST] invoice_value = '($14.36)'
    Row 17: Added $-14.36 to invoice (running total: $46678.98)
    Row 18: [LIST] invoice_value = '($928.34)'
    Row 18: Added $-928.34 to invoice (running total: $45750.64)
    Row 19: [LIST] invoice_value = '($928.34)'
    Row 19: Added $-928.34 to invoice (running total: $44822.30)
    Row 20: [LIST] invoice_value = '($297.96)'
    Row 20: Added $-297.96 to invoice (running total: $44524.34)
    Row 21: [LIST] invoice_value = '($297.96)'
    Row 21: Added $-297.96 to invoice (running total: $44226.38)
    Row 22: [LIST] invoice_value = '($297.96)'
    Row 22: Added $-297.96 to invoice (running total: $43928.42)
    Row 23: [LIST] invoice_value = '($297.96)'
    Row 23: Added $-297.96 to invoice (running total: $43630.46)
    Row 24: [LIST] invoice_value = '($297.96)'
    Row 24: Added $-297.96 to invoice (running total: $43332.50)
    Row 25: [LIST] invoice_value = '($974.10)'
    Row 25: Added $-974.10 to invoice (running total: $42358.40)
    Row 26: [LIST] invoice_value = '($974.10)'
    Row 26: Added $-974.10 to invoice (running total: $41384.30)
    Row 27: [LIST] invoice_value = '($298.00)'
    Row 27: Added $-298.00 to invoice (running total: $41086.30)
    Row 28: [LIST] invoice_value = '($297.03)'
    Row 28: Added $-297.03 to invoice (running total: $40789.27)
    Row 29: [LIST] invoice_value = '$474.13'
    Row 29: Added $474.13 to invoice (running total: $41263.40)
    Row 30: [LIST] invoice_value = '$9,078.08'
    Row 30: Added $9078.08 to invoice (running total: $50341.48)
    Row 31: [LIST] invoice_value = '($491.59)'
    Row 31: Added $-491.59 to invoice (running total: $49849.89)
    Row 32: [LIST] invoice_value = '$9,078.08'
    Row 32: Added $9078.08 to invoice (running total: $58927.97)
  ‚úÖ Table 0 invoice total: $58927.97
üí∞ Final extracted_invoice_total: $58927.97
‚úÖ Set extracted_total=3757.47, total_amount_match=True
‚úÖ Set extracted_invoice_total=58927.97
‚úÖ Statement approved, processing commission data with BULK OPTIMIZATION...
üöÄ BULK PROCESSING: Starting optimized commission processing for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üîç Extracting field mappings from: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
‚úÖ Found client name field: Group Name -> Client Name
‚úÖ Found commission field (exact match): Paid Amount -> Commission Earned
‚úÖ Found invoice total field (exact): Invoice Total -> Invoice Total
üîç Extracted field mappings: {'client_name_field': 'Group Name', 'commission_earned_field': 'Paid Amount', 'invoice_total_field': 'Invoice Total'}
   ‚úÖ Client Name: Using 'Group Name'
   ‚úÖ Commission Earned: Using 'Paid Amount'
   ‚úÖ Invoice Total: Using 'Invoice Total'
‚úÖ OPTIMIZED: Pre-extracted field mappings: client=Group Name, commission=Paid Amount, invoice=Invoice Total
üë§ Processing for user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191
üåç Processing for environment_id: ce970b80-0cbc-4861-b6bd-449e1590a99c
üìÖ Statement date: 2025-08-06 00:00:00 (month: 8, year: 2025)
üìä Table 0: Mapped fields - client[1]=Group Name, commission[9]=Paid Amount, invoice[4]=Invoice Total
üîç DEBUG Table 0: summaryRows raw value: [], type: <class 'list'>
‚ö†Ô∏è  Table 0: NO summary rows to exclude - all rows will be processed
üìä Extracted 33 commission records for bulk processing
üîç Found 6 clients with multiple statement rows:
   1. FUZION EXPRESS LL: 2 rows, total commission: $-514.61
   2. LUDICROUS SPEED LOGI: 5 rows, total commission: $1389.84
   3. SITIJI IN: 11 rows, total commission: $1132.82
   4. BTK RUSH IN: 5 rows, total commission: $-305.40
   5. THE TOTAL PACKAGE LO: 2 rows, total commission: $-175.32
üìä Commission Analysis: {'total_records': 33, 'unique_clients': 11, 'clients_with_multiple_rows': 6}
üîç Bulk fetch: Looking up 11 unique commission records (with user isolation)
‚úÖ Bulk fetch: Found 0 existing records for specified users
üìä Aggregating 33 individual records by unique constraint...
‚úÖ Aggregated into 11 unique commission records (with user isolation)
   üìã BOLT LOGISTIC (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $-141.14 commission, $-627.27 invoice
   üìã FUZION EXPRESS LL (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $-514.61 commission, $4474.67 invoice
   üìã LUDICROUS SPEED LOGI (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $1389.84 commission, $22615.92 invoice
üìä Bulk operations prepared: 0 updates, 11 inserts
‚ûï Executing bulk insert for 11 records
‚úÖ BULK PROCESSING: Successfully processed 33 records
üìà Performance: Reduced from 600-800 DB operations to 2-3 operations
INFO:app.api.auto_approval:üìù Auto-approval: Normalizing filename for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
ERROR:app.services.gcs_utils:Source file not found in GCS for rename: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.auto_approval:‚ö†Ô∏è Auto-approval: Failed to rename file in GCS
INFO:app.api.auto_approval:  ‚è≠Ô∏è Auto-approval: Skipping rate field: 'Agent %' -> 'Commission Rate'
INFO:app.api.auto_approval:üí∞ Auto-approval: Found commission field: 'Paid Amount' (mapped to 'Commission Earned')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Table 0: Found 10 headers
INFO:app.api.auto_approval:üí∞ Auto-approval: Commission field 'Paid Amount' found at index 9
INFO:app.api.auto_approval:üí∞ Auto-approval: Table has 33 rows, 0 summary rows to skip
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 33 data rows from table 0
INFO:app.api.auto_approval:üí∞ Auto-approval: Found invoice field (exact match): 'Invoice Total' (mapped to 'Invoice Total')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating invoice total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Invoice field 'Invoice Total' found at index 4
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 33 invoice rows from table 0
INFO:app.api.auto_approval:Total validation:
INFO:app.api.auto_approval:  - Extracted from file: $3604.95
INFO:app.api.auto_approval:  - Calculated from table: $3757.47
INFO:app.api.auto_approval:  - Invoice total calculated: $58927.97
INFO:app.api.auto_approval:  - Match: True (difference: 4.23%)
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:Auto-approval completed for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:     127.0.0.1:57980 - "POST /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58072 - "GET /api/companies/user-specific/4488bb05-bd57-458c-915c-4de65619610d/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58074 - "GET /api/earned-commission/carrier/user-specific/4488bb05-bd57-458c-915c-4de65619610d/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [70606]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [79390]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [79390]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
WARNING:  StatReload detected changes in 'app/api/auto_approval.py'. Reloading...
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [80788]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [81165]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [81165]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [83443]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [83443]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [84333]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1762985476844_vv5imenjx. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:     127.0.0.1:61736 - "WebSocket /api/ws/progress/upload_1762985476844_vv5imenjx?session_id=session_1762985476872_w25lakt7x" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1762985476844_vv5imenjx, session_id=session_1762985476872_w25lakt7x, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1762985476844_vv5imenjx
INFO:     127.0.0.1:61738 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:üìÅ File: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üîë Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üìè Size: 373495 bytes
INFO:app.api.new_extract:üë§ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üîç Checking for user duplicates - Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üìö Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf: hash=98272fc00893adae..., status=approved
INFO:app.services.duplicate_detection_service:  - statements/defb777c-dfcb-4c37-8ec2-bd62ac58a1a2/01.13.2025.2 Allied Innovative Payment.pdf: hash=3e2ff2652f27d527..., status=Approved
INFO:app.services.duplicate_detection_service:‚ùå No duplicate found for hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üöÄ Starting extract-tables-smart for file: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìÅ File path: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìä File size: 373495 bytes
INFO:app.api.new_extract:üÜî Upload ID: upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:üíæ Saving uploaded file...
INFO:app.api.new_extract:‚úÖ File saved successfully
INFO:app.api.new_extract:üì§ Uploading file to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ File uploaded to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:‚úÖ Successfully uploaded and verified file in GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:Using specified environment ce970b80-0cbc-4861-b6bd-449e1590a99c (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: b845111f-7c3a-4f80-b930-9b14560779fd)
INFO:app.api.new_extract:üîß Getting enhanced extraction service...
INFO:app.services.claude.service:üîÑ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:üîë API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:‚úÖ Claude API client initialized successfully
INFO:app.services.claude.service:üìã Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic Extraction Service initialized
INFO:app.services.claude.service:‚úÖ Claude Document AI Service initialized
INFO:app.services.claude.service:üìã Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìã Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìè Limits: 32MB, 100 pages
INFO:app.services.claude.service:üõ°Ô∏è  Rate limiting: ENABLED (50 RPM, 25,500 TPM)
INFO:app.services.claude.service:üíæ Prompt caching: SUPPORTED
INFO:app.services.enhanced_extraction_service:‚úÖ Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:üÜï PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:üìã FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:‚è±Ô∏è  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:üöÄ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:‚úÖ Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:üöÄ Starting extraction task...
INFO:app.api.new_extract:üìä Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:‚úÖ CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:üîç Extracting metadata with Claude from: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.claude.service:üìä Estimated tokens for request: 178,977 (54 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (178977/25500). Waiting 59.83s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 1/50 RPM, 178977/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 59.83s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=116,913, output=311
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this commission statement document, I can extract the following metadata:

```json
{
  "carrier_name": "Allied Benefit Systems",
  "carrier_confidence": 0.95,
  "statement_date": "2025-08-06",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.95,
  "document_type": "commission_statement",
  "total_pages": 54,
  "evidence": "Carrier name found in document header 'ABSF Commission Payment Summary' and Allied logo/branding. Statement date found 
INFO:app.services.enhanced_extraction_service:‚úì Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:üì° Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚úÖ Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:üì° Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/08.06.2025 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:Large file detected (54 pages, 0.36MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.utils:üìÑ Created chunk 1/3: Pages 1-25 (~68,750 tokens)
INFO:app.services.claude.utils:üìÑ Created chunk 2/3: Pages 26-50 (~68,750 tokens)
INFO:app.services.claude.utils:üìÑ Created chunk 3/3: Pages 51-54 (~11,000 tokens)
INFO:app.services.claude.service:üìÑ Split document into 3 chunks (25 pages each)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 82,624 (25 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (261601/25500). Waiting 43.36s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 2/50 RPM, 82624/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 43.37s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.442555 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.994378 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.claude.service:‚ùå Claude API error (attempt 1/5): Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV4mJCjib4z8zFDZDwwit'}
ERROR:app.services.claude.service:   Rate limit error: True, Retriable: True
WARNING:app.services.claude.service:‚ö†Ô∏è  Rate limit hit! Retry-After: 168.00s
INFO:app.api.websocket:Received unknown message type: heartbeat

detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:‚úÖ Enhanced AI Analysis Complete: Overall confidence 0.91
INFO:app.api.new_extract:‚úÖ AI Field Mapping: 10 mappings with 0.92 confidence
INFO:app.api.new_extract:‚úÖ Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is This is an Allied commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 in net commissions across a substantial portfolio of 10 unique companies with multiple line items. PRIDE DELIVERY SERVIC dominates the portfolio with $2,318.37 in net commissions (64% of total) from three separate transactions, followed by LUDICROUS SPEED LOGI contributing $1,389.84 net from five transactions, and SITIJI IN generating $1,130.33 net despite having both positive and negative adjustments across ten line items. The statement reveals significant commission volatility with numerous negative adjustments, particularly affecting BTK RUSH IN (five consecutive deductions of $61.08 each totaling -$305.40), FUZION EXPRESS LL (net loss of -$514.61), and several other transportation and logistics companies, suggesting either premium adjustments, policy cancellations, or billing corrections across this logistics-focused client base.
INFO:app.api.new_extract:   Structured data: {'carrier_name': 'ALLIED', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-08-06', 'total_amount': '3604.95', 'company_count': '10', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'PRIDE DELIVERY SERVIC', 'amount': '2318.37'}, {'name': 'LUDICROUS SPEED LOGI', 'amount': '1389.84'}, {'name': 'SITIJI IN', 'amount': '1130.33'}], 'commission_structure': 'Percentage-based'}
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 2e496f0f-585c-4195-9de1-5b4aa4755b3d)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {"carrier_name": "ALLIED", "broker_company": "INNOVATIVE BPS LLC", "statement_date": "2025-08-06", "total_amount": "3604.95", "company_count": "10", "broker_id_confidence": 0.7, "top_contributors": [{...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762984467706_6t83gdc10: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762984467706_6t83gdc10
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1762984467706_6t83gdc10
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1762984467706_6t83gdc10
INFO:     127.0.0.1:57978 - "OPTIONS /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:57386 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1762984467706_6t83gdc10, session_id=session_1762984467730_5n4y9fnao
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1762984467706_6t83gdc10, session_id=session_1762984467730_5n4y9fnao
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1762984467706_6t83gdc10
INFO:app.api.auto_approval:Auto-approval started for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:üîç Auto-approval: Filtered 1 tables to 1 commission tables for saving
INFO:app.api.auto_approval:ü§ñ Auto-approval: Raw field_mapping from learned format: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
INFO:app.api.auto_approval:ü§ñ Auto-approval: Using 10 field mappings from learned format
INFO:app.api.auto_approval:ü§ñ Auto-approval: Field config list: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Saving edited tables for upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.table_editor:üéØ Table Editor API: Tables count: 1
INFO:app.api.table_editor:üéØ Table Editor API: Selected statement date: {'date': '2025-08-06'}
INFO:app.api.table_editor:üéØ Table Editor API: Company ID: 4488bb05-bd57-458c-915c-4de65619610d
INFO:app.api.table_editor:üéØ Table Editor API: Field config received: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:üéØ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:üéØ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:üéØ Table Editor API: Updating upload with tables, statement date, and carrier
üéØ CRUD: update_upload_tables called for upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üéØ CRUD: Tables data length: 1
üéØ CRUD: Selected statement date: {'date': '2025-08-06'}
üéØ CRUD: Carrier ID: None
üéØ CRUD: Found upload, updating with tables, statement date, and carrier
üéØ CRUD: Saved selected statement date to database: {'date': '2025-08-06'}
üéØ CRUD: Statement date type: <class 'dict'>
üéØ CRUD: Statement date keys: ['date']
üéØ CRUD: Also saved statement date and carrier to progress_data
üéØ CRUD: Successfully updated upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d with tables, statement date, and carrier
üéØ CRUD: Final selected_statement_date in database: {'date': '2025-08-06'}
INFO:app.api.table_editor:üéØ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:üéØ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:üéØ Table Editor API: Successfully saved 1 edited tables
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:Updated format learning usage count for signature: 434609905947a9e8728df0b79ba381ce
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üíæ Saving statement review: upload_id=2e496f0f-585c-4195-9de1-5b4aa4755b3d, status=Approved
üìã Field config being saved: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
üìä Final data rows: 1
üìÖ Selected statement date being saved: {'date': '2025-08-06'}
üîç DEBUG Saving table 0 'Table 1': summaryRows=[], type=<class 'list'>
üìù Extracted field_mapping with 10 mappings: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
üí∞ Calculating extracted_total for manual approval...
üí∞ field_mapping keys: ['Agent %', 'Group No.', 'Census Ct.', 'Group Name', 'Adj. Period', 'Paid Amount', 'Invoice Total', 'Billing Period', 'Stoploss Total', 'Calculation Method']
üí∞ Number of tables in final_data: 1
üí∞ Found commission field (EXACT MATCH): Paid Amount -> Commission Earned
üí∞ Final commission_source_field: Paid Amount
  üìä Table 0: 10 headers, 33 rows
  üìã Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  üìã First row sample: ['L213059', 'BOLT LOGISTIC', '8/1/2025', '7/1/2025', '($627.27)', '($266.05)', '22.5%', 'Premium Equivalent', '-1', '($141.14)']
  üí∞ Table 0: Commission column 'Paid Amount' at index 9
    Row 0: [LIST] raw_value = '($141.14)' (type: <class 'str'>)
    Row 0: Added $-141.14 (running total: $-141.14)
    Row 1: [LIST] raw_value = '($552.73)' (type: <class 'str'>)
    Row 1: Added $-552.73 (running total: $-693.87)
    Row 2: [LIST] raw_value = '$38.12' (type: <class 'str'>)
    Row 2: Added $38.12 (running total: $-655.75)
    Row 3: [LIST] raw_value = '$159.51' (type: <class 'str'>)
    Row 3: Added $159.51 (running total: $-496.24)
    Row 4: [LIST] raw_value = '$122.04' (type: <class 'str'>)
    Row 4: Added $122.04 (running total: $-374.20)
    Row 5: [LIST] raw_value = '$244.08' (type: <class 'str'>)
    Row 5: Added $244.08 (running total: $-130.12)
    Row 6: [LIST] raw_value = '$925.23' (type: <class 'str'>)
    Row 6: Added $925.23 (running total: $795.11)
    Row 7: [LIST] raw_value = '($61.02)' (type: <class 'str'>)
    Row 7: Added $-61.02 (running total: $734.09)
    Row 8: [LIST] raw_value = '$68.68' (type: <class 'str'>)
    Row 8: Added $68.68 (running total: $802.77)
    Row 9: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 9: Added $58.62 (running total: $861.39)
    Row 10: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 10: Added $-61.14 (running total: $800.25)
    Row 11: [LIST] raw_value = '$132.52' (type: <class 'str'>)
    Row 11: Added $132.52 (running total: $932.77)
    Row 12: [LIST] raw_value = '$163.29' (type: <class 'str'>)
    Row 12: Added $163.29 (running total: $1096.06)
    Row 13: [LIST] raw_value = '$221.70' (type: <class 'str'>)
    Row 13: Added $221.70 (running total: $1317.76)
    Row 14: [LIST] raw_value = '$724.20' (type: <class 'str'>)
    Row 14: Added $724.20 (running total: $2041.96)
    Row 15: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 15: Added $58.62 (running total: $2100.58)
    Row 16: [LIST] raw_value = '($61.14)' (type: <class 'str'>)
    Row 16: Added $-61.14 (running total: $2039.44)
    Row 17: [LIST] raw_value = '$58.62' (type: <class 'str'>)
    Row 17: Added $58.62 (running total: $2098.06)
    Row 18: [LIST] raw_value = '($15.28)' (type: <class 'str'>)
    Row 18: Added $-15.28 (running total: $2082.78)
    Row 19: [LIST] raw_value = '($147.19)' (type: <class 'str'>)
    Row 19: Added $-147.19 (running total: $1935.59)
    Row 20: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 20: Added $-61.08 (running total: $1874.51)
    Row 21: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 21: Added $-61.08 (running total: $1813.43)
    Row 22: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 22: Added $-61.08 (running total: $1752.35)
    Row 23: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 23: Added $-61.08 (running total: $1691.27)
    Row 24: [LIST] raw_value = '($61.08)' (type: <class 'str'>)
    Row 24: Added $-61.08 (running total: $1630.19)
    Row 25: [LIST] raw_value = '($87.66)' (type: <class 'str'>)
    Row 25: Added $-87.66 (running total: $1542.53)
    Row 26: [LIST] raw_value = '($87.66)' (type: <class 'str'>)
    Row 26: Added $-87.66 (running total: $1454.87)
    Row 27: [LIST] raw_value = '($31.29)' (type: <class 'str'>)
    Row 27: Added $-31.29 (running total: $1423.58)
    Row 28: [LIST] raw_value = '($81.68)' (type: <class 'str'>)
    Row 28: Added $-81.68 (running total: $1341.90)
    Row 29: [LIST] raw_value = '$97.20' (type: <class 'str'>)
    Row 29: Added $97.20 (running total: $1439.10)
    Row 30: [LIST] raw_value = '$1,194.57' (type: <class 'str'>)
    Row 30: Added $1194.57 (running total: $2633.67)
    Row 31: [LIST] raw_value = '($132.73)' (type: <class 'str'>)
    Row 31: Added $-132.73 (running total: $2500.94)
    Row 32: [LIST] raw_value = '$1,256.53' (type: <class 'str'>)
    Row 32: Added $1256.53 (running total: $3757.47)
  ‚úÖ Table 0 total: $3757.47
üí∞ Final extracted_total: $3757.47
üí∞ Calculating extracted_invoice_total for manual approval...
üí∞ Found invoice field (exact match): Invoice Total -> Invoice Total
  üìä Table 0: 10 headers, 33 rows
  üìã Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  üìã First row sample: ['L213059', 'BOLT LOGISTIC', '8/1/2025', '7/1/2025', '($627.27)', '($266.05)', '22.5%', 'Premium Equivalent', '-1', '($141.14)']
  üí∞ Table 0: Invoice column 'Invoice Total' at index 4
    Row 0: [LIST] invoice_value = '($627.27)'
    Row 0: Added $-627.27 to invoice (running total: $-627.27)
    Row 1: [LIST] invoice_value = '$4,806.13'
    Row 1: Added $4806.13 to invoice (running total: $4178.86)
    Row 2: [LIST] invoice_value = '($331.46)'
    Row 2: Added $-331.46 to invoice (running total: $3847.40)
    Row 3: [LIST] invoice_value = '$547.17'
    Row 3: Added $547.17 to invoice (running total: $4394.57)
    Row 4: [LIST] invoice_value = '$7,173.86'
    Row 4: Added $7173.86 to invoice (running total: $11568.43)
    Row 5: [LIST] invoice_value = '$7,173.86'
    Row 5: Added $7173.86 to invoice (running total: $18742.29)
    Row 6: [LIST] invoice_value = '$7,173.86'
    Row 6: Added $7173.86 to invoice (running total: $25916.15)
    Row 7: [LIST] invoice_value = '$547.17'
    Row 7: Added $547.17 to invoice (running total: $26463.32)
    Row 8: [LIST] invoice_value = '$443.10'
    Row 8: Added $443.10 to invoice (running total: $26906.42)
    Row 9: [LIST] invoice_value = '($14.36)'
    Row 9: Added $-14.36 to invoice (running total: $26892.06)
    Row 10: [LIST] invoice_value = '$407.91'
    Row 10: Added $407.91 to invoice (running total: $27299.97)
    Row 11: [LIST] invoice_value = '$407.91'
    Row 11: Added $407.91 to invoice (running total: $27707.88)
    Row 12: [LIST] invoice_value = '$6,338.06'
    Row 12: Added $6338.06 to invoice (running total: $34045.94)
    Row 13: [LIST] invoice_value = '$6,338.06'
    Row 13: Added $6338.06 to invoice (running total: $40384.00)
    Row 14: [LIST] invoice_value = '$6,338.06'
    Row 14: Added $6338.06 to invoice (running total: $46722.06)
    Row 15: [LIST] invoice_value = '($14.36)'
    Row 15: Added $-14.36 to invoice (running total: $46707.70)
    Row 16: [LIST] invoice_value = '($14.36)'
    Row 16: Added $-14.36 to invoice (running total: $46693.34)
    Row 17: [LIST] invoice_value = '($14.36)'
    Row 17: Added $-14.36 to invoice (running total: $46678.98)
    Row 18: [LIST] invoice_value = '($928.34)'
    Row 18: Added $-928.34 to invoice (running total: $45750.64)
    Row 19: [LIST] invoice_value = '($928.34)'
    Row 19: Added $-928.34 to invoice (running total: $44822.30)
    Row 20: [LIST] invoice_value = '($297.96)'
    Row 20: Added $-297.96 to invoice (running total: $44524.34)
    Row 21: [LIST] invoice_value = '($297.96)'
    Row 21: Added $-297.96 to invoice (running total: $44226.38)
    Row 22: [LIST] invoice_value = '($297.96)'
    Row 22: Added $-297.96 to invoice (running total: $43928.42)
    Row 23: [LIST] invoice_value = '($297.96)'
    Row 23: Added $-297.96 to invoice (running total: $43630.46)
    Row 24: [LIST] invoice_value = '($297.96)'
    Row 24: Added $-297.96 to invoice (running total: $43332.50)
    Row 25: [LIST] invoice_value = '($974.10)'
    Row 25: Added $-974.10 to invoice (running total: $42358.40)
    Row 26: [LIST] invoice_value = '($974.10)'
    Row 26: Added $-974.10 to invoice (running total: $41384.30)
    Row 27: [LIST] invoice_value = '($298.00)'
    Row 27: Added $-298.00 to invoice (running total: $41086.30)
    Row 28: [LIST] invoice_value = '($297.03)'
    Row 28: Added $-297.03 to invoice (running total: $40789.27)
    Row 29: [LIST] invoice_value = '$474.13'
    Row 29: Added $474.13 to invoice (running total: $41263.40)
    Row 30: [LIST] invoice_value = '$9,078.08'
    Row 30: Added $9078.08 to invoice (running total: $50341.48)
    Row 31: [LIST] invoice_value = '($491.59)'
    Row 31: Added $-491.59 to invoice (running total: $49849.89)
    Row 32: [LIST] invoice_value = '$9,078.08'
    Row 32: Added $9078.08 to invoice (running total: $58927.97)
  ‚úÖ Table 0 invoice total: $58927.97
üí∞ Final extracted_invoice_total: $58927.97
‚úÖ Set extracted_total=3757.47, total_amount_match=True
‚úÖ Set extracted_invoice_total=58927.97
‚úÖ Statement approved, processing commission data with BULK OPTIMIZATION...
üöÄ BULK PROCESSING: Starting optimized commission processing for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
üîç Extracting field mappings from: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
‚úÖ Found client name field: Group Name -> Client Name
‚úÖ Found commission field (exact match): Paid Amount -> Commission Earned
‚úÖ Found invoice total field (exact): Invoice Total -> Invoice Total
üîç Extracted field mappings: {'client_name_field': 'Group Name', 'commission_earned_field': 'Paid Amount', 'invoice_total_field': 'Invoice Total'}
   ‚úÖ Client Name: Using 'Group Name'
   ‚úÖ Commission Earned: Using 'Paid Amount'
   ‚úÖ Invoice Total: Using 'Invoice Total'
‚úÖ OPTIMIZED: Pre-extracted field mappings: client=Group Name, commission=Paid Amount, invoice=Invoice Total
üë§ Processing for user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191
üåç Processing for environment_id: ce970b80-0cbc-4861-b6bd-449e1590a99c
üìÖ Statement date: 2025-08-06 00:00:00 (month: 8, year: 2025)
üìä Table 0: Mapped fields - client[1]=Group Name, commission[9]=Paid Amount, invoice[4]=Invoice Total
üîç DEBUG Table 0: summaryRows raw value: [], type: <class 'list'>
‚ö†Ô∏è  Table 0: NO summary rows to exclude - all rows will be processed
üìä Extracted 33 commission records for bulk processing
üîç Found 6 clients with multiple statement rows:
   1. FUZION EXPRESS LL: 2 rows, total commission: $-514.61
   2. LUDICROUS SPEED LOGI: 5 rows, total commission: $1389.84
   3. SITIJI IN: 11 rows, total commission: $1132.82
   4. BTK RUSH IN: 5 rows, total commission: $-305.40
   5. THE TOTAL PACKAGE LO: 2 rows, total commission: $-175.32
üìä Commission Analysis: {'total_records': 33, 'unique_clients': 11, 'clients_with_multiple_rows': 6}
üîç Bulk fetch: Looking up 11 unique commission records (with user isolation)
‚úÖ Bulk fetch: Found 0 existing records for specified users
üìä Aggregating 33 individual records by unique constraint...
‚úÖ Aggregated into 11 unique commission records (with user isolation)
   üìã BOLT LOGISTIC (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $-141.14 commission, $-627.27 invoice
   üìã FUZION EXPRESS LL (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $-514.61 commission, $4474.67 invoice
   üìã LUDICROUS SPEED LOGI (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $1389.84 commission, $22615.92 invoice
üìä Bulk operations prepared: 0 updates, 11 inserts
‚ûï Executing bulk insert for 11 records
‚úÖ BULK PROCESSING: Successfully processed 33 records
üìà Performance: Reduced from 600-800 DB operations to 2-3 operations
INFO:app.api.auto_approval:üìù Auto-approval: Normalizing filename for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
ERROR:app.services.gcs_utils:Source file not found in GCS for rename: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.auto_approval:‚ö†Ô∏è Auto-approval: Failed to rename file in GCS
INFO:app.api.auto_approval:  ‚è≠Ô∏è Auto-approval: Skipping rate field: 'Agent %' -> 'Commission Rate'
INFO:app.api.auto_approval:üí∞ Auto-approval: Found commission field: 'Paid Amount' (mapped to 'Commission Earned')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Table 0: Found 10 headers
INFO:app.api.auto_approval:üí∞ Auto-approval: Commission field 'Paid Amount' found at index 9
INFO:app.api.auto_approval:üí∞ Auto-approval: Table has 33 rows, 0 summary rows to skip
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 33 data rows from table 0
INFO:app.api.auto_approval:üí∞ Auto-approval: Found invoice field (exact match): 'Invoice Total' (mapped to 'Invoice Total')
INFO:app.api.auto_approval:üí∞ Auto-approval: Calculating invoice total from 1 table(s)
INFO:app.api.auto_approval:üí∞ Auto-approval: Invoice field 'Invoice Total' found at index 4
INFO:app.api.auto_approval:üí∞ Auto-approval: Processed 33 invoice rows from table 0
INFO:app.api.auto_approval:Total validation:
INFO:app.api.auto_approval:  - Extracted from file: $3604.95
INFO:app.api.auto_approval:  - Calculated from table: $3757.47
INFO:app.api.auto_approval:  - Invoice total calculated: $58927.97
INFO:app.api.auto_approval:  - Match: True (difference: 4.23%)
INFO:app.services.websocket_service:Broadcasting message to upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:Auto-approval completed for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:     127.0.0.1:57980 - "POST /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58072 - "GET /api/companies/user-specific/4488bb05-bd57-458c-915c-4de65619610d/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58074 - "GET /api/earned-commission/carrier/user-specific/4488bb05-bd57-458c-915c-4de65619610d/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [70606]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [79390]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [79390]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
WARNING:  StatReload detected changes in 'app/api/auto_approval.py'. Reloading...
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [80788]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [81165]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [81165]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [83443]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [83443]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [84333]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1762985476844_vv5imenjx. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:     127.0.0.1:61736 - "WebSocket /api/ws/progress/upload_1762985476844_vv5imenjx?session_id=session_1762985476872_w25lakt7x" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1762985476844_vv5imenjx, session_id=session_1762985476872_w25lakt7x, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1762985476844_vv5imenjx
INFO:     127.0.0.1:61738 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:üìÅ File: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üîë Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üìè Size: 373495 bytes
INFO:app.api.new_extract:üë§ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üîç Checking for user duplicates - Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üìö Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf: hash=98272fc00893adae..., status=approved
INFO:app.services.duplicate_detection_service:  - statements/defb777c-dfcb-4c37-8ec2-bd62ac58a1a2/01.13.2025.2 Allied Innovative Payment.pdf: hash=3e2ff2652f27d527..., status=Approved
INFO:app.services.duplicate_detection_service:‚ùå No duplicate found for hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üöÄ Starting extract-tables-smart for file: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìÅ File path: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìä File size: 373495 bytes
INFO:app.api.new_extract:üÜî Upload ID: upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:üíæ Saving uploaded file...
INFO:app.api.new_extract:‚úÖ File saved successfully
INFO:app.api.new_extract:üì§ Uploading file to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ File uploaded to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:‚úÖ Successfully uploaded and verified file in GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:Using specified environment ce970b80-0cbc-4861-b6bd-449e1590a99c (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: b845111f-7c3a-4f80-b930-9b14560779fd)
INFO:app.api.new_extract:üîß Getting enhanced extraction service...
INFO:app.services.claude.service:üîÑ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:üîë API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:‚úÖ Claude API client initialized successfully
INFO:app.services.claude.service:üìã Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic Extraction Service initialized
INFO:app.services.claude.service:‚úÖ Claude Document AI Service initialized
INFO:app.services.claude.service:üìã Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìã Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìè Limits: 32MB, 100 pages
INFO:app.services.claude.service:üõ°Ô∏è  Rate limiting: ENABLED (50 RPM, 25,500 TPM)
INFO:app.services.claude.service:üíæ Prompt caching: SUPPORTED
INFO:app.services.enhanced_extraction_service:‚úÖ Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:üÜï PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:üìã FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:‚è±Ô∏è  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:üöÄ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:‚úÖ Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:üöÄ Starting extraction task...
INFO:app.api.new_extract:üìä Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:‚úÖ CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:üîç Extracting metadata with Claude from: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.claude.service:üìä Estimated tokens for request: 178,977 (54 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (178977/25500). Waiting 59.83s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 1/50 RPM, 178977/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 59.83s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=116,913, output=311
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this commission statement document, I can extract the following metadata:

```json
{
  "carrier_name": "Allied Benefit Systems",
  "carrier_confidence": 0.95,
  "statement_date": "2025-08-06",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.95,
  "document_type": "commission_statement",
  "total_pages": 54,
  "evidence": "Carrier name found in document header 'ABSF Commission Payment Summary' and Allied logo/branding. Statement date found 
INFO:app.services.enhanced_extraction_service:‚úì Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:üì° Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚úÖ Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:üì° Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/08.06.2025 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:Large file detected (54 pages, 0.36MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.utils:üìÑ Created chunk 1/3: Pages 1-25 (~68,750 tokens)
INFO:app.services.claude.utils:üìÑ Created chunk 2/3: Pages 26-50 (~68,750 tokens)
INFO:app.services.claude.utils:üìÑ Created chunk 3/3: Pages 51-54 (~11,000 tokens)
INFO:app.services.claude.service:üìÑ Split document into 3 chunks (25 pages each)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 82,624 (25 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (261601/25500). Waiting 43.36s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 2/50 RPM, 82624/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 43.37s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.442555 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.994378 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.claude.service:‚ùå Claude API error (attempt 1/5): Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV4mJCjib4z8zFDZDwwit'}
ERROR:app.services.claude.service:   Rate limit error: True, Retriable: True
WARNING:app.services.claude.service:‚ö†Ô∏è  Rate limit hit! Retry-After: 168.00s
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 2/5, cache=False)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=53,623, output=1,309
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: I'll extract all tables from this commission statement section, following the standard extraction rules and marking any incomplete tables.

## Table 1: Commission Payment Details

| Group No. | Group Name | Census Ct. | Paid Amount | Billing Period | Adj. Period | Invoice Total | Stoploss Total | Agent Rate | Calculation Method | Writing Agent Number | Writing Agent Name |
|-----------|------------|------------|-------------|----------------|-------------|---------------|----------------|-------
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:‚è≥ Waiting 3s between chunks for rate limit safety...
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 82,624 (25 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (82624/25500). Waiting 60.00s

or upload_id 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:app.api.auto_approval:Auto-approval completed for upload 2e496f0f-585c-4195-9de1-5b4aa4755b3d
INFO:     127.0.0.1:57980 - "POST /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58052 - "GET /api/companies/?view_mode=my_data&environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58072 - "GET /api/companies/user-specific/4488bb05-bd57-458c-915c-4de65619610d/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:58074 - "GET /api/earned-commission/carrier/user-specific/4488bb05-bd57-458c-915c-4de65619610d/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
INFO:     127.0.0.1:57980 - "GET /api/companies/user-specific?environment_id=ce970b80-0cbc-4861-b6bd-449e1590a99c HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [70606]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [79390]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [79390]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
WARNING:  StatReload detected changes in 'app/api/auto_approval.py'. Reloading...
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [80788]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [81165]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [81165]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [83443]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
WARNING:  StatReload detected changes in 'app/utils/filename_utils.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [83443]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [84333]
INFO:     Waiting for application startup.
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 460 expired/inactive sessions
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 307 Temporary Redirect
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:app.api.statements:üîç PDF preview requested for: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîç Checking if file exists in GCS: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
WARNING:app.api.statements:‚ö†Ô∏è File not found at new path: statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:üîÑ Attempting backward compatibility lookup...
INFO:app.api.statements:üîç Extracted upload_id: 2e496f0f-585c-4195-9de1-5b4aa4755b3d, filename: 08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:app.api.statements:üîç Trying old path format with carrier_id: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File found at old path: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ File exists, generating signed URL: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.statements:‚úÖ Signed URL generated successfully for: statements/4488bb05-bd57-458c-915c-4de65619610d/08.06.2025 Allied Innovative Payment 2.pdf
INFO:     127.0.0.1:61599 - "GET /api/pdf-preview/?gcs_key=statements%2F2e496f0f-585c-4195-9de1-5b4aa4755b3d%2F08.06.2025%20Allied%20Innovative%20Payment%202.pdf HTTP/1.1" 200 OK
INFO:     127.0.0.1:61601 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:61682 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1762985476844_vv5imenjx. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:     127.0.0.1:61736 - "WebSocket /api/ws/progress/upload_1762985476844_vv5imenjx?session_id=session_1762985476872_w25lakt7x" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1762985476844_vv5imenjx, session_id=session_1762985476872_w25lakt7x, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1762985476844_vv5imenjx, session_id: session_1762985476872_w25lakt7x
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1762985476844_vv5imenjx
INFO:     127.0.0.1:61738 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:üìÅ File: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üîë Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üìè Size: 373495 bytes
INFO:app.api.new_extract:üë§ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üîç Checking for user duplicates - Hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:üìö Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/2e496f0f-585c-4195-9de1-5b4aa4755b3d/08.06.2025 Allied Innovative Payment 2.pdf: hash=98272fc00893adae..., status=approved
INFO:app.services.duplicate_detection_service:  - statements/defb777c-dfcb-4c37-8ec2-bd62ac58a1a2/01.13.2025.2 Allied Innovative Payment.pdf: hash=3e2ff2652f27d527..., status=Approved
INFO:app.services.duplicate_detection_service:‚ùå No duplicate found for hash: b86b185f1745fb0ff4d40f49c6e12a271f365b94b41c50a3428c5150623593a2
INFO:app.api.new_extract:üöÄ Starting extract-tables-smart for file: 08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìÅ File path: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:üìä File size: 373495 bytes
INFO:app.api.new_extract:üÜî Upload ID: upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:üíæ Saving uploaded file...
INFO:app.api.new_extract:‚úÖ File saved successfully
INFO:app.api.new_extract:üì§ Uploading file to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ File uploaded to GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.api.new_extract:‚úÖ Successfully uploaded and verified file in GCS: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:Using specified environment ce970b80-0cbc-4861-b6bd-449e1590a99c (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: b845111f-7c3a-4f80-b930-9b14560779fd)
INFO:app.api.new_extract:üîß Getting enhanced extraction service...
INFO:app.services.claude.service:üîÑ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:üîë API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:‚úÖ Claude API client initialized successfully
INFO:app.services.claude.service:üìã Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic Extraction Service initialized
INFO:app.services.claude.service:‚úÖ Claude Document AI Service initialized
INFO:app.services.claude.service:üìã Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìã Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:üìè Limits: 32MB, 100 pages
INFO:app.services.claude.service:üõ°Ô∏è  Rate limiting: ENABLED (50 RPM, 25,500 TPM)
INFO:app.services.claude.service:üíæ Prompt caching: SUPPORTED
INFO:app.services.enhanced_extraction_service:‚úÖ Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:üÜï PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:üìã FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:‚è±Ô∏è  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:üöÄ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:‚úÖ Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:üöÄ Starting extraction task...
INFO:app.api.new_extract:üìä Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:‚úÖ CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:üîç Extracting metadata with Claude from: pdfs/08.06.2025 Allied Innovative Payment.pdf
INFO:app.services.claude.service:üìä Estimated tokens for request: 178,977 (54 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (178977/25500). Waiting 59.83s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 1/50 RPM, 178977/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 59.83s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=116,913, output=311
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this commission statement document, I can extract the following metadata:

```json
{
  "carrier_name": "Allied Benefit Systems",
  "carrier_confidence": 0.95,
  "statement_date": "2025-08-06",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.95,
  "document_type": "commission_statement",
  "total_pages": 54,
  "evidence": "Carrier name found in document header 'ABSF Commission Payment Summary' and Allied logo/branding. Statement date found 
INFO:app.services.enhanced_extraction_service:‚úì Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:üì° Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚úÖ Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:üì° Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/08.06.2025 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:Large file detected (54 pages, 0.36MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.utils:üìÑ Created chunk 1/3: Pages 1-25 (~68,750 tokens)
INFO:app.services.claude.utils:üìÑ Created chunk 2/3: Pages 26-50 (~68,750 tokens)
INFO:app.services.claude.utils:üìÑ Created chunk 3/3: Pages 51-54 (~11,000 tokens)
INFO:app.services.claude.service:üìÑ Split document into 3 chunks (25 pages each)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 82,624 (25 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (261601/25500). Waiting 43.36s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 2/50 RPM, 82624/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 43.37s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.442555 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.994378 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.claude.service:‚ùå Claude API error (attempt 1/5): Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV4mJCjib4z8zFDZDwwit'}
ERROR:app.services.claude.service:   Rate limit error: True, Retriable: True
WARNING:app.services.claude.service:‚ö†Ô∏è  Rate limit hit! Retry-After: 168.00s
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 2/5, cache=False)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=53,623, output=1,309
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: I'll extract all tables from this commission statement section, following the standard extraction rules and marking any incomplete tables.

## Table 1: Commission Payment Details

| Group No. | Group Name | Census Ct. | Paid Amount | Billing Period | Adj. Period | Invoice Total | Stoploss Total | Agent Rate | Calculation Method | Writing Agent Number | Writing Agent Name |
|-----------|------------|------------|-------------|----------------|-------------|---------------|----------------|-------
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:‚è≥ Waiting 3s between chunks for rate limit safety...
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 82,624 (25 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (82624/25500). Waiting 60.00s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 1/50 RPM, 82624/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 60.00s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=54,501, output=2,604
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: I'll extract all tables from this section of the commission statement, marking any incomplete tables appropriately.

## Table 1: Commission Details (Continued from previous chunk)
**Status: Incomplete - continues from previous chunk**

| Group No. | Group Name | Billing Period | Adj. Period | Invoice Total | Stoploss Total | Agent Rate | Calculation Method | Census Ct. | Paid Amount |
|-----------|------------|----------------|-------------|---------------|----------------|------------|---------
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:‚è≥ Waiting 3s between chunks for rate limit safety...
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 13,324 (4 pages)
WARNING:app.services.claude.utils:‚ö†Ô∏è  TPM limit would be exceeded (95948/25500). Waiting 20.52s
INFO:app.services.claude.utils:‚úÖ Rate limit status: 2/50 RPM, 13324/25500 TPM
INFO:app.services.claude.service:‚è±Ô∏è  Waited 20.52s for rate limit compliance
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 21.000000 seconds
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=8,719, output=858
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: I'll extract all tables from this section of the commission statement, following the standard extraction rules and marking any incomplete tables.

## Table 1: Commission Details (Continuation from previous pages)

**Table Type:** Commission Payment Details
**Incomplete:** No (this section appears complete)

| Group No. | Group Name | Billing Period | Adj. Period | Invoice Total | Stoploss Total | Agent Rate | Calculation Method | Census Ct. | Paid Amount |
|-----------|------------|-------------
INFO:app.services.claude.service:üöÄ Running enhanced 3-phase extraction pipeline...
INFO:app.services.claude.service:   Phase 1: Document Intelligence ‚úì (completed)
INFO:app.services.claude.service:   Phase 2: Semantic Extraction ‚Üí Starting...
INFO:app.services.claude.service:   Phase 3: Intelligent Summarization ‚Üí Pending...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage semantic_analysis for upload upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:üìä Phase 2: Semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:üîç Starting semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:üìä Extracted 0 writing agents: []
INFO:app.services.claude.semantic_extractor:üìä Extracted 0 groups/companies
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic extraction completed successfully
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed stage semantic_analysis for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:‚úçÔ∏è Phase 3: Intelligent summarization...
INFO:app.services.claude.service:üìä Semantic result keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.claude.service:   - Entities: ‚úÖ
INFO:app.services.claude.service:   - Relationships: ‚úÖ
INFO:app.services.claude.service:   - Business Intelligence: ‚úÖ
INFO:app.services.claude.service:üìù Summary service available: True
INFO:app.services.claude.service:üöÄ Calling generate_conversational_summary with use_enhanced=True...
INFO:app.services.conversational_summary_service:üó£Ô∏è Generating conversational summary...
INFO:app.services.conversational_summary_service:üîç _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.conversational_summary_service:‚úÖ Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:üéØ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: ['carrier', 'broker', 'writing_agents', 'groups_and_companies', 'document_metadata']
INFO:app.services.conversational_summary_service:   - Relationships: ['carrier_to_broker', 'broker_to_agents', 'agents_to_groups', 'groups_to_payments']
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['total_commission_amount', 'number_of_groups', 'commission_structures', 'top_contributors', 'special_payments', 'payment_period', 'patterns_detected']
INFO:app.services.conversational_summary_service:‚úÖ SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:üöÄ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:‚úÖ SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:üöÄ Calling Claude API for summary generation...
INFO:app.services.conversational_summary_service:   Model: claude-sonnet-4-20250514
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 9356 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.conversational_summary_service:‚úÖ Claude API call successful
INFO:app.services.conversational_summary_service:   Response content blocks: 1
INFO:app.services.conversational_summary_service:‚úÖ Detected structured JSON response from Claude
INFO:app.services.conversational_summary_service:üìä Claude provided 0 fields: []
INFO:app.services.conversational_summary_service:‚úÖ Extracted structured summary data (3 fields): ['company_count', 'broker_id_confidence', 'commission_structure']
INFO:app.services.conversational_summary_service:‚úÖ Fallback added 3 missing fields: ['broker_id_confidence', 'company_count', 'commission_structure']
INFO:app.services.conversational_summary_service:üìÑ Generated summary length: 765 characters
INFO:app.services.conversational_summary_service:üìä Final structured data keys: ['company_count', 'broker_id_confidence', 'commission_structure']
INFO:app.services.claude.service:‚úÖ Summary generation completed. Success: True
INFO:app.services.claude.service:üìÑ Generated summary (first 200 chars): This is This is a commission document with 54 pages that appears to be incomplete or corrupted, as no carrier name, broker company, statement date, or commission details could be extracted from the pr...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1762985476844_vv5imenjx
INFO:app.services.claude.service:‚úÖ Enhanced 3-phase pipeline completed successfully
INFO:app.services.claude.service:üì¶ Enhanced result keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'quality_summary', 'metadata', 'extraction_quality', 'entities', 'relationships', 'business_intelligence', 'summary', 'structured_data', 'extraction_pipeline', 'semantic_extraction_success']
INFO:app.services.claude.service:   - Summary length: 765 characters
INFO:app.services.claude.service:   - Summary preview: This is This is a commission document with 54 pages that appears to be incomplete or corrupted, as no carrier name, broker company, statement date, or...
INFO:app.services.claude.service:   - Structured data: {'company_count': 0, 'broker_id_confidence': 0.7, 'commission_structure': 'Standard'}
INFO:app.services.claude.service:‚úÖ Claude extraction completed in 404.89s
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata from Claude extraction results
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude metadata: carrier=None, date=None, broker=None
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:üéØ STAGE 3: CONVERSATIONAL SUMMARY GENERATION
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   - Enhanced mode enabled: True
INFO:app.services.enhanced_extraction_service:   - Result has 'summary': True
INFO:app.services.enhanced_extraction_service:   - Summary service available: True
INFO:app.services.enhanced_extraction_service:‚úÖ Using enhanced summary from Claude pipeline
INFO:app.services.enhanced_extraction_service:   Summary length: 765 characters
INFO:app.services.enhanced_extraction_service:   Summary preview: This is This is a commission document with 54 pages that appears to be incomplete or corrupted, as no carrier name, broker company, statement date, or commission details could be extracted from the pr...
INFO:app.services.enhanced_extraction_service:üì§ Sending Claude-generated summary AND structured data to frontend via WebSocket NOW
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.enhanced_extraction_service:‚úÖ Sent structured summary data to frontend: {'company_count': 0, 'broker_id_confidence': 0.7, 'commission_structure': 'Standard'}
INFO:app.services.enhanced_extraction_service:‚úÖ Claude-generated summary sent to frontend successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:üìù FINAL SUMMARY SELECTION: ENHANCED CONVERSATIONAL
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   Summary length: 765 characters
INFO:app.services.enhanced_extraction_service:   Full summary:
This is This is a commission document with 54 pages that appears to be incomplete or corrupted, as no carrier name, broker company, statement date, or commission details could be extracted from the provided data. The document shows a standard commission structure pattern but lacks all essential financial information including total commission amounts, group details, writing agent information, and payment breakdowns that would typically be present in a commission statement. Without access to the actual commission data, payment periods, or entity relationships, this appears to be either a blank template, corrupted file, or document where the extraction process failed to capture the core business intelligence typically found in carrier commission statements.
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚úÖ Added structured_data to result: ['company_count', 'broker_id_confidence', 'commission_structure']
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Started stage validation for upload upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Completed processing for upload upload_1762985476844_vv5imenjx in 481.51 seconds
INFO:app.api.new_extract:‚úÖ Extraction completed successfully: {'success': True, 'tables': [], 'extraction_method': 'claude', 'file_type': 'pdf', 'document_metadata': {'carrier_name': None, 'carrier_confidence': 0.9, 'statement_date': None, 'date_confidence': 0.9, 'broker_company': None, 'broker_confidence': 0.8, 'total_pages': 54, 'file_size_mb': 0.35619258880615234, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 0, 'total_amount_label': None}, 'extracted_carrier': None, 'extracted_date': None, 'quality_summary': {'overall_confidence': 0.0, 'table_structure_score': 0.0, 'data_completeness': 0.0, 'extraction_accuracy': 0.0, 'issues_detected': ['No tables extracted'], 'quality_grade': 'F'}, 'metadata': {'table_count': 0, 'quality_grade': 'F', 'confidence_score': 0.0, 'token_usage': {'note': 'Chunked processing with rate limiting'}}, 'extraction_quality': {'overall_confidence': 0.0, 'table_structure_score': 0.0, 'data_completeness': 0.0, 'extraction_accuracy': 0.0, 'issues_detected': ['No tables extracted'], 'quality_grade': 'F'}, 'entities': {'carrier': {'name': None, 'confidence': 0.9, 'evidence': 'Document metadata'}, 'broker': {'company_name': None, 'confidence': 0.8, 'evidence': 'Document metadata'}, 'writing_agents': [], 'groups_and_companies': [], 'document_metadata': {'carrier_name': None, 'carrier_confidence': 0.9, 'statement_date': None, 'date_confidence': 0.9, 'broker_company': None, 'broker_confidence': 0.8, 'total_pages': 54, 'file_size_mb': 0.35619258880615234, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 0, 'total_amount_label': None}}, 'relationships': {'carrier_to_broker': {'carrier': None, 'broker': None, 'relationship': 'issues_commission_to'}, 'broker_to_agents': [], 'agents_to_groups': [], 'groups_to_payments': []}, 'business_intelligence': {'total_commission_amount': 'Not specified', 'number_of_groups': 0, 'commission_structures': ['Standard'], 'top_contributors': [], 'special_payments': [], 'payment_period': '', 'patterns_detected': ['Standard commission structure']}, 'summary': 'This is This is a commission document with 54 pages that appears to be incomplete or corrupted, as no carrier name, broker company, statement date, or commission details could be extracted from the provided data. The document shows a standard commission structure pattern but lacks all essential financial information including total commission amounts, group details, writing agent information, and payment breakdowns that would typically be present in a commission statement. Without access to the actual commission data, payment periods, or entity relationships, this appears to be either a blank template, corrupted file, or document where the extraction process failed to capture the core business intelligence typically found in carrier commission statements.', 'structured_data': {'company_count': 0, 'broker_id_confidence': 0.7, 'commission_structure': 'Standard'}, 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:üíæ Updating upload record with results...
INFO:app.api.new_extract:‚úÖ Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: b845111f-7c3a-4f80-b930-9b14560779fd)
INFO:app.api.new_extract:‚úÖ Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is This is a commission document with 54 pages that appears to be incomplete or corrupted, as no carrier name, broker company, statement date, or commission details could be extracted from the provided data. The document shows a standard commission structure pattern but lacks all essential financial information including total commission amounts, group details, writing agent information, and payment breakdowns that would typically be present in a commission statement. Without access to the actual commission data, payment periods, or entity relationships, this appears to be either a blank template, corrupted file, or document where the extraction process failed to capture the core business intelligence typically found in carrier commission statements.
INFO:app.api.new_extract:   Structured data: {'company_count': 0, 'broker_id_confidence': 0.7, 'commission_structure': 'Standard'}
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: b845111f-7c3a-4f80-b930-9b14560779fd)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {"company_count": 0, "broker_id_confidence": 0.7, "commission_structure": "Standard"}...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1762985476844_vv5imenjx: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1762985476844_vv5imenjx
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1762985476844_vv5imenjx
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1762985476844_vv5imenjx
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1762985476844_vv5imenjx, session_id=session_1762985476872_w25lakt7x
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1762985476844_vv5imenjx, session_id=session_1762985476872_w25lakt7x
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1762985476844_vv5imenjx
INFO:     127.0.0.1:61740 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.pdf_proxy:üîÑ Proxying PDF from: https://storage.googleapis.com/pdf_extraction_files_saver/statements/b845111f-7c3a-4f80-b930-9b14560...
INFO:httpx:HTTP Request: GET https://storage.googleapis.com/pdf_extraction_files_saver/statements/b845111f-7c3a-4f80-b930-9b14560779fd/08.06.2025%20Allied%20Innovative%20Payment.pdf?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=docsai-table-extractor%40pdf-tables-extractor-465009.iam.gserviceaccount.com%2F20251112%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20251112T221124Z&X-Goog-Expires=3599&X-Goog-SignedHeaders=host&response-content-disposition=inline&response-content-type=application%2Fpdf&X-Goog-Signature=43bad865eaeef82fe9651bec30fdf16c4db26afc59bd969ac85cf95798b65196b89bcc5d8f481e66cc6956af44a3200d550f39cdd22083cf755e3fd6412bb0d3a564cec41834debda6c181cf6323ef4fbe195b27ab9dc5785d7010de1946d2e6da601a611db1f94c4c697807538e8c44a41a89d9c40e2a66065752c894a2fa4660998d5347ba598fa6dc8f88d55e83fdd70a98f245c981cd5afad44d570f43c6f31dc96ac24d2f9c6f1ed5b86ca4bb44d0e994b5fc46189093c0264e280190a178f73fb69bdb39863781ce1210cf00307fe57bb8b10b592e32f9e8f98e34ef548b43ee68c50ac71e982c693448f193debed31bc192b2f51ce0b8a4a66661c6c0 "HTTP/1.1 200 OK"
INFO:     127.0.0.1:61846 - "GET /api/pdf-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fpdf_extraction_files_saver%2Fstatements%2Fb845111f-7c3a-4f80-b930-9b14560779fd%2F08.06.2025%2520Allied%2520Innovative%2520Payment.pdf%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Ddocsai-table-extractor%2540pdf-tables-extractor-465009.iam.gserviceaccount.com%252F20251112%252Fauto%252Fstorage%252Fgoog4_request%26X-Goog-Date%3D20251112T221124Z%26X-Goog-Expires%3D3599%26X-Goog-SignedHeaders%3Dhost%26response-content-disposition%3Dinline%26response-content-type%3Dapplication%252Fpdf%26X-Goog-Signature%3D43bad865eaeef82fe9651bec30fdf16c4db26afc59bd969ac85cf95798b65196b89bcc5d8f481e66cc6956af44a3200d550f39cdd22083cf755e3fd6412bb0d3a564cec41834debda6c181cf6323ef4fbe195b27ab9dc5785d7010de1946d2e6da601a611db1f94c4c697807538e8c44a41a89d9c40e2a66065752c894a2fa4660998d5347ba598fa6dc8f88d55e83fdd70a98f245c981cd5afad44d570f43c6f31dc96ac24d2f9c6f1ed5b86ca4bb44d0e994b5fc46189093c0264e280190a178f73fb69bdb39863781ce1210cf00307fe57bb8b10b592e32f9e8f98e34ef548b43ee68c50ac71e982c693448f193debed31bc192b2f51ce0b8a4a66661c6c0 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61844 - "GET /api/pending/progress/b845111f-7c3a-4f80-b930-9b14560779fd/table_editor HTTP/1.1" 200 OK
