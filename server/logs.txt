ates a concentrated client relationship, with the larger payments ($419.93 each) representing 82% of the total commission volume. The commission structure appears to follow Allied's standard percentage-based calculation method, though specific rates and member counts are not detailed in this particular statement format.", 'structured_data': {'carrier_name': 'ALLIED', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-01-08', 'total_amount': '1027.20', 'company_count': '1', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '1027.20'}], 'commission_structure': 'Percentage-based'}, 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1763057482518_subz9xqnb
INFO:app.api.new_extract:ğŸ’¾ Updating upload record with results...
INFO:app.api.new_extract:âœ… Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: ec70c446-1066-4e9e-ae78-7f9ff5597204)
INFO:app.api.new_extract:ğŸ†• Carrier 'ALLIED' not found in database, creating automatically...
INFO:app.api.new_extract:âœ… Auto-created carrier: ALLIED with ID 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.new_extract:ğŸ¯ Format Learning: Using carrier ALLIED with ID 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
WARNING:app.api.new_extract:ğŸš¨ CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as ALLIED (35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.api.new_extract:ğŸ”„ Reassigning file to correct carrier: ALLIED
INFO:app.services.gcs_utils:âœ… File copied in GCS: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf -> statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File deleted from GCS: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… File moved to correct carrier folder in GCS: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Updated statement upload: carrier_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc, company_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.new_extract:ğŸ“Š Single table detected, using it for field mapping
INFO:app.api.new_extract:ğŸ¯ Using table 0 for field mapping with 10 headers
ğŸ¯ FormatLearningService: Finding matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ FormatLearningService: Headers type: <class 'list'>
ğŸ¯ FormatLearningService: Headers length: 10
ğŸ¯ CRUD: Finding best matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD: Input table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ CRUD: Found 0 saved formats for company
ğŸ¯ FormatLearningService: Best match score: 0
ğŸ¯ FormatLearningService: No matching format found
INFO:app.api.new_extract:ğŸ¯ Format Learning: No matching format found (score: 0.0)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:ğŸ” AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:âœ… AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763057482518_subz9xqnb
INFO:app.api.new_extract:ğŸ§  AI Field Mapping: Starting field mapping during extraction
INFO:app.api.ai_intelligent_mapping:ğŸš€ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ğŸ¤– AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:ğŸ” AI Mapping: carrier_id provided: True (value: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.services.ai_field_mapping_service:ğŸ¯ Carrier ID is valid, attempting to retrieve learned mapping for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.services.ai_field_mapping_service:ğŸ” Generated format signature for lookup: 434609905947a9e8728df0b79ba381ce
INFO:app.services.ai_field_mapping_service:ğŸ” Looking up learned format for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc with 10 headers
INFO:app.services.ai_field_mapping_service:âŒ No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:ğŸ” Found 0 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:âŒ No matching format found
INFO:app.services.ai_field_mapping_service:âŒ No learned mapping found for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:âœ… AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:âœ… AI Mapping: Generated 10 mappings with 0.86 confidence
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:âœ… Enhanced AI Analysis Complete: Overall confidence 0.88
INFO:app.api.new_extract:âœ… AI Field Mapping: 10 mappings with 0.86 confidence
INFO:app.api.new_extract:âœ… Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is This is an Allied commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total of $1,027.20 in commissions exclusively from SOAR LOGISTICS LL across four separate payment entries. The statement reveals an interesting payment pattern with two identical amounts of $419.93 each and two matching amounts of $93.67 each, suggesting either different billing periods or plan types for the same client group. While no specific writing agents are identified in the documentation, the uniform focus on a single logistics company indicates a concentrated client relationship, with the larger payments ($419.93 each) representing 82% of the total commission volume. The commission structure appears to follow Allied's standard percentage-based calculation method, though specific rates and member counts are not detailed in this particular statement format.
INFO:app.api.new_extract:   Structured data: {'carrier_name': 'ALLIED', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-01-08', 'total_amount': '1027.20', 'company_count': '1', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '1027.20'}], 'commission_structure': 'Percentage-based'}
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: ec70c446-1066-4e9e-ae78-7f9ff5597204)
INFO:app.api.new_extract:ğŸ“¤ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:ğŸ“Š Sending structured data: {"carrier_name": "ALLIED", "broker_company": "INNOVATIVE BPS LLC", "statement_date": "2025-01-08", "total_amount": "1027.20", "company_count": "1", "broker_id_confidence": 0.7, "top_contributors": [{"...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763057482518_subz9xqnb
INFO:app.api.new_extract:âœ… Extraction complete! Sent results via WebSocket for upload_id: upload_1763057482518_subz9xqnb
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763057482518_subz9xqnb, session_id=session_1763057482543_c9bu8ixy8
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763057482518_subz9xqnb, session_id=session_1763057482543_c9bu8ixy8
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763057482518_subz9xqnb
INFO:     127.0.0.1:61248 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.pdf_proxy:ğŸ”„ Proxying PDF from: https://storage.googleapis.com/pdf_extraction_files_saver/statements/35df0e13-76d7-4a42-b66a-2f1a4d8...
INFO:httpx:HTTP Request: GET https://storage.googleapis.com/pdf_extraction_files_saver/statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2%20Allied%20Innovative%20Payment.pdf?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=docsai-table-extractor%40pdf-tables-extractor-465009.iam.gserviceaccount.com%2F20251113%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20251113T181203Z&X-Goog-Expires=3599&X-Goog-SignedHeaders=host&response-content-disposition=inline&response-content-type=application%2Fpdf&X-Goog-Signature=2bb0e11c77c344376efc60f32a4ec24696c1f2ae883a5c4b1479b4970a9adc88f8e403a2c60b481e4270af1771a0a93ec51fe19ceea152698980e9a092e906d14cf325891ddd7b56cfdf9b6362c4543b8fc119da8915d137e05d671127253405bf17247618c1bc6995c15dd26a4a0d31710af4b3dbcb71ca669de2ef95a34ee77126280802bd0d37c5785594dc6bd7d6f88e20ca407ab4eb1380e74c12f32196b0adf56061311f47d99ef778d49dc97d767b84125a36e8129e0f5ef2188b7c5c89332bff3f9a73104604bd387f7baddc84d898f4b8e67c5adc251065576c83671ef5689b98926c8a59771052642c867732773df187f5734762e26aee92e01d80 "HTTP/1.1 200 OK"
INFO:     127.0.0.1:61603 - "GET /api/pdf-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fpdf_extraction_files_saver%2Fstatements%2F35df0e13-76d7-4a42-b66a-2f1a4d8f96cc%2F01.13.2025.2%2520Allied%2520Innovative%2520Payment.pdf%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Ddocsai-table-extractor%2540pdf-tables-extractor-465009.iam.gserviceaccount.com%252F20251113%252Fauto%252Fstorage%252Fgoog4_request%26X-Goog-Date%3D20251113T181203Z%26X-Goog-Expires%3D3599%26X-Goog-SignedHeaders%3Dhost%26response-content-disposition%3Dinline%26response-content-type%3Dapplication%252Fpdf%26X-Goog-Signature%3D2bb0e11c77c344376efc60f32a4ec24696c1f2ae883a5c4b1479b4970a9adc88f8e403a2c60b481e4270af1771a0a93ec51fe19ceea152698980e9a092e906d14cf325891ddd7b56cfdf9b6362c4543b8fc119da8915d137e05d671127253405bf17247618c1bc6995c15dd26a4a0d31710af4b3dbcb71ca669de2ef95a34ee77126280802bd0d37c5785594dc6bd7d6f88e20ca407ab4eb1380e74c12f32196b0adf56061311f47d99ef778d49dc97d767b84125a36e8129e0f5ef2188b7c5c89332bff3f9a73104604bd387f7baddc84d898f4b8e67c5adc251065576c83671ef5689b98926c8a59771052642c867732773df187f5734762e26aee92e01d80 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61601 - "GET /api/pending/progress/ec70c446-1066-4e9e-ae78-7f9ff5597204/table_editor HTTP/1.1" 200 OK
INFO:     127.0.0.1:61678 - "OPTIONS /api/table-editor/save-tables/ HTTP/1.1" 200 OK
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saving edited tables for upload_id: ec70c446-1066-4e9e-ae78-7f9ff5597204
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Tables count: 1
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Selected statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Company ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Field config received: [{'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Processing carrier (potentially corrected by user): ALLIED
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Using existing carrier: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc (ALLIED)
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Updating upload with tables, statement date, and carrier
ğŸ¯ CRUD: update_upload_tables called for upload_id: ec70c446-1066-4e9e-ae78-7f9ff5597204
ğŸ¯ CRUD: Tables data length: 1
ğŸ¯ CRUD: Selected statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
ğŸ¯ CRUD: Carrier ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Found upload, updating with tables, statement date, and carrier
ğŸ¯ CRUD: Saved selected statement date to database: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
ğŸ¯ CRUD: Statement date type: <class 'dict'>
ğŸ¯ CRUD: Statement date keys: ['date', 'confidence', 'source']
ğŸ¯ CRUD: Linking statement to carrier: carrier_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc, company_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Also saved statement date and carrier to progress_data
ğŸ¯ CRUD: Successfully updated upload ec70c446-1066-4e9e-ae78-7f9ff5597204 with tables, statement date, and carrier
ğŸ¯ CRUD: Final selected_statement_date in database: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully updated upload with statement date and carrier
INFO:app.api.table_editor:ğŸ“ Normalizing filename for upload ec70c446-1066-4e9e-ae78-7f9ff5597204
INFO:app.api.table_editor:ğŸ“ Current filename: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.table_editor:ğŸ“ New normalized filename: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/ALLIED_2025-01.pdf
ERROR:app.services.gcs_utils:Source file not found in GCS for rename: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf
WARNING:app.api.table_editor:âš ï¸ Failed to rename file in GCS, keeping original filename
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Learning format patterns from edited tables for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor Format Learning: Saving 10 field mappings
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully learned format with signature: 434609905947a9e8728df0b79ba381ce for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully learned table editor format patterns
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully saved 1 edited tables
INFO:     127.0.0.1:61680 - "POST /api/table-editor/save-tables/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:61723 - "OPTIONS /api/table-editor/learn-format-patterns HTTP/1.1" 200 OK
INFO:app.api.table_editor:ğŸ¯ Format Learning: Processing carrier (may be user-corrected): ALLIED
INFO:app.api.table_editor:ğŸ¯ Format Learning: Using existing carrier: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Format Learning: Extracted 10 field mappings from field_config
INFO:app.api.table_editor:ğŸ¯ Format Learning: Field mappings: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
INFO:app.api.table_editor:Successfully learned format patterns with signature: 434609905947a9e8728df0b79ba381ce for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:     127.0.0.1:61680 - "POST /api/table-editor/learn-format-patterns HTTP/1.1" 200 OK
INFO:     127.0.0.1:61723 - "OPTIONS /api/companies/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/mapping/?upload_id=ec70c446-1066-4e9e-ae78-7f9ff5597204 HTTP/1.1" 200 OK
INFO:app.api.mapping:ğŸ¯ Mapping API: Received mapping request for carrier/company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Upload ID: ec70c446-1066-4e9e-ae78-7f9ff5597204
INFO:app.api.mapping:ğŸ¯ Mapping API: Config received - mapping keys: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Selected statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.mapping:ğŸ¯ Mapping API: Table data rows: 4
INFO:app.api.mapping:ğŸ¯ Mapping API: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Retrieved carrier_id from upload: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Final carrier_id to use: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Saved 10 field mappings for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Saved configuration for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Learning format from processed file for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Table data length: 4
INFO:app.api.mapping:ğŸ¯ Mapping API: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Mapping: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
INFO:app.api.mapping:ğŸ¯ Mapping API: Retrieved carrier name for format learning: ALLIED
ğŸ¯ FormatLearningService: Learning from processed file for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Field mapping: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
ğŸ¯ FormatLearningService: Table data length: 4
ğŸ¯ FormatLearningService: Generated format signature: 434609905947a9e8728df0b79ba381ce
ğŸ¯ FormatLearningService: Found potential total field: Invoice Total at index 4
ğŸ¯ FormatLearningService: Extracted total from data row: 9336.9
ğŸ¯ FormatLearningService: Total amount extracted: $9336.90 from field 'Invoice Total'
ğŸ¯ FormatLearningService: Saving corrected carrier name: ALLIED
ğŸ¯ FormatLearningService: Saving corrected statement date: 2025-01-08
ğŸ¯ FormatLearningService: Saving total amount: $9336.90
ğŸ¯ FormatLearningService: Final enhanced table editor settings keys: ['carrier_name', 'corrected_carrier_name', 'statement_date', 'corrected_statement_date', 'statement_total_amount', 'total_amount_field_name']
ğŸ¯ FormatLearningService: Successfully learned format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Format learning completed successfully for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Processing commission data with statement date
INFO:app.api.mapping:ğŸ¯ Mapping API: Statement date object: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
WARNING:app.api.mapping:ğŸ¯ Mapping API: Could not retrieve environment_id: module 'app.db.crud' has no attribute 'get_statement_upload'
INFO:app.api.mapping:ğŸ¯ Commission Processing: Starting commission data processing
INFO:app.api.mapping:ğŸ¯ Commission Processing: Company ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Commission Processing: Table data rows: 4
INFO:app.api.mapping:ğŸ¯ Commission Processing: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Commission Processing: Mapping: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
INFO:app.api.mapping:ğŸ¯ Commission Processing: Statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.mapping:ğŸ¯ Commission Processing: Date value extracted: 2025-01-08
INFO:app.api.mapping:ğŸ¯ Date Parsing: Attempting to parse date: 2025-01-08
INFO:app.api.mapping:ğŸ¯ Date Parsing: Successfully parsed date '2025-01-08' with format '%Y-%m-%d' -> 2025-01-08 00:00:00
INFO:app.api.mapping:ğŸ¯ Commission Processing: Parsed date: 2025-01-08 00:00:00
INFO:app.api.mapping:ğŸ¯ Commission Processing: Month: 1, Year: 2025
INFO:app.api.mapping:ğŸ¯ Commission Processing: Found client name column: Group Name -> Client Name
INFO:app.api.mapping:ğŸ¯ Commission Processing: Found invoice total column: Invoice Total -> Invoice Total
INFO:app.api.mapping:ğŸ¯ Commission Processing: Found commission column: Paid Amount -> Commission Earned
INFO:app.api.mapping:ğŸ¯ Commission Processing: Final column mapping - Client: Group Name, Invoice: Invoice Total, Commission: Paid Amount
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 0 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $93.67
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 0 - Parsed values - Invoice: 9336.9, Commission: 93.67
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating new record with user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191 and environment_id: None
INFO:app.api.mapping:ğŸ¯ Commission Record: Set jan_commission = 93.67
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully created new record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 0
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 1 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $419.93
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 1 - Parsed values - Invoice: 9336.9, Commission: 419.93
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Updating existing record ID 3c92ffe9-98eb-4e7f-b0b2-4a3e6b6207be
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully updated existing record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 1
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 2 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $93.67
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 2 - Parsed values - Invoice: 9336.9, Commission: 93.67
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Updating existing record ID 3c92ffe9-98eb-4e7f-b0b2-4a3e6b6207be
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully updated existing record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 2
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 3 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $419.93
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 3 - Parsed values - Invoice: 9336.9, Commission: 419.93
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Updating existing record ID 3c92ffe9-98eb-4e7f-b0b2-4a3e6b6207be
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully updated existing record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 3
INFO:app.api.mapping:ğŸ¯ Commission Processing: Completed processing 4 rows with statement date 2025-01-08
Processed commission data for 4 rows with statement date 2025-01-08
INFO:app.api.mapping:ğŸ¯ Mapping API: Commission data processing completed successfully
INFO:app.api.mapping:ğŸ¯ Mapping API: Mapping update completed successfully for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:     127.0.0.1:61680 - "POST /api/companies/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/mapping/?upload_id=ec70c446-1066-4e9e-ae78-7f9ff5597204 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61846 - "OPTIONS /api/review/approve/ HTTP/1.1" 200 OK
ğŸ’¾ Saving statement review: upload_id=ec70c446-1066-4e9e-ae78-7f9ff5597204, status=Approved
ğŸ“‹ Field config being saved: [{'display_name': 'Policy Number', 'source_field': 'Group No.'}, {'display_name': 'Client Name', 'source_field': 'Group Name'}, {'display_name': 'Coverage Period Start', 'source_field': 'Billing Period'}, {'display_name': 'Adjustment Period Start', 'source_field': 'Adj. Period'}, {'display_name': 'Invoice Total', 'source_field': 'Invoice Total'}, {'display_name': 'Stoploss Total', 'source_field': 'Stoploss Total'}, {'display_name': 'Commission Rate', 'source_field': 'Agent %'}, {'display_name': 'Plan Type', 'source_field': 'Calculation Method'}, {'display_name': 'Total Subscribers', 'source_field': 'Census Ct.'}, {'display_name': 'Commission Earned', 'source_field': 'Paid Amount'}]
ğŸ“Š Final data rows: 1
ğŸ“… Selected statement date being saved: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
ğŸ” DEBUG Saving table 0 'Unnamed Table': summaryRows=[], type=<class 'list'>
ğŸ“ Extracted field_mapping with 10 mappings: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
ğŸ’° Calculating extracted_total for manual approval...
ğŸ’° field_mapping keys: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ’° Number of tables in final_data: 1
ğŸ’° Found commission field (EXACT MATCH): Paid Amount -> Commission Earned
ğŸ’° Final commission_source_field: Paid Amount
  ğŸ“Š Table 0: 10 headers, 4 rows
  ğŸ“‹ Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  ğŸ“‹ First row sample: {'Group No.': 'L244338', 'Group Name': 'SOAR LOGISTICS LL', 'Billing Period': '12/1/2024', 'Adj. Period': '12/1/2024', 'Invoice Total': '$9,336.90', 'Stoploss Total': '$3,514.94', 'Agent %': '6%', 'Calculation Method': 'Premium Equivalent', 'Census Ct.': '4', 'Paid Amount': '$93.67'}
  ğŸ’° Table 0: Commission column 'Paid Amount' at index 9
    Row 0: [DICT] raw_value = '$93.67' (type: <class 'str'>)
    Row 0: Added $93.67 (running total: $93.67)
    Row 1: [DICT] raw_value = '$419.93' (type: <class 'str'>)
    Row 1: Added $419.93 (running total: $513.60)
    Row 2: [DICT] raw_value = '$93.67' (type: <class 'str'>)
    Row 2: Added $93.67 (running total: $607.27)
    Row 3: [DICT] raw_value = '$419.93' (type: <class 'str'>)
    Row 3: Added $419.93 (running total: $1027.20)
  âœ… Table 0 total: $1027.20
ğŸ’° Final extracted_total: $1027.20
ğŸ’° Calculating extracted_invoice_total for manual approval...
ğŸ’° Found invoice field (exact match): Invoice Total -> Invoice Total
  ğŸ“Š Table 0: 10 headers, 4 rows
  ğŸ“‹ Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  ğŸ“‹ First row sample: {'Group No.': 'L244338', 'Group Name': 'SOAR LOGISTICS LL', 'Billing Period': '12/1/2024', 'Adj. Period': '12/1/2024', 'Invoice Total': '$9,336.90', 'Stoploss Total': '$3,514.94', 'Agent %': '6%', 'Calculation Method': 'Premium Equivalent', 'Census Ct.': '4', 'Paid Amount': '$93.67'}
  ğŸ’° Table 0: Invoice column 'Invoice Total' at index 4
    Row 0: [DICT] invoice_value = '$9,336.90'
    Row 0: Added $9336.90 to invoice (running total: $9336.90)
    Row 1: [DICT] invoice_value = '$9,336.90'
    Row 1: Added $9336.90 to invoice (running total: $18673.80)
    Row 2: [DICT] invoice_value = '$9,336.90'
    Row 2: Added $9336.90 to invoice (running total: $28010.70)
    Row 3: [DICT] invoice_value = '$9,336.90'
    Row 3: Added $9336.90 to invoice (running total: $37347.60)
  âœ… Table 0 invoice total: $37347.60
ğŸ’° Final extracted_invoice_total: $37347.60
âœ… Set extracted_total=1027.2, total_amount_match=True
âœ… Set extracted_invoice_total=37347.6
âœ… Statement approved, processing commission data with BULK OPTIMIZATION...
ğŸš€ BULK PROCESSING: Starting optimized commission processing for upload ec70c446-1066-4e9e-ae78-7f9ff5597204
ğŸ” Extracting field mappings from: [{'display_name': 'Policy Number', 'source_field': 'Group No.'}, {'display_name': 'Client Name', 'source_field': 'Group Name'}, {'display_name': 'Coverage Period Start', 'source_field': 'Billing Period'}, {'display_name': 'Adjustment Period Start', 'source_field': 'Adj. Period'}, {'display_name': 'Invoice Total', 'source_field': 'Invoice Total'}, {'display_name': 'Stoploss Total', 'source_field': 'Stoploss Total'}, {'display_name': 'Commission Rate', 'source_field': 'Agent %'}, {'display_name': 'Plan Type', 'source_field': 'Calculation Method'}, {'display_name': 'Total Subscribers', 'source_field': 'Census Ct.'}, {'display_name': 'Commission Earned', 'source_field': 'Paid Amount'}]
âœ… Found client name field: Group Name -> Client Name
âœ… Found invoice total field (exact): Invoice Total -> Invoice Total
âœ… Found commission field (exact match): Paid Amount -> Commission Earned
ğŸ” Extracted field mappings: {'client_name_field': 'Group Name', 'commission_earned_field': 'Paid Amount', 'invoice_total_field': 'Invoice Total'}
   âœ… Client Name: Using 'Group Name'
   âœ… Commission Earned: Using 'Paid Amount'
   âœ… Invoice Total: Using 'Invoice Total'
âœ… OPTIMIZED: Pre-extracted field mappings: client=Group Name, commission=Paid Amount, invoice=Invoice Total
ğŸ‘¤ Processing for user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191
ğŸŒ Processing for environment_id: 9f4a7a57-5715-4b1e-98a9-b9901726a485
ğŸ“… Statement date: 2025-01-08 00:00:00 (month: 1, year: 2025)
ğŸ“Š Table 0: Mapped fields - client[1]=Group Name, commission[9]=Paid Amount, invoice[4]=Invoice Total
ğŸ” DEBUG Table 0: summaryRows raw value: [], type: <class 'list'>
âš ï¸  Table 0: NO summary rows to exclude - all rows will be processed
ğŸ“Š Extracted 4 commission records for bulk processing
ğŸ” Found 1 clients with multiple statement rows:
   1. SOAR LOGISTICS LL: 4 rows, total commission: $1027.20
ğŸ“Š Commission Analysis: {'total_records': 4, 'unique_clients': 1, 'clients_with_multiple_rows': 1}
ğŸ” Bulk fetch: Looking up 1 unique commission records (with user isolation)
âœ… Bulk fetch: Found 0 existing records for specified users
ğŸ“Š Aggregating 4 individual records by unique constraint...
âœ… Aggregated into 1 unique commission records (with user isolation)
   ğŸ“‹ SOAR LOGISTICS LL (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $1027.20 commission, $37347.60 invoice
ğŸ“Š Bulk operations prepared: 0 updates, 1 inserts
â• Executing bulk insert for 1 records
âœ… BULK PROCESSING: Successfully processed 4 records
ğŸ“ˆ Performance: Reduced from 600-800 DB operations to 2-3 operations
INFO:     127.0.0.1:61848 - "POST /api/review/approve/ HTTP/1.1" 200 OK
ğŸ” Auth Status - All cookies: ['__next_hmr_refresh_hash__', 'access_token', 'refresh_token', 'session_token']
ğŸ” Auth Status - Access token present: True
ğŸ” Auth Status - Request host: localhost:8000
ğŸ” Auth Status - Request origin: http://localhost:3000
ğŸ” Auth Status - Cookie __next_hmr_refresh_hash__: 38b1362e0cad76e6df5faeceef21be02633457081244afec
ğŸ” Auth Status - Cookie access_token: eyJhbGciOiJIUzI1NiIs...
ğŸ” Auth Status - Cookie refresh_token: eyJhbGciOiJIUzI1NiIs...
ğŸ” Auth Status - Cookie session_token: 06f60d9c-a3bb-4ca6-b...
INFO:     127.0.0.1:61848 - "GET /api/auth/otp/status HTTP/1.1" 200 OK
ğŸ” Debug - All cookies received: ['__next_hmr_refresh_hash__', 'access_token', 'refresh_token', 'session_token']
ğŸ” Debug - Access token present: True
INFO:     127.0.0.1:61848 - "GET /api/auth/permissions HTTP/1.1" 200 OK
INFO:     127.0.0.1:61887 - "GET /environments HTTP/1.1" 200 OK
INFO:     127.0.0.1:61899 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61887 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61903 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61901 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:61848 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61897 - "GET /api/dashboard/stats?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:61899 - "GET /api/companies/user-specific HTTP/1.1" 200 OK
INFO:     127.0.0.1:61887 - "GET /api/companies/?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:61903 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61901 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61848 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025 HTTP/1.1" 200 OK}], 'groups_to_payments': [{'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}]}, 'business_intelligence': {'total_commission_amount': 'Not specified', 'number_of_groups': 4, 'commission_structures': ['Premium Equivalent', 'Percentage-based'], 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$93.67'}], 'special_payments': [], 'payment_period': '', 'patterns_detected': ['Standard commission structure']}, 'summary': "This is This is an Allied commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total of $1,027.20 in commissions exclusively from SOAR LOGISTICS LL across four separate payment entries. The statement reveals an interesting payment pattern with two identical amounts of $419.93 each and two matching amounts of $93.67 each, suggesting either different billing periods or plan types for the same client group. While no specific writing agents are identified in the documentation, the unifoINFO:     127.0.0.1:62159 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:62159 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763057700614_9hm9htdp0. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763057700614_9hm9htdp0, session_id: session_1763057700644_fvxgyo5kz
INFO:     127.0.0.1:62215 - "WebSocket /api/ws/progress/upload_1763057700614_9hm9htdp0?session_id=session_1763057700644_fvxgyo5kz" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763057700614_9hm9htdp0, session_id=session_1763057700644_fvxgyo5kz, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763057700614_9hm9htdp0, session_id: session_1763057700644_fvxgyo5kz
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ“ File: 01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ”‘ Hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d
INFO:app.api.new_extract:ğŸ“ Size: 326364 bytes
INFO:app.api.new_extract:ğŸ‘¤ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ” Checking for user duplicates - Hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ“š Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf: hash=3e2ff2652f27d527..., status=Approved
INFO:app.services.duplicate_detection_service:âŒ No duplicate found for hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d
INFO:app.api.new_extract:ğŸš€ Starting extract-tables-smart for file: 01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“ File path: pdfs/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“Š File size: 326364 bytes
INFO:app.api.new_extract:ğŸ†” Upload ID: upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ’¾ Saving uploaded file...
INFO:app.api.new_extract:âœ… File saved successfully
INFO:app.api.new_extract:ğŸ“¤ Uploading file to GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File uploaded to GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Successfully uploaded and verified file in GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:Using specified environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: 57077d49-835c-4185-b54b-a9b3dd7c641a)
INFO:app.api.new_extract:ğŸ”§ Getting enhanced extraction service...
INFO:app.services.claude.service:ğŸ”„ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:ğŸ”‘ API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:âœ… Claude API client initialized successfully
INFO:app.services.claude.service:ğŸ“‹ Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:âœ… Semantic Extraction Service initialized
INFO:app.services.claude.service:âœ… Claude Document AI Service initialized
INFO:app.services.claude.service:ğŸ“‹ Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“‹ Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“ Limits: 32MB, 100 pages
INFO:app.services.claude.service:ğŸ›¡ï¸  Rate limiting: ENABLED (50 RPM, 25,500 TPM)
INFO:app.services.claude.service:ğŸ’¾ Prompt caching: SUPPORTED
INFO:app.services.enhanced_extraction_service:âœ… Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:ğŸ†• PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:ğŸ“‹ FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:â±ï¸  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:ğŸš€ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:âœ… Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:ğŸš€ Starting extraction task...
INFO:app.api.new_extract:ğŸ“Š Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:âœ… Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:âœ… CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âš¡ Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:ğŸ” Extracting metadata with Claude from: pdfs/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.claude.service:ğŸ“Š Estimated tokens for request: 122,877 (37 pages)
WARNING:app.services.claude.utils:âš ï¸  TPM limit would be exceeded: 0 current + 122,877 new = 122,877 tokens (limit: 25,500). Waiting 61.85s for token bucket reset.
INFO:app.services.claude.utils:âœ… Token bucket forcefully reset. Proceeding with 122,877 tokens.
INFO:app.services.claude.utils:ğŸ“Š Rate limit status: 1/50 RPM, 122,877/25,500 TPM
INFO:app.services.claude.service:â±ï¸  Waited 61.83s for rate limit compliance
INFO:app.services.claude.service:ğŸ”„ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:âœ… Claude API call successful. Tokens: input=79,317, output=313
INFO:app.services.claude.service:ğŸ“Š Token tracking: Estimated=122,877, Actual=79,317, Diff=-43,560
INFO:app.services.claude.service:ğŸ”§ Token bucket adjusted: 122,877 â†’ 79,317
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this ABSF Commission Payment Summary document, I can extract the following metadata:

```json
{
  "carrier_name": "Allied Benefit Systems",
  "carrier_confidence": 0.95,
  "statement_date": "2025-01-08",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.95,
  "document_type": "commission_statement",
  "total_pages": 37,
  "evidence": "Carrier name found in Allied logo and company branding throughout document. Statement date found as 'Report 
INFO:app.services.enhanced_extraction_service:âœ“ Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âœ… Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/01.13.25 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:Standard file (37 pages, 0.31MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:ğŸ“‹ No carrier-specific prompt for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:ğŸ“Š Estimated tokens for request: 125,488 (37 pages)
WARNING:app.services.claude.utils:âš ï¸  TPM limit would be exceeded: 79,317 current + 125,488 new = 204,805 tokens (limit: 25,500). Waiting 51.22s for token bucket reset.

ates a concentrated client relationship, with the larger payments ($419.93 each) representing 82% of the total commission volume. The commission structure appears to follow Allied's standard percentage-based calculation method, though specific rates and member counts are not detailed in this particular statement format.", 'structured_data': {'carrier_name': 'ALLIED', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-01-08', 'total_amount': '1027.20', 'company_count': '1', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '1027.20'}], 'commission_structure': 'Percentage-based'}, 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1763057482518_subz9xqnb
INFO:app.api.new_extract:ğŸ’¾ Updating upload record with results...
INFO:app.api.new_extract:âœ… Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: ec70c446-1066-4e9e-ae78-7f9ff5597204)
INFO:app.api.new_extract:ğŸ†• Carrier 'ALLIED' not found in database, creating automatically...
INFO:app.api.new_extract:âœ… Auto-created carrier: ALLIED with ID 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.new_extract:ğŸ¯ Format Learning: Using carrier ALLIED with ID 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
WARNING:app.api.new_extract:ğŸš¨ CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as ALLIED (35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.api.new_extract:ğŸ”„ Reassigning file to correct carrier: ALLIED
INFO:app.services.gcs_utils:âœ… File copied in GCS: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf -> statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File deleted from GCS: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… File moved to correct carrier folder in GCS: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Updated statement upload: carrier_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc, company_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.new_extract:ğŸ“Š Single table detected, using it for field mapping
INFO:app.api.new_extract:ğŸ¯ Using table 0 for field mapping with 10 headers
ğŸ¯ FormatLearningService: Finding matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ FormatLearningService: Headers type: <class 'list'>
ğŸ¯ FormatLearningService: Headers length: 10
ğŸ¯ CRUD: Finding best matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD: Input table structure: {'row_count': 4, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ CRUD: Found 0 saved formats for company
ğŸ¯ FormatLearningService: Best match score: 0
ğŸ¯ FormatLearningService: No matching format found
INFO:app.api.new_extract:ğŸ¯ Format Learning: No matching format found (score: 0.0)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:ğŸ” AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:âœ… AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763057482518_subz9xqnb
INFO:app.api.new_extract:ğŸ§  AI Field Mapping: Starting field mapping during extraction
INFO:app.api.ai_intelligent_mapping:ğŸš€ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ğŸ¤– AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:ğŸ” AI Mapping: carrier_id provided: True (value: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.services.ai_field_mapping_service:ğŸ¯ Carrier ID is valid, attempting to retrieve learned mapping for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.services.ai_field_mapping_service:ğŸ” Generated format signature for lookup: 434609905947a9e8728df0b79ba381ce
INFO:app.services.ai_field_mapping_service:ğŸ” Looking up learned format for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc with 10 headers
INFO:app.services.ai_field_mapping_service:âŒ No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:ğŸ” Found 0 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:âŒ No matching format found
INFO:app.services.ai_field_mapping_service:âŒ No learned mapping found for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:âœ… AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:âœ… AI Mapping: Generated 10 mappings with 0.86 confidence
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:âœ… Enhanced AI Analysis Complete: Overall confidence 0.88
INFO:app.api.new_extract:âœ… AI Field Mapping: 10 mappings with 0.86 confidence
INFO:app.api.new_extract:âœ… Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is This is an Allied commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total of $1,027.20 in commissions exclusively from SOAR LOGISTICS LL across four separate payment entries. The statement reveals an interesting payment pattern with two identical amounts of $419.93 each and two matching amounts of $93.67 each, suggesting either different billing periods or plan types for the same client group. While no specific writing agents are identified in the documentation, the uniform focus on a single logistics company indicates a concentrated client relationship, with the larger payments ($419.93 each) representing 82% of the total commission volume. The commission structure appears to follow Allied's standard percentage-based calculation method, though specific rates and member counts are not detailed in this particular statement format.
INFO:app.api.new_extract:   Structured data: {'carrier_name': 'ALLIED', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-01-08', 'total_amount': '1027.20', 'company_count': '1', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '1027.20'}], 'commission_structure': 'Percentage-based'}
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: ec70c446-1066-4e9e-ae78-7f9ff5597204)
INFO:app.api.new_extract:ğŸ“¤ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:ğŸ“Š Sending structured data: {"carrier_name": "ALLIED", "broker_company": "INNOVATIVE BPS LLC", "statement_date": "2025-01-08", "total_amount": "1027.20", "company_count": "1", "broker_id_confidence": 0.7, "top_contributors": [{"...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057482518_subz9xqnb: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057482518_subz9xqnb
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763057482518_subz9xqnb
INFO:app.api.new_extract:âœ… Extraction complete! Sent results via WebSocket for upload_id: upload_1763057482518_subz9xqnb
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763057482518_subz9xqnb, session_id=session_1763057482543_c9bu8ixy8
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763057482518_subz9xqnb, session_id=session_1763057482543_c9bu8ixy8
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763057482518_subz9xqnb
INFO:     127.0.0.1:61248 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.pdf_proxy:ğŸ”„ Proxying PDF from: https://storage.googleapis.com/pdf_extraction_files_saver/statements/35df0e13-76d7-4a42-b66a-2f1a4d8...
INFO:httpx:HTTP Request: GET https://storage.googleapis.com/pdf_extraction_files_saver/statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.2025.2%20Allied%20Innovative%20Payment.pdf?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=docsai-table-extractor%40pdf-tables-extractor-465009.iam.gserviceaccount.com%2F20251113%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20251113T181203Z&X-Goog-Expires=3599&X-Goog-SignedHeaders=host&response-content-disposition=inline&response-content-type=application%2Fpdf&X-Goog-Signature=2bb0e11c77c344376efc60f32a4ec24696c1f2ae883a5c4b1479b4970a9adc88f8e403a2c60b481e4270af1771a0a93ec51fe19ceea152698980e9a092e906d14cf325891ddd7b56cfdf9b6362c4543b8fc119da8915d137e05d671127253405bf17247618c1bc6995c15dd26a4a0d31710af4b3dbcb71ca669de2ef95a34ee77126280802bd0d37c5785594dc6bd7d6f88e20ca407ab4eb1380e74c12f32196b0adf56061311f47d99ef778d49dc97d767b84125a36e8129e0f5ef2188b7c5c89332bff3f9a73104604bd387f7baddc84d898f4b8e67c5adc251065576c83671ef5689b98926c8a59771052642c867732773df187f5734762e26aee92e01d80 "HTTP/1.1 200 OK"
INFO:     127.0.0.1:61603 - "GET /api/pdf-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fpdf_extraction_files_saver%2Fstatements%2F35df0e13-76d7-4a42-b66a-2f1a4d8f96cc%2F01.13.2025.2%2520Allied%2520Innovative%2520Payment.pdf%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Ddocsai-table-extractor%2540pdf-tables-extractor-465009.iam.gserviceaccount.com%252F20251113%252Fauto%252Fstorage%252Fgoog4_request%26X-Goog-Date%3D20251113T181203Z%26X-Goog-Expires%3D3599%26X-Goog-SignedHeaders%3Dhost%26response-content-disposition%3Dinline%26response-content-type%3Dapplication%252Fpdf%26X-Goog-Signature%3D2bb0e11c77c344376efc60f32a4ec24696c1f2ae883a5c4b1479b4970a9adc88f8e403a2c60b481e4270af1771a0a93ec51fe19ceea152698980e9a092e906d14cf325891ddd7b56cfdf9b6362c4543b8fc119da8915d137e05d671127253405bf17247618c1bc6995c15dd26a4a0d31710af4b3dbcb71ca669de2ef95a34ee77126280802bd0d37c5785594dc6bd7d6f88e20ca407ab4eb1380e74c12f32196b0adf56061311f47d99ef778d49dc97d767b84125a36e8129e0f5ef2188b7c5c89332bff3f9a73104604bd387f7baddc84d898f4b8e67c5adc251065576c83671ef5689b98926c8a59771052642c867732773df187f5734762e26aee92e01d80 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61601 - "GET /api/pending/progress/ec70c446-1066-4e9e-ae78-7f9ff5597204/table_editor HTTP/1.1" 200 OK
INFO:     127.0.0.1:61678 - "OPTIONS /api/table-editor/save-tables/ HTTP/1.1" 200 OK
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saving edited tables for upload_id: ec70c446-1066-4e9e-ae78-7f9ff5597204
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Tables count: 1
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Selected statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Company ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Field config received: [{'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Processing carrier (potentially corrected by user): ALLIED
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Using existing carrier: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc (ALLIED)
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Updating upload with tables, statement date, and carrier
ğŸ¯ CRUD: update_upload_tables called for upload_id: ec70c446-1066-4e9e-ae78-7f9ff5597204
ğŸ¯ CRUD: Tables data length: 1
ğŸ¯ CRUD: Selected statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
ğŸ¯ CRUD: Carrier ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Found upload, updating with tables, statement date, and carrier
ğŸ¯ CRUD: Saved selected statement date to database: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
ğŸ¯ CRUD: Statement date type: <class 'dict'>
ğŸ¯ CRUD: Statement date keys: ['date', 'confidence', 'source']
ğŸ¯ CRUD: Linking statement to carrier: carrier_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc, company_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Also saved statement date and carrier to progress_data
ğŸ¯ CRUD: Successfully updated upload ec70c446-1066-4e9e-ae78-7f9ff5597204 with tables, statement date, and carrier
ğŸ¯ CRUD: Final selected_statement_date in database: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully updated upload with statement date and carrier
INFO:app.api.table_editor:ğŸ“ Normalizing filename for upload ec70c446-1066-4e9e-ae78-7f9ff5597204
INFO:app.api.table_editor:ğŸ“ Current filename: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf
INFO:app.api.table_editor:ğŸ“ New normalized filename: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/ALLIED_2025-01.pdf
ERROR:app.services.gcs_utils:Source file not found in GCS for rename: statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf
WARNING:app.api.table_editor:âš ï¸ Failed to rename file in GCS, keeping original filename
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Learning format patterns from edited tables for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor Format Learning: Saving 10 field mappings
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully learned format with signature: 434609905947a9e8728df0b79ba381ce for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully learned table editor format patterns
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully saved 1 edited tables
INFO:     127.0.0.1:61680 - "POST /api/table-editor/save-tables/ HTTP/1.1" 200 OK
INFO:     127.0.0.1:61723 - "OPTIONS /api/table-editor/learn-format-patterns HTTP/1.1" 200 OK
INFO:app.api.table_editor:ğŸ¯ Format Learning: Processing carrier (may be user-corrected): ALLIED
INFO:app.api.table_editor:ğŸ¯ Format Learning: Using existing carrier: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Format Learning: Extracted 10 field mappings from field_config
INFO:app.api.table_editor:ğŸ¯ Format Learning: Field mappings: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
INFO:app.api.table_editor:Successfully learned format patterns with signature: 434609905947a9e8728df0b79ba381ce for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:     127.0.0.1:61680 - "POST /api/table-editor/learn-format-patterns HTTP/1.1" 200 OK
INFO:     127.0.0.1:61723 - "OPTIONS /api/companies/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/mapping/?upload_id=ec70c446-1066-4e9e-ae78-7f9ff5597204 HTTP/1.1" 200 OK
INFO:app.api.mapping:ğŸ¯ Mapping API: Received mapping request for carrier/company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Upload ID: ec70c446-1066-4e9e-ae78-7f9ff5597204
INFO:app.api.mapping:ğŸ¯ Mapping API: Config received - mapping keys: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Selected statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.mapping:ğŸ¯ Mapping API: Table data rows: 4
INFO:app.api.mapping:ğŸ¯ Mapping API: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Retrieved carrier_id from upload: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Final carrier_id to use: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Saved 10 field mappings for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Saved configuration for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Learning format from processed file for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Table data length: 4
INFO:app.api.mapping:ğŸ¯ Mapping API: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Mapping API: Mapping: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
INFO:app.api.mapping:ğŸ¯ Mapping API: Retrieved carrier name for format learning: ALLIED
ğŸ¯ FormatLearningService: Learning from processed file for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Field mapping: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
ğŸ¯ FormatLearningService: Table data length: 4
ğŸ¯ FormatLearningService: Generated format signature: 434609905947a9e8728df0b79ba381ce
ğŸ¯ FormatLearningService: Found potential total field: Invoice Total at index 4
ğŸ¯ FormatLearningService: Extracted total from data row: 9336.9
ğŸ¯ FormatLearningService: Total amount extracted: $9336.90 from field 'Invoice Total'
ğŸ¯ FormatLearningService: Saving corrected carrier name: ALLIED
ğŸ¯ FormatLearningService: Saving corrected statement date: 2025-01-08
ğŸ¯ FormatLearningService: Saving total amount: $9336.90
ğŸ¯ FormatLearningService: Final enhanced table editor settings keys: ['carrier_name', 'corrected_carrier_name', 'statement_date', 'corrected_statement_date', 'statement_total_amount', 'total_amount_field_name']
ğŸ¯ FormatLearningService: Successfully learned format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Format learning completed successfully for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Mapping API: Processing commission data with statement date
INFO:app.api.mapping:ğŸ¯ Mapping API: Statement date object: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
WARNING:app.api.mapping:ğŸ¯ Mapping API: Could not retrieve environment_id: module 'app.db.crud' has no attribute 'get_statement_upload'
INFO:app.api.mapping:ğŸ¯ Commission Processing: Starting commission data processing
INFO:app.api.mapping:ğŸ¯ Commission Processing: Company ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.mapping:ğŸ¯ Commission Processing: Table data rows: 4
INFO:app.api.mapping:ğŸ¯ Commission Processing: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
INFO:app.api.mapping:ğŸ¯ Commission Processing: Mapping: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
INFO:app.api.mapping:ğŸ¯ Commission Processing: Statement date: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
INFO:app.api.mapping:ğŸ¯ Commission Processing: Date value extracted: 2025-01-08
INFO:app.api.mapping:ğŸ¯ Date Parsing: Attempting to parse date: 2025-01-08
INFO:app.api.mapping:ğŸ¯ Date Parsing: Successfully parsed date '2025-01-08' with format '%Y-%m-%d' -> 2025-01-08 00:00:00
INFO:app.api.mapping:ğŸ¯ Commission Processing: Parsed date: 2025-01-08 00:00:00
INFO:app.api.mapping:ğŸ¯ Commission Processing: Month: 1, Year: 2025
INFO:app.api.mapping:ğŸ¯ Commission Processing: Found client name column: Group Name -> Client Name
INFO:app.api.mapping:ğŸ¯ Commission Processing: Found invoice total column: Invoice Total -> Invoice Total
INFO:app.api.mapping:ğŸ¯ Commission Processing: Found commission column: Paid Amount -> Commission Earned
INFO:app.api.mapping:ğŸ¯ Commission Processing: Final column mapping - Client: Group Name, Invoice: Invoice Total, Commission: Paid Amount
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 0 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $93.67
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 0 - Parsed values - Invoice: 9336.9, Commission: 93.67
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating new record with user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191 and environment_id: None
INFO:app.api.mapping:ğŸ¯ Commission Record: Set jan_commission = 93.67
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully created new record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 0
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 1 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $419.93
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 1 - Parsed values - Invoice: 9336.9, Commission: 419.93
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Updating existing record ID 3c92ffe9-98eb-4e7f-b0b2-4a3e6b6207be
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully updated existing record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 1
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 2 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $93.67
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 2 - Parsed values - Invoice: 9336.9, Commission: 93.67
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Updating existing record ID 3c92ffe9-98eb-4e7f-b0b2-4a3e6b6207be
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully updated existing record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 2
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 3 - Client: SOAR LOGISTICS LL, Invoice: $9,336.90, Commission: $419.93
INFO:app.api.mapping:ğŸ¯ Commission Processing: Row 3 - Parsed values - Invoice: 9336.9, Commission: 419.93
INFO:app.api.mapping:ğŸ¯ Commission Record: Creating/updating record for 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc - SOAR LOGISTICS LL - 2025-01-08 00:00:00 - user: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.mapping:ğŸ¯ Commission Record: Updating existing record ID 3c92ffe9-98eb-4e7f-b0b2-4a3e6b6207be
INFO:app.api.mapping:ğŸ¯ Commission Record: Successfully updated existing record
INFO:app.api.mapping:ğŸ¯ Commission Processing: Successfully processed row 3
INFO:app.api.mapping:ğŸ¯ Commission Processing: Completed processing 4 rows with statement date 2025-01-08
Processed commission data for 4 rows with statement date 2025-01-08
INFO:app.api.mapping:ğŸ¯ Mapping API: Commission data processing completed successfully
INFO:app.api.mapping:ğŸ¯ Mapping API: Mapping update completed successfully for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:     127.0.0.1:61680 - "POST /api/companies/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/mapping/?upload_id=ec70c446-1066-4e9e-ae78-7f9ff5597204 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61846 - "OPTIONS /api/review/approve/ HTTP/1.1" 200 OK
ğŸ’¾ Saving statement review: upload_id=ec70c446-1066-4e9e-ae78-7f9ff5597204, status=Approved
ğŸ“‹ Field config being saved: [{'display_name': 'Policy Number', 'source_field': 'Group No.'}, {'display_name': 'Client Name', 'source_field': 'Group Name'}, {'display_name': 'Coverage Period Start', 'source_field': 'Billing Period'}, {'display_name': 'Adjustment Period Start', 'source_field': 'Adj. Period'}, {'display_name': 'Invoice Total', 'source_field': 'Invoice Total'}, {'display_name': 'Stoploss Total', 'source_field': 'Stoploss Total'}, {'display_name': 'Commission Rate', 'source_field': 'Agent %'}, {'display_name': 'Plan Type', 'source_field': 'Calculation Method'}, {'display_name': 'Total Subscribers', 'source_field': 'Census Ct.'}, {'display_name': 'Commission Earned', 'source_field': 'Paid Amount'}]
ğŸ“Š Final data rows: 1
ğŸ“… Selected statement date being saved: {'date': '2025-01-08', 'confidence': 0.92, 'source': 'ai_extraction'}
ğŸ” DEBUG Saving table 0 'Unnamed Table': summaryRows=[], type=<class 'list'>
ğŸ“ Extracted field_mapping with 10 mappings: {'Group No.': 'Policy Number', 'Group Name': 'Client Name', 'Billing Period': 'Coverage Period Start', 'Adj. Period': 'Adjustment Period Start', 'Invoice Total': 'Invoice Total', 'Stoploss Total': 'Stoploss Total', 'Agent %': 'Commission Rate', 'Calculation Method': 'Plan Type', 'Census Ct.': 'Total Subscribers', 'Paid Amount': 'Commission Earned'}
ğŸ’° Calculating extracted_total for manual approval...
ğŸ’° field_mapping keys: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ’° Number of tables in final_data: 1
ğŸ’° Found commission field (EXACT MATCH): Paid Amount -> Commission Earned
ğŸ’° Final commission_source_field: Paid Amount
  ğŸ“Š Table 0: 10 headers, 4 rows
  ğŸ“‹ Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  ğŸ“‹ First row sample: {'Group No.': 'L244338', 'Group Name': 'SOAR LOGISTICS LL', 'Billing Period': '12/1/2024', 'Adj. Period': '12/1/2024', 'Invoice Total': '$9,336.90', 'Stoploss Total': '$3,514.94', 'Agent %': '6%', 'Calculation Method': 'Premium Equivalent', 'Census Ct.': '4', 'Paid Amount': '$93.67'}
  ğŸ’° Table 0: Commission column 'Paid Amount' at index 9
    Row 0: [DICT] raw_value = '$93.67' (type: <class 'str'>)
    Row 0: Added $93.67 (running total: $93.67)
    Row 1: [DICT] raw_value = '$419.93' (type: <class 'str'>)
    Row 1: Added $419.93 (running total: $513.60)
    Row 2: [DICT] raw_value = '$93.67' (type: <class 'str'>)
    Row 2: Added $93.67 (running total: $607.27)
    Row 3: [DICT] raw_value = '$419.93' (type: <class 'str'>)
    Row 3: Added $419.93 (running total: $1027.20)
  âœ… Table 0 total: $1027.20
ğŸ’° Final extracted_total: $1027.20
ğŸ’° Calculating extracted_invoice_total for manual approval...
ğŸ’° Found invoice field (exact match): Invoice Total -> Invoice Total
  ğŸ“Š Table 0: 10 headers, 4 rows
  ğŸ“‹ Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  ğŸ“‹ First row sample: {'Group No.': 'L244338', 'Group Name': 'SOAR LOGISTICS LL', 'Billing Period': '12/1/2024', 'Adj. Period': '12/1/2024', 'Invoice Total': '$9,336.90', 'Stoploss Total': '$3,514.94', 'Agent %': '6%', 'Calculation Method': 'Premium Equivalent', 'Census Ct.': '4', 'Paid Amount': '$93.67'}
  ğŸ’° Table 0: Invoice column 'Invoice Total' at index 4
    Row 0: [DICT] invoice_value = '$9,336.90'
    Row 0: Added $9336.90 to invoice (running total: $9336.90)
    Row 1: [DICT] invoice_value = '$9,336.90'
    Row 1: Added $9336.90 to invoice (running total: $18673.80)
    Row 2: [DICT] invoice_value = '$9,336.90'
    Row 2: Added $9336.90 to invoice (running total: $28010.70)
    Row 3: [DICT] invoice_value = '$9,336.90'
    Row 3: Added $9336.90 to invoice (running total: $37347.60)
  âœ… Table 0 invoice total: $37347.60
ğŸ’° Final extracted_invoice_total: $37347.60
âœ… Set extracted_total=1027.2, total_amount_match=True
âœ… Set extracted_invoice_total=37347.6
âœ… Statement approved, processing commission data with BULK OPTIMIZATION...
ğŸš€ BULK PROCESSING: Starting optimized commission processing for upload ec70c446-1066-4e9e-ae78-7f9ff5597204
ğŸ” Extracting field mappings from: [{'display_name': 'Policy Number', 'source_field': 'Group No.'}, {'display_name': 'Client Name', 'source_field': 'Group Name'}, {'display_name': 'Coverage Period Start', 'source_field': 'Billing Period'}, {'display_name': 'Adjustment Period Start', 'source_field': 'Adj. Period'}, {'display_name': 'Invoice Total', 'source_field': 'Invoice Total'}, {'display_name': 'Stoploss Total', 'source_field': 'Stoploss Total'}, {'display_name': 'Commission Rate', 'source_field': 'Agent %'}, {'display_name': 'Plan Type', 'source_field': 'Calculation Method'}, {'display_name': 'Total Subscribers', 'source_field': 'Census Ct.'}, {'display_name': 'Commission Earned', 'source_field': 'Paid Amount'}]
âœ… Found client name field: Group Name -> Client Name
âœ… Found invoice total field (exact): Invoice Total -> Invoice Total
âœ… Found commission field (exact match): Paid Amount -> Commission Earned
ğŸ” Extracted field mappings: {'client_name_field': 'Group Name', 'commission_earned_field': 'Paid Amount', 'invoice_total_field': 'Invoice Total'}
   âœ… Client Name: Using 'Group Name'
   âœ… Commission Earned: Using 'Paid Amount'
   âœ… Invoice Total: Using 'Invoice Total'
âœ… OPTIMIZED: Pre-extracted field mappings: client=Group Name, commission=Paid Amount, invoice=Invoice Total
ğŸ‘¤ Processing for user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191
ğŸŒ Processing for environment_id: 9f4a7a57-5715-4b1e-98a9-b9901726a485
ğŸ“… Statement date: 2025-01-08 00:00:00 (month: 1, year: 2025)
ğŸ“Š Table 0: Mapped fields - client[1]=Group Name, commission[9]=Paid Amount, invoice[4]=Invoice Total
ğŸ” DEBUG Table 0: summaryRows raw value: [], type: <class 'list'>
âš ï¸  Table 0: NO summary rows to exclude - all rows will be processed
ğŸ“Š Extracted 4 commission records for bulk processing
ğŸ” Found 1 clients with multiple statement rows:
   1. SOAR LOGISTICS LL: 4 rows, total commission: $1027.20
ğŸ“Š Commission Analysis: {'total_records': 4, 'unique_clients': 1, 'clients_with_multiple_rows': 1}
ğŸ” Bulk fetch: Looking up 1 unique commission records (with user isolation)
âœ… Bulk fetch: Found 0 existing records for specified users
ğŸ“Š Aggregating 4 individual records by unique constraint...
âœ… Aggregated into 1 unique commission records (with user isolation)
   ğŸ“‹ SOAR LOGISTICS LL (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $1027.20 commission, $37347.60 invoice
ğŸ“Š Bulk operations prepared: 0 updates, 1 inserts
â• Executing bulk insert for 1 records
âœ… BULK PROCESSING: Successfully processed 4 records
ğŸ“ˆ Performance: Reduced from 600-800 DB operations to 2-3 operations
INFO:     127.0.0.1:61848 - "POST /api/review/approve/ HTTP/1.1" 200 OK
ğŸ” Auth Status - All cookies: ['__next_hmr_refresh_hash__', 'access_token', 'refresh_token', 'session_token']
ğŸ” Auth Status - Access token present: True
ğŸ” Auth Status - Request host: localhost:8000
ğŸ” Auth Status - Request origin: http://localhost:3000
ğŸ” Auth Status - Cookie __next_hmr_refresh_hash__: 38b1362e0cad76e6df5faeceef21be02633457081244afec
ğŸ” Auth Status - Cookie access_token: eyJhbGciOiJIUzI1NiIs...
ğŸ” Auth Status - Cookie refresh_token: eyJhbGciOiJIUzI1NiIs...
ğŸ” Auth Status - Cookie session_token: 06f60d9c-a3bb-4ca6-b...
INFO:     127.0.0.1:61848 - "GET /api/auth/otp/status HTTP/1.1" 200 OK
ğŸ” Debug - All cookies received: ['__next_hmr_refresh_hash__', 'access_token', 'refresh_token', 'session_token']
ğŸ” Debug - Access token present: True
INFO:     127.0.0.1:61848 - "GET /api/auth/permissions HTTP/1.1" 200 OK
INFO:     127.0.0.1:61887 - "GET /environments HTTP/1.1" 200 OK
INFO:     127.0.0.1:61899 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61887 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61903 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61901 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:61848 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61897 - "GET /api/dashboard/stats?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:61899 - "GET /api/companies/user-specific HTTP/1.1" 200 OK
INFO:     127.0.0.1:61887 - "GET /api/companies/?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:61903 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61901 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:61848 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025 HTTP/1.1" 200 OK}], 'groups_to_payments': [{'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$93.67', 'relationship': 'generates_commission'}, {'group': 'SOAR LOGISTICS LL', 'amount': '$419.93', 'relationship': 'generates_commission'}]}, 'business_intelligence': {'total_commission_amount': 'Not specified', 'number_of_groups': 4, 'commission_structures': ['Premium Equivalent', 'Percentage-based'], 'top_contributors': [{'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$419.93'}, {'name': 'SOAR LOGISTICS LL', 'amount': '$93.67'}], 'special_payments': [], 'payment_period': '', 'patterns_detected': ['Standard commission structure']}, 'summary': "This is This is an Allied commission statement for INNOVATIVE BPS LLC dated January 8, 2025, showing a total of $1,027.20 in commissions exclusively from SOAR LOGISTICS LL across four separate payment entries. The statement reveals an interesting payment pattern with two identical amounts of $419.93 each and two matching amounts of $93.67 each, suggesting either different billing periods or plan types for the same client group. While no specific writing agents are identified in the documentation, the unifoINFO:     127.0.0.1:62159 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:62159 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763057700614_9hm9htdp0. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763057700614_9hm9htdp0, session_id: session_1763057700644_fvxgyo5kz
INFO:     127.0.0.1:62215 - "WebSocket /api/ws/progress/upload_1763057700614_9hm9htdp0?session_id=session_1763057700644_fvxgyo5kz" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763057700614_9hm9htdp0, session_id=session_1763057700644_fvxgyo5kz, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763057700614_9hm9htdp0, session_id: session_1763057700644_fvxgyo5kz
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ“ File: 01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ”‘ Hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d
INFO:app.api.new_extract:ğŸ“ Size: 326364 bytes
INFO:app.api.new_extract:ğŸ‘¤ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ” Checking for user duplicates - Hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ“š Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf: hash=3e2ff2652f27d527..., status=Approved
INFO:app.services.duplicate_detection_service:âŒ No duplicate found for hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d
INFO:app.api.new_extract:ğŸš€ Starting extract-tables-smart for file: 01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“ File path: pdfs/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“Š File size: 326364 bytes
INFO:app.api.new_extract:ğŸ†” Upload ID: upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ’¾ Saving uploaded file...
INFO:app.api.new_extract:âœ… File saved successfully
INFO:app.api.new_extract:ğŸ“¤ Uploading file to GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File uploaded to GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Successfully uploaded and verified file in GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:Using specified environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: 57077d49-835c-4185-b54b-a9b3dd7c641a)
INFO:app.api.new_extract:ğŸ”§ Getting enhanced extraction service...
INFO:app.services.claude.service:ğŸ”„ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:ğŸ”‘ API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:âœ… Claude API client initialized successfully
INFO:app.services.claude.service:ğŸ“‹ Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:âœ… Semantic Extraction Service initialized
INFO:app.services.claude.service:âœ… Claude Document AI Service initialized
INFO:app.services.claude.service:ğŸ“‹ Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“‹ Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“ Limits: 32MB, 100 pages
INFO:app.services.claude.service:ğŸ›¡ï¸  Rate limiting: ENABLED (50 RPM, 25,500 TPM)
INFO:app.services.claude.service:ğŸ’¾ Prompt caching: SUPPORTED
INFO:app.services.enhanced_extraction_service:âœ… Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:ğŸ†• PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:ğŸ“‹ FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:â±ï¸  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:ğŸš€ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:âœ… Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:ğŸš€ Starting extraction task...
INFO:app.api.new_extract:ğŸ“Š Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:âœ… Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:âœ… CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âš¡ Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:ğŸ” Extracting metadata with Claude from: pdfs/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.claude.service:ğŸ“Š Estimated tokens for request: 122,877 (37 pages)
WARNING:app.services.claude.utils:âš ï¸  TPM limit would be exceeded: 0 current + 122,877 new = 122,877 tokens (limit: 25,500). Waiting 61.85s for token bucket reset.
INFO:app.services.claude.utils:âœ… Token bucket forcefully reset. Proceeding with 122,877 tokens.
INFO:app.services.claude.utils:ğŸ“Š Rate limit status: 1/50 RPM, 122,877/25,500 TPM
INFO:app.services.claude.service:â±ï¸  Waited 61.83s for rate limit compliance
INFO:app.services.claude.service:ğŸ”„ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:âœ… Claude API call successful. Tokens: input=79,317, output=313
INFO:app.services.claude.service:ğŸ“Š Token tracking: Estimated=122,877, Actual=79,317, Diff=-43,560
INFO:app.services.claude.service:ğŸ”§ Token bucket adjusted: 122,877 â†’ 79,317
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this ABSF Commission Payment Summary document, I can extract the following metadata:

```json
{
  "carrier_name": "Allied Benefit Systems",
  "carrier_confidence": 0.95,
  "statement_date": "2025-01-08",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.95,
  "document_type": "commission_statement",
  "total_pages": 37,
  "evidence": "Carrier name found in Allied logo and company branding throughout document. Statement date found as 'Report 
INFO:app.services.enhanced_extraction_service:âœ“ Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âœ… Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/01.13.25 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:Standard file (37 pages, 0.31MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:ğŸ“‹ No carrier-specific prompt for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:ğŸ“Š Estimated tokens for request: 125,488 (37 pages)
WARNING:app.services.claude.utils:âš ï¸  TPM limit would be exceeded: 79,317 current + 125,488 new = 204,805 tokens (limit: 25,500). Waiting 51.22s for token bucket reset.
INFO:app.services.claude.utils:âœ… Token bucket forcefully reset. Proceeding with 125,488 tokens.
INFO:app.services.claude.utils:ğŸ“Š Rate limit status: 2/50 RPM, 125,488/25,500 TPM
INFO:app.services.claude.service:â±ï¸  Waited 51.22s for rate limit compliance
INFO:app.services.claude.service:ğŸ”„ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.433755 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.824892 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.claude.service:âŒ Claude API error (attempt 1/5): Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV6M6Gmw9SAvjjBRA6Uig'}
ERROR:app.services.claude.service:   Rate limit error: True, Retriable: True
WARNING:app.services.claude.service:âš ï¸  Rate limit hit! Retry-After: 95.00s
INFO:app.api.websocket:Received unknown message type: heartbeat

_fvxgyo5kz
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ“ File: 01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ”‘ Hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d
INFO:app.api.new_extract:ğŸ“ Size: 326364 bytes
INFO:app.api.new_extract:ğŸ‘¤ User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ” Checking for user duplicates - Hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.duplicate_detection_service:ğŸ“š Recent uploads for user:
INFO:app.services.duplicate_detection_service:  - statements/ec70c446-1066-4e9e-ae78-7f9ff5597204/01.13.2025.2 Allied Innovative Payment.pdf: hash=3e2ff2652f27d527..., status=Approved
INFO:app.services.duplicate_detection_service:âŒ No duplicate found for hash: d6ed3d21c4fd12b445df775ec4617ce5a0bae82097004a4d43197d8f178d4f2d
INFO:app.api.new_extract:ğŸš€ Starting extract-tables-smart for file: 01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“ File path: pdfs/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:ğŸ“Š File size: 326364 bytes
INFO:app.api.new_extract:ğŸ†” Upload ID: upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ’¾ Saving uploaded file...
INFO:app.api.new_extract:âœ… File saved successfully
INFO:app.api.new_extract:ğŸ“¤ Uploading file to GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File uploaded to GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Successfully uploaded and verified file in GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:Using specified environment 9f4a7a57-5715-4b1e-98a9-b9901726a485 (Default) for upload
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: 57077d49-835c-4185-b54b-a9b3dd7c641a)
INFO:app.api.new_extract:ğŸ”§ Getting enhanced extraction service...
INFO:app.services.claude.service:ğŸ”„ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:ğŸ”‘ API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:âœ… Claude API client initialized successfully
INFO:app.services.claude.service:ğŸ“‹ Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:âœ… Semantic Extraction Service initialized
INFO:app.services.claude.service:âœ… Claude Document AI Service initialized
INFO:app.services.claude.service:ğŸ“‹ Primary model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“‹ Fallback model: claude-sonnet-4-20250514
INFO:app.services.claude.service:ğŸ“ Limits: 32MB, 100 pages
INFO:app.services.claude.service:ğŸ›¡ï¸  Rate limiting: ENABLED (50 RPM, 25,500 TPM)
INFO:app.services.claude.service:ğŸ’¾ Prompt caching: SUPPORTED
INFO:app.services.enhanced_extraction_service:âœ… Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:ğŸ†• PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:ğŸ“‹ FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:â±ï¸  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:ğŸš€ Enhanced 3-phase pipeline: ENABLED
INFO:app.api.new_extract:âœ… Enhanced extraction service obtained (enhanced_mode=True)
INFO:app.api.new_extract:ğŸš€ Starting extraction task...
INFO:app.api.new_extract:ğŸ“Š Calling extract_tables_with_progress...
INFO:app.services.enhanced_extraction_service:âœ… Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:âœ… CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âš¡ Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:ğŸ” Extracting metadata with Claude from: pdfs/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.claude.service:ğŸ“Š Estimated tokens for request: 122,877 (37 pages)
WARNING:app.services.claude.utils:âš ï¸  TPM limit would be exceeded: 0 current + 122,877 new = 122,877 tokens (limit: 25,500). Waiting 61.85s for token bucket reset.
INFO:app.services.claude.utils:âœ… Token bucket forcefully reset. Proceeding with 122,877 tokens.
INFO:app.services.claude.utils:ğŸ“Š Rate limit status: 1/50 RPM, 122,877/25,500 TPM
INFO:app.services.claude.service:â±ï¸  Waited 61.83s for rate limit compliance
INFO:app.services.claude.service:ğŸ”„ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:âœ… Claude API call successful. Tokens: input=79,317, output=313
INFO:app.services.claude.service:ğŸ“Š Token tracking: Estimated=122,877, Actual=79,317, Diff=-43,560
INFO:app.services.claude.service:ğŸ”§ Token bucket adjusted: 122,877 â†’ 79,317
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this ABSF Commission Payment Summary document, I can extract the following metadata:

```json
{
  "carrier_name": "Allied Benefit Systems",
  "carrier_confidence": 0.95,
  "statement_date": "2025-01-08",
  "date_confidence": 0.90,
  "broker_company": "INNOVATIVE BPS LLC",
  "broker_confidence": 0.95,
  "document_type": "commission_statement",
  "total_pages": 37,
  "evidence": "Carrier name found in Allied logo and company branding throughout document. Statement date found as 'Report 
INFO:app.services.enhanced_extraction_service:âœ“ Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âœ… Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:ğŸ“¡ Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/01.13.25 Allied Innovative Payment.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:Standard file (37 pages, 0.31MB)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:ğŸ“‹ No carrier-specific prompt for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:ğŸ“Š Estimated tokens for request: 125,488 (37 pages)
WARNING:app.services.claude.utils:âš ï¸  TPM limit would be exceeded: 79,317 current + 125,488 new = 204,805 tokens (limit: 25,500). Waiting 51.22s for token bucket reset.
INFO:app.services.claude.utils:âœ… Token bucket forcefully reset. Proceeding with 125,488 tokens.
INFO:app.services.claude.utils:ğŸ“Š Rate limit status: 2/50 RPM, 125,488/25,500 TPM
INFO:app.services.claude.service:â±ï¸  Waited 51.22s for rate limit compliance
INFO:app.services.claude.service:ğŸ”„ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.433755 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.824892 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.claude.service:âŒ Claude API error (attempt 1/5): Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV6M6Gmw9SAvjjBRA6Uig'}
ERROR:app.services.claude.service:   Rate limit error: True, Retriable: True
WARNING:app.services.claude.service:âš ï¸  Rate limit hit! Retry-After: 95.00s
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.claude.service:ğŸ”„ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 2/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:âœ… Claude API call successful. Tokens: input=81,949, output=1,382
INFO:app.services.claude.service:ğŸ“Š Token tracking: Estimated=125,488, Actual=81,949, Diff=-43,539
INFO:app.services.claude.service:ğŸ”§ Token bucket adjusted: 125,488 â†’ 81,949
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this ABSF Commission Payment Summary document, I'll extract the information with pixel-perfect accuracy.

```json
{
  "document_metadata": {
    "carrier_name": "ALLIED",
    "carrier_confidence": 0.95,
    "statement_date": "2025-01-08",
    "date_confidence": 0.95,
    "broker_company": "INNOVATIVE BPS LLC",
    "broker_confidence": 0.95,
    "total_amount": 77137.16,
    "total_amount_label": "Total for Vendor",
    "total_amount_confidence": 0.98,
    "total_calculation_method": "
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage validation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage validation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:ğŸš€ Running enhanced 3-phase extraction pipeline...
INFO:app.services.claude.service:   Phase 1: Document Intelligence âœ“ (completed)
INFO:app.services.claude.service:   Phase 2: Semantic Extraction â†’ Starting...
INFO:app.services.claude.service:   Phase 3: Intelligent Summarization â†’ Pending...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage semantic_analysis for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:ğŸ“Š Phase 2: Semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ” Starting semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 0 writing agents: []
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 16 groups/companies
INFO:app.services.claude.semantic_extractor:âœ… Semantic extraction completed successfully
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage semantic_analysis for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:âœï¸ Phase 3: Intelligent summarization...
INFO:app.services.claude.service:ğŸ“Š Semantic result keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.claude.service:   - Entities: âœ…
INFO:app.services.claude.service:   - Relationships: âœ…
INFO:app.services.claude.service:   - Business Intelligence: âœ…
INFO:app.services.claude.service:ğŸ“ Summary service available: True
INFO:app.services.claude.service:ğŸš€ Calling generate_conversational_summary with use_enhanced=True...
INFO:app.services.conversational_summary_service:ğŸ—£ï¸ Generating conversational summary...
INFO:app.services.conversational_summary_service:ğŸ” _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.conversational_summary_service:âœ… Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:ğŸ¯ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: ['carrier', 'broker', 'writing_agents', 'groups_and_companies', 'document_metadata']
INFO:app.services.conversational_summary_service:   - Relationships: ['carrier_to_broker', 'broker_to_agents', 'agents_to_groups', 'groups_to_payments']
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['total_commission_amount', 'number_of_groups', 'commission_structures', 'top_contributors', 'special_payments', 'payment_period', 'patterns_detected']
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:ğŸš€ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:ğŸš€ Calling Claude API for summary generation...
INFO:app.services.conversational_summary_service:   Model: claude-sonnet-4-20250514
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 19016 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.462185 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.800704 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.conversational_summary_service:âŒ Summary generation failed: Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV6MFMAcH7DUTnqZuXR2o'}
ERROR:app.services.conversational_summary_service:   Error type: RateLimitError
ERROR:app.services.conversational_summary_service:   Full traceback:
Traceback (most recent call last):
  File "/Users/kayttaja/Desktop/commision-tracker/server/app/services/conversational_summary_service.py", line 204, in generate_conversational_summary
    response = await self.client.messages.create(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kayttaja/Desktop/commision-tracker/server/venv/lib/python3.11/site-packages/anthropic/resources/messages/messages.py", line 2113, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/kayttaja/Desktop/commision-tracker/server/venv/lib/python3.11/site-packages/anthropic/_base_client.py", line 1898, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kayttaja/Desktop/commision-tracker/server/venv/lib/python3.11/site-packages/anthropic/_base_client.py", line 1698, in request
    raise self._make_status_error_from_response(err.response) from None
anthropic.RateLimitError: Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV6MFMAcH7DUTnqZuXR2o'}
ERROR:app.services.conversational_summary_service:   Extraction data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
WARNING:app.services.conversational_summary_service:ğŸ”„ Generating fallback summary...
INFO:app.services.conversational_summary_service:   Using entity data: carrier=ALLIED, broker=INNOVATIVE BPS LLC, date=2025-01-08
WARNING:app.services.conversational_summary_service:   Fallback summary: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
WARNING:app.services.conversational_summary_service:âš ï¸ Using fallback summary: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
INFO:app.services.claude.service:âœ… Summary generation completed. Success: True
INFO:app.services.claude.service:ğŸ“„ Generated summary (first 200 chars): Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC....
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:âœ… Enhanced 3-phase pipeline completed successfully
INFO:app.services.claude.service:ğŸ“¦ Enhanced result keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'quality_summary', 'metadata', 'extraction_quality', 'entities', 'relationships', 'business_intelligence', 'summary', 'structured_data', 'extraction_pipeline', 'semantic_extraction_success']
INFO:app.services.claude.service:   - Summary length: 84 characters
INFO:app.services.claude.service:   - Summary preview: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC....
INFO:app.services.claude.service:   - Structured data: {}
INFO:app.services.claude.service:âœ… Claude extraction completed in 176.60s
INFO:app.services.enhanced_extraction_service:âš¡ Extracting metadata from Claude extraction results
INFO:app.services.enhanced_extraction_service:âœ… Using Claude metadata: carrier=ALLIED, date=2025-01-08, broker=INNOVATIVE BPS LLC
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
ğŸ“ Enhanced multi-strategy stitching: Processing 1 tables
ğŸ“ Canonical header identified: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Table 1 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Found 1 unique header patterns
ğŸ“ Grouped 1 tables into 1 groups
ğŸ“ Merging group 1 with 1 tables
INFO:app.services.extraction_utils:âœ… Merged table created: 16 rows (enhancements preserved from individual tables)
ğŸ“ Merged table 1: 10 headers, 16 rows
ğŸ“ Merged headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ“ Enhanced stitching completed: 1 final tables
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.enhanced_extraction_service:Claude: Verified normalized headers
INFO:app.services.enhanced_extraction_service:Claude: Processed 1 tables into 1 tables
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ¯ STAGE 3: CONVERSATIONAL SUMMARY GENERATION
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   - Enhanced mode enabled: True
INFO:app.services.enhanced_extraction_service:   - Result has 'summary': True
INFO:app.services.enhanced_extraction_service:   - Summary service available: True
INFO:app.services.enhanced_extraction_service:âœ… Using enhanced summary from Claude pipeline
INFO:app.services.enhanced_extraction_service:   Summary length: 84 characters
INFO:app.services.enhanced_extraction_service:   Summary preview: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC....
INFO:app.services.enhanced_extraction_service:ğŸ“¤ Sending Claude-generated summary AND structured data to frontend via WebSocket NOW
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âœ… Sent structured summary data to frontend: {}
INFO:app.services.enhanced_extraction_service:âœ… Claude-generated summary sent to frontend successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ“ FINAL SUMMARY SELECTION: ENHANCED CONVERSATIONAL
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   Summary length: 84 characters
INFO:app.services.enhanced_extraction_service:   Full summary:
Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
INFO:app.services.enhanced_extraction_service:================================================================================
WARNING:app.services.enhanced_extraction_service:âš ï¸ No structured_summary_data available
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage validation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed processing for upload upload_1763057700614_9hm9htdp0 in 249.50 seconds
INFO:app.api.new_extract:âœ… Extraction completed successfully: {'success': True, 'tables': [{'headers': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'rows': [['L210316', 'TRAXX IN', '1/1/2025', '11/1/2024', '$269.27', '$110.20', '19%', 'Premium Equivalent', '1', '$51.16'], ['L210316', 'TRAXX IN', '1/1/2025', '12/1/2024', '$269.27', '$110.20', '19%', 'Premium Equivalent', '1', '$51.16'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '10/1/2024', '($582.23)', '($229.85)', '18%', 'Premium Equivalent', '', '($104.80)'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '1/1/2025', '$9,316.24', '$3,677.74', '18%', 'Premium Equivalent', '21', '$1,676.87'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '11/1/2024', '($582.23)', '($229.85)', '18%', 'Premium Equivalent', '', '($104.80)'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '12/1/2024', '($194.05)', '($76.61)', '18%', 'Premium Equivalent', '1', '($34.93)'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '11/1/2024', '$394.00', '$88.28', '13%', 'Premium Equivalent', '1', '$51.22'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '1/1/2025', '$5,910.00', '$1,324.20', '13%', 'Premium Equivalent', '10', '$512.20'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '1/1/2025', '$5,910.00', '$1,324.20', '13%', 'Premium Equivalent', '5', '$256.10'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '12/1/2024', '$394.00', '$88.28', '13%', 'Premium Equivalent', '1', '$51.22'], ['L211608', 'RAPIDO LL', '1/1/2025', '11/1/2024', '($266.34)', '($122.63)', '9%', 'Premium Equivalent', '-1', '($23.97)'], ['L211608', 'RAPIDO LL', '1/1/2025', '12/1/2024', '$266.34', '$122.63', '9%', 'Premium Equivalent', '1', '$23.97'], ['L211608', 'RAPIDO LL', '1/1/2025', '1/1/2025', '$13,130.51', '$6,045.68', '9%', 'Premium Equivalent', '39', '$1,109.83'], ['L211608', 'RAPIDO LL', '1/1/2025', '1/1/2025', '$13,130.51', '$6,045.68', '9%', 'Premium Equivalent', '3', '$71.91'], ['L211660', 'BOXIFY LOGISTIC', '1/1/2025', '1/1/2025', '$6,354.91', '$2,734.81', '24%', 'Premium Equivalent', '12', '$821.76'], ['L211660', 'BOXIFY LOGISTIC', '1/1/2025', '10/1/2024', '($344.82)', '($148.45)', '24%', 'Premium Equivalent', '-1', '($82.76)']], 'table_type': 'commission_table', 'page_number': 1, 'confidence_score': 0.95, 'summary_rows': [], 'metadata': {'total_tables_merged': 1, 'total_rows': 16, 'canonical_header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'merged_from_tables': [0]}, 'header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']}], 'extraction_method': 'claude', 'file_type': 'pdf', 'document_metadata': {'carrier_name': 'ALLIED', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.95, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.95, 'total_pages': 37, 'file_size_mb': 0.3112449645996094, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 77137.16, 'total_amount_label': 'Total for Vendor'}, 'extracted_carrier': 'ALLIED', 'extracted_date': '2025-01-08', 'quality_summary': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 0.99, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'metadata': {'table_count': 1, 'quality_grade': 'A', 'confidence_score': 0.98, 'token_usage': {'input_tokens': 81949, 'output_tokens': 1382, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}}, 'extraction_quality': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 0.99, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'entities': {'carrier': {'name': 'ALLIED', 'confidence': 0.95, 'evidence': 'Document metadata'}, 'broker': {'company_name': 'INNOVATIVE BPS LLC', 'confidence': 0.95, 'evidence': 'Document metadata'}, 'writing_agents': [], 'groups_and_companies': [{'group_name': 'TRAXX IN', 'group_number': None, 'paid_amount': '$51.16'}, {'group_name': 'TRAXX IN', 'group_number': None, 'paid_amount': '$51.16'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '($104.80)'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '$1,676.87'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '($104.80)'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '($34.93)'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$51.22'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$512.20'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$256.10'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$51.22'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '($23.97)'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '$23.97'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '$1,109.83'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '$71.91'}, {'group_name': 'BOXIFY LOGISTIC', 'group_number': None, 'paid_amount': '$821.76'}, {'group_name': 'BOXIFY LOGISTIC', 'group_number': None, 'paid_amount': '($82.76)'}], 'document_metadata': {'carrier_name': 'ALLIED', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.95, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.95, 'total_pages': 37, 'file_size_mb': 0.3112449645996094, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 77137.16, 'total_amount_label': 'Total for Vendor'}}, 'relationships': {'carrier_to_broker': {'carrier': 'ALLIED', 'broker': 'INNOVATIVE BPS LLC', 'relationship': 'issues_commission_to'}, 'broker_to_agents': [], 'agents_to_groups': [{'agent': 'Unknown', 'group': 'TRAXX IN', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'TRAXX IN', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'BOXIFY LOGISTIC', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'BOXIFY LOGISTIC', 'relationship': 'manages'}], 'groups_to_payments': [{'group': 'TRAXX IN', 'amount': '$51.16', 'relationship': 'generates_commission'}, {'group': 'TRAXX IN', 'amount': '$51.16', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '($104.80)', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '$1,676.87', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '($104.80)', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '($34.93)', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$51.22', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$512.20', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$256.10', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$51.22', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '($23.97)', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '$23.97', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '$1,109.83', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '$71.91', 'relationship': 'generates_commission'}, {'group': 'BOXIFY LOGISTIC', 'amount': '$821.76', 'relationship': 'generates_commission'}, {'group': 'BOXIFY LOGISTIC', 'amount': '($82.76)', 'relationship': 'generates_commission'}]}, 'business_intelligence': {'total_commission_amount': 'Not specified', 'number_of_groups': 16, 'commission_structures': ['Premium Equivalent', 'Percentage-based'], 'top_contributors': [{'name': 'THE GOOD NEWS SERVI', 'amount': '$1,676.87'}, {'name': 'RAPIDO LL', 'amount': '$1,109.83'}, {'name': 'BOXIFY LOGISTIC', 'amount': '$821.76'}], 'special_payments': [], 'payment_period': '', 'patterns_detected': ['Large portfolio with 16 groups']}, 'summary': 'Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.', 'structured_data': {}, 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ’¾ Updating upload record with results...
INFO:app.api.new_extract:âœ… Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: 57077d49-835c-4185-b54b-a9b3dd7c641a)
INFO:app.api.new_extract:ğŸ¯ Format Learning: Using carrier ALLIED with ID 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
WARNING:app.api.new_extract:ğŸš¨ CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as ALLIED (35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.api.new_extract:ğŸ”„ Reassigning file to correct carrier: ALLIED
INFO:app.services.gcs_utils:âœ… File copied in GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf -> statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File deleted from GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… File moved to correct carrier folder in GCS: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Updated statement upload: carrier_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc, company_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.new_extract:ğŸ“Š Single table detected, using it for field mapping
INFO:app.api.new_extract:ğŸ¯ Using table 0 for field mapping with 10 headers
ğŸ¯ FormatLearningService: Finding matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Table structure: {'row_count': 16, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ FormatLearningService: Headers type: <class 'list'>
ğŸ¯ FormatLearningService: Headers length: 10
ğŸ¯ CRUD: Finding best matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD: Input table structure: {'row_count': 16, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ CRUD: Found 1 saved formats for company
ğŸ¯ CRUD: Comparing with saved format:
ğŸ¯ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD:   Header similarity: 0.7200000000000001
ğŸ¯ CRUD:   Structure similarity: 1.0
ğŸ¯ CRUD:   Total score: 0.776
ğŸ¯ CRUD:   -> New best match with score 0.776
ğŸ¯ FormatLearningService: Best match score: 0.776
ğŸ¯ FormatLearningService: Found matching format with signature: 434609905947a9e8728df0b79ba381ce
ğŸ¯ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
ğŸ¯ FormatLearningService: Learned table editor settings: {'carrier_name': 'ALLIED', 'corrected_carrier_name': 'ALLIED', 'statement_date': '2025-01-08', 'corrected_statement_date': '2025-01-08', 'statement_total_amount': 9336.9, 'total_amount_field_name': 'Invoice Total'}
INFO:app.api.new_extract:ğŸ¯ Format Learning: Found matching format with score 0.776
INFO:app.api.new_extract:ğŸ¯ Format Learning: Applying corrected carrier name from learned format: ALLIED
INFO:app.api.new_extract:ğŸ¯ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:âœ… Total extracted from document_metadata: $77137.16
INFO:app.api.new_extract:ğŸ¯ Format Learning: Total validation result: {'matches': False, 'extracted_amount': 77137.16, 'learned_amount': 9336.9, 'difference': 67800.26000000001, 'difference_percent': 726.15, 'status': 'mismatch', 'tolerance_percent': 5.0}
INFO:app.api.new_extract:ğŸ“Š Added total to document_metadata: $77137.16 (method: document_metadata)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:ğŸ” AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.85 confidence
INFO:app.api.new_extract:âœ… AI Plan Detection: 1 plan types with 0.85 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ§  AI Field Mapping: Starting field mapping during extraction
INFO:app.api.ai_intelligent_mapping:ğŸš€ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ğŸ¤– AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:ğŸ” AI Mapping: carrier_id provided: True (value: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.ai_field_mapping_service:ğŸ¯ Carrier ID is valid, attempting to retrieve learned mapping for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.services.ai_field_mapping_service:ğŸ” Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:ğŸ” Looking up learned format for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc with 10 headers
INFO:app.services.ai_field_mapping_service:âŒ No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:ğŸ” Found 1 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:ğŸ” Format signature 434609905947a9e8728df0b79ba381ce: similarity = 0.72
INFO:app.services.ai_field_mapping_service:âœ… New best match with similarity 0.72
INFO:app.services.ai_field_mapping_service:âœ… Found similar format with 0.72 similarity score
INFO:app.services.ai_field_mapping_service:ğŸ¯ Found learned mapping for carrier with 0.72 confidence
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:âœ… AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:âœ… AI Mapping: Generated 10 mappings with 0.90 confidence
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.85 confidence
INFO:app.api.ai_intelligent_mapping:âœ… Enhanced AI Analysis Complete: Overall confidence 0.88
INFO:app.api.new_extract:âœ… AI Field Mapping: 10 mappings with 0.90 confidence
INFO:app.api.new_extract:âœ… Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
INFO:app.api.new_extract:   Structured data: {}
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 57077d49-835c-4185-b54b-a9b3dd7c641a)
INFO:app.api.new_extract:ğŸ“¤ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:ğŸ“Š Sending structured data: {}...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:âœ… Extraction complete! Sent results via WebSocket for upload_id: upload_1763057700614_9hm9htdp0
INFO:     127.0.0.1:63492 - "OPTIONS /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:62221 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763057700614_9hm9htdp0, session_id=session_1763057700644_fvxgyo5kz
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763057700614_9hm9htdp0, session_id=session_1763057700644_fvxgyo5kz
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763057700614_9hm9htdp0
INFO:app.api.auto_approval:Auto-approval started for upload 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.api.auto_approval:ğŸ” Auto-approval: Filtered 1 tables to 1 commission tables for saving
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Raw field_mapping from learned format: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Using 10 field mappings from learned format
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Field config list: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saving edited tables for upload_id: 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Tables count: 1
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Selected statement date: {'date': '2025-01-08'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Company ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Field config received: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Updating upload with tables, statement date, and carrier
ğŸ¯ CRUD: update_upload_tables called for upload_id: 57077d49-835c-4185-b54b-a9b3dd7c641a
ğŸ¯ CRUD: Tables data length: 1
ğŸ¯ CRUD: Selected statement date: {'date': '2025-01-08'}
ğŸ¯ CRUD: Carrier ID: None
ğŸ¯ CRUD: Found upload, updating with tables, statement date, and carrier
ğŸ¯ CRUD: Saved selected statement date to database: {'date': '2025-01-08'}
ğŸ¯ CRUD: Statement date type: <class 'dict'>
ğŸ¯ CRUD: Statement date keys: ['date']
ğŸ¯ CRUD: Also saved statement date and carrier to progress_data


 organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV6M6Gmw9SAvjjBRA6Uig'}
ERROR:app.services.claude.service:   Rate limit error: True, Retriable: True
WARNING:app.services.claude.service:âš ï¸  Rate limit hit! Retry-After: 95.00s
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.claude.service:ğŸ”„ Calling Claude API with model: claude-sonnet-4-20250514 (attempt 2/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:âœ… Claude API call successful. Tokens: input=81,949, output=1,382
INFO:app.services.claude.service:ğŸ“Š Token tracking: Estimated=125,488, Actual=81,949, Diff=-43,539
INFO:app.services.claude.service:ğŸ”§ Token bucket adjusted: 125,488 â†’ 81,949
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
ERROR:app.services.claude.utils:JSON decode error: Expecting value: line 1 column 1 (char 0)
ERROR:app.services.claude.utils:Response text: Looking at this ABSF Commission Payment Summary document, I'll extract the information with pixel-perfect accuracy.

```json
{
  "document_metadata": {
    "carrier_name": "ALLIED",
    "carrier_confidence": 0.95,
    "statement_date": "2025-01-08",
    "date_confidence": 0.95,
    "broker_company": "INNOVATIVE BPS LLC",
    "broker_confidence": 0.95,
    "total_amount": 77137.16,
    "total_amount_label": "Total for Vendor",
    "total_amount_confidence": 0.98,
    "total_calculation_method": "
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage validation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage validation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:ğŸš€ Running enhanced 3-phase extraction pipeline...
INFO:app.services.claude.service:   Phase 1: Document Intelligence âœ“ (completed)
INFO:app.services.claude.service:   Phase 2: Semantic Extraction â†’ Starting...
INFO:app.services.claude.service:   Phase 3: Intelligent Summarization â†’ Pending...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage semantic_analysis for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:ğŸ“Š Phase 2: Semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ” Starting semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 0 writing agents: []
INFO:app.services.claude.semantic_extractor:ğŸ“Š Extracted 16 groups/companies
INFO:app.services.claude.semantic_extractor:âœ… Semantic extraction completed successfully
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage semantic_analysis for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:âœï¸ Phase 3: Intelligent summarization...
INFO:app.services.claude.service:ğŸ“Š Semantic result keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.claude.service:   - Entities: âœ…
INFO:app.services.claude.service:   - Relationships: âœ…
INFO:app.services.claude.service:   - Business Intelligence: âœ…
INFO:app.services.claude.service:ğŸ“ Summary service available: True
INFO:app.services.claude.service:ğŸš€ Calling generate_conversational_summary with use_enhanced=True...
INFO:app.services.conversational_summary_service:ğŸ—£ï¸ Generating conversational summary...
INFO:app.services.conversational_summary_service:ğŸ” _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.conversational_summary_service:âœ… Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:ğŸ¯ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: ['carrier', 'broker', 'writing_agents', 'groups_and_companies', 'document_metadata']
INFO:app.services.conversational_summary_service:   - Relationships: ['carrier_to_broker', 'broker_to_agents', 'agents_to_groups', 'groups_to_payments']
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['total_commission_amount', 'number_of_groups', 'commission_structures', 'top_contributors', 'special_payments', 'payment_period', 'patterns_detected']
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:ğŸš€ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:âœ… SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:ğŸš€ Calling Claude API for summary generation...
INFO:app.services.conversational_summary_service:   Model: claude-sonnet-4-20250514
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 19016 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.462185 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
INFO:anthropic._base_client:Retrying request to /v1/messages in 0.800704 seconds
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 429 Too Many Requests"
ERROR:app.services.conversational_summary_service:âŒ Summary generation failed: Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV6MFMAcH7DUTnqZuXR2o'}
ERROR:app.services.conversational_summary_service:   Error type: RateLimitError
ERROR:app.services.conversational_summary_service:   Full traceback:
Traceback (most recent call last):
  File "/Users/kayttaja/Desktop/commision-tracker/server/app/services/conversational_summary_service.py", line 204, in generate_conversational_summary
    response = await self.client.messages.create(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kayttaja/Desktop/commision-tracker/server/venv/lib/python3.11/site-packages/anthropic/resources/messages/messages.py", line 2113, in create
    return await self._post(
           ^^^^^^^^^^^^^^^^^
  File "/Users/kayttaja/Desktop/commision-tracker/server/venv/lib/python3.11/site-packages/anthropic/_base_client.py", line 1898, in post
    return await self.request(cast_to, opts, stream=stream, stream_cls=stream_cls)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/kayttaja/Desktop/commision-tracker/server/venv/lib/python3.11/site-packages/anthropic/_base_client.py", line 1698, in request
    raise self._make_status_error_from_response(err.response) from None
anthropic.RateLimitError: Error code: 429 - {'type': 'error', 'error': {'type': 'rate_limit_error', 'message': 'This request would exceed the rate limit for your organization (ec551ca5-87dd-45f2-9405-0ec7e8ddf74f) of 30,000 input tokens per minute. For details, refer to: https://docs.claude.com/en/api/rate-limits. You can see the response headers for current usage. Please reduce the prompt length or the maximum tokens requested, or try again later. You may also contact sales at https://www.anthropic.com/contact-sales to discuss your options for a rate limit increase.'}, 'request_id': 'req_011CV6MFMAcH7DUTnqZuXR2o'}
ERROR:app.services.conversational_summary_service:   Extraction data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
WARNING:app.services.conversational_summary_service:ğŸ”„ Generating fallback summary...
INFO:app.services.conversational_summary_service:   Using entity data: carrier=ALLIED, broker=INNOVATIVE BPS LLC, date=2025-01-08
WARNING:app.services.conversational_summary_service:   Fallback summary: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
WARNING:app.services.conversational_summary_service:âš ï¸ Using fallback summary: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
INFO:app.services.claude.service:âœ… Summary generation completed. Success: True
INFO:app.services.claude.service:ğŸ“„ Generated summary (first 200 chars): Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC....
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.claude.service:âœ… Enhanced 3-phase pipeline completed successfully
INFO:app.services.claude.service:ğŸ“¦ Enhanced result keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'quality_summary', 'metadata', 'extraction_quality', 'entities', 'relationships', 'business_intelligence', 'summary', 'structured_data', 'extraction_pipeline', 'semantic_extraction_success']
INFO:app.services.claude.service:   - Summary length: 84 characters
INFO:app.services.claude.service:   - Summary preview: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC....
INFO:app.services.claude.service:   - Structured data: {}
INFO:app.services.claude.service:âœ… Claude extraction completed in 176.60s
INFO:app.services.enhanced_extraction_service:âš¡ Extracting metadata from Claude extraction results
INFO:app.services.enhanced_extraction_service:âœ… Using Claude metadata: carrier=ALLIED, date=2025-01-08, broker=INNOVATIVE BPS LLC
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
ğŸ“ Enhanced multi-strategy stitching: Processing 1 tables
ğŸ“ Canonical header identified: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Table 1 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
ğŸ“ Found 1 unique header patterns
ğŸ“ Grouped 1 tables into 1 groups
ğŸ“ Merging group 1 with 1 tables
INFO:app.services.extraction_utils:âœ… Merged table created: 16 rows (enhancements preserved from individual tables)
ğŸ“ Merged table 1: 10 headers, 16 rows
ğŸ“ Merged headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ“ Enhanced stitching completed: 1 final tables
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.enhanced_extraction_service:Claude: Verified normalized headers
INFO:app.services.enhanced_extraction_service:Claude: Processed 1 tables into 1 tables
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ¯ STAGE 3: CONVERSATIONAL SUMMARY GENERATION
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   - Enhanced mode enabled: True
INFO:app.services.enhanced_extraction_service:   - Result has 'summary': True
INFO:app.services.enhanced_extraction_service:   - Summary service available: True
INFO:app.services.enhanced_extraction_service:âœ… Using enhanced summary from Claude pipeline
INFO:app.services.enhanced_extraction_service:   Summary length: 84 characters
INFO:app.services.enhanced_extraction_service:   Summary preview: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC....
INFO:app.services.enhanced_extraction_service:ğŸ“¤ Sending Claude-generated summary AND structured data to frontend via WebSocket NOW
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.enhanced_extraction_service:âœ… Sent structured summary data to frontend: {}
INFO:app.services.enhanced_extraction_service:âœ… Claude-generated summary sent to frontend successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:ğŸ“ FINAL SUMMARY SELECTION: ENHANCED CONVERSATIONAL
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   Summary length: 84 characters
INFO:app.services.enhanced_extraction_service:   Full summary:
Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
INFO:app.services.enhanced_extraction_service:================================================================================
WARNING:app.services.enhanced_extraction_service:âš ï¸ No structured_summary_data available
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Started stage validation for upload upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Completed processing for upload upload_1763057700614_9hm9htdp0 in 249.50 seconds
INFO:app.api.new_extract:âœ… Extraction completed successfully: {'success': True, 'tables': [{'headers': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'rows': [['L210316', 'TRAXX IN', '1/1/2025', '11/1/2024', '$269.27', '$110.20', '19%', 'Premium Equivalent', '1', '$51.16'], ['L210316', 'TRAXX IN', '1/1/2025', '12/1/2024', '$269.27', '$110.20', '19%', 'Premium Equivalent', '1', '$51.16'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '10/1/2024', '($582.23)', '($229.85)', '18%', 'Premium Equivalent', '', '($104.80)'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '1/1/2025', '$9,316.24', '$3,677.74', '18%', 'Premium Equivalent', '21', '$1,676.87'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '11/1/2024', '($582.23)', '($229.85)', '18%', 'Premium Equivalent', '', '($104.80)'], ['L211274', 'THE GOOD NEWS SERVI', '1/1/2025', '12/1/2024', '($194.05)', '($76.61)', '18%', 'Premium Equivalent', '1', '($34.93)'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '11/1/2024', '$394.00', '$88.28', '13%', 'Premium Equivalent', '1', '$51.22'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '1/1/2025', '$5,910.00', '$1,324.20', '13%', 'Premium Equivalent', '10', '$512.20'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '1/1/2025', '$5,910.00', '$1,324.20', '13%', 'Premium Equivalent', '5', '$256.10'], ['L211361', 'NORTH STAR DELIVERY', '1/1/2025', '12/1/2024', '$394.00', '$88.28', '13%', 'Premium Equivalent', '1', '$51.22'], ['L211608', 'RAPIDO LL', '1/1/2025', '11/1/2024', '($266.34)', '($122.63)', '9%', 'Premium Equivalent', '-1', '($23.97)'], ['L211608', 'RAPIDO LL', '1/1/2025', '12/1/2024', '$266.34', '$122.63', '9%', 'Premium Equivalent', '1', '$23.97'], ['L211608', 'RAPIDO LL', '1/1/2025', '1/1/2025', '$13,130.51', '$6,045.68', '9%', 'Premium Equivalent', '39', '$1,109.83'], ['L211608', 'RAPIDO LL', '1/1/2025', '1/1/2025', '$13,130.51', '$6,045.68', '9%', 'Premium Equivalent', '3', '$71.91'], ['L211660', 'BOXIFY LOGISTIC', '1/1/2025', '1/1/2025', '$6,354.91', '$2,734.81', '24%', 'Premium Equivalent', '12', '$821.76'], ['L211660', 'BOXIFY LOGISTIC', '1/1/2025', '10/1/2024', '($344.82)', '($148.45)', '24%', 'Premium Equivalent', '-1', '($82.76)']], 'table_type': 'commission_table', 'page_number': 1, 'confidence_score': 0.95, 'summary_rows': [], 'metadata': {'total_tables_merged': 1, 'total_rows': 16, 'canonical_header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'], 'merged_from_tables': [0]}, 'header': ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']}], 'extraction_method': 'claude', 'file_type': 'pdf', 'document_metadata': {'carrier_name': 'ALLIED', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.95, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.95, 'total_pages': 37, 'file_size_mb': 0.3112449645996094, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 77137.16, 'total_amount_label': 'Total for Vendor'}, 'extracted_carrier': 'ALLIED', 'extracted_date': '2025-01-08', 'quality_summary': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 0.99, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'metadata': {'table_count': 1, 'quality_grade': 'A', 'confidence_score': 0.98, 'token_usage': {'input_tokens': 81949, 'output_tokens': 1382, 'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0}}, 'extraction_quality': {'overall_confidence': 0.98, 'table_structure_score': 1.0, 'data_completeness': 0.99, 'extraction_accuracy': 0.98, 'issues_detected': [], 'quality_grade': 'A', 'table_count': 1}, 'entities': {'carrier': {'name': 'ALLIED', 'confidence': 0.95, 'evidence': 'Document metadata'}, 'broker': {'company_name': 'INNOVATIVE BPS LLC', 'confidence': 0.95, 'evidence': 'Document metadata'}, 'writing_agents': [], 'groups_and_companies': [{'group_name': 'TRAXX IN', 'group_number': None, 'paid_amount': '$51.16'}, {'group_name': 'TRAXX IN', 'group_number': None, 'paid_amount': '$51.16'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '($104.80)'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '$1,676.87'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '($104.80)'}, {'group_name': 'THE GOOD NEWS SERVI', 'group_number': None, 'paid_amount': '($34.93)'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$51.22'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$512.20'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$256.10'}, {'group_name': 'NORTH STAR DELIVERY', 'group_number': None, 'paid_amount': '$51.22'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '($23.97)'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '$23.97'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '$1,109.83'}, {'group_name': 'RAPIDO LL', 'group_number': None, 'paid_amount': '$71.91'}, {'group_name': 'BOXIFY LOGISTIC', 'group_number': None, 'paid_amount': '$821.76'}, {'group_name': 'BOXIFY LOGISTIC', 'group_number': None, 'paid_amount': '($82.76)'}], 'document_metadata': {'carrier_name': 'ALLIED', 'carrier_confidence': 0.95, 'statement_date': '2025-01-08', 'date_confidence': 0.95, 'broker_company': 'INNOVATIVE BPS LLC', 'broker_confidence': 0.95, 'total_pages': 37, 'file_size_mb': 0.3112449645996094, 'extraction_method': 'claude', 'claude_model': 'claude-sonnet-4-20250514', 'total_amount': 77137.16, 'total_amount_label': 'Total for Vendor'}}, 'relationships': {'carrier_to_broker': {'carrier': 'ALLIED', 'broker': 'INNOVATIVE BPS LLC', 'relationship': 'issues_commission_to'}, 'broker_to_agents': [], 'agents_to_groups': [{'agent': 'Unknown', 'group': 'TRAXX IN', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'TRAXX IN', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'THE GOOD NEWS SERVI', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'NORTH STAR DELIVERY', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'RAPIDO LL', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'BOXIFY LOGISTIC', 'relationship': 'manages'}, {'agent': 'Unknown', 'group': 'BOXIFY LOGISTIC', 'relationship': 'manages'}], 'groups_to_payments': [{'group': 'TRAXX IN', 'amount': '$51.16', 'relationship': 'generates_commission'}, {'group': 'TRAXX IN', 'amount': '$51.16', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '($104.80)', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '$1,676.87', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '($104.80)', 'relationship': 'generates_commission'}, {'group': 'THE GOOD NEWS SERVI', 'amount': '($34.93)', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$51.22', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$512.20', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$256.10', 'relationship': 'generates_commission'}, {'group': 'NORTH STAR DELIVERY', 'amount': '$51.22', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '($23.97)', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '$23.97', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '$1,109.83', 'relationship': 'generates_commission'}, {'group': 'RAPIDO LL', 'amount': '$71.91', 'relationship': 'generates_commission'}, {'group': 'BOXIFY LOGISTIC', 'amount': '$821.76', 'relationship': 'generates_commission'}, {'group': 'BOXIFY LOGISTIC', 'amount': '($82.76)', 'relationship': 'generates_commission'}]}, 'business_intelligence': {'total_commission_amount': 'Not specified', 'number_of_groups': 16, 'commission_structures': ['Premium Equivalent', 'Percentage-based'], 'top_contributors': [{'name': 'THE GOOD NEWS SERVI', 'amount': '$1,676.87'}, {'name': 'RAPIDO LL', 'amount': '$1,109.83'}, {'name': 'BOXIFY LOGISTIC', 'amount': '$821.76'}], 'special_payments': [], 'payment_period': '', 'patterns_detected': ['Large portfolio with 16 groups']}, 'summary': 'Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.', 'structured_data': {}, 'extraction_pipeline': '3-phase-enhanced', 'semantic_extraction_success': True}
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ’¾ Updating upload record with results...
INFO:app.api.new_extract:âœ… Upload record updated successfully
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: 57077d49-835c-4185-b54b-a9b3dd7c641a)
INFO:app.api.new_extract:ğŸ¯ Format Learning: Using carrier ALLIED with ID 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
WARNING:app.api.new_extract:ğŸš¨ CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as ALLIED (35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.api.new_extract:ğŸ”„ Reassigning file to correct carrier: ALLIED
INFO:app.services.gcs_utils:âœ… File copied in GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf -> statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… File deleted from GCS: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
INFO:app.services.gcs_utils:âœ… Generated signed URL for GCS file with inline headers: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… File moved to correct carrier folder in GCS: statements/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/01.13.25 Allied Innovative Payment.pdf
INFO:app.api.new_extract:âœ… Updated statement upload: carrier_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc, company_id=35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.new_extract:ğŸ“Š Single table detected, using it for field mapping
INFO:app.api.new_extract:ğŸ¯ Using table 0 for field mapping with 10 headers
ğŸ¯ FormatLearningService: Finding matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ FormatLearningService: Table structure: {'row_count': 16, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ FormatLearningService: Headers type: <class 'list'>
ğŸ¯ FormatLearningService: Headers length: 10
ğŸ¯ CRUD: Finding best matching format for company 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
ğŸ¯ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD: Input table structure: {'row_count': 16, 'column_count': 10, 'has_financial_data': True}
ğŸ¯ CRUD: Found 1 saved formats for company
ğŸ¯ CRUD: Comparing with saved format:
ğŸ¯ CRUD:   Saved headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent %', 'Calculation Method', 'Census Ct.', 'Paid Amount']
ğŸ¯ CRUD:   Header similarity: 0.7200000000000001
ğŸ¯ CRUD:   Structure similarity: 1.0
ğŸ¯ CRUD:   Total score: 0.776
ğŸ¯ CRUD:   -> New best match with score 0.776
ğŸ¯ FormatLearningService: Best match score: 0.776
ğŸ¯ FormatLearningService: Found matching format with signature: 434609905947a9e8728df0b79ba381ce
ğŸ¯ FormatLearningService: Learned field mapping: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
ğŸ¯ FormatLearningService: Learned table editor settings: {'carrier_name': 'ALLIED', 'corrected_carrier_name': 'ALLIED', 'statement_date': '2025-01-08', 'corrected_statement_date': '2025-01-08', 'statement_total_amount': 9336.9, 'total_amount_field_name': 'Invoice Total'}
INFO:app.api.new_extract:ğŸ¯ Format Learning: Found matching format with score 0.776
INFO:app.api.new_extract:ğŸ¯ Format Learning: Applying corrected carrier name from learned format: ALLIED
INFO:app.api.new_extract:ğŸ¯ Format Learning: Skipping statement date auto-apply (dates are document-specific)
INFO:app.api.new_extract:âœ… Total extracted from document_metadata: $77137.16
INFO:app.api.new_extract:ğŸ¯ Format Learning: Total validation result: {'matches': False, 'extracted_amount': 77137.16, 'learned_amount': 9336.9, 'difference': 67800.26000000001, 'difference_percent': 726.15, 'status': 'mismatch', 'tolerance_percent': 5.0}
INFO:app.api.new_extract:ğŸ“Š Added total to document_metadata: $77137.16 (method: document_metadata)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:ğŸ” AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.85 confidence
INFO:app.api.new_extract:âœ… AI Plan Detection: 1 plan types with 0.85 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:ğŸ§  AI Field Mapping: Starting field mapping during extraction
INFO:app.api.ai_intelligent_mapping:ğŸš€ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ğŸ¤– AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:ğŸ” AI Mapping: carrier_id provided: True (value: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.ai_field_mapping_service:ğŸ¯ Carrier ID is valid, attempting to retrieve learned mapping for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.services.ai_field_mapping_service:ğŸ” Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:ğŸ” Looking up learned format for carrier 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc with 10 headers
INFO:app.services.ai_field_mapping_service:âŒ No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:ğŸ” Found 1 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:ğŸ” Format signature 434609905947a9e8728df0b79ba381ce: similarity = 0.72
INFO:app.services.ai_field_mapping_service:âœ… New best match with similarity 0.72
INFO:app.services.ai_field_mapping_service:âœ… Found similar format with 0.72 similarity score
INFO:app.services.ai_field_mapping_service:ğŸ¯ Found learned mapping for carrier with 0.72 confidence
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:âœ… AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:âœ… AI Mapping: Generated 10 mappings with 0.90 confidence
INFO:app.services.ai_plan_type_detection_service:ğŸ” AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:âœ… AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:âœ… AI Plan Detection: Found 1 plan types with 0.85 confidence
INFO:app.api.ai_intelligent_mapping:âœ… Enhanced AI Analysis Complete: Overall confidence 0.88
INFO:app.api.new_extract:âœ… AI Field Mapping: 10 mappings with 0.90 confidence
INFO:app.api.new_extract:âœ… Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: Commission statement from ALLIED, dated 2025-01-08, prepared for INNOVATIVE BPS LLC.
INFO:app.api.new_extract:   Structured data: {}
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.services.user_profile_service:Recorded contribution: upload for user f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: 57077d49-835c-4185-b54b-a9b3dd7c641a)
INFO:app.api.new_extract:ğŸ“¤ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:ğŸ“Š Sending structured data: {}...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763057700614_9hm9htdp0: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763057700614_9hm9htdp0
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763057700614_9hm9htdp0
INFO:app.api.new_extract:âœ… Extraction complete! Sent results via WebSocket for upload_id: upload_1763057700614_9hm9htdp0
INFO:     127.0.0.1:63492 - "OPTIONS /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:62221 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763057700614_9hm9htdp0, session_id=session_1763057700644_fvxgyo5kz
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763057700614_9hm9htdp0, session_id=session_1763057700644_fvxgyo5kz
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763057700614_9hm9htdp0
INFO:app.api.auto_approval:Auto-approval started for upload 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.api.auto_approval:ğŸ” Auto-approval: Filtered 1 tables to 1 commission tables for saving
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Raw field_mapping from learned format: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Using 10 field mappings from learned format
INFO:app.api.auto_approval:ğŸ¤– Auto-approval: Field config list: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saving edited tables for upload_id: 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Tables count: 1
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Selected statement date: {'date': '2025-01-08'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Company ID: 35df0e13-76d7-4a42-b66a-2f1a4d8f96cc
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Field config received: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Converted 1 tables to database format
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Saved edited tables to database
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Updating upload with tables, statement date, and carrier
ğŸ¯ CRUD: update_upload_tables called for upload_id: 57077d49-835c-4185-b54b-a9b3dd7c641a
ğŸ¯ CRUD: Tables data length: 1
ğŸ¯ CRUD: Selected statement date: {'date': '2025-01-08'}
ğŸ¯ CRUD: Carrier ID: None
ğŸ¯ CRUD: Found upload, updating with tables, statement date, and carrier
ğŸ¯ CRUD: Saved selected statement date to database: {'date': '2025-01-08'}
ğŸ¯ CRUD: Statement date type: <class 'dict'>
ğŸ¯ CRUD: Statement date keys: ['date']
ğŸ¯ CRUD: Also saved statement date and carrier to progress_data
ğŸ¯ CRUD: Successfully updated upload 57077d49-835c-4185-b54b-a9b3dd7c641a with tables, statement date, and carrier
ğŸ¯ CRUD: Final selected_statement_date in database: {'date': '2025-01-08'}
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully updated upload with statement date and carrier
WARNING:app.api.table_editor:ğŸ¯ Table Editor API: Skipping format learning - no carrier_id available
INFO:app.api.table_editor:ğŸ¯ Table Editor API: Successfully saved 1 edited tables
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.api.auto_approval:Updated format learning usage count for signature: 434609905947a9e8728df0b79ba381ce
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
ğŸ’¾ Saving statement review: upload_id=57077d49-835c-4185-b54b-a9b3dd7c641a, status=Approved
ğŸ“‹ Field config being saved: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
ğŸ“Š Final data rows: 1
ğŸ“… Selected statement date being saved: {'date': '2025-01-08'}
ğŸ” DEBUG Saving table 0 'Table 1': summaryRows=[], type=<class 'list'>
ğŸ“ Extracted field_mapping with 10 mappings: {'Agent %': 'Commission Rate', 'Group No.': 'Policy Number', 'Census Ct.': 'Total Subscribers', 'Group Name': 'Client Name', 'Adj. Period': 'Adjustment Period Start', 'Paid Amount': 'Commission Earned', 'Invoice Total': 'Invoice Total', 'Billing Period': 'Coverage Period Start', 'Stoploss Total': 'Stoploss Total', 'Calculation Method': 'Plan Type'}
ğŸ’° Calculating extracted_total for manual approval...
ğŸ’° field_mapping keys: ['Agent %', 'Group No.', 'Census Ct.', 'Group Name', 'Adj. Period', 'Paid Amount', 'Invoice Total', 'Billing Period', 'Stoploss Total', 'Calculation Method']
ğŸ’° Number of tables in final_data: 1
ğŸ’° Found commission field (EXACT MATCH): Paid Amount -> Commission Earned
ğŸ’° Final commission_source_field: Paid Amount
  ğŸ“Š Table 0: 10 headers, 16 rows
  ğŸ“‹ Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  ğŸ“‹ First row sample: ['L210316', 'TRAXX IN', '1/1/2025', '11/1/2024', '$269.27', '$110.20', '19%', 'Premium Equivalent', '1', '$51.16']
  ğŸ’° Table 0: Commission column 'Paid Amount' at index 9
    Row 0: [LIST] raw_value = '$51.16' (type: <class 'str'>)
    Row 0: Added $51.16 (running total: $51.16)
    Row 1: [LIST] raw_value = '$51.16' (type: <class 'str'>)
    Row 1: Added $51.16 (running total: $102.32)
    Row 2: [LIST] raw_value = '($104.80)' (type: <class 'str'>)
    Row 2: Added $-104.80 (running total: $-2.48)
    Row 3: [LIST] raw_value = '$1,676.87' (type: <class 'str'>)
    Row 3: Added $1676.87 (running total: $1674.39)
    Row 4: [LIST] raw_value = '($104.80)' (type: <class 'str'>)
    Row 4: Added $-104.80 (running total: $1569.59)
    Row 5: [LIST] raw_value = '($34.93)' (type: <class 'str'>)
    Row 5: Added $-34.93 (running total: $1534.66)
    Row 6: [LIST] raw_value = '$51.22' (type: <class 'str'>)
    Row 6: Added $51.22 (running total: $1585.88)
    Row 7: [LIST] raw_value = '$512.20' (type: <class 'str'>)
    Row 7: Added $512.20 (running total: $2098.08)
    Row 8: [LIST] raw_value = '$256.10' (type: <class 'str'>)
    Row 8: Added $256.10 (running total: $2354.18)
    Row 9: [LIST] raw_value = '$51.22' (type: <class 'str'>)
    Row 9: Added $51.22 (running total: $2405.40)
    Row 10: [LIST] raw_value = '($23.97)' (type: <class 'str'>)
    Row 10: Added $-23.97 (running total: $2381.43)
    Row 11: [LIST] raw_value = '$23.97' (type: <class 'str'>)
    Row 11: Added $23.97 (running total: $2405.40)
    Row 12: [LIST] raw_value = '$1,109.83' (type: <class 'str'>)
    Row 12: Added $1109.83 (running total: $3515.23)
    Row 13: [LIST] raw_value = '$71.91' (type: <class 'str'>)
    Row 13: Added $71.91 (running total: $3587.14)
    Row 14: [LIST] raw_value = '$821.76' (type: <class 'str'>)
    Row 14: Added $821.76 (running total: $4408.90)
    Row 15: [LIST] raw_value = '($82.76)' (type: <class 'str'>)
    Row 15: Added $-82.76 (running total: $4326.14)
  âœ… Table 0 total: $4326.14
ğŸ’° Final extracted_total: $4326.14
ğŸ’° Calculating extracted_invoice_total for manual approval...
ğŸ’° Found invoice field (exact match): Invoice Total -> Invoice Total
  ğŸ“Š Table 0: 10 headers, 16 rows
  ğŸ“‹ Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
  ğŸ“‹ First row sample: ['L210316', 'TRAXX IN', '1/1/2025', '11/1/2024', '$269.27', '$110.20', '19%', 'Premium Equivalent', '1', '$51.16']
  ğŸ’° Table 0: Invoice column 'Invoice Total' at index 4
    Row 0: [LIST] invoice_value = '$269.27'
    Row 0: Added $269.27 to invoice (running total: $269.27)
    Row 1: [LIST] invoice_value = '$269.27'
    Row 1: Added $269.27 to invoice (running total: $538.54)
    Row 2: [LIST] invoice_value = '($582.23)'
    Row 2: Added $-582.23 to invoice (running total: $-43.69)
    Row 3: [LIST] invoice_value = '$9,316.24'
    Row 3: Added $9316.24 to invoice (running total: $9272.55)
    Row 4: [LIST] invoice_value = '($582.23)'
    Row 4: Added $-582.23 to invoice (running total: $8690.32)
    Row 5: [LIST] invoice_value = '($194.05)'
    Row 5: Added $-194.05 to invoice (running total: $8496.27)
    Row 6: [LIST] invoice_value = '$394.00'
    Row 6: Added $394.00 to invoice (running total: $8890.27)
    Row 7: [LIST] invoice_value = '$5,910.00'
    Row 7: Added $5910.00 to invoice (running total: $14800.27)
    Row 8: [LIST] invoice_value = '$5,910.00'
    Row 8: Added $5910.00 to invoice (running total: $20710.27)
    Row 9: [LIST] invoice_value = '$394.00'
    Row 9: Added $394.00 to invoice (running total: $21104.27)
    Row 10: [LIST] invoice_value = '($266.34)'
    Row 10: Added $-266.34 to invoice (running total: $20837.93)
    Row 11: [LIST] invoice_value = '$266.34'
    Row 11: Added $266.34 to invoice (running total: $21104.27)
    Row 12: [LIST] invoice_value = '$13,130.51'
    Row 12: Added $13130.51 to invoice (running total: $34234.78)
    Row 13: [LIST] invoice_value = '$13,130.51'
    Row 13: Added $13130.51 to invoice (running total: $47365.29)
    Row 14: [LIST] invoice_value = '$6,354.91'
    Row 14: Added $6354.91 to invoice (running total: $53720.20)
    Row 15: [LIST] invoice_value = '($344.82)'
    Row 15: Added $-344.82 to invoice (running total: $53375.38)
  âœ… Table 0 invoice total: $53375.38
ğŸ’° Final extracted_invoice_total: $53375.38
âœ… Set extracted_total=4326.14, total_amount_match=True
âœ… Set extracted_invoice_total=53375.38
âœ… Statement approved, processing commission data with BULK OPTIMIZATION...
ğŸš€ BULK PROCESSING: Starting optimized commission processing for upload 57077d49-835c-4185-b54b-a9b3dd7c641a
ğŸ” Extracting field mappings from: [{'field': 'Agent %', 'mapping': 'Commission Rate'}, {'field': 'Group No.', 'mapping': 'Policy Number'}, {'field': 'Census Ct.', 'mapping': 'Total Subscribers'}, {'field': 'Group Name', 'mapping': 'Client Name'}, {'field': 'Adj. Period', 'mapping': 'Adjustment Period Start'}, {'field': 'Paid Amount', 'mapping': 'Commission Earned'}, {'field': 'Invoice Total', 'mapping': 'Invoice Total'}, {'field': 'Billing Period', 'mapping': 'Coverage Period Start'}, {'field': 'Stoploss Total', 'mapping': 'Stoploss Total'}, {'field': 'Calculation Method', 'mapping': 'Plan Type'}]
âœ… Found client name field: Group Name -> Client Name
âœ… Found commission field (exact match): Paid Amount -> Commission Earned
âœ… Found invoice total field (exact): Invoice Total -> Invoice Total
ğŸ” Extracted field mappings: {'client_name_field': 'Group Name', 'commission_earned_field': 'Paid Amount', 'invoice_total_field': 'Invoice Total'}
   âœ… Client Name: Using 'Group Name'
   âœ… Commission Earned: Using 'Paid Amount'
   âœ… Invoice Total: Using 'Invoice Total'
âœ… OPTIMIZED: Pre-extracted field mappings: client=Group Name, commission=Paid Amount, invoice=Invoice Total
ğŸ‘¤ Processing for user_id: f6cf1764-5bfc-4352-abd9-81b72b7cf191
ğŸŒ Processing for environment_id: 9f4a7a57-5715-4b1e-98a9-b9901726a485
ğŸ“… Statement date: 2025-01-08 00:00:00 (month: 1, year: 2025)
ğŸ“Š Table 0: Mapped fields - client[1]=Group Name, commission[9]=Paid Amount, invoice[4]=Invoice Total
ğŸ” DEBUG Table 0: summaryRows raw value: [], type: <class 'list'>
âš ï¸  Table 0: NO summary rows to exclude - all rows will be processed
ğŸ“Š Extracted 16 commission records for bulk processing
ğŸ” Found 5 clients with multiple statement rows:
   1. TRAXX IN: 2 rows, total commission: $102.32
   2. THE GOOD NEWS SERVI: 4 rows, total commission: $1432.34
   3. NORTH STAR DELIVERY: 4 rows, total commission: $870.74
   4. RAPIDO LL: 4 rows, total commission: $1181.74
   5. BOXIFY LOGISTIC: 2 rows, total commission: $739.00
ğŸ“Š Commission Analysis: {'total_records': 16, 'unique_clients': 5, 'clients_with_multiple_rows': 5}
ğŸ” Bulk fetch: Looking up 5 unique commission records (with user isolation)
âœ… Bulk fetch: Found 0 existing records for specified users
ğŸ“Š Aggregating 16 individual records by unique constraint...
âœ… Aggregated into 5 unique commission records (with user isolation)
   ğŸ“‹ TRAXX IN (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $102.32 commission, $538.54 invoice
   ğŸ“‹ THE GOOD NEWS SERVI (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $1432.34 commission, $7957.73 invoice
   ğŸ“‹ NORTH STAR DELIVERY (user: f6cf1764-5bfc-4352-abd9-81b72b7cf191): $870.74 commission, $12608.00 invoice
ğŸ“Š Bulk operations prepared: 0 updates, 5 inserts
â• Executing bulk insert for 5 records
âœ… BULK PROCESSING: Successfully processed 16 records
ğŸ“ˆ Performance: Reduced from 600-800 DB operations to 2-3 operations
INFO:app.api.auto_approval:ğŸ“ Auto-approval: Normalizing filename for upload 57077d49-835c-4185-b54b-a9b3dd7c641a
ERROR:app.services.gcs_utils:Source file not found in GCS for rename: statements/57077d49-835c-4185-b54b-a9b3dd7c641a/01.13.25 Allied Innovative Payment.pdf
WARNING:app.api.auto_approval:âš ï¸ Auto-approval: Failed to rename file in GCS
INFO:app.api.auto_approval:  â­ï¸ Auto-approval: Skipping rate field: 'Agent %' -> 'Commission Rate'
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Found commission field: 'Paid Amount' (mapped to 'Commission Earned')
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Calculating total from 1 table(s)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table 0: Found 10 headers
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Commission field 'Paid Amount' found at index 9
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Table has 16 rows, 0 summary rows to skip
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 16 data rows from table 0
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Found invoice field (exact match): 'Invoice Total' (mapped to 'Invoice Total')
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Calculating invoice total from 1 table(s)
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Invoice field 'Invoice Total' found at index 4
INFO:app.api.auto_approval:ğŸ’° Auto-approval: Processed 16 invoice rows from table 0
INFO:app.api.auto_approval:Total validation:
INFO:app.api.auto_approval:  - Extracted from file: $77137.16
INFO:app.api.auto_approval:  - Calculated from table: $4326.14
INFO:app.api.auto_approval:  - Invoice total calculated: $53375.38
INFO:app.api.auto_approval:  - Match: False (difference: 94.39%)
INFO:app.services.websocket_service:Broadcasting message to upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a: progress_update
WARNING:app.services.websocket_service:No active connections found for upload_id 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:app.api.auto_approval:Auto-approval completed for upload 57077d49-835c-4185-b54b-a9b3dd7c641a
INFO:     127.0.0.1:63494 - "POST /api/auto-approve/process HTTP/1.1" 200 OK
INFO:     127.0.0.1:63571 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:63494 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:63571 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:63494 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:63589 - "GET /api/companies/user-specific/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:63591 - "GET /api/earned-commission/carrier/user-specific/35df0e13-76d7-4a42-b66a-2f1a4d8f96cc/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:63494 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:63494 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
