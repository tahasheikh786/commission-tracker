INFO:     127.0.0.1:51987 - "GET /api/dashboard/stats?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:51993 - "GET /api/companies/?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:51991 - "GET /api/companies/?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:51989 - "GET /api/companies/user-specific HTTP/1.1" 200 OK
INFO:     127.0.0.1:51977 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:51972 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:51987 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:51993 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:51991 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:51972 - "GET /api/companies/?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:51977 - "GET /api/dashboard/stats?view_mode=my_data HTTP/1.1" 200 OK
INFO:     127.0.0.1:51987 - "GET /api/companies/user-specific HTTP/1.1" 200 OK
INFO:     127.0.0.1:51989 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025 HTTP/1.1" 200 OK
INFO:     127.0.0.1:51993 - "GET /api/companies/user-specific?environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:51991 - "GET /api/companies/user-specific/7dab2cec-f932-4d59-b0af-123255b5fa81/statements HTTP/1.1" 200 OK
INFO:     127.0.0.1:51972 - "GET /api/earned-commission/carrier/user-specific/7dab2cec-f932-4d59-b0af-123255b5fa81/stats HTTP/1.1" 200 OK
INFO:     127.0.0.1:51977 - "GET /api/companies/user-specific HTTP/1.1" 200 OK
INFO:     127.0.0.1:51972 - "GET /api/companies/user-specific HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/api/dashboard.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [20557]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
WARNING:  StatReload detected changes in 'app/api/dashboard.py'. Reloading...
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [28973]
INFO:     Waiting for application startup.
INFO:app.main:‚úÖ Orphan cleanup scheduler started (runs every 3 minutes)
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.orphan_cleanup_service:üöÄ Starting orphan cleanup scheduler (runs every 3 minutes)
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [29251]
INFO:     Waiting for application startup.
INFO:app.main:‚úÖ Orphan cleanup scheduler started (runs every 3 minutes)
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.orphan_cleanup_service:üöÄ Starting orphan cleanup scheduler (runs every 3 minutes)
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.main:Cleaned up 465 expired/inactive sessions
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:     127.0.0.1:52181 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52183 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:52185 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52179 - "GET /api/dashboard/stats?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52187 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52177 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52181 - "GET /api/earned-commission/stats?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52185 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52179 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:52187 - "GET /api/earned-commission/carriers-detailed?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52183 - "GET /api/dashboard/stats?view_mode=my_data&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52177 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52464 - "GET /api/dashboard/earned-commissions/years HTTP/1.1" 200 OK
INFO:     127.0.0.1:52464 - "GET /api/dashboard/earned-commissions/years HTTP/1.1" 200 OK
INFO:     127.0.0.1:52462 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:52468 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52466 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52468 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52466 - "GET /api/dashboard/earned-commissions?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52462 - "GET /api/earned-commission/carriers HTTP/1.1" 200 OK
INFO:     127.0.0.1:52468 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
INFO:     127.0.0.1:52468 - "GET /api/earned-commission/companies-aggregated?view_mode=my_data&year=2025&environment_id=9f4a7a57-5715-4b1e-98a9-b9901726a485 HTTP/1.1" 200 OK
WARNING:  StatReload detected changes in 'app/api/dashboard.py'. Reloading...
INFO:     Shutting down
INFO:     Waiting for application shutdown.
INFO:app.main:FastAPI shutdown event triggered
INFO:app.services.process_monitor:Process monitoring cancelled
INFO:app.services.process_monitor:Process monitoring loop stopped
INFO:app.services.process_monitor:Process monitoring stopped
INFO:app.main:Process monitoring stopped
INFO:app.main:Graceful shutdown complete
INFO:     Application shutdown complete.
INFO:     Finished server process [29251]
‚úÖ Using Render PostgreSQL database
‚úÖ Using Render PostgreSQL database
INFO:app.services.company_name_service:spaCy not available, using pattern matching only
INFO:app.services.gpt4o_vision_service:GPT-5 Vision service initialized successfully
INFO:app.services.ai_field_mapping_service:AI Field Mapping Service initialized successfully
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
üåê CORS Configuration - Allowed Origins: ['http://localhost:3000', 'http://127.0.0.1:3000', 'https://commission-tracker-1.onrender.com', 'https://commission-tracker-ochre.vercel.app']
INFO:     Started server process [30537]
INFO:     Waiting for application startup.
INFO:app.main:‚úÖ Orphan cleanup scheduler started (runs every 3 minutes)
INFO:app.services.process_monitor:Process monitor initialized: max_time=1800s, heartbeat_timeout=300s
INFO:app.services.process_monitor:Process monitoring started
INFO:app.main:Process monitoring started for large file processing
INFO:app.main:Application startup complete with enhanced monitoring
INFO:app.services.orphan_cleanup_service:üöÄ Starting orphan cleanup scheduler (runs every 3 minutes)
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.process_monitor:Starting process monitoring loop
INFO:     Application startup complete.
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:app.main:Cleaned up 465 expired/inactive sessions
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:     127.0.0.1:54413 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
INFO:     127.0.0.1:54413 - "GET /api/database-fields/?active_only=true HTTP/1.1" 200 OK
WARNING:app.api.websocket:WebSocket connection without explicit token for upload_id=upload_1763080046273_6dxb61kbm. This is allowed for progress tracking, but consider implementing token passing for production.
INFO:app.api.websocket:Attempting to connect WebSocket for upload_id: upload_1763080046273_6dxb61kbm, session_id: session_1763080046297_wzwiy63p1
INFO:     127.0.0.1:54471 - "WebSocket /api/ws/progress/upload_1763080046273_6dxb61kbm?session_id=session_1763080046297_wzwiy63p1" [accepted]
INFO:app.services.websocket_service:WebSocket connected: upload_id=upload_1763080046273_6dxb61kbm, session_id=session_1763080046297_wzwiy63p1, timeout=1800s
INFO:     connection open
INFO:app.api.websocket:WebSocket connected successfully for upload_id: upload_1763080046273_6dxb61kbm, session_id: session_1763080046297_wzwiy63p1
INFO:app.api.websocket:Started keepalive task for upload_id=upload_1763080046273_6dxb61kbm
INFO:     127.0.0.1:54473 - "OPTIONS /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.new_extract:üìÅ File: 08.06.2025 Allied Innovative Payment 2.pdf, Size: 227321 bytes, User: f6cf1764-5bfc-4352-abd9-81b72b7cf191
INFO:app.api.new_extract:üöÄ Starting extraction: 08.06.2025 Allied Innovative Payment 2.pdf (ID: upload_1763080046273_6dxb61kbm)
INFO:app.services.gcs_utils:‚úÖ File uploaded to GCS: statements/bf49646f-28e2-4b49-af55-ba486cafb9c7/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.new_extract:‚úÖ Uploaded to GCS: statements/bf49646f-28e2-4b49-af55-ba486cafb9c7/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/bf49646f-28e2-4b49-af55-ba486cafb9c7/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Step started: Uploading Document (Step 1) for upload_id upload_1763080046273_6dxb61kbm
INFO:app.api.new_extract:üìù Upload metadata prepared (NOT saved to DB): bf49646f-28e2-4b49-af55-ba486cafb9c7
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_process (ID: bf49646f-28e2-4b49-af55-ba486cafb9c7)
INFO:app.services.claude.service:üîÑ Initializing Claude API client (SDK version: True)
INFO:app.services.claude.service:üîë API Key found: sk-ant-api03-vz...
INFO:app.services.claude.service:‚úÖ Claude API client initialized successfully
INFO:app.services.claude.service:üìã Client object: <class 'anthropic.Anthropic'>
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic Extraction Service initialized
INFO:app.services.claude.utils:üîß Token Bucket initialized:
INFO:app.services.claude.utils:   RPM Limit: 45 (from 50)
INFO:app.services.claude.utils:   TPM Limit: 36,000 (from 40,000)
INFO:app.services.claude.utils:   Buffer: 90%
INFO:app.services.claude.utils:   Max chunk: 12 pages = 33,000 tokens + 3K prompt
INFO:app.services.claude.service:‚úÖ Claude Document AI Service initialized
INFO:app.services.claude.service:üìã Primary model: claude-sonnet-4-5-20250929
INFO:app.services.claude.service:üìã Fallback model: claude-opus-4-1-20250805
INFO:app.services.claude.service:üìè Limits: 32MB, 100 pages
INFO:app.services.claude.service:üõ°Ô∏è  Rate limiting: ENABLED (40 RPM, 32,000 TPM) - OPTIMAL for performance
INFO:app.services.claude.service:üíæ Prompt caching: SUPPORTED
INFO:app.services.claude.service:üìä Chunk size: Dynamic (calculated per file, adapts 2-8 pages)
INFO:app.services.enhanced_extraction_service:‚úÖ Enhanced Extraction Service initialized (OPTIMIZED)
INFO:app.services.enhanced_extraction_service:üÜï PRIMARY: Claude Document AI (all extraction + metadata)
INFO:app.services.enhanced_extraction_service:üìã FALLBACK services: Lazy-loaded on demand (GPT-4, Mistral, DocAI, Excel)
INFO:app.services.enhanced_extraction_service:‚è±Ô∏è  Timeout management: {'metadata_extraction': 300, 'document_processing': 600, 'table_extraction': 1200, 'post_processing': 300, 'total_process': 1800}
INFO:app.services.enhanced_extraction_service:üöÄ Enhanced 3-phase pipeline: ENABLED
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude as primary extraction service
INFO:app.services.enhanced_extraction_service:‚úÖ CLAUDE service validated successfully
INFO:app.services.enhanced_extraction_service:Routing to Claude extraction (method: smart)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Started stage document_processing for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763080046273_6dxb61kbm
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata with Claude to determine carrier-specific prompt
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.claude.service:üîç Extracting metadata with Claude from: pdfs/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.claude.service:üìÑ Large file (7 pages) - Using ONLY first 3 pages for metadata
INFO:app.services.claude.service:   Savings: 4 pages / ~11,000 tokens saved
INFO:app.services.claude.service:üìä Estimated tokens for request: 10,677 (3 pages)
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-5-20250929 (attempt 1/5, cache=False)
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=7,623, output=240
INFO:app.services.claude.service:üìä Token tracking: Estimated=10,677, Actual=7,623, Diff=-3,054
INFO:app.services.claude.service:üîß Token bucket adjusted: 10,677 ‚Üí 7,623
INFO:app.services.enhanced_extraction_service:‚úì Using Claude-extracted carrier name for prompt: Allied Benefit Systems
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.enhanced_extraction_service:üì° Emitting extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Step started: Analyzing Document (Step 2) for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.enhanced_extraction_service:‚úÖ Metadata extraction completed by Claude
INFO:app.services.enhanced_extraction_service:üì° Emitting table_extraction step...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Step started: Reading Commission Data (Step 3) for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.enhanced_extraction_service:Starting Claude extraction for pdfs/08.06.2025 Allied Innovative Payment 2.pdf (enhanced=True)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.claude.service:üìÑ Standard file (7 pages) - Using STANDARD processing
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed stage document_processing for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Started stage table_detection for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.claude.dynamic_prompts:No carrier-specific prompt found for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìã No carrier-specific prompt for 'Allied Benefit Systems', using standard prompt only
INFO:app.services.claude.service:üìä Estimated tokens for request: 26,488 (7 pages)
INFO:app.services.claude.service:üîÑ Calling Claude API with model: claude-sonnet-4-5-20250929 (attempt 1/5, cache=False)
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.claude.service:‚úÖ Claude API call successful. Tokens: input=18,866, output=5,237
INFO:app.services.claude.service:üìä Token tracking: Estimated=26,488, Actual=18,866, Diff=-7,622
INFO:app.services.claude.service:üîß Token bucket adjusted: 34,111 ‚Üí 26,489
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Started stage validation for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed stage validation for upload upload_1763080046273_6dxb61kbm
INFO:app.services.claude.service:üöÄ Running enhanced 3-phase extraction pipeline...
INFO:app.services.claude.service:   Phase 1: Document Intelligence ‚úì (completed)
INFO:app.services.claude.service:   Phase 2: Semantic Extraction ‚Üí Starting...
INFO:app.services.claude.service:   Phase 3: Intelligent Summarization ‚Üí Pending...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Started stage semantic_analysis for upload upload_1763080046273_6dxb61kbm
INFO:app.services.claude.service:üìä Phase 2: Semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:üîç Starting semantic extraction and relationship mapping...
INFO:app.services.claude.semantic_extractor:üìä Extracted 0 writing agents: []
INFO:app.services.claude.semantic_extractor:üìä Extracted 57 groups/companies
INFO:app.services.claude.semantic_extractor:‚úÖ Semantic extraction completed successfully
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed stage semantic_analysis for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Started stage summary_generation for upload upload_1763080046273_6dxb61kbm
INFO:app.services.claude.service:‚úçÔ∏è Phase 3: Intelligent summarization...
INFO:app.services.claude.service:üìä Semantic result keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.claude.service:   - Entities: ‚úÖ
INFO:app.services.claude.service:   - Relationships: ‚úÖ
INFO:app.services.claude.service:   - Business Intelligence: ‚úÖ
INFO:app.services.claude.service:üìù Summary service available: True
INFO:app.services.claude.service:üöÄ Calling generate_conversational_summary with use_enhanced=True...
INFO:app.services.conversational_summary_service:üó£Ô∏è Generating conversational summary...
INFO:app.services.conversational_summary_service:üîç _build_summary_prompt called:
INFO:app.services.conversational_summary_service:   - use_enhanced: True
INFO:app.services.conversational_summary_service:   - has_enhanced_data: True
INFO:app.services.conversational_summary_service:   - extraction_data keys: ['success', 'entities', 'relationships', 'business_intelligence', 'raw_tables']
INFO:app.services.conversational_summary_service:‚úÖ Using ENHANCED summary prompt (with enhanced prompts module)
INFO:app.services.conversational_summary_service:üéØ Building enhanced summary prompt...
INFO:app.services.conversational_summary_service:   - Entities: ['carrier', 'broker', 'writing_agents', 'groups_and_companies', 'document_metadata']
INFO:app.services.conversational_summary_service:   - Relationships: ['carrier_to_broker', 'broker_to_agents', 'agents_to_groups', 'groups_to_payments']
INFO:app.services.conversational_summary_service:   - Business Intelligence: ['total_commission_amount', 'number_of_groups', 'commission_structures', 'top_contributors', 'special_payments', 'payment_period', 'patterns_detected']
INFO:app.services.conversational_summary_service:‚úÖ SUCCESS: Enhanced prompts module imported
INFO:app.services.conversational_summary_service:üöÄ Using EnhancedClaudePrompts.get_intelligent_summarization_prompt()
INFO:app.services.conversational_summary_service:‚úÖ SUCCESS: Enhanced prompts imported correctly
INFO:app.services.conversational_summary_service:üöÄ Calling Claude API for summary generation...
INFO:app.services.conversational_summary_service:   Model: claude-sonnet-4-5-20250929
INFO:app.services.conversational_summary_service:   Max tokens: 1200
INFO:app.services.conversational_summary_service:   Prompt length: 42006 chars
INFO:app.services.conversational_summary_service:   System prompt length: 1421 chars
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.anthropic.com/v1/messages "HTTP/1.1 200 OK"
INFO:app.services.conversational_summary_service:‚úÖ Claude API call successful
INFO:app.services.conversational_summary_service:   Response content blocks: 1
INFO:app.services.conversational_summary_service:‚úÖ Detected structured JSON response from Claude
INFO:app.services.conversational_summary_service:üìä Claude provided 7 fields: ['total_amount', 'carrier_name', 'broker_company', 'statement_date', 'company_count', 'top_contributors', 'commission_structure']
INFO:app.services.conversational_summary_service:‚úÖ Extracted structured summary data (8 fields): ['carrier_name', 'broker_company', 'statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'top_contributors', 'commission_structure']
INFO:app.services.conversational_summary_service:‚úÖ Fallback added 1 missing fields: ['broker_id_confidence']
INFO:app.services.conversational_summary_service:üìÑ Generated summary length: 1260 characters
INFO:app.services.conversational_summary_service:üìä Final structured data keys: ['carrier_name', 'broker_company', 'statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'top_contributors', 'commission_structure']
INFO:app.services.claude.service:‚úÖ Summary generation completed. Success: True
INFO:app.services.claude.service:üìÑ Generated summary (first 200 chars): This is This is an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 across 57 individual payment line items spanning 11 distinct client group...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed stage summary_generation for upload upload_1763080046273_6dxb61kbm
INFO:app.services.claude.service:‚úÖ Enhanced 3-phase pipeline completed successfully
INFO:app.services.claude.service:üì¶ Enhanced result keys: ['success', 'tables', 'extraction_method', 'file_type', 'document_metadata', 'extracted_carrier', 'extracted_date', 'quality_summary', 'metadata', 'extraction_quality', 'entities', 'relationships', 'business_intelligence', 'summary', 'structured_data', 'extraction_pipeline', 'semantic_extraction_success']
INFO:app.services.claude.service:   - Summary length: 1260 characters
INFO:app.services.claude.service:   - Summary preview: This is This is an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 across 57 individual pa...
INFO:app.services.claude.service:   - Structured data: {'carrier_name': 'Allied Benefit Systems', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-08-06', 'total_amount': '3604.95', 'company_count': '11', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'PRIDE DELIVERY SERVIC', 'amount': '2318.37'}, {'name': 'LUDICROUS SPEED LOGI', 'amount': '1389.84'}, {'name': 'SITIJI IN', 'amount': '1133.14'}], 'commission_structure': 'Premium Equivalent'}
INFO:app.services.claude.service:‚úÖ Claude extraction completed in 81.91s
INFO:app.services.enhanced_extraction_service:‚ö° Extracting metadata from Claude extraction results
INFO:app.services.enhanced_extraction_service:‚úÖ Using Claude metadata: carrier=Allied Benefit Systems, date=2025-08-06, broker=INNOVATIVE BPS LLC
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
üìé Enhanced multi-strategy stitching: Processing 1 tables
üìé Canonical header identified: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Table 1 headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount'] (10 columns)
üìé Found 1 unique header patterns
üìé Grouped 1 tables into 1 groups
üìé Merging group 1 with 1 tables
INFO:app.services.extraction_utils:‚úÖ Merged table created: 93 rows (enhancements preserved from individual tables)
üìé Merged table 1: 10 headers, 93 rows
üìé Merged headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üìé Enhanced stitching completed: 1 final tables
INFO:app.services.extraction_utils:Header normalization: 10 headers normalized
INFO:app.services.enhanced_extraction_service:Claude: Verified normalized headers
INFO:app.services.enhanced_extraction_service:Claude: Processed 1 tables into 1 tables
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed stage table_detection for upload upload_1763080046273_6dxb61kbm
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:üéØ STAGE 3: CONVERSATIONAL SUMMARY GENERATION
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   - Enhanced mode enabled: True
INFO:app.services.enhanced_extraction_service:   - Result has 'summary': True
INFO:app.services.enhanced_extraction_service:   - Summary service available: True
INFO:app.services.enhanced_extraction_service:‚úÖ Using enhanced summary from Claude pipeline
INFO:app.services.enhanced_extraction_service:   Summary length: 1260 characters
INFO:app.services.enhanced_extraction_service:   Summary preview: This is This is an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 across 57 individual payment line items spanning 11 distinct client group...
INFO:app.services.enhanced_extraction_service:üì§ Sending Claude-generated summary AND structured data to frontend via WebSocket NOW
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.enhanced_extraction_service:‚úÖ Sent structured summary data to frontend: {'carrier_name': 'Allied Benefit Systems', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-08-06', 'total_amount': '3604.95', 'company_count': '11', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'PRIDE DELIVERY SERVIC', 'amount': '2318.37'}, {'name': 'LUDICROUS SPEED LOGI', 'amount': '1389.84'}, {'name': 'SITIJI IN', 'amount': '1133.14'}], 'commission_structure': 'Premium Equivalent'}
INFO:app.services.enhanced_extraction_service:‚úÖ Claude-generated summary sent to frontend successfully
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:üìù FINAL SUMMARY SELECTION: ENHANCED CONVERSATIONAL
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:   Summary length: 1260 characters
INFO:app.services.enhanced_extraction_service:   Full summary:
This is This is an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 across 57 individual payment line items spanning 11 distinct client groups in the transportation and logistics sector. The portfolio is dominated by three major accounts: PRIDE DELIVERY SERVIC generating a net $2,318.37 across three payment entries (including individual payments of $1,256.53 and $1,194.57 offset by a $132.73 adjustment), LUDICROUS SPEED LOGI contributing a net $1,389.84 from five transactions (led by a $925.23 payment), and SITIJI IN showing extensive activity with 32 payment entries netting approximately $1,133.14 despite significant churn with alternating positive $58.62 and negative $61.14 adjustments suggesting frequent enrollment changes. The statement reveals a challenging period with substantial negative adjustments totaling over $2,000 across multiple groups including BTK RUSH IN (five consecutive $61.08 chargebacks), FUZION EXPRESS LL (net negative $514.61), BOLT LOGISTIC ($141.14 chargeback), CONNECT LOGISTICS IN ($81.68), and PATEL LOGISTICS IN ($31.29), indicating either cancellations, retroactive coverage adjustments, or commission recaptures that offset the gross commission generation.
INFO:app.services.enhanced_extraction_service:================================================================================
INFO:app.services.enhanced_extraction_service:‚úÖ Added structured_data to result: ['carrier_name', 'broker_company', 'statement_date', 'total_amount', 'company_count', 'broker_id_confidence', 'top_contributors', 'commission_structure']
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Started stage validation for upload upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: progress_update
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: completion
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Completed processing for upload upload_1763080046273_6dxb61kbm in 88.96 seconds
INFO:app.api.new_extract:‚úÖ Extraction completed
INFO:app.services.cancellation_manager:Cleared cancellation status for upload upload_1763080046273_6dxb61kbm
INFO:app.api.new_extract:‚úÖ Extraction completed (data NOT saved to DB, will be saved on approval)
INFO:app.services.audit_logging_service:Audit: data_view by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on extraction_complete (ID: bf49646f-28e2-4b49-af55-ba486cafb9c7)
INFO:app.api.new_extract:üÜï Carrier 'Allied Benefit Systems' not found in database, creating automatically...
INFO:app.api.new_extract:‚úÖ Auto-created carrier: Allied Benefit Systems with ID 13fb5384-7e92-442a-9ecc-5ce5d7790fb9
INFO:app.api.new_extract:üéØ Format Learning: Using carrier Allied Benefit Systems with ID 13fb5384-7e92-442a-9ecc-5ce5d7790fb9
WARNING:app.api.new_extract:üö® CARRIER MISMATCH DETECTED: File uploaded to d883a865-a54f-41d6-968e-f94c3cb3f589 but extracted as Allied Benefit Systems (13fb5384-7e92-442a-9ecc-5ce5d7790fb9)
INFO:app.api.new_extract:üîÑ Reassigning file to correct carrier: Allied Benefit Systems
INFO:app.services.gcs_utils:‚úÖ File copied in GCS: statements/bf49646f-28e2-4b49-af55-ba486cafb9c7/08.06.2025 Allied Innovative Payment 2.pdf -> statements/13fb5384-7e92-442a-9ecc-5ce5d7790fb9/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ File deleted from GCS: statements/bf49646f-28e2-4b49-af55-ba486cafb9c7/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.services.gcs_utils:‚úÖ Generated signed URL for GCS file with inline headers: statements/13fb5384-7e92-442a-9ecc-5ce5d7790fb9/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.new_extract:‚úÖ File moved to correct carrier folder in GCS: statements/13fb5384-7e92-442a-9ecc-5ce5d7790fb9/08.06.2025 Allied Innovative Payment 2.pdf
INFO:app.api.new_extract:‚úÖ Updated upload metadata: carrier_id=13fb5384-7e92-442a-9ecc-5ce5d7790fb9, company_id=13fb5384-7e92-442a-9ecc-5ce5d7790fb9
INFO:app.api.new_extract:üìä Single table detected, using it for field mapping
INFO:app.api.new_extract:üéØ Using table 0 for field mapping with 10 headers
üéØ FormatLearningService: Finding matching format for company 13fb5384-7e92-442a-9ecc-5ce5d7790fb9
üéØ FormatLearningService: Headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ FormatLearningService: Table structure: {'row_count': 93, 'column_count': 10, 'has_financial_data': True}
üéØ FormatLearningService: Headers type: <class 'list'>
üéØ FormatLearningService: Headers length: 10
üéØ CRUD: Finding best matching format for company 13fb5384-7e92-442a-9ecc-5ce5d7790fb9
üéØ CRUD: Input headers: ['Group No.', 'Group Name', 'Billing Period', 'Adj. Period', 'Invoice Total', 'Stoploss Total', 'Agent Rate', 'Calculation Method', 'Census Ct.', 'Paid Amount']
üéØ CRUD: Input table structure: {'row_count': 93, 'column_count': 10, 'has_financial_data': True}
üéØ CRUD: Found 0 saved formats for company
üéØ FormatLearningService: Best match score: 0
üéØ FormatLearningService: No matching format found
INFO:app.api.new_extract:üéØ Format Learning: No matching format found (score: 0.0)
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Step started: Understanding Structure (Step 4) for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.ai_plan_type_detection_service:AI Plan Type Detection Service initialized successfully
INFO:app.api.new_extract:üîç AI Plan Type Detection: Detecting plan types during extraction
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.new_extract:‚úÖ AI Plan Detection: 1 plan types with 0.90 confidence
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Step started: AI Field Mapping (Step 5) for upload_id upload_1763080046273_6dxb61kbm
INFO:app.api.new_extract:üß† AI Field Mapping: Starting field mapping during extraction
INFO:app.api.ai_intelligent_mapping:üöÄ Enhanced AI Analysis Request: User muhammad@pinecrestconsulting.com
INFO:app.services.ai_field_mapping_service:ü§ñ AI Mapping: Analyzing 10 headers with AI intelligence
INFO:app.services.ai_field_mapping_service:üîç AI Mapping: carrier_id provided: True (value: 13fb5384-7e92-442a-9ecc-5ce5d7790fb9)
INFO:app.services.ai_field_mapping_service:üéØ Carrier ID is valid, attempting to retrieve learned mapping for carrier 13fb5384-7e92-442a-9ecc-5ce5d7790fb9
INFO:app.services.ai_field_mapping_service:üîç Generated format signature for lookup: 6f736ac611e1789c131a993b10321314
INFO:app.services.ai_field_mapping_service:üîç Looking up learned format for carrier 13fb5384-7e92-442a-9ecc-5ce5d7790fb9 with 10 headers
INFO:app.services.ai_field_mapping_service:‚ùå No exact match found, trying fuzzy matching...
INFO:app.services.ai_field_mapping_service:üîç Found 0 saved formats for fuzzy matching
INFO:app.services.ai_field_mapping_service:‚ùå No matching format found
INFO:app.services.ai_field_mapping_service:‚ùå No learned mapping found for carrier 13fb5384-7e92-442a-9ecc-5ce5d7790fb9
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_field_mapping_service:‚úÖ AI successfully generated field mappings
INFO:app.services.ai_field_mapping_service:‚úÖ AI Mapping: Generated 10 mappings with 0.86 confidence
INFO:app.services.ai_plan_type_detection_service:üîç AI Plan Detection: Analyzing document for insurance plan types
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.api.websocket:Received unknown message type: heartbeat
INFO:httpx:HTTP Request: POST https://api.mistral.ai/v1/chat/completions "HTTP/1.1 200 OK"
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI successfully detected plan types
INFO:app.services.ai_plan_type_detection_service:‚úÖ AI Plan Detection: Found 1 plan types with 0.90 confidence
INFO:app.api.ai_intelligent_mapping:‚úÖ Enhanced AI Analysis Complete: Overall confidence 0.88
INFO:app.api.new_extract:‚úÖ AI Field Mapping: 10 mappings with 0.86 confidence
INFO:app.api.new_extract:‚úÖ Enhanced summary already generated by Claude pipeline - using it
INFO:app.api.new_extract:   Enhanced summary: This is This is an Allied Benefit Systems commission statement for INNOVATIVE BPS LLC dated August 6, 2025, totaling $3,604.95 across 57 individual payment line items spanning 11 distinct client groups in the transportation and logistics sector. The portfolio is dominated by three major accounts: PRIDE DELIVERY SERVIC generating a net $2,318.37 across three payment entries (including individual payments of $1,256.53 and $1,194.57 offset by a $132.73 adjustment), LUDICROUS SPEED LOGI contributing a net $1,389.84 from five transactions (led by a $925.23 payment), and SITIJI IN showing extensive activity with 32 payment entries netting approximately $1,133.14 despite significant churn with alternating positive $58.62 and negative $61.14 adjustments suggesting frequent enrollment changes. The statement reveals a challenging period with substantial negative adjustments totaling over $2,000 across multiple groups including BTK RUSH IN (five consecutive $61.08 chargebacks), FUZION EXPRESS LL (net negative $514.61), BOLT LOGISTIC ($141.14 chargeback), CONNECT LOGISTICS IN ($81.68), and PATEL LOGISTICS IN ($31.29), indicating either cancellations, retroactive coverage adjustments, or commission recaptures that offset the gross commission generation.
INFO:app.api.new_extract:   Structured data: {'carrier_name': 'Allied Benefit Systems', 'broker_company': 'INNOVATIVE BPS LLC', 'statement_date': '2025-08-06', 'total_amount': '3604.95', 'company_count': '11', 'broker_id_confidence': 0.7, 'top_contributors': [{'name': 'PRIDE DELIVERY SERVIC', 'amount': '2318.37'}, {'name': 'LUDICROUS SPEED LOGI', 'amount': '1389.84'}, {'name': 'SITIJI IN', 'amount': '1133.14'}], 'commission_structure': 'Premium Equivalent'}
ERROR:app.services.user_profile_service:Error recording user contribution: (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.ForeignKeyViolationError'>: insert or update on table "user_data_contributions" violates foreign key constraint "user_data_contributions_upload_id_fkey"
DETAIL:  Key (upload_id)=(bf49646f-28e2-4b49-af55-ba486cafb9c7) is not present in table "statement_uploads".
[SQL: INSERT INTO user_data_contributions (id, user_id, upload_id, contribution_type, contribution_data, created_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::VARCHAR, $5::JSON, $6::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (UUID('7645e0af-354a-47b1-96fb-3ee7b1d4dcd5'), UUID('f6cf1764-5bfc-4352-abd9-81b72b7cf191'), UUID('bf49646f-28e2-4b49-af55-ba486cafb9c7'), 'upload', '{"file_name": "08.06.2025 Allied Innovative Payment 2.pdf", "file_size": 227321, "file_hash": "98272fc00893adaec0ba3d024c34cd58ae3c39498cb8f83c45f819900f06e322", "extraction_method": "smart", "confidence_threshold": 0.6, "enable_ocr": true, "enable_multipage": true}', datetime.datetime(2025, 11, 14, 0, 29, 44, 845829))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
INFO:app.api.new_extract:‚ÑπÔ∏è User contribution deferred until approval (statement not yet persisted): (sqlalchemy.dialects.postgresql.asyncpg.IntegrityError) <class 'asyncpg.exceptions.ForeignKeyViolationError'>: insert or update on table "user_data_contributions" violates foreign key constraint "user_data_contributions_upload_id_fkey"
DETAIL:  Key (upload_id)=(bf49646f-28e2-4b49-af55-ba486cafb9c7) is not present in table "statement_uploads".
[SQL: INSERT INTO user_data_contributions (id, user_id, upload_id, contribution_type, contribution_data, created_at) VALUES ($1::UUID, $2::UUID, $3::UUID, $4::VARCHAR, $5::JSON, $6::TIMESTAMP WITHOUT TIME ZONE)]
[parameters: (UUID('7645e0af-354a-47b1-96fb-3ee7b1d4dcd5'), UUID('f6cf1764-5bfc-4352-abd9-81b72b7cf191'), UUID('bf49646f-28e2-4b49-af55-ba486cafb9c7'), 'upload', '{"file_name": "08.06.2025 Allied Innovative Payment 2.pdf", "file_size": 227321, "file_hash": "98272fc00893adaec0ba3d024c34cd58ae3c39498cb8f83c45f819900f06e322", "extraction_method": "smart", "confidence_threshold": 0.6, "enable_ocr": true, "enable_multipage": true}', datetime.datetime(2025, 11, 14, 0, 29, 44, 845829))]
(Background on this error at: https://sqlalche.me/e/20/gkpj)
INFO:app.services.audit_logging_service:Audit: file_upload by user f6cf1764-5bfc-4352-abd9-81b72b7cf191 on statement_upload (ID: bf49646f-28e2-4b49-af55-ba486cafb9c7)
INFO:app.api.new_extract:üì§ Sending pre-generated enhanced summary via WebSocket...
INFO:app.api.new_extract:üìä Sending structured data: {"carrier_name": "Allied Benefit Systems", "broker_company": "INNOVATIVE BPS LLC", "statement_date": "2025-08-06", "total_amount": "3604.95", "company_count": "11", "broker_id_confidence": 0.7, "top_c...
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_STARTED
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Step started: Preparing Results (Step 6) for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: STEP_PROGRESS
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Broadcasting message to upload_id upload_1763080046273_6dxb61kbm: EXTRACTION_COMPLETE
INFO:app.services.websocket_service:Found 1 connections for upload_id upload_1763080046273_6dxb61kbm
INFO:app.services.websocket_service:Extraction complete for upload_id upload_1763080046273_6dxb61kbm
INFO:app.api.new_extract:‚úÖ Extraction complete! Sent results via WebSocket for upload_id: upload_1763080046273_6dxb61kbm
INFO:     connection closed
INFO:app.api.websocket:WebSocket disconnected: upload_id=upload_1763080046273_6dxb61kbm, session_id=session_1763080046297_wzwiy63p1
INFO:app.services.websocket_service:WebSocket disconnected: upload_id=upload_1763080046273_6dxb61kbm, session_id=session_1763080046297_wzwiy63p1
INFO:app.api.websocket:WebSocket cleanup completed for upload_id=upload_1763080046273_6dxb61kbm
INFO:     127.0.0.1:54475 - "POST /api/extract-tables-smart/ HTTP/1.1" 200 OK
INFO:app.api.pdf_proxy:üîÑ Proxying PDF from: https://storage.googleapis.com/pdf_extraction_files_saver/statements/13fb5384-7e92-442a-9ecc-5ce5d77...
INFO:httpx:HTTP Request: GET https://storage.googleapis.com/pdf_extraction_files_saver/statements/13fb5384-7e92-442a-9ecc-5ce5d7790fb9/08.06.2025%20Allied%20Innovative%20Payment%202.pdf?X-Goog-Algorithm=GOOG4-RSA-SHA256&X-Goog-Credential=docsai-table-extractor%40pdf-tables-extractor-465009.iam.gserviceaccount.com%2F20251114%2Fauto%2Fstorage%2Fgoog4_request&X-Goog-Date=20251114T002904Z&X-Goog-Expires=3599&X-Goog-SignedHeaders=host&response-content-disposition=inline&response-content-type=application%2Fpdf&X-Goog-Signature=3a7d0934a5a23b04ae4ba9d60b0829fbe0f6eb0428a154c01c24149fe2ee62ff6e4b1e5c955c435f5ed774432470ebd81ff58bd11c6caa3c813c1740936727a6cba2add429938eb5e6fe87e215056c441711794bc7eba18ee2b2875c0cabf24001eb4d86af10c27f0ea61c532b610d26026a50b5355f912292a7533e4acef541fc1c95fb6e434e538c32f9f66a23d9b541f1e415059452df9655f8dc880775688dd84882a49aee879ba62b34ae54d98eb0ad803943945e2ffb4a5a1fdfa7ff633d7bb29c25a01aad9f04f06a69403102410799d1eba2510daa69f497b4c17003c0936368bf25dba42b6c95146d23a288f8d9b81b7da091a1498d19e3b76c5eb5 "HTTP/1.1 200 OK"
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
INFO:     127.0.0.1:55080 - "GET /api/pdf-proxy?url=https%3A%2F%2Fstorage.googleapis.com%2Fpdf_extraction_files_saver%2Fstatements%2F13fb5384-7e92-442a-9ecc-5ce5d7790fb9%2F08.06.2025%2520Allied%2520Innovative%2520Payment%25202.pdf%3FX-Goog-Algorithm%3DGOOG4-RSA-SHA256%26X-Goog-Credential%3Ddocsai-table-extractor%2540pdf-tables-extractor-465009.iam.gserviceaccount.com%252F20251114%252Fauto%252Fstorage%252Fgoog4_request%26X-Goog-Date%3D20251114T002904Z%26X-Goog-Expires%3D3599%26X-Goog-SignedHeaders%3Dhost%26response-content-disposition%3Dinline%26response-content-type%3Dapplication%252Fpdf%26X-Goog-Signature%3D3a7d0934a5a23b04ae4ba9d60b0829fbe0f6eb0428a154c01c24149fe2ee62ff6e4b1e5c955c435f5ed774432470ebd81ff58bd11c6caa3c813c1740936727a6cba2add429938eb5e6fe87e215056c441711794bc7eba18ee2b2875c0cabf24001eb4d86af10c27f0ea61c532b610d26026a50b5355f912292a7533e4acef541fc1c95fb6e434e538c32f9f66a23d9b541f1e415059452df9655f8dc880775688dd84882a49aee879ba62b34ae54d98eb0ad803943945e2ffb4a5a1fdfa7ff633d7bb29c25a01aad9f04f06a69403102410799d1eba2510daa69f497b4c17003c0936368bf25dba42b6c95146d23a288f8d9b81b7da091a1498d19e3b76c5eb5 HTTP/1.1" 200 OK
INFO:     127.0.0.1:55078 - "GET /api/pending/progress/bf49646f-28e2-4b49-af55-ba486cafb9c7/table_editor HTTP/1.1" 200 OK
INFO:app.services.orphan_cleanup_service:üßπ Starting orphan cleanup job...
INFO:app.services.orphan_cleanup_service:‚úÖ Orphan cleanup completed: no orphans found
